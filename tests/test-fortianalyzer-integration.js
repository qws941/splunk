#!/usr/bin/env node

/**
 * FortiAnalyzer Ïã§Ï†ú Ïó∞Îèô Í∞ÄÎä•ÏÑ± ÌÖåÏä§Ìä∏
 * Ïã§Ï†ú FAZ ÏÑúÎ≤ÑÏôÄ Splunk HEC Ïó∞Îèô ÌÖåÏä§Ìä∏
 */

import https from 'https';
import http from 'http';
import net from 'net';

const FAZ_CONFIG = {
  host: process.env.FAZ_HOST || 'fortianalyzer.jclee.me',
  port: process.env.FAZ_PORT || 443,
  username: process.env.FAZ_USERNAME || 'admin',
  password: process.env.FAZ_PASSWORD || 'fortinet'
};

const SPLUNK_CONFIG = {
  host: process.env.SPLUNK_HEC_HOST || 'splunk.jclee.me',
  port: process.env.SPLUNK_HEC_PORT || 8088,
  token: process.env.SPLUNK_HEC_TOKEN || 'test-token'
};

/**
 * FortiAnalyzer REST API Ìò∏Ï∂ú ÌÖåÏä§Ìä∏
 */
async function testFortiAnalyzerConnection() {
  console.log('üîç FortiAnalyzer REST API Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ï§ë...');
  console.log(`üì° Ïó∞Í≤∞ ÎåÄÏÉÅ: ${FAZ_CONFIG.host}:${FAZ_CONFIG.port}`);

  return new Promise((resolve) => {
    const auth = Buffer.from(`${FAZ_CONFIG.username}:${FAZ_CONFIG.password}`).toString('base64');

    const options = {
      hostname: FAZ_CONFIG.host,
      port: FAZ_CONFIG.port,
      path: '/api/v2/cmdb/system/status',
      method: 'GET',
      headers: {
        'Authorization': `Basic ${auth}`,
        'Content-Type': 'application/json'
      },
      rejectUnauthorized: false,
      timeout: 10000
    };

    const req = https.request(options, (res) => {
      let data = '';
      res.on('data', chunk => data += chunk);
      res.on('end', () => {
        if (res.statusCode === 200) {
          console.log('‚úÖ FortiAnalyzer Ïó∞Í≤∞ ÏÑ±Í≥µ!');
          try {
            const response = JSON.parse(data);
            console.log(`üì¶ Î≤ÑÏ†Ñ: ${response.version || 'N/A'}`);
            console.log(`üè∑Ô∏è Ìò∏Ïä§Ìä∏Î™Ö: ${response.hostname || 'N/A'}`);
            resolve(true);
          } catch (error) {
            console.log('‚úÖ Ïó∞Í≤∞ ÏÑ±Í≥µ (ÏùëÎãµ ÌååÏã± Ïò§Î•ò)');
            resolve(true);
          }
        } else {
          console.log(`‚ùå FortiAnalyzer Ïó∞Í≤∞ Ïã§Ìå® (HTTP ${res.statusCode})`);
          resolve(false);
        }
      });
    });

    req.on('error', (error) => {
      console.log('‚ùå FortiAnalyzer Ïó∞Í≤∞ Ïò§Î•ò:', error.message);
      resolve(false);
    });

    req.on('timeout', () => {
      req.destroy();
      console.log('‚ùå FortiAnalyzer Ïó∞Í≤∞ ÌÉÄÏûÑÏïÑÏõÉ');
      resolve(false);
    });

    req.setTimeout(10000);
    req.end();
  });
}

/**
 * Splunk HEC Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
 */
async function testSplunkHECConnection() {
  console.log('\nüíß Splunk HEC Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ï§ë...');
  console.log(`üì° Ïó∞Í≤∞ ÎåÄÏÉÅ: ${SPLUNK_CONFIG.host}:${SPLUNK_CONFIG.port}`);

  return new Promise((resolve) => {
    const testEvent = {
      event: 'FortiAnalyzer integration test',
      source: 'fortianalyzer:test',
      sourcetype: 'fortianalyzer:integration',
      index: 'main',
      time: Math.floor(Date.now() / 1000),
      host: 'integration-test'
    };

    const postData = JSON.stringify(testEvent);

    const options = {
      hostname: SPLUNK_CONFIG.host,
      port: SPLUNK_CONFIG.port,
      path: '/services/collector',
      method: 'POST',
      headers: {
        'Authorization': `Splunk ${SPLUNK_CONFIG.token}`,
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(postData)
      },
      rejectUnauthorized: false,
      timeout: 10000
    };

    const protocol = SPLUNK_CONFIG.port === 8088 ? https : http;
    const req = protocol.request(options, (res) => {
      let data = '';
      res.on('data', chunk => data += chunk);
      res.on('end', () => {
        if (res.statusCode === 200) {
          console.log('‚úÖ Splunk HEC Ïó∞Í≤∞ ÏÑ±Í≥µ!');
          console.log('üì§ ÌÖåÏä§Ìä∏ Ïù¥Î≤§Ìä∏ Ï†ÑÏÜ° ÏôÑÎ£å');
          resolve(true);
        } else {
          console.log(`‚ùå Splunk HEC Ïó∞Í≤∞ Ïã§Ìå® (HTTP ${res.statusCode})`);
          console.log('üìÑ ÏùëÎãµ:', data);
          resolve(false);
        }
      });
    });

    req.on('error', (error) => {
      console.log('‚ùå Splunk HEC Ïó∞Í≤∞ Ïò§Î•ò:', error.message);
      resolve(false);
    });

    req.on('timeout', () => {
      req.destroy();
      console.log('‚ùå Splunk HEC Ïó∞Í≤∞ ÌÉÄÏûÑÏïÑÏõÉ');
      resolve(false);
    });

    req.setTimeout(10000);
    req.write(postData);
    req.end();
  });
}

/**
 * Î™®Ïùò FortiGate Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
 */
function generateMockFortiGateLog() {
  const timestamp = new Date().toISOString();
  const mockLog = {
    time: timestamp,
    devname: 'FortiGate-Main-01',
    devid: 'FGT60E1234567890',
    logid: '0000000013',
    type: 'traffic',
    subtype: 'forward',
    level: 'notice',
    vd: 'root',
    eventtime: Math.floor(Date.now() / 1000),
    srcip: '192.168.1.100',
    srcport: 54321,
    srcintf: 'internal',
    srcintfrole: 'lan',
    dstip: '203.0.113.50',
    dstport: 443,
    dstintf: 'wan1',
    dstintfrole: 'wan',
    policyid: 1001,
    policytype: 'policy',
    service: 'HTTPS',
    proto: 6,
    action: 'accept',
    policyname: 'Allow_HTTPS_Outbound',
    duration: 120,
    sentbyte: 2048,
    rcvdbyte: 8192,
    sentpkt: 15,
    rcvdpkt: 12,
    appcat: 'unscanned'
  };

  return {
    event: mockLog,
    source: 'fortianalyzer',
    sourcetype: 'fortigate_traffic',
    index: 'security',
    time: Math.floor(Date.now() / 1000),
    host: 'fortianalyzer.jclee.me'
  };
}

/**
 * Î™®Ïùò Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ Splunk Ï†ÑÏÜ° ÌÖåÏä§Ìä∏
 */
async function testLogDataTransmission() {
  console.log('\nüìä Î™®Ïùò FortiGate Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ° ÌÖåÏä§Ìä∏ Ï§ë...');

  const mockEvent = generateMockFortiGateLog();
  const postData = JSON.stringify(mockEvent);

  return new Promise((resolve) => {
    const options = {
      hostname: SPLUNK_CONFIG.host,
      port: SPLUNK_CONFIG.port,
      path: '/services/collector',
      method: 'POST',
      headers: {
        'Authorization': `Splunk ${SPLUNK_CONFIG.token}`,
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(postData)
      },
      rejectUnauthorized: false,
      timeout: 10000
    };

    const protocol = SPLUNK_CONFIG.port === 8088 ? https : http;
    const req = protocol.request(options, (res) => {
      let data = '';
      res.on('data', chunk => data += chunk);
      res.on('end', () => {
        if (res.statusCode === 200) {
          console.log('‚úÖ Î™®Ïùò Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ° ÏÑ±Í≥µ!');
          console.log('üì§ Ï†ÑÏÜ°Îêú Ïù¥Î≤§Ìä∏:');
          console.log(`   - ÏÜåÏä§ IP: ${mockEvent.event.srcip}`);
          console.log(`   - Î™©Ï†ÅÏßÄ IP: ${mockEvent.event.dstip}`);
          console.log(`   - Ï†ïÏ±Ö ID: ${mockEvent.event.policyid}`);
          console.log(`   - Ïï°ÏÖò: ${mockEvent.event.action}`);
          resolve(true);
        } else {
          console.log(`‚ùå Î™®Ïùò Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ° Ïã§Ìå® (HTTP ${res.statusCode})`);
          resolve(false);
        }
      });
    });

    req.on('error', (error) => {
      console.log('‚ùå Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ° Ïò§Î•ò:', error.message);
      resolve(false);
    });

    req.on('timeout', () => {
      req.destroy();
      console.log('‚ùå Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ° ÌÉÄÏûÑÏïÑÏõÉ');
      resolve(false);
    });

    req.setTimeout(10000);
    req.write(postData);
    req.end();
  });
}

/**
 * ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ÏÑ± ÌÖåÏä§Ìä∏
 */
async function testNetworkConnectivity() {
  console.log('\nüåê ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ÏÑ± ÌÖåÏä§Ìä∏ Ï§ë...');

  const testConnections = [
    { name: 'FortiAnalyzer', host: FAZ_CONFIG.host, port: FAZ_CONFIG.port },
    { name: 'Splunk HEC', host: SPLUNK_CONFIG.host, port: SPLUNK_CONFIG.port }
  ];

  const results = [];

  for (const conn of testConnections) {
    const result = await new Promise((resolve) => {
      const startTime = Date.now();
      const socket = new net.Socket();

      socket.setTimeout(5000);

      socket.connect(conn.port, conn.host, () => {
        const latency = Date.now() - startTime;
        console.log(`‚úÖ ${conn.name} Ïó∞Í≤∞ ÏÑ±Í≥µ (ÏßÄÏó∞ÏãúÍ∞Ñ: ${latency}ms)`);
        socket.destroy();
        resolve({ name: conn.name, success: true, latency });
      });

      socket.on('error', (error) => {
        console.log(`‚ùå ${conn.name} Ïó∞Í≤∞ Ïã§Ìå®: ${error.message}`);
        resolve({ name: conn.name, success: false, error: error.message });
      });

      socket.on('timeout', () => {
        console.log(`‚ùå ${conn.name} Ïó∞Í≤∞ ÌÉÄÏûÑÏïÑÏõÉ`);
        socket.destroy();
        resolve({ name: conn.name, success: false, error: 'timeout' });
      });
    });

    results.push(result);
  }

  return results;
}

/**
 * Î©îÏù∏ ÌÖåÏä§Ìä∏ Ïã§Ìñâ Ìï®Ïàò
 */
async function runIntegrationTests() {
  console.log('üß™ FortiAnalyzer-Splunk ÌÜµÌï© Ïó∞Îèô ÌÖåÏä§Ìä∏ ÏãúÏûë\n');
  console.log('=' .repeat(60));

  let successCount = 0;
  const totalTests = 4;

  // 1. ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ÏÑ± ÌÖåÏä§Ìä∏
  const networkResults = await testNetworkConnectivity();
  const networkSuccess = networkResults.every(r => r.success);
  if (networkSuccess) successCount++;

  // 2. FortiAnalyzer Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
  if (await testFortiAnalyzerConnection()) successCount++;

  // 3. Splunk HEC Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
  if (await testSplunkHECConnection()) successCount++;

  // 4. Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ° ÌÖåÏä§Ìä∏
  if (await testLogDataTransmission()) successCount++;

  // Í≤∞Í≥º ÏöîÏïΩ
  console.log('\n' + '=' .repeat(60));
  console.log('üìä ÌÜµÌï© ÌÖåÏä§Ìä∏ Í≤∞Í≥º ÏöîÏïΩ:');
  console.log(`‚úÖ ÏÑ±Í≥µÌïú ÌÖåÏä§Ìä∏: ${successCount}/${totalTests}`);

  console.log('\nüí° Ïã§Ï†ú Ïó∞ÎèôÏùÑ ÏúÑÌïú ÌôòÍ≤Ω ÏÑ§Ï†ï:');
  console.log('   FAZ_HOST=' + FAZ_CONFIG.host);
  console.log('   FAZ_USERNAME=' + FAZ_CONFIG.username);
  console.log('   SPLUNK_HEC_HOST=' + SPLUNK_CONFIG.host);
  console.log('   SPLUNK_HEC_TOKEN=' + SPLUNK_CONFIG.token);

  if (successCount === totalTests) {
    console.log('\nüéâ Î™®Îì† ÌÜµÌï© ÌÖåÏä§Ìä∏ ÏÑ±Í≥µ! Ïã§Ï†ú ÌôòÍ≤ΩÏóêÏÑú ÏôÑÏ†ÑÌûà ÎèôÏûëÌï† Ïàò ÏûàÏäµÎãàÎã§.');
  } else if (successCount >= 2) {
    console.log('\n‚ö†Ô∏è Î∂ÄÎ∂ÑÏ†Å ÏÑ±Í≥µ. ÌôòÍ≤Ω ÏÑ§Ï†ï ÌõÑ ÏôÑÏ†Ñ ÎèôÏûë Í∞ÄÎä•Ìï©ÎãàÎã§.');
  } else {
    console.log('\n‚ùå ÎåÄÎ∂ÄÎ∂ÑÏùò ÌÖåÏä§Ìä∏ Ïã§Ìå®. ÌôòÍ≤Ω ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
  }

  return successCount;
}

// Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä ÏßÅÏ†ë Ïã§ÌñâÎê† ÎïåÎßå ÌÖåÏä§Ìä∏ Ïã§Ìñâ
if (import.meta.url === `file://${process.argv[1]}`) {
  runIntegrationTests().catch(console.error);
}

export { testFortiAnalyzerConnection, testSplunkHECConnection, generateMockFortiGateLog };