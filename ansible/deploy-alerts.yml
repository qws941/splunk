---
# Ansible Playbook for Splunk Alert Deployment
# Purpose: Automate end-to-end alert setup (HEC + Alerts + Plugins)
# Usage: ansible-playbook -i inventory.ini deploy-alerts.yml

- name: Deploy FortiGate Alerts to Splunk
  hosts: splunk_servers
  gather_facts: yes
  vars:
    splunk_home: "/opt/splunk"
    splunk_user: "splunk"
    splunk_password: "changeme"
    splunk_url: "https://{{ ansible_host }}:8089"
    hec_port: 8088
    fortigate_index: "fortianalyzer"
    slack_channel: "#security-firewall-alert"

    # Plugin versions
    slack_plugin_version: "2.3.2"
    fortigate_ta_version: "1.6.9"
    cim_version: "6.2.0"

  tasks:
    # =========================================================================
    # Phase 1: Prerequisites Check
    # =========================================================================
    - name: Check Splunk is running
      command: "{{ splunk_home }}/bin/splunk status"
      register: splunk_status
      changed_when: false
      failed_when: "'splunkd is not running' in splunk_status.stdout"

    - name: Verify Splunk version
      command: "{{ splunk_home }}/bin/splunk version"
      register: splunk_version_output
      changed_when: false

    - name: Display Splunk version
      debug:
        msg: "Splunk version: {{ splunk_version_output.stdout }}"

    # =========================================================================
    # Phase 2: Plugin Installation
    # =========================================================================
    - name: Check if Slack plugin is installed
      stat:
        path: "{{ splunk_home }}/etc/apps/slack_alerts"
      register: slack_plugin

    - name: Install Slack Notification Alert plugin
      command: >
        {{ splunk_home }}/bin/splunk install app
        /tmp/slack-notification-alert_{{ slack_plugin_version }}.tgz
        -auth admin:{{ splunk_password }}
      when: not slack_plugin.stat.exists
      notify: restart splunk

    - name: Check if FortiGate TA is installed
      stat:
        path: "{{ splunk_home }}/etc/apps/TA-fortinet-fortigate"
      register: fortigate_ta

    - name: Install FortiGate Technology Add-on
      command: >
        {{ splunk_home }}/bin/splunk install app
        /tmp/fortinet-fortigate-add-on-for-splunk_{{ fortigate_ta_version }}.tgz
        -auth admin:{{ splunk_password }}
      when: not fortigate_ta.stat.exists
      notify: restart splunk

    - name: Check if Splunk CIM is installed
      stat:
        path: "{{ splunk_home }}/etc/apps/Splunk_SA_CIM"
      register: cim_app

    - name: Install Splunk Common Information Model
      command: >
        {{ splunk_home }}/bin/splunk install app
        /tmp/splunk-common-information-model-cim_{{ cim_version }}.tgz
        -auth admin:{{ splunk_password }}
      when: not cim_app.stat.exists
      notify: restart splunk

    # =========================================================================
    # Phase 3: HEC Configuration
    # =========================================================================
    - name: Enable HEC globally
      uri:
        url: "{{ splunk_url }}/servicesNS/nobody/splunk_httpinput/data/inputs/http/http"
        method: POST
        user: admin
        password: "{{ splunk_password }}"
        body_format: form-urlencoded
        body:
          disabled: "0"
          enableSSL: "1"
          port: "{{ hec_port }}"
        validate_certs: no
        status_code: [200, 201, 409]

    - name: Create HEC token for FortiGate
      uri:
        url: "{{ splunk_url }}/servicesNS/nobody/splunk_httpinput/data/inputs/http"
        method: POST
        user: admin
        password: "{{ splunk_password }}"
        body_format: form-urlencoded
        body:
          name: "fortigate-local-test"
          index: "{{ fortigate_index }}"
          source: "fortigate:hec"
          sourcetype: "fortigate:event"
          disabled: "0"
        validate_certs: no
        status_code: [200, 201, 409]
      register: hec_token_creation

    - name: Get HEC token value
      uri:
        url: "{{ splunk_url }}/servicesNS/nobody/splunk_httpinput/data/inputs/http/fortigate-local-test"
        method: GET
        user: admin
        password: "{{ splunk_password }}"
        validate_certs: no
        return_content: yes
      register: hec_token_info

    - name: Display HEC token (masked)
      debug:
        msg: "HEC token created (first 8 chars): {{ hec_token_info.content | regex_search('<s:key name=\"token\">([^<]+)</s:key>', '\\1') | first | default('N/A') | truncate(8) }}..."

    # =========================================================================
    # Phase 4: Index Creation
    # =========================================================================
    - name: Create fortianalyzer index
      uri:
        url: "{{ splunk_url }}/servicesNS/nobody/system/data/indexes"
        method: POST
        user: admin
        password: "{{ splunk_password }}"
        body_format: form-urlencoded
        body:
          name: "{{ fortigate_index }}"
          datatype: "event"
          maxTotalDataSizeMB: "500000"
          frozenTimePeriodInSecs: "188697600"  # 6 years
        validate_certs: no
        status_code: [200, 201, 409]

    # =========================================================================
    # Phase 5: Alert Deployment
    # =========================================================================
    - name: Deploy Config Change Alert
      uri:
        url: "{{ splunk_url }}/servicesNS/nobody/search/saved/searches"
        method: POST
        user: admin
        password: "{{ splunk_password }}"
        body_format: form-urlencoded
        body:
          name: "FortiGate_Config_Change_Alert"
          search: |
            index={{ fortigate_index }} earliest=rt-30s latest=rt type=event subtype=system
              (logid=0100044546 OR logid=0100044547)
              (cfgpath="firewall.policy*" OR cfgpath="firewall.address*" OR
               cfgpath="firewall.service*" OR cfgpath="system.interface*" OR
               cfgpath="router.static*" OR cfgpath="vpn.ipsec*")
            | dedup devname, user, cfgpath
            | eval details = case(isnull(cfgattr), "No details available", 1=1, substr(cfgattr, 1, 100))
            | eval alert_message = "ðŸ”¥ FortiGate Config Change - Device: " + devname + " | Admin: " + user + " (" + ui + ") | Path: " + cfgpath + " | Object: " + cfgobj + " | Details: " + details
            | table alert_message
          disabled: "0"
          is_scheduled: "1"
          realtime_schedule: "1"
          cron_schedule: "* * * * *"
          alert_type: "number of events"
          alert_comparator: "greater than"
          alert_threshold: "0"
          alert.suppress: "1"
          alert.suppress.period: "15s"
          alert.suppress.fields: "user,cfgpath"
          action.slack: "1"
          action.slack.param.channel: "{{ slack_channel }}"
          action.slack.param.message: "$result.alert_message$"
        validate_certs: no
        status_code: [200, 201, 409]

    - name: Deploy Critical Event Alert
      uri:
        url: "{{ splunk_url }}/servicesNS/nobody/search/saved/searches"
        method: POST
        user: admin
        password: "{{ splunk_password }}"
        body_format: form-urlencoded
        body:
          name: "FortiGate_Critical_Event_Alert"
          search: |
            index={{ fortigate_index }} earliest=rt-30s latest=rt type=event subtype=system level=critical
              logid!=0100044546 logid!=0100044547
            | search NOT msg="*Update Fail*"
            | dedup devname, logid
            | eval alert_message = "ðŸš¨ FortiGate CRITICAL Event - Device: " + devname + " | LogID: " + logid + " | Severity: " + level + " | Description: " + msg
            | table alert_message
          disabled: "0"
          is_scheduled: "1"
          realtime_schedule: "1"
          cron_schedule: "* * * * *"
          alert_type: "number of events"
          alert_comparator: "greater than"
          alert_threshold: "0"
          alert.suppress: "1"
          alert.suppress.period: "15s"
          alert.suppress.fields: "devname"
          action.slack: "1"
          action.slack.param.channel: "{{ slack_channel }}"
          action.slack.param.message: "$result.alert_message$"
        validate_certs: no
        status_code: [200, 201, 409]

    - name: Deploy HA Event Alert
      uri:
        url: "{{ splunk_url }}/servicesNS/nobody/search/saved/searches"
        method: POST
        user: admin
        password: "{{ splunk_password }}"
        body_format: form-urlencoded
        body:
          name: "FortiGate_HA_Event_Alert"
          search: |
            index={{ fortigate_index }} earliest=rt-30s latest=rt type=event subtype=system logid=0103*
            | dedup devname, logid, level
            | eval icon = case(level="critical", "ðŸ”´", level="error", "ðŸŸ ", level="warning", "ðŸŸ¡", 1=1, "ðŸ”µ")
            | eval alert_message = icon + " FortiGate HA Event - Device: " + devname + " | Severity: " + level + " | LogID: " + logid + " | Description: " + msg
            | table alert_message
          disabled: "0"
          is_scheduled: "1"
          realtime_schedule: "1"
          cron_schedule: "* * * * *"
          alert_type: "number of events"
          alert_comparator: "greater than"
          alert_threshold: "0"
          alert.suppress: "1"
          alert.suppress.period: "15s"
          alert.suppress.fields: "devname"
          action.slack: "1"
          action.slack.param.channel: "{{ slack_channel }}"
          action.slack.param.message: "$result.alert_message$"
        validate_certs: no
        status_code: [200, 201, 409]

    # =========================================================================
    # Phase 6: Verification
    # =========================================================================
    - name: Verify alerts are registered
      uri:
        url: "{{ splunk_url }}/servicesNS/nobody/search/saved/searches"
        method: GET
        user: admin
        password: "{{ splunk_password }}"
        validate_certs: no
        return_content: yes
      register: saved_searches

    - name: Check alert count
      set_fact:
        fortigate_alerts: "{{ saved_searches.content | regex_findall('FortiGate_.*_Alert') | unique }}"

    - name: Display registered alerts
      debug:
        msg: "Registered FortiGate alerts: {{ fortigate_alerts }}"

    - name: Verify alert count
      assert:
        that:
          - fortigate_alerts | length >= 3
        fail_msg: "Expected 3 FortiGate alerts, found {{ fortigate_alerts | length }}"
        success_msg: "âœ… All 3 FortiGate alerts registered successfully"

  handlers:
    - name: restart splunk
      command: "{{ splunk_home }}/bin/splunk restart"
      async: 45
      poll: 0
