# Saved Searches for Fortinet Device Management Dashboard Alerts
# Channel ID: C09DSD6JH2Q

# ==========================================
# Device Events Alert
# ==========================================
[Fortinet_Device_Events_Alert]
search = index=fw devname=* \
| where "$alert_device_events$" != "disabled" \
| stats latest(_time) as last_seen, count as event_count, latest(status) as status by devname, logdesc \
| eval event_time=strftime(last_seen, "%Y-%m-%d %H:%M:%S") \
| eval threshold=$alert_device_events_threshold$ \
| eval mode="$alert_device_events_mode$" \
| where (mode="realtime" AND event_count > 0) OR (mode="threshold" AND event_count > threshold) OR status="Disconnected" \
| eval priority=case(status="Disconnected", "HIGH", event_count > threshold*2, "MEDIUM", 1=1, "LOW") \
| table devname, event_time, status, event_count, logdesc, priority, mode, threshold

dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */15 * * * *
enableSched = 1

alert.track = 1
alert.severity = 3
counttype = number of events
quantity = 0
relation = greater than

action.slack = 1
action.slack.param.channel = C09DSD6JH2Q
action.slack.param.attachment = message
action.slack.param.message = *üñ•Ô∏è Device Event Alert*\n\n*Device:* $result.devname$\n*Time:* $result.event_time$\n*Status:* $result.status$\n*Event Count:* $result.event_count$\n*Priority:* $result.priority$\n\n*Details:*\n```$result.logdesc$```\n\n<https://splunk.yourdomain.com/app/search/fortinet_device_management|View Dashboard>

# ==========================================
# Admin Activity Alert
# ==========================================
[Fortinet_Admin_Activity_Alert]
search = index=fw (logdesc="Admin*" OR user=*) \
| where "$alert_admin_activity$" != "disabled" \
| eval event_time=strftime(_time, "%Y-%m-%d %H:%M:%S") \
| eval admin_user=coalesce(user, adminuser, "Unknown") \
| eval activity_type=case(match(logdesc, "(?i)login"), "Login", match(logdesc, "(?i)logout"), "Logout", match(logdesc, "(?i)config"), "Config", 1=1, "Other") \
| eval source_ip=coalesce(srcip, remip, "N/A") \
| eval priority=case(activity_type="Config" OR match(logdesc, "(?i)fail"), "HIGH", 1=1, "MEDIUM") \
| stats count as activity_count by event_time, admin_user, activity_type, source_ip, logdesc, priority \
| eval threshold=$alert_admin_activity_threshold$ \
| eval mode="$alert_admin_activity_mode$" \
| where (mode="realtime" AND activity_count > 0) OR (mode="threshold" AND activity_count > threshold) \
| table event_time, admin_user, activity_type, source_ip, logdesc, priority, activity_count, mode, threshold

dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */15 * * * *
enableSched = 1

alert.track = 1
alert.severity = 2
counttype = number of events
quantity = 0
relation = greater than

action.slack = 1
action.slack.param.channel = C09DSD6JH2Q
action.slack.param.attachment = message
action.slack.param.message = *üë§ Admin Activity Alert*\n\n*Admin User:* $result.admin_user$\n*Activity:* $result.activity_type$\n*Source IP:* $result.source_ip$\n*Time:* $result.event_time$\n*Priority:* $result.priority$\n\n*Action Details:*\n```$result.logdesc$```\n\n<https://splunk.yourdomain.com/app/search/fortinet_device_management|View Dashboard>

# ==========================================
# Configuration Changes Alert
# ==========================================
[Fortinet_Config_Changes_Alert]
search = index=fw (logdesc="*Configuration*" OR action="config-change") \
| where "$alert_config_changes$" != "disabled" \
| eval event_time=strftime(_time, "%Y-%m-%d %H:%M:%S") \
| eval admin_user=coalesce(user, adminuser, "Unknown") \
| eval change_category=case(match(msg, "(?i)policy"), "Policy", match(msg, "(?i)address"), "Address", match(msg, "(?i)service"), "Service", match(msg, "(?i)interface"), "Interface", match(msg, "(?i)route"), "Route", 1=1, "Other") \
| eval device=coalesce(devname, "Global") \
| eval priority=case(change_category IN ("Policy", "Route"), "HIGH", 1=1, "MEDIUM") \
| stats count as change_count by event_time, admin_user, device, change_category, msg, priority \
| eval threshold=$alert_config_changes_threshold$ \
| eval mode="$alert_config_changes_mode$" \
| where (mode="realtime" AND change_count > 0) OR (mode="threshold" AND change_count > threshold) \
| table event_time, admin_user, device, change_category, msg, priority, change_count, mode, threshold

dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */15 * * * *
enableSched = 1

alert.track = 1
alert.severity = 2
counttype = number of events
quantity = 0
relation = greater than

action.slack = 1
action.slack.param.channel = C09DSD6JH2Q
action.slack.param.attachment = message
action.slack.param.message = *üîß Configuration Change Alert*\n\n*Admin User:* $result.admin_user$\n*Device:* $result.device$\n*Category:* $result.change_category$\n*Time:* $result.event_time$\n*Priority:* $result.priority$\n\n*Change Details:*\n```$result.msg$```\n\n<https://splunk.yourdomain.com/app/search/fortinet_device_management|View Dashboard> ‚Ä¢ <https://splunk.yourdomain.com/app/search/config_history|Config History>

# ==========================================
# Install/Update Alert
# ==========================================
[Fortinet_Install_Update_Alert]
search = index=fw (logdesc="*install*" OR logdesc="*upgrade*" OR logdesc="*update*" OR msg="*firmware*" OR msg="*package*install*") \
| where "$alert_install_updates$" != "disabled" \
| eval install_time=strftime(_time, "%Y-%m-%d %H:%M:%S") \
| eval install_type=case(match(logdesc, "(?i)firmware"), "Firmware", match(logdesc, "(?i)upgrade"), "Upgrade", match(logdesc, "(?i)package"), "Package", 1=1, "Update") \
| eval device=coalesce(devname, "FMG") \
| eval admin_user=coalesce(user, adminuser, "System") \
| eval status=case(match(msg, "(?i)success"), "Success", match(msg, "(?i)fail"), "Failed", match(msg, "(?i)complete"), "Completed", 1=1, "In Progress") \
| eval priority=case(status="Failed", "HIGH", install_type="Firmware", "HIGH", 1=1, "MEDIUM") \
| stats count as install_count by install_time, device, install_type, admin_user, status, msg, priority \
| eval threshold=$alert_install_updates_threshold$ \
| eval mode="$alert_install_updates_mode$" \
| where (mode="realtime" AND install_count > 0) OR (mode="threshold" AND install_count > threshold) \
| table install_time, device, install_type, admin_user, status, msg, priority, install_count, mode, threshold

dispatch.earliest_time = -1h
dispatch.latest_time = now
cron_schedule = 0 * * * *
enableSched = 1

alert.track = 1
alert.severity = 3
counttype = number of events
quantity = 0
relation = greater than

action.slack = 1
action.slack.param.channel = C09DSD6JH2Q
action.slack.param.attachment = message
action.slack.param.message = *üì¶ Install/Update Alert*\n\n*Device:* $result.device$\n*Type:* $result.install_type$\n*Status:* $result.status$\n*Admin:* $result.admin_user$\n*Priority:* $result.priority$\n\n*Installation Details:*\n```$result.msg$```\n\n*Time:* $result.install_time$\n\n<https://splunk.yourdomain.com/app/search/fortinet_device_management|View Dashboard> ‚Ä¢ <https://splunk.yourdomain.com/app/search/install_history|Install History>

# ==========================================
# Alert Schedule Summary
# ==========================================
# Device Events Alert: Every 15 minutes
# Admin Activity Alert: Every 15 minutes
# Config Changes Alert: Every 15 minutes
# Install/Update Alert: Every hour (at :00)

# ==========================================
# Priority Levels
# ==========================================
# HIGH: Critical events requiring immediate attention
# MEDIUM: Important events for monitoring
# LOW: Normal operational events

# ==========================================
# Slack Channel Configuration
# ==========================================
# All alerts sent to: C09DSD6JH2Q (#splunk-alerts)
# Message format: Markdown with code blocks
# Links: Dashboard + specific views

# ==========================================
# Deployment Instructions
# ==========================================
# 1. Copy this file to: $SPLUNK_HOME/etc/apps/fortigate/local/savedsearches.conf
# 2. Restart Splunk or reload searches: splunk reload search
# 3. Verify alerts: Settings > Searches, reports, and alerts
# 4. Test alerts manually: Click "Run" on each saved search
# 5. Check Slack channel for test messages

# ==========================================
# Dashboard Token Integration
# ==========================================
# To enable/disable alerts from dashboard:
# 1. Add condition to search: | where "$alert_device_events$" != "disabled"
# 2. Token values: "C09DSD6JH2Q" (enabled) or "disabled" (off)
# 3. Example:
#    index=fw devname=*
#    | where "$alert_device_events$" != "disabled"
#    | ... (rest of search)
