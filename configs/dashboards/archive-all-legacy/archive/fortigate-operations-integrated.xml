<form version="1.1" theme="dark">
  <label>ğŸ›¡ï¸ FortiGate Operations + Slack Control</label>
  <description>Production firewall operations with integrated Slack alert control</description>

  <!-- Global Time Picker -->
  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="time_picker">
      <label>Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>

  <!-- Row 0: Slack Alert Control -->
  <row>
    <panel>
      <html>
        <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h2 style="color: white; margin: 0 0 5px 0;">ğŸ”” Slack ì•Œë¦¼ ì œì–´</h2>
              <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 13px;">Correlation Rule ì•Œë¦¼ ì¼œê¸°/ë„ê¸°</p>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
              <button id="enable-btn" onclick="toggleSlackAlerts('enable')"
                      style="padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                âœ… ì¼œê¸°
              </button>
              <button id="disable-btn" onclick="toggleSlackAlerts('disable')"
                      style="padding: 12px 30px; background: #dc3545; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                â›” ë„ê¸°
              </button>
              <button id="test-btn" onclick="sendTestMessage()"
                      style="padding: 12px 25px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 15px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                ğŸ“¤ í…ŒìŠ¤íŠ¸
              </button>
            </div>
          </div>
          <div id="status-message" style="text-align: center; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; margin-top: 15px; color: white; min-height: 35px;">
            í´ë¦­í•˜ì—¬ Slack ì•Œë¦¼ì„ ì œì–´í•˜ì„¸ìš”
          </div>
        </div>

        <script type="text/javascript">
          require([
              'jquery',
              'splunkjs/ready!',
              'splunkjs/mvc/simplexml/ready!'
          ], function($, mvc) {

              // Slack ì•Œë¦¼ í† ê¸€ í•¨ìˆ˜
              window.toggleSlackAlerts = function(action) {
                  const statusDiv = $('#status-message');
                  const enableBtn = $('#enable-btn');
                  const disableBtn = $('#disable-btn');

                  enableBtn.prop('disabled', true);
                  disableBtn.prop('disabled', true);

                  const actionText = action === 'enable' ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”';
                  statusDiv.html('&lt;span style="color: #ffc107;"&gt;â³ Slack ì•Œë¦¼ì„ ' + actionText + ' ì¤‘...&lt;/span&gt;');

                  const correlationRules = [
                      'Correlation_Multi_Factor_Threat',
                      'Correlation_Repeated_High_Risk',
                      'Correlation_Weak_Signal_Combo',
                      'Correlation_Geo_Attack_Pattern',
                      'Correlation_Time_Anomaly',
                      'Correlation_Sophisticated_Threat_APT'
                  ];

                  const slackValue = action === 'enable' ? '1' : '0';
                  let successCount = 0;
                  let errorCount = 0;

                  correlationRules.forEach(function(ruleName, index) {
                      setTimeout(function() {
                          $.ajax({
                              url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ruleName,
                              type: 'POST',
                              data: {
                                  'action.slack': slackValue
                              },
                              success: function() {
                                  successCount++;
                                  if (successCount + errorCount === correlationRules.length) {
                                      finishToggle(action, successCount, errorCount);
                                  }
                              },
                              error: function() {
                                  errorCount++;
                                  if (successCount + errorCount === correlationRules.length) {
                                      finishToggle(action, successCount, errorCount);
                                  }
                              }
                          });
                      }, index * 200);
                  });
              };

              function finishToggle(action, successCount, errorCount) {
                  const statusDiv = $('#status-message');
                  const enableBtn = $('#enable-btn');
                  const disableBtn = $('#disable-btn');

                  enableBtn.prop('disabled', false);
                  disableBtn.prop('disabled', false);

                  if (errorCount === 0) {
                      const icon = action === 'enable' ? 'âœ…' : 'â›”';
                      const actionText = action === 'enable' ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”';
                      statusDiv.html(
                          '&lt;span style="color: #28a745; font-size: 16px;"&gt;' +
                          icon + ' Slack ì•Œë¦¼ ' + actionText + ' ì™„ë£Œ!&lt;/span&gt;&lt;br/&gt;' +
                          '&lt;span style="font-size: 13px;"&gt;ì´ ' + successCount + 'ê°œ ê·œì¹™ ì—…ë°ì´íŠ¸ë¨&lt;/span&gt;'
                      );

                      sendSlackNotification(action);

                      setTimeout(function() {
                          location.reload();
                      }, 2000);
                  } else {
                      statusDiv.html(
                          '&lt;span style="color: #dc3545; font-size: 16px;"&gt;âŒ ì˜¤ë¥˜ ë°œìƒ&lt;/span&gt;&lt;br/&gt;' +
                          '&lt;span style="font-size: 13px;"&gt;ì„±ê³µ: ' + successCount + ' / ì‹¤íŒ¨: ' + errorCount + '&lt;/span&gt;'
                      );
                  }
              }

              function sendSlackNotification(action) {
                  const icon = action === 'enable' ? 'âœ…' : 'â›”';
                  const actionText = action === 'enable' ? 'ENABLED' : 'DISABLED';
                  const timestamp = new Date().toISOString().replace('T', ' ').substr(0, 19);

                  const message = icon + ' *Slack Alert Status Changed*\\n\\n' +
                                'Status: ' + actionText + '\\n' +
                                'Changed By: FortiGate Dashboard\\n' +
                                'Timestamp: ' + timestamp + '\\n' +
                                'Total Rules Updated: 6';

                  const spl = '| makeresults | eval message="' + message + '" | sendalert slack param.message=message';

                  $.ajax({
                      url: '/en-US/splunkd/__raw/services/search/jobs',
                      type: 'POST',
                      data: {
                          search: spl,
                          exec_mode: 'oneshot',
                          output_mode: 'json'
                      }
                  });
              }

              // í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
              window.sendTestMessage = function() {
                  const statusDiv = $('#status-message');
                  statusDiv.html('&lt;span style="color: #ffc107;"&gt;â³ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ ì¤‘...&lt;/span&gt;');

                  const spl = '| makeresults | eval message="ğŸ§ª Slack ì—°ê²° í…ŒìŠ¤íŠ¸ - ' + new Date().toLocaleString() + '" | sendalert slack param.message=message';

                  $.ajax({
                      url: '/en-US/splunkd/__raw/services/search/jobs',
                      type: 'POST',
                      data: {
                          search: spl,
                          exec_mode: 'oneshot',
                          output_mode: 'json'
                      },
                      success: function() {
                          statusDiv.html('&lt;span style="color: #28a745;"&gt;âœ… í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ!&lt;/span&gt;');
                      },
                      error: function() {
                          statusDiv.html('&lt;span style="color: #dc3545;"&gt;âŒ ì „ì†¡ ì‹¤íŒ¨&lt;/span&gt;');
                      }
                  });
              };
          });
        </script>
      </html>
    </panel>
  </row>

  <!-- Row 1: Slack Status + KPI Metrics -->
  <row>
    <panel>
      <title>ğŸ”” Slack ì•Œë¦¼ ìƒíƒœ</title>
      <table>
        <search>
          <query>| rest /services/saved/searches splunk_server=local
| search title="Correlation_*"
| eval slack_status = if(match('action.slack', "1"), "âœ…", "â›”")
| stats count(eval(match('action.slack', "1"))) as enabled, count as total
| eval display = enabled + " / " + total
| eval status_text = case(enabled==total, "ì „ì²´ í™œì„±í™”", enabled==0, "ì „ì²´ ë¹„í™œì„±í™”", 1=1, "ë¶€ë¶„ í™œì„±í™”")
| table display, status_text
| rename display as "í™œì„±í™” ê·œì¹™", status_text as "ìƒíƒœ"</query>
          <refresh>30s</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="count">5</option>
      </table>
    </panel>

    <panel>
      <title>âœ… Total Events</title>
      <single>
        <search>
          <query>
index=fw earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count
          </query>
        </search>
        <option name="drilldown">none</option>
        <option name="underLabel">Total Traffic Events</option>
        <option name="numberPrecision">0</option>
      </single>
    </panel>

    <panel>
      <title>ğŸš« Blocked Events</title>
      <single>
        <search>
          <query>
index=fw action=deny earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count
          </query>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[100,500,1000]</option>
        <option name="underLabel">Denied Traffic</option>
        <option name="useColors">1</option>
      </single>
    </panel>

    <panel>
      <title>âœ… Allowed Events</title>
      <single>
        <search>
          <query>
index=fw action=accept earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count
          </query>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0xD93F3C","0xF58F39","0xF7BC38","0x65A637"]</option>
        <option name="rangeValues">[1000,5000,10000]</option>
        <option name="underLabel">Allowed Traffic</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>

  <!-- Row 2: Traffic Timeline -->
  <row>
    <panel>
      <title>ğŸ“Š Traffic Over Time (Allowed vs Blocked)</title>
      <chart>
        <search>
          <query>
index=fw earliest=$time_picker.earliest$ latest=$time_picker.latest$
| timechart span=1h count by action
          </query>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Event Count</option>
        <option name="charting.fieldColors">{"accept":"0x65A637","deny":"0xD93F3C"}</option>
      </chart>
    </panel>
  </row>

  <!-- Row 3: Top Sources and Destinations -->
  <row>
    <panel>
      <title>ğŸ¯ Top 10 Source IPs (Most Active)</title>
      <table>
        <search>
          <query>
index=fw earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as total_events,
        sum(eval(if(action="deny",1,0))) as blocked,
        sum(eval(if(action="accept",1,0))) as allowed
  by src_ip
| eval block_rate = round(blocked/total_events*100, 2)
| sort -total_events
| head 10
| rename src_ip as "Source IP", total_events as "Total Events", blocked as "Blocked", allowed as "Allowed", block_rate as "Block Rate (%)"
          </query>
        </search>
        <option name="drilldown">cell</option>
        <option name="count">10</option>
        <format type="color" field="Block Rate (%)">
          <colorPalette type="minMidMax" maxColor="#D93F3C" midColor="#F7BC38" minColor="#65A637"></colorPalette>
          <scale type="minMidMax" minValue="0" midValue="50" maxValue="100"></scale>
        </format>
      </table>
    </panel>

    <panel>
      <title>ğŸ¯ Top 10 Destination IPs</title>
      <table>
        <search>
          <query>
index=fw earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as total_events,
        sum(eval(if(action="deny",1,0))) as blocked,
        sum(eval(if(action="accept",1,0))) as allowed
  by dst_ip
| eval block_rate = round(blocked/total_events*100, 2)
| sort -total_events
| head 10
| rename dst_ip as "Destination IP", total_events as "Total Events", blocked as "Blocked", allowed as "Allowed", block_rate as "Block Rate (%)"
          </query>
        </search>
        <option name="drilldown">cell</option>
        <option name="count">10</option>
        <format type="color" field="Block Rate (%)">
          <colorPalette type="minMidMax" maxColor="#D93F3C" midColor="#F7BC38" minColor="#65A637"></colorPalette>
          <scale type="minMidMax" minValue="0" midValue="50" maxValue="100"></scale>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 4: Protocol and Port Statistics -->
  <row>
    <panel>
      <title>ğŸ”Œ Top Protocols</title>
      <chart>
        <search>
          <query>
index=fw earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count by proto
| sort -count
| head 10
          </query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>

    <panel>
      <title>ğŸ”¢ Top Destination Ports</title>
      <chart>
        <search>
          <query>
index=fw earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count by dst_port
| sort -count
| head 10
          </query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisTitleX.text">Event Count</option>
        <option name="charting.axisTitleY.text">Port</option>
      </chart>
    </panel>
  </row>

  <!-- Row 5: Policy Hits -->
  <row>
    <panel>
      <title>ğŸ“œ Top 10 Firewall Policies (Most Hit)</title>
      <table>
        <search>
          <query>
index=fw earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as hits by policyid, policyname, action
| sort -hits
| head 10
| rename policyid as "Policy ID", policyname as "Policy Name", action as "Action", hits as "Hit Count"
          </query>
        </search>
        <option name="drilldown">cell</option>
        <option name="count">10</option>
        <format type="color" field="Action">
          <colorPalette type="map">{"accept":"#65A637","deny":"#D93F3C"}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 6: Blocked Traffic Details -->
  <row>
    <panel>
      <title>ğŸš« Recently Blocked Traffic (Last 100)</title>
      <table>
        <search>
          <query>
index=fw action=deny earliest=$time_picker.earliest$ latest=$time_picker.latest$
| table _time, src_ip, dst_ip, dst_port, proto, policyname, msg
| sort -_time
| head 100
| rename _time as "Time", src_ip as "Source IP", dst_ip as "Dest IP", dst_port as "Dest Port", proto as "Protocol", policyname as "Policy", msg as "Message"
          </query>
        </search>
        <option name="drilldown">cell</option>
        <option name="count">20</option>
        <option name="wrap">true</option>
        <format type="color" field="Protocol">
          <colorPalette type="sharedList"></colorPalette>
          <scale type="sharedCategory"></scale>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 7: Top Blocked IPs (Potential Threats) -->
  <row>
    <panel>
      <title>âš ï¸ Top 20 Most Blocked Source IPs (Potential Attackers)</title>
      <table>
        <search>
          <query>
index=fw action=deny earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as block_count,
        dc(dst_ip) as unique_targets,
        dc(dst_port) as unique_ports,
        values(proto) as protocols
  by src_ip
| sort -block_count
| head 20
| rename src_ip as "Source IP", block_count as "Block Count", unique_targets as "Unique Targets", unique_ports as "Unique Ports", protocols as "Protocols"
          </query>
        </search>
        <option name="drilldown">cell</option>
        <option name="count">20</option>
        <format type="color" field="Block Count">
          <colorPalette type="minMidMax" maxColor="#D93F3C" midColor="#F7BC38" minColor="#F58F39"></colorPalette>
          <scale type="minMidMax" minValue="0" midValue="50" maxValue="100"></scale>
        </format>
      </table>
    </panel>
  </row>

</form>
