<form version="1.1" theme="dark">
  <label>ğŸ”” Slack Alert Control Panel</label>
  <description>Slack ì•Œë¦¼ ON/OFF ì œì–´ ë° í˜„í™© ëª¨ë‹ˆí„°ë§</description>

  <!-- Row 1: Control Buttons -->
  <row>
    <panel>
      <title>âš¡ Slack ì•Œë¦¼ ì œì–´</title>
      <html>
        <div style="padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
          <h2 style="margin-top: 0; font-size: 28px; text-align: center;">ğŸ”” Slack ì•Œë¦¼ ì»¨íŠ¸ë¡¤</h2>

          <div style="display: flex; justify-content: center; gap: 30px; margin: 30px 0;">
            <!-- Enable Button -->
            <a href="/app/search/search?q=| makeresults | eval action=%22enable%22, script_path=%22/home/jclee/app/splunk/scripts/toggle-slack-alerts.sh%22, command=%22on%22 | map search=%22%7C sendalert script param.script_path=$script_path$ param.command=$command$%22 | collect index=slack_toggle_log"
               target="_blank"
               style="display: inline-block; padding: 20px 40px; background: #28a745; color: white; text-decoration: none; border-radius: 8px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: transform 0.2s;">
              âœ… ì•Œë¦¼ ì¼œê¸° (ON)
            </a>

            <!-- Disable Button -->
            <a href="/app/search/search?q=| makeresults | eval action=%22disable%22, script_path=%22/home/jclee/app/splunk/scripts/toggle-slack-alerts.sh%22, command=%22off%22 | map search=%22%7C sendalert script param.script_path=$script_path$ param.command=$command$%22 | collect index=slack_toggle_log"
               target="_blank"
               style="display: inline-block; padding: 20px 40px; background: #dc3545; color: white; text-decoration: none; border-radius: 8px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: transform 0.2s;">
              â›” ì•Œë¦¼ ë„ê¸° (OFF)
            </a>
          </div>

          <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px; margin-top: 20px;">
            <h3 style="margin-top: 0; font-size: 18px;">ğŸ“ ì‚¬ìš© ì•ˆë‚´</h3>
            <ul style="font-size: 14px; line-height: 1.8; margin: 10px 0;">
              <li><strong>âœ… ì•Œë¦¼ ì¼œê¸°</strong>: ëª¨ë“  Correlation Ruleì˜ Slack ì•Œë¦¼ í™œì„±í™”</li>
              <li><strong>â›” ì•Œë¦¼ ë„ê¸°</strong>: ëª¨ë“  Correlation Ruleì˜ Slack ì•Œë¦¼ ë¹„í™œì„±í™”</li>
              <li><strong>ğŸ”” ìƒíƒœ ë³€ê²½ ì•Œë¦¼</strong>: ì¼œê³ /ëŒ ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ Slack ë©”ì‹œì§€ ì „ì†¡</li>
              <li><strong>ğŸ“Š ë³€ê²½ ì´ë ¥</strong>: ì•„ë˜ íŒ¨ë„ì—ì„œ ëª¨ë“  í† ê¸€ ì´ë ¥ í™•ì¸ ê°€ëŠ¥</li>
            </ul>
          </div>

          <div style="background: rgba(255,193,7,0.2); border-left: 4px solid #ffc107; padding: 15px; border-radius: 4px; margin-top: 20px;">
            <strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong>
            <ul style="font-size: 13px; margin: 10px 0 0 15px;">
              <li>ë²„íŠ¼ í´ë¦­ ì‹œ ì¦‰ì‹œ ì ìš©ë©ë‹ˆë‹¤ (Splunk ì¬ì‹œì‘ ë¶ˆí•„ìš”)</li>
              <li>ëª¨ë“  í† ê¸€ ì´ë²¤íŠ¸ëŠ” <code>index=slack_toggle_log</code>ì— ì €ì¥ë©ë‹ˆë‹¤</li>
              <li><code>SLACK_WEBHOOK_URL</code> í™˜ê²½ë³€ìˆ˜ ì„¤ì • í•„ìš” (ìƒíƒœ ì•Œë¦¼ìš©)</li>
            </ul>
          </div>
        </div>
      </html>
    </panel>
  </row>

  <!-- Row 2: Current Status -->
  <row>
    <panel>
      <title>ğŸ“Š í˜„ì¬ Slack ì•Œë¦¼ ìƒíƒœ</title>
      <table>
        <search>
          <query>| makeresults
| eval rules = "Correlation_Multi_Factor_Threat,Correlation_Repeated_High_Risk,Correlation_Weak_Signal_Combo,Correlation_Geo_Attack_Pattern,Correlation_Time_Anomaly,Correlation_Sophisticated_Threat_APT"
| makemv delim="," rules
| mvexpand rules
| eval slack_enabled = case(
    rules == "Correlation_Weak_Signal_Combo", "âœ… Enabled",
    rules == "Correlation_Sophisticated_Threat_APT", "âœ… Enabled",
    1=1, "â›” Disabled"
)
| eval description = case(
    rules == "Correlation_Multi_Factor_Threat", "Multi-Factor Threat Score (75+)",
    rules == "Correlation_Repeated_High_Risk", "Repeated High-Risk Events (80+)",
    rules == "Correlation_Weak_Signal_Combo", "Weak Signal Combination (80+)",
    rules == "Correlation_Geo_Attack_Pattern", "Geo + Attack Pattern (85+)",
    rules == "Correlation_Time_Anomaly", "Time-Based Anomaly (85+)",
    rules == "Correlation_Sophisticated_Threat_APT", "Cross-Event Type / APT (90+)",
    1=1, "Unknown"
)
| table rules, description, slack_enabled
| rename rules as "Correlation Rule", description as "Description", slack_enabled as "Slack Alert Status"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="count">10</option>
        <option name="rowNumbers">false</option>
        <format type="color" field="Slack Alert Status">
          <colorPalette type="map">{"âœ… Enabled":"#28a745","â›” Disabled":"#dc3545"}</colorPalette>
        </format>
      </table>
    </panel>

    <panel>
      <title>ğŸ”¢ í†µê³„ ìš”ì•½</title>
      <single>
        <search>
          <query>| makeresults
| eval enabled = 2, total = 6
| eval status = enabled + " / " + total + " rules"
| fields status</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0xdc3545","0xffc107","0x28a745"]</option>
        <option name="rangeValues">[2,4]</option>
        <option name="underLabel">Currently Enabled</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>

  <!-- Row 3: Toggle History -->
  <row>
    <panel>
      <title>ğŸ“œ Slack ì•Œë¦¼ í† ê¸€ ì´ë ¥ (ìµœê·¼ 24ì‹œê°„)</title>
      <table>
        <search>
          <query>index=slack_toggle_log earliest=-24h
| eval toggle_time = strftime(_time, "%Y-%m-%d %H:%M:%S"),
       status = case(
           action == "enable", "âœ… Enabled",
           action == "disable", "â›” Disabled",
           1=1, "Unknown"
       )
| table toggle_time, action, status, host, user
| sort -_time
| head 50
| rename toggle_time as "Time", action as "Action", status as "Status", host as "Host", user as "User"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="count">20</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="Status">
          <colorPalette type="map">{"âœ… Enabled":"#28a745","â›” Disabled":"#dc3545"}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 4: Slack Notification Test -->
  <row>
    <panel>
      <title>ğŸ§ª Slack ì—°ê²° í…ŒìŠ¤íŠ¸</title>
      <html>
        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6;">
          <h3 style="margin-top: 0; color: #333;">Slack Webhook ì—°ê²° í™•ì¸</h3>
          <p style="color: #666; font-size: 14px; line-height: 1.6;">
            ì•„ë˜ ëª…ë ¹ì–´ë¡œ Slack ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”:
          </p>
          <pre style="background: #272822; color: #f8f8f2; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 13px;">
# 1. í™˜ê²½ë³€ìˆ˜ ì„¤ì • (í•œ ë²ˆë§Œ)
export SLACK_WEBHOOK_URL="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"

# 2. í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
curl -X POST "$SLACK_WEBHOOK_URL" \
  -H 'Content-Type: application/json' \
  -d '{"text":"ğŸ§ª Slack ì—°ê²° í…ŒìŠ¤íŠ¸ - ì •ìƒ ì‘ë™!"}'

# 3. ìŠ¤í¬ë¦½íŠ¸ ì§ì ‘ ì‹¤í–‰
/home/jclee/app/splunk/scripts/toggle-slack-alerts.sh status  # í˜„ì¬ ìƒíƒœ í™•ì¸
/home/jclee/app/splunk/scripts/toggle-slack-alerts.sh on      # ì•Œë¦¼ ì¼œê¸°
/home/jclee/app/splunk/scripts/toggle-slack-alerts.sh off     # ì•Œë¦¼ ë„ê¸°
          </pre>

          <div style="background: #d1ecf1; border-left: 4px solid #0c5460; padding: 15px; border-radius: 4px; margin-top: 20px;">
            <strong style="color: #0c5460;">ğŸ’¡ Tip:</strong>
            <p style="color: #0c5460; font-size: 13px; margin: 5px 0 0 0;">
              <code>.env</code> íŒŒì¼ì— <code>SLACK_WEBHOOK_URL</code>ì„ ì €ì¥í•˜ë©´ ë§¤ë²ˆ export í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
            </p>
          </div>
        </div>
      </html>
    </panel>
  </row>

  <!-- Row 5: Recent Slack Alert Activity -->
  <row>
    <panel>
      <title>ğŸ“¬ ìµœê·¼ Slack ì•Œë¦¼ ì „ì†¡ ì´ë ¥ (24ì‹œê°„)</title>
      <table>
        <search>
          <query>index=_internal source=*scheduler.log action=alert_fired alert_actions=*slack* earliest=-24h
| eval alert_time = strftime(_time, "%Y-%m-%d %H:%M:%S")
| stats count as alert_count,
        latest(alert_time) as last_sent
  by savedsearch_name
| sort -alert_count
| rename savedsearch_name as "Alert Name", alert_count as "Count", last_sent as "Last Sent"</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="count">10</option>
        <option name="rowNumbers">false</option>
        <format type="number" field="Count">
          <option name="precision">0</option>
        </format>
      </table>
    </panel>

    <panel>
      <title>âœ… Slack ì•Œë¦¼ ì„±ê³µë¥ </title>
      <single>
        <search>
          <query>index=_internal source=*alert_actions* "slack" earliest=-24h
| stats count as total,
        sum(eval(if(match(_raw, "(?i)success|sent"), 1, 0))) as successful
| eval success_rate = round((successful / total) * 100, 1)
| eval display = success_rate + "%"
| fields display</query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0xdc3545","0xffc107","0x28a745"]</option>
        <option name="rangeValues">[50,90]</option>
        <option name="underLabel">Last 24 Hours</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>
</form>
