<?xml version="1.0" encoding="UTF-8"?>
<form version="1.1" theme="dark">
  <label>ğŸ›ï¸ Slack Alert Manager - ON/OFF Control</label>
  <description>All Slack alerts in one place - View status and toggle ON/OFF</description>

  <row>
    <panel>
      <title>Slack Alert Control Center</title>
      <html>
        <div id="slack-manager-panel">
          <div style="margin: 20px 0; padding: 20px; background: #f5f5f5; border-radius: 8px;">
            <h3 style="margin-top: 0;">ğŸ“Š Registered Slack Alerts</h3>
            <div id="status-container" style="margin: 15px 0;">Loading alerts...</div>

            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
              <button onclick="enableAllAlerts()" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">âœ… Enable All</button>
              <button onclick="disableAllAlerts()" style="padding: 12px 24px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">ğŸ”´ Disable All</button>
              <button onclick="refreshAlerts()" style="padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">ğŸ”„ Refresh</button>
            </div>

            <div id="alerts-list" style="margin-top: 25px;">
              <!-- Alert cards will be injected here -->
            </div>

            <div id="result-message" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
          </div>
        </div>

        <script><![CDATA[
require(['jquery', 'splunkjs/ready!'], function($, mvc) {
    let allAlerts = [];

    function showMessage(message, type) {
        const resultDiv = $('#result-message');
        const bgColor = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1';
        const textColor = type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460';

        resultDiv.css({
            'background': bgColor,
            'color': textColor,
            'border': '1px solid ' + textColor,
            'padding': '12px',
            'border-radius': '4px'
        }).text(message).show();

        setTimeout(() => resultDiv.fadeOut(), 5000);
    }

    function refreshAlerts() {
        $('#status-container').html('<div style="color: #007bff; font-size: 16px;">ğŸ”„ Loading alerts...</div>');
        $('#alerts-list').html('');
        allAlerts = [];

        // Get all saved searches with Slack action
        $.ajax({
            url: '/en-US/splunkd/__raw/servicesNS/-/-/saved/searches?count=-1&output_mode=json',
            type: 'GET',
            success: function(response) {
                const searches = JSON.parse(response);

                if (searches.entry) {
                    searches.entry.forEach(function(search) {
                        const content = search.content;

                        // Only show alerts with Slack action
                        if (content['action.slack'] === '1' || content['actions'] && content['actions'].includes('slack')) {
                            allAlerts.push({
                                name: search.name,
                                title: search.title || search.name,
                                enabled: content['action.slack'] === '1',
                                disabled: content['disabled'] === '1',
                                schedule: content['cron_schedule'] || 'Not scheduled',
                                channel: content['action.slack.param.channel'] || 'Default',
                                owner: search.author || 'nobody',
                                app: content['eai:acl'] ? content['eai:acl'].app : 'search'
                            });
                        }
                    });
                }

                renderAlerts();
            },
            error: function(xhr, status, error) {
                $('#status-container').html('<div style="color: #dc3545;">âŒ Failed to load alerts: ' + error + '</div>');
            }
        });
    }

    function renderAlerts() {
        if (allAlerts.length === 0) {
            $('#status-container').html('<div style="color: #6c757d; font-size: 16px;">ğŸ“­ No Slack alerts found</div>');
            $('#alerts-list').html('<div style="padding: 20px; text-align: center; color: #6c757d;">Create your first alert using the registration script!</div>');
            return;
        }

        const enabledCount = allAlerts.filter(a => a.enabled && !a.disabled).length;
        const totalCount = allAlerts.length;

        let statusHtml = '<div style="font-size: 20px; font-weight: bold; margin-bottom: 10px; color: ';
        statusHtml += enabledCount === totalCount ? '#28a745' : enabledCount === 0 ? '#dc3545' : '#f7bc38';
        statusHtml += ';">';
        statusHtml += enabledCount + ' / ' + totalCount + ' alerts enabled</div>';

        statusHtml += '<div style="font-size: 14px; color: #6c757d;">Last updated: ' + new Date().toLocaleString() + '</div>';
        $('#status-container').html(statusHtml);

        let alertsHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 15px;">';

        allAlerts.forEach(function(alert) {
            const isActive = alert.enabled && !alert.disabled;
            const statusColor = isActive ? '#28a745' : '#dc3545';
            const statusIcon = isActive ? 'âœ…' : 'ğŸ”´';
            const statusText = isActive ? 'ENABLED' : 'DISABLED';

            alertsHtml += '<div style="background: white; border-left: 4px solid ' + statusColor + '; padding: 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            alertsHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
            alertsHtml += '<div style="font-weight: bold; font-size: 16px; color: #333;">' + statusIcon + ' ' + alert.title + '</div>';
            alertsHtml += '<div style="background: ' + statusColor + '; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold;">' + statusText + '</div>';
            alertsHtml += '</div>';

            alertsHtml += '<div style="margin: 8px 0; font-size: 13px; color: #666;">';
            alertsHtml += '<div>ğŸ“… Schedule: <code>' + alert.schedule + '</code></div>';
            alertsHtml += '<div>ğŸ“¢ Channel: <code>' + alert.channel + '</code></div>';
            alertsHtml += '<div>ğŸ‘¤ Owner: <code>' + alert.owner + '</code></div>';
            alertsHtml += '</div>';

            alertsHtml += '<div style="margin-top: 12px; display: flex; gap: 8px;">';

            if (isActive) {
                alertsHtml += '<button onclick="toggleAlert(\'' + alert.name + '\', false)" style="flex: 1; padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">ğŸ”´ Disable</button>';
            } else {
                alertsHtml += '<button onclick="toggleAlert(\'' + alert.name + '\', true)" style="flex: 1; padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">âœ… Enable</button>';
            }

            alertsHtml += '<button onclick="editAlert(\'' + alert.name + '\')" style="flex: 1; padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">âœï¸ Edit</button>';
            alertsHtml += '<button onclick="deleteAlert(\'' + alert.name + '\')" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">ğŸ—‘ï¸</button>';
            alertsHtml += '</div>';

            alertsHtml += '</div>';
        });

        alertsHtml += '</div>';
        $('#alerts-list').html(alertsHtml);
    }

    window.toggleAlert = function(alertName, enable) {
        showMessage('ğŸ”„ Updating ' + alertName + '...', 'info');

        $.ajax({
            url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + encodeURIComponent(alertName),
            type: 'POST',
            data: {
                'action.slack': enable ? '1' : '0',
                'disabled': enable ? '0' : '1'
            },
            success: function() {
                showMessage('âœ… ' + alertName + ' ' + (enable ? 'enabled' : 'disabled') + ' successfully!', 'success');
                setTimeout(refreshAlerts, 500);
            },
            error: function(xhr, status, error) {
                showMessage('âŒ Failed to update alert: ' + error, 'error');
            }
        });
    };

    window.enableAllAlerts = function() {
        if (allAlerts.length === 0) {
            showMessage('âš ï¸ No alerts to enable', 'error');
            return;
        }

        if (!confirm('Enable all ' + allAlerts.length + ' alerts?')) {
            return;
        }

        showMessage('ğŸ”„ Enabling all alerts...', 'info');
        let completed = 0;
        let errors = 0;

        allAlerts.forEach(function(alert, index) {
            setTimeout(function() {
                $.ajax({
                    url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + encodeURIComponent(alert.name),
                    type: 'POST',
                    data: {
                        'action.slack': '1',
                        'disabled': '0'
                    },
                    success: function() {
                        completed++;
                        if (completed + errors === allAlerts.length) {
                            showMessage('âœ… Enabled ' + completed + ' alerts' + (errors > 0 ? ' (' + errors + ' failed)' : ''), 'success');
                            setTimeout(refreshAlerts, 500);
                        }
                    },
                    error: function() {
                        errors++;
                        completed++;
                        if (completed + errors === allAlerts.length) {
                            showMessage('âš ï¸ Enabled ' + (completed - errors) + ' alerts (' + errors + ' failed)', 'error');
                            setTimeout(refreshAlerts, 500);
                        }
                    }
                });
            }, index * 200);
        });
    };

    window.disableAllAlerts = function() {
        if (allAlerts.length === 0) {
            showMessage('âš ï¸ No alerts to disable', 'error');
            return;
        }

        if (!confirm('Disable all ' + allAlerts.length + ' alerts?')) {
            return;
        }

        showMessage('ğŸ”„ Disabling all alerts...', 'info');
        let completed = 0;
        let errors = 0;

        allAlerts.forEach(function(alert, index) {
            setTimeout(function() {
                $.ajax({
                    url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + encodeURIComponent(alert.name),
                    type: 'POST',
                    data: {
                        'action.slack': '0',
                        'disabled': '1'
                    },
                    success: function() {
                        completed++;
                        if (completed + errors === allAlerts.length) {
                            showMessage('âœ… Disabled ' + completed + ' alerts' + (errors > 0 ? ' (' + errors + ' failed)' : ''), 'success');
                            setTimeout(refreshAlerts, 500);
                        }
                    },
                    error: function() {
                        errors++;
                        completed++;
                        if (completed + errors === allAlerts.length) {
                            showMessage('âš ï¸ Disabled ' + (completed - errors) + ' alerts (' + errors + ' failed)', 'error');
                            setTimeout(refreshAlerts, 500);
                        }
                    }
                });
            }, index * 200);
        });
    };

    window.refreshAlerts = refreshAlerts;

    window.editAlert = function(alertName) {
        window.open('/app/search/alert?s=' + encodeURIComponent(alertName), '_blank');
    };

    window.deleteAlert = function(alertName) {
        if (!confirm('âš ï¸ Delete alert "' + alertName + '"?\n\nThis action cannot be undone!')) {
            return;
        }

        $.ajax({
            url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + encodeURIComponent(alertName),
            type: 'DELETE',
            success: function() {
                showMessage('âœ… Alert deleted successfully', 'success');
                setTimeout(refreshAlerts, 500);
            },
            error: function(xhr, status, error) {
                showMessage('âŒ Failed to delete alert: ' + error, 'error');
            }
        });
    };

    // Auto-load on page load
    refreshAlerts();

    // Auto-refresh every 30 seconds
    setInterval(refreshAlerts, 30000);
});
        ]]></script>
      </html>
    </panel>
  </row>

  <!-- Quick Stats -->
  <row>
    <panel>
      <title>ğŸ“Š Alert Statistics</title>
      <table>
        <search>
          <query>| rest /servicesNS/-/-/saved/searches
| search action.slack=1
| eval status=if(disabled=0 AND 'action.slack'=1, "âœ… Active", "ğŸ”´ Inactive"),
       schedule='cron_schedule',
       channel='action.slack.param.channel'
| stats count by status
| sort -count</query>
          <earliest>-5m</earliest>
          <latest>now</latest>
          <refresh>30s</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>

    <panel>
      <title>ğŸ“ˆ Recent Alert Executions (Last Hour)</title>
      <table>
        <search>
          <query>index=_internal source=*scheduler.log action=alert_fired alert_actions=*slack*
| eval execution_time=strftime(_time, "%H:%M:%S"),
       alert_name=savedsearch_name,
       results=result_count,
       status=if(results &gt; 0, "âœ… Sent", "â­• No data")
| table execution_time, alert_name, results, status
| sort -_time
| head 10</query>
          <earliest>-1h</earliest>
          <latest>now</latest>
          <refresh>30s</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>
</form>
