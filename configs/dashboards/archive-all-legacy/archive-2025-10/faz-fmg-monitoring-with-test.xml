<?xml version="1.0" encoding="UTF-8"?>
<form version="1.1" theme="dark">
  <label>ğŸ¯ FAZ/FMG Unified Monitoring Dashboard</label>
  <description>FortiAnalyzer Critical Logs, FortiManager Configuration Changes &amp; Slack Alert Controls with Testing</description>

  <!-- Time Picker -->
  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="time_picker">
      <label>Time Range</label>
      <default>
        <earliest>-60m@m</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>

  <!-- Row 1: Slack Alert Control Panel with Test Buttons -->
  <row>
    <panel>
      <title>ğŸ”” Slack Alert Control &amp; Testing</title>
      <html>
        <div id="slack-control-panel">
          <div style="margin: 20px 0; padding: 20px; background: #f5f5f5; border-radius: 8px;">
            <h3 style="margin-top: 0;">ğŸ“Š Alert Status &amp; Quick Test</h3>
            <div id="status-container" style="margin: 15px 0;">Loading...</div>

            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
              <button onclick="toggleAllSlackAlerts('enable')" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">âœ… Enable All Alerts</button>
              <button onclick="toggleAllSlackAlerts('disable')" style="padding: 12px 24px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">ğŸ”´ Disable All Alerts</button>
              <button onclick="refreshStatus()" style="padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">ğŸ”„ Refresh Status</button>
              <button onclick="testAllAlerts()" style="padding: 12px 24px; background: #ffc107; color: #000; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">ğŸ§ª Test All Alerts</button>
            </div>

            <div id="individual-controls" style="margin-top: 25px;">
              <h4>Individual Rule Controls &amp; Testing</h4>
              <div id="rules-container"></div>
            </div>

            <div id="result-message" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
          </div>
        </div>

        <script><![CDATA[
require(['jquery', 'splunkjs/ready!'], function($, mvc) {
    const ALERT_RULES = [
        'FAZ_Critical_Alerts',
        'FMG_Policy_Install',
        'FMG_Policy_CRUD',
        'FMG_Object_CRUD'
    ];

    const RULE_LABELS = {
        'FAZ_Critical_Alerts': 'ğŸ”´ FAZ Critical Alerts (Update Fail ì œì™¸)',
        'FMG_Policy_Install': 'ğŸ“¦ FMG Policy Install',
        'FMG_Policy_CRUD': 'ğŸ“ FMG Policy CRUD',
        'FMG_Object_CRUD': 'ğŸ”§ FMG Object CRUD'
    };

    let currentStatus = {};

    function showMessage(message, type) {
        const resultDiv = $('#result-message');
        resultDiv.removeClass('alert-success alert-danger alert-info alert-warning')
                 .addClass('alert-' + type)
                 .html(message)
                 .show();
        setTimeout(() => resultDiv.fadeOut(), 8000);
    }

    function refreshStatus() {
        $('#status-container').html('<div style="color: #007bff;">ğŸ”„ Loading status...</div>');

        let completed = 0;
        const total = ALERT_RULES.length;

        ALERT_RULES.forEach(function(ruleName) {
            $.ajax({
                url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ruleName,
                type: 'GET',
                success: function(response) {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(response, 'text/xml');
                    const slackValue = $(xmlDoc).find('s\\:key[name="action.slack"]').text();
                    currentStatus[ruleName] = slackValue === '1';

                    completed++;
                    if (completed === total) {
                        renderStatus();
                    }
                },
                error: function() {
                    currentStatus[ruleName] = false;
                    completed++;
                    if (completed === total) {
                        renderStatus();
                    }
                }
            });
        });
    }

    function renderStatus() {
        const enabled = Object.values(currentStatus).filter(v => v).length;
        const total = ALERT_RULES.length;

        let statusHtml = '<div style="font-size: 18px; font-weight: bold; color: ';
        statusHtml += enabled === total ? '#28a745' : enabled === 0 ? '#dc3545' : '#f7bc38';
        statusHtml += ';">' + enabled + ' / ' + total + ' alerts enabled</div>';

        $('#status-container').html(statusHtml);

        let rulesHtml = '';
        ALERT_RULES.forEach(function(ruleName) {
            const isEnabled = currentStatus[ruleName];
            const statusBadge = isEnabled ?
                '<span style="color: #28a745; font-weight: bold;">ğŸŸ¢ ON</span>' :
                '<span style="color: #dc3545; font-weight: bold;">ğŸ”´ OFF</span>';

            rulesHtml += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; margin: 5px 0; background: white; border-radius: 4px; border: 1px solid #ddd;">';
            rulesHtml += '<span style="flex: 1;">' + RULE_LABELS[ruleName] + '</span>';
            rulesHtml += '<span style="width: 80px; text-align: center;">' + statusBadge + '</span>';
            rulesHtml += '<div style="display: flex; gap: 5px;">';
            rulesHtml += '<button onclick="toggleSingleRule(\'' + ruleName + '\', ' + !isEnabled + ')" style="padding: 6px 16px; background: ' + (isEnabled ? '#dc3545' : '#28a745') + '; color: white; border: none; border-radius: 4px; cursor: pointer;">';
            rulesHtml += isEnabled ? 'Disable' : 'Enable';
            rulesHtml += '</button>';
            rulesHtml += '<button onclick="testSingleAlert(\'' + ruleName + '\')" style="padding: 6px 16px; background: #ffc107; color: #000; border: none; border-radius: 4px; cursor: pointer;">ğŸ§ª Test</button>';
            rulesHtml += '</div>';
            rulesHtml += '</div>';
        });

        $('#rules-container').html(rulesHtml);
    }

    window.toggleAllSlackAlerts = function(action) {
        const slackValue = action === 'enable' ? '1' : '0';
        const actionText = action === 'enable' ? 'Enabling' : 'Disabling';

        showMessage(actionText + ' all Slack alerts...', 'info');

        let completed = 0;
        const total = ALERT_RULES.length;

        ALERT_RULES.forEach(function(ruleName, index) {
            setTimeout(function() {
                $.ajax({
                    url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ruleName,
                    type: 'POST',
                    data: {
                        'action.slack': slackValue
                    },
                    success: function() {
                        currentStatus[ruleName] = action === 'enable';
                        completed++;
                        if (completed === total) {
                            showMessage('âœ… Successfully ' + (action === 'enable' ? 'enabled' : 'disabled') + ' all Slack alerts', 'success');
                            refreshStatus();
                        }
                    },
                    error: function(xhr) {
                        completed++;
                        if (completed === total) {
                            showMessage('âš ï¸ Some alerts failed to update. Check permissions.', 'danger');
                            refreshStatus();
                        }
                    }
                });
            }, index * 200);
        });
    };

    window.toggleSingleRule = function(ruleName, enable) {
        const slackValue = enable ? '1' : '0';
        const actionText = enable ? 'Enabling' : 'Disabling';

        showMessage(actionText + ' ' + RULE_LABELS[ruleName] + '...', 'info');

        $.ajax({
            url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ruleName,
            type: 'POST',
            data: {
                'action.slack': slackValue
            },
            success: function() {
                currentStatus[ruleName] = enable;
                showMessage('âœ… Successfully ' + (enable ? 'enabled' : 'disabled') + ' ' + RULE_LABELS[ruleName], 'success');
                renderStatus();
            },
            error: function() {
                showMessage('âŒ Failed to update ' + RULE_LABELS[ruleName] + '. Check permissions.', 'danger');
            }
        });
    };

    window.testSingleAlert = function(ruleName) {
        showMessage('ğŸ§ª Testing ' + RULE_LABELS[ruleName] + '...', 'info');

        $.ajax({
            url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ruleName + '/dispatch',
            type: 'POST',
            data: {
                'trigger_actions': '1'
            },
            success: function(response) {
                showMessage('âœ… Test triggered for ' + RULE_LABELS[ruleName] + '<br>Check Slack channel for results in ~30 seconds', 'success');
            },
            error: function(xhr) {
                showMessage('âŒ Failed to test ' + RULE_LABELS[ruleName] + '<br>Error: ' + xhr.statusText, 'danger');
            }
        });
    };

    window.testAllAlerts = function() {
        showMessage('ğŸ§ª Testing all 4 alerts... Check Slack in ~30 seconds', 'info');

        let completed = 0;
        const total = ALERT_RULES.length;
        let successCount = 0;

        ALERT_RULES.forEach(function(ruleName, index) {
            setTimeout(function() {
                $.ajax({
                    url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ruleName + '/dispatch',
                    type: 'POST',
                    data: {
                        'trigger_actions': '1'
                    },
                    success: function() {
                        successCount++;
                        completed++;
                        if (completed === total) {
                            showMessage('âœ… ' + successCount + '/' + total + ' alerts tested successfully<br>Check Slack channel for results', 'success');
                        }
                    },
                    error: function() {
                        completed++;
                        if (completed === total) {
                            showMessage('âš ï¸ ' + successCount + '/' + total + ' alerts tested successfully<br>Some alerts may have failed', 'warning');
                        }
                    }
                });
            }, index * 500);
        });
    };

    window.refreshStatus = refreshStatus;
    refreshStatus();
});
        ]]></script>

        <style>
.alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
.alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        </style>
      </html>
    </panel>
  </row>

  <!-- Row 2: Summary Stats -->
  <row>
    <panel>
      <title>ğŸ”´ FAZ Critical Events (Last Hour)</title>
      <single>
        <search>
          <query>
index=fw sourcetype=fw_log earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search (severity=critical OR level=critical)
| search NOT msg="*Update Fail*"
| search NOT logid IN ("0100032001","0100032002","0100032003","0100032004","0100032005","0101039424","0101039425","0101039426","0101039427","0101039428","0102043008","0102043009","0102043010")
| stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xD93F3C"]</option>
        <option name="rangeValues">[0,5]</option>
        <option name="underLabel">Critical Events</option>
      </single>
    </panel>

    <panel>
      <title>ğŸ“¦ FMG Policy Installs</title>
      <single>
        <search>
          <query>
index=fw sourcetype=fw_log earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search action=install OR msg="*install*policy*"
| stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38"]</option>
        <option name="rangeValues">[0,3]</option>
        <option name="underLabel">Install Events</option>
      </single>
    </panel>

    <panel>
      <title>ğŸ“ FMG Policy Changes</title>
      <single>
        <search>
          <query>
index=fw sourcetype=fw_log earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search object="*policy*"
| search operation IN (add,set,delete,create,modify,remove)
| stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xD93F3C"]</option>
        <option name="rangeValues">[0,10]</option>
        <option name="underLabel">Policy CRUD</option>
      </single>
    </panel>

    <panel>
      <title>ğŸ”§ FMG Object Changes</title>
      <single>
        <search>
          <query>
index=fw sourcetype=fw_log earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search object IN (address,service,vip,addrgrp,servgrp)
| search operation IN (add,set,delete,create,modify,remove)
| stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xD93F3C"]</option>
        <option name="rangeValues">[0,15]</option>
        <option name="underLabel">Object CRUD</option>
      </single>
    </panel>
  </row>

  <!-- Row 3: FAZ Critical Events Detail -->
  <row>
    <panel>
      <title>ğŸ”´ FAZ Critical Events Detail (Top 20)</title>
      <table>
        <search>
          <query>
index=fw sourcetype=fw_log earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search (severity=critical OR level=critical)
| search NOT msg="*Update Fail*"
| search NOT logid IN ("0100032001","0100032002","0100032003","0100032004","0100032005","0101039424","0101039425","0101039426","0101039427","0101039428","0102043008","0102043009","0102043010")
| eval time=strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval src_ip=coalesce(srcip, src, "N/A")
| eval dst_ip=coalesce(dstip, dst, "N/A")
| eval severity_level=coalesce(severity, level, "critical")
| eval log_id=coalesce(logid, "N/A")
| eval message=coalesce(msg, message, logdesc, "")
| eval device=coalesce(devname, device, hostname, "Unknown")
| table time, src_ip, dst_ip, severity_level, log_id, message, device
| rename time AS "ì‹œê°„", src_ip AS "ì¶œë°œì§€ IP", dst_ip AS "ëª©ì ì§€ IP", severity_level AS "ì‹¬ê°ë„", log_id AS "ë¡œê·¸ID", message AS "ë©”ì‹œì§€", device AS "ì¥ë¹„ëª…"
| head 20
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="count">20</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <format type="color" field="ì‹¬ê°ë„">
          <colorPalette type="map">{"critical":#D93F3C}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 4: Usage Instructions -->
  <row>
    <panel>
      <title>ğŸ“‹ Usage Instructions</title>
      <html>
        <div style="padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
          <h4 style="margin-top: 0;">ğŸ¯ ëŒ€ì‹œë³´ë“œ ì‚¬ìš© ë°©ë²•</h4>
          <ul style="line-height: 1.8;">
            <li><strong>âœ… Enable All Alerts:</strong> 4ê°œ ì•Œë¦¼ ê·œì¹™ì˜ Slack ì•Œë¦¼ ì¼ê´„ í™œì„±í™”</li>
            <li><strong>ğŸ”´ Disable All Alerts:</strong> ëª¨ë“  Slack ì•Œë¦¼ ì¼ê´„ ë¹„í™œì„±í™”</li>
            <li><strong>ğŸ”„ Refresh Status:</strong> í˜„ì¬ ì•Œë¦¼ ìƒíƒœ ìƒˆë¡œê³ ì¹¨</li>
            <li><strong>ğŸ§ª Test All Alerts:</strong> ëª¨ë“  ì•Œë¦¼ ì¦‰ì‹œ ì‹¤í–‰ (30ì´ˆ í›„ Slack í™•ì¸)</li>
            <li><strong>Individual Controls:</strong> ê° ê·œì¹™ë³„ ê°œë³„ í™œì„±í™”/ë¹„í™œì„±í™”</li>
            <li><strong>ğŸ§ª Test (ê°œë³„):</strong> í•´ë‹¹ ì•Œë¦¼ë§Œ ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</li>
          </ul>
          <h4>ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•</h4>
          <ul style="line-height: 1.8;">
            <li><strong>ì „ì²´ í…ŒìŠ¤íŠ¸:</strong> "ğŸ§ª Test All Alerts" ë²„íŠ¼ í´ë¦­ â†’ 30ì´ˆ í›„ Slack í™•ì¸</li>
            <li><strong>ê°œë³„ í…ŒìŠ¤íŠ¸:</strong> ê° ê·œì¹™ ì˜† "ğŸ§ª Test" ë²„íŠ¼ í´ë¦­</li>
            <li><strong>ê²°ê³¼ í™•ì¸:</strong> #splunk-alerts ì±„ë„ì—ì„œ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ìˆ˜ì‹ </li>
          </ul>
          <p style="margin-bottom: 0;"><strong>ì°¸ê³ :</strong> í…ŒìŠ¤íŠ¸ëŠ” ì‹¤ì œ ê²€ìƒ‰ì„ ì‹¤í–‰í•˜ë¯€ë¡œ, ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì•Œë¦¼ì´ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        </div>
      </html>
    </panel>
  </row>

</form>
