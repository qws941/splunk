<?xml version="1.0" encoding="UTF-8"?>
<form version="1.1" theme="dark">
  <label>üéõÔ∏è Slack Real-time Alert Manager</label>
  <description>Manage real-time Slack alerts - ON/OFF toggle control</description>

  <row>
    <panel>
      <title>Real-time Slack Alert Control</title>
      <html>
        <div id="slack-manager">
          <div style="margin: 20px 0; padding: 20px; background: #f5f5f5; border-radius: 8px;">
            <h3 style="margin-top: 0;">üìä Alert Status</h3>
            <div id="status-container" style="margin: 15px 0;">Loading...</div>

            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
              <button onclick="toggleAllSlackAlerts('enable')" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">‚úÖ Enable All</button>
              <button onclick="toggleAllSlackAlerts('disable')" style="padding: 12px 24px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">üî¥ Disable All</button>
              <button onclick="refreshStatus()" style="padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">üîÑ Refresh</button>
              <button onclick="sendTestAlert()" style="padding: 12px 24px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">üß™ Test</button>
            </div>

            <div id="individual-controls" style="margin-top: 25px;">
              <h4>Individual Alert Controls</h4>
              <div id="rules-container"></div>
            </div>

            <div id="result-message" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
          </div>
        </div>

        <script><![CDATA[
require(['jquery', 'splunkjs/ready!'], function($, mvc) {
    // Auto-discovered alerts with Slack action
    let ALL_SLACK_ALERTS = [];
    let currentStatus = {};

    function showMessage(message, type) {
        const resultDiv = $('#result-message');
        const bgColors = {
            'success': '#d4edda',
            'danger': '#f8d7da',
            'info': '#d1ecf1'
        };
        const textColors = {
            'success': '#155724',
            'danger': '#721c24',
            'info': '#0c5460'
        };

        resultDiv.css({
            'background': bgColors[type] || bgColors['info'],
            'color': textColors[type] || textColors['info'],
            'border': '1px solid ' + (textColors[type] || textColors['info']),
            'display': 'block'
        }).text(message);

        setTimeout(() => resultDiv.fadeOut(), 5000);
    }

    function refreshStatus() {
        $('#status-container').html('<div style="color: #007bff;">üîÑ Loading alerts...</div>');

        // Discover all saved searches with Slack action
        $.ajax({
            url: '/en-US/splunkd/__raw/servicesNS/-/-/saved/searches?count=-1',
            type: 'GET',
            success: function(response) {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(response, 'text/xml');
                const entries = $(xmlDoc).find('entry');

                ALL_SLACK_ALERTS = [];
                let completed = 0;

                entries.each(function() {
                    const title = $(this).find('title').text();
                    const slackAction = $(this).find('s\\:key[name="action.slack"]').text();

                    // Only include alerts with Slack action
                    if (slackAction === '1' || slackAction === '0') {
                        ALL_SLACK_ALERTS.push(title);
                    }
                });

                if (ALL_SLACK_ALERTS.length === 0) {
                    $('#status-container').html('<div style="color: #6c757d;">üì≠ No Slack alerts found</div>');
                    $('#rules-container').html('<div style="padding: 20px; text-align: center; color: #6c757d;">No alerts configured yet</div>');
                    return;
                }

                // Load status for each alert
                ALL_SLACK_ALERTS.forEach(function(ruleName) {
                    $.ajax({
                        url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ruleName,
                        type: 'GET',
                        success: function(response) {
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(response, 'text/xml');
                            const slackValue = $(xmlDoc).find('s\\:key[name="action.slack"]').text();
                            currentStatus[ruleName] = slackValue === '1';

                            completed++;
                            if (completed === ALL_SLACK_ALERTS.length) {
                                renderStatus();
                            }
                        },
                        error: function() {
                            currentStatus[ruleName] = false;
                            completed++;
                            if (completed === ALL_SLACK_ALERTS.length) {
                                renderStatus();
                            }
                        }
                    });
                });
            },
            error: function() {
                $('#status-container').html('<div style="color: #dc3545;">‚ùå Failed to load alerts</div>');
            }
        });
    }

    function renderStatus() {
        const enabled = Object.values(currentStatus).filter(v => v).length;
        const total = ALL_SLACK_ALERTS.length;

        let statusHtml = '<div style="font-size: 18px; font-weight: bold; color: ';
        statusHtml += enabled === total ? '#28a745' : enabled === 0 ? '#dc3545' : '#f7bc38';
        statusHtml += ';">' + enabled + ' / ' + total + ' alerts enabled</div>';

        $('#status-container').html(statusHtml);

        let rulesHtml = '';
        ALL_SLACK_ALERTS.forEach(function(ruleName) {
            const isEnabled = currentStatus[ruleName];
            const statusBadge = isEnabled ?
                '<span style="color: #28a745; font-weight: bold;">üü¢ ON</span>' :
                '<span style="color: #dc3545; font-weight: bold;">üî¥ OFF</span>';

            rulesHtml += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; margin: 5px 0; background: white; border-radius: 4px; border: 1px solid #ddd;">';
            rulesHtml += '<span style="flex: 1;">' + ruleName + '</span>';
            rulesHtml += '<span style="width: 80px; text-align: center;">' + statusBadge + '</span>';
            rulesHtml += '<button onclick="toggleSingleRule(\'' + ruleName.replace(/'/g, "\\'") + '\', ' + !isEnabled + ')" style="padding: 6px 16px; background: ' + (isEnabled ? '#dc3545' : '#28a745') + '; color: white; border: none; border-radius: 4px; cursor: pointer;">';
            rulesHtml += isEnabled ? 'Disable' : 'Enable';
            rulesHtml += '</button>';
            rulesHtml += '</div>';
        });

        $('#rules-container').html(rulesHtml);
    }

    window.toggleAllSlackAlerts = function(action) {
        const slackValue = action === 'enable' ? '1' : '0';
        const actionText = action === 'enable' ? 'Enabling' : 'Disabling';

        showMessage(actionText + ' all Slack alerts...', 'info');

        let completed = 0;
        const total = ALL_SLACK_ALERTS.length;

        ALL_SLACK_ALERTS.forEach(function(ruleName, index) {
            setTimeout(function() {
                $.ajax({
                    url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ruleName,
                    type: 'POST',
                    data: {
                        'action.slack': slackValue
                    },
                    success: function() {
                        currentStatus[ruleName] = action === 'enable';
                        completed++;
                        if (completed === total) {
                            showMessage('‚úÖ Successfully ' + (action === 'enable' ? 'enabled' : 'disabled') + ' all Slack alerts', 'success');
                            refreshStatus();
                        }
                    },
                    error: function(xhr) {
                        completed++;
                        if (completed === total) {
                            showMessage('‚ö†Ô∏è Some alerts failed. Check permissions.', 'danger');
                            refreshStatus();
                        }
                    }
                });
            }, index * 200);
        });
    };

    window.toggleSingleRule = function(ruleName, enable) {
        const slackValue = enable ? '1' : '0';
        const actionText = enable ? 'Enabling' : 'Disabling';

        showMessage(actionText + ' ' + ruleName + '...', 'info');

        $.ajax({
            url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ruleName,
            type: 'POST',
            data: {
                'action.slack': slackValue
            },
            success: function() {
                currentStatus[ruleName] = enable;
                showMessage('‚úÖ Successfully ' + (enable ? 'enabled' : 'disabled') + ' ' + ruleName, 'success');
                renderStatus();
            },
            error: function() {
                showMessage('‚ùå Failed to update ' + ruleName, 'danger');
            }
        });
    };

    window.sendTestAlert = function() {
        showMessage('üß™ Sending test alert...', 'info');

        const testSearch = '| makeresults | eval alert_text="üß™ Test Alert\\nTime: " + strftime(now(), "%Y-%m-%d %H:%M:%S") + "\\nStatus: Working!" | table alert_text | sendalert slack param.channel="C09DSD6JH2Q"';

        $.ajax({
            url: '/en-US/splunkd/__raw/services/search/jobs',
            type: 'POST',
            data: {
                search: testSearch,
                output_mode: 'json',
                exec_mode: 'oneshot'
            },
            success: function() {
                showMessage('‚úÖ Test alert sent! Check Slack.', 'success');
            },
            error: function() {
                showMessage('‚ùå Test failed. Check configuration.', 'danger');
            }
        });
    };

    window.refreshStatus = refreshStatus;

    // Auto-load
    refreshStatus();

    // Auto-refresh every 30s
    setInterval(refreshStatus, 30000);
});
        ]]></script>
      </html>
    </panel>
  </row>
</form>
