<form version="1.1" theme="dark">
  <label>FortiGate Operations Monitoring</label>
  <description>Real-time firewall operations - Traffic analysis, policy hits, and top talkers</description>

  <!-- Filters -->
  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="time_picker">
      <label>Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>

  <!-- Row 1: KPI Summary -->
  <row>
    <panel>
      <title>Total Events</title>
      <single>
        <search>
          <query>index=fw earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[1000,5000,10000,50000]</option>
        <option name="underLabel">All Events</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
      </single>
    </panel>

    <panel>
      <title>Blocked Events</title>
      <single>
        <search>
          <query>index=fw action=deny earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[100,500,1000]</option>
        <option name="underLabel">Deny Actions</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
      </single>
    </panel>

    <panel>
      <title>Allowed Events</title>
      <single>
        <search>
          <query>index=fw action=accept earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38"]</option>
        <option name="rangeValues">[10000,50000]</option>
        <option name="underLabel">Accept Actions</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
      </single>
    </panel>

    <panel>
      <title>Unique Source IPs</title>
      <single>
        <search>
          <query>index=fw earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats dc(src_ip) as unique_ips</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38","0xF58F39"]</option>
        <option name="rangeValues">[100,500,1000]</option>
        <option name="underLabel">Active Sources</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
      </single>
    </panel>
  </row>

  <!-- Row 2: Traffic Trend -->
  <row>
    <panel>
      <title>Traffic Over Time (Allowed vs Blocked)</title>
      <chart>
        <search>
          <query>index=fw earliest=$time_picker.earliest$ latest=$time_picker.latest$
| timechart span=10m count by action
| fillnull value=0</query>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Event Count</option>
        <option name="charting.fieldColors">{"accept":"#65A637","deny":"#D93F3C"}</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>
  </row>

  <!-- Row 3: Top Source IPs and Destination IPs -->
  <row>
    <panel>
      <title>Top 10 Source IPs (Most Active)</title>
      <table>
        <search>
          <query>index=fw earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as event_count,
        dc(dst_ip) as unique_targets,
        values(action) as actions
  by src_ip
| sort -event_count
| head 10
| rename src_ip as "Source IP", event_count as "Event Count", unique_targets as "Unique Targets", actions as "Actions"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="count">10</option>
        <format type="number" field="Event Count">
          <option name="precision">0</option>
        </format>
      </table>
    </panel>

    <panel>
      <title>Top 10 Destination IPs</title>
      <table>
        <search>
          <query>index=fw earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as event_count,
        dc(src_ip) as unique_sources,
        values(action) as actions
  by dst_ip
| sort -event_count
| head 10
| rename dst_ip as "Destination IP", event_count as "Event Count", unique_sources as "Unique Sources", actions as "Actions"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="count">10</option>
        <format type="number" field="Event Count">
          <option name="precision">0</option>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 4: Protocols and Ports -->
  <row>
    <panel>
      <title>Top Protocols</title>
      <chart>
        <search>
          <query>index=fw earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count by proto
| sort -count
| head 10</query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>

    <panel>
      <title>Top Destination Ports</title>
      <chart>
        <search>
          <query>index=fw earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count by dstport
| sort -count
| head 10</query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisTitleX.text">Event Count</option>
        <option name="charting.axisTitleY.text">Port</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>
  </row>

  <!-- Row 5: Firewall Policies -->
  <row>
    <panel>
      <title>Top 10 Firewall Policies (Most Hit)</title>
      <table>
        <search>
          <query>index=fw policyid=* earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as hit_count,
        values(action) as actions,
        dc(src_ip) as unique_sources,
        dc(dst_ip) as unique_destinations
  by policyid
| sort -hit_count
| head 10
| rename policyid as "Policy ID", hit_count as "Hit Count", actions as "Actions", unique_sources as "Sources", unique_destinations as "Destinations"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="count">10</option>
        <format type="number" field="Hit Count">
          <option name="precision">0</option>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 6: Recently Blocked Traffic -->
  <row>
    <panel>
      <title>Recently Blocked Traffic (Last 100)</title>
      <table>
        <search>
          <query>index=fw action=deny earliest=$time_picker.earliest$ latest=$time_picker.latest$
| eval event_time=strftime(_time, "%Y-%m-%d %H:%M:%S")
| table event_time, src_ip, dst_ip, dstport, proto, severity, msg
| head 100
| rename event_time as "Time", src_ip as "Source IP", dst_ip as "Dest IP", dstport as "Port", proto as "Protocol", severity as "Severity", msg as "Message"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="count">20</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="Severity">
          <colorPalette type="map">{"critical":"#D93F3C","high":"#F58F39","medium":"#F7BC38","low":"#6DB7C6"}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 7: Top Blocked IPs -->
  <row>
    <panel>
      <title>Top 20 Most Blocked Source IPs (Potential Attackers)</title>
      <table>
        <search>
          <query>index=fw action=deny earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as block_count,
        dc(dst_ip) as unique_targets,
        values(severity) as severities,
        earliest(_time) as first_seen,
        latest(_time) as last_seen
  by src_ip
| eval first_seen=strftime(first_seen, "%Y-%m-%d %H:%M"),
       last_seen=strftime(last_seen, "%Y-%m-%d %H:%M")
| sort -block_count
| head 20
| rename src_ip as "Source IP", block_count as "Block Count", unique_targets as "Targets", severities as "Severity", first_seen as "First Seen", last_seen as "Last Seen"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="count">20</option>
        <option name="rowNumbers">true</option>
        <format type="number" field="Block Count">
          <option name="precision">0</option>
        </format>
        <format type="color" field="Block Count">
          <colorPalette type="minMidMax" minColor="#65A637" midColor="#F7BC38" maxColor="#D93F3C"></colorPalette>
          <scale type="minMidMax" minType="number" minValue="10" midType="number" midValue="100" maxType="number" maxValue="1000"></scale>
        </format>
      </table>
    </panel>
  </row>
</form>
