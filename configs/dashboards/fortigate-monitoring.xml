<form version="1.1">
  <label>FortiGate Monitoring</label>
  <description>Configuration Changes + Operational Events</description>

  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="time_picker">
      <label>ì‹œê°„ ë²”ìœ„</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>

  <!-- ========== Alert ì œì–´ ì„¹ì…˜ ========== -->

  <!-- Row 0: Alert ìƒíƒœ ë° ON/OFF ì œì–´ -->
  <row>
    <panel>
      <title>âš™ï¸ Slack Alert ì œì–´ (Real-time)</title>
      <table id="element1">
        <search>
          <query>
| rest /services/saved/searches
| search title="FortiGate_*"
| eval status = if(disabled==0, "âœ… ON", "ğŸ”´ OFF")
| eval alert_type = case(
    match(title, "Config_Change"), "ì„¤ì • ë³€ê²½",
    match(title, "Critical_Event"), "Critical ì´ë²¤íŠ¸",
    match(title, "HA_Event"), "HA ì´ë²¤íŠ¸",
    1=1, "ê¸°íƒ€")
| eval channel = "security-firewall-alert"
| eval window = "rt-30s"
| eval suppress = "15ì´ˆ"
| table title, alert_type, status, channel, window, suppress, realtime_schedule
| rename title AS "Alert ì´ë¦„", alert_type AS "íƒ€ì…", status AS "ìƒíƒœ", channel AS "ì±„ë„", window AS "ìœˆë„ìš°", suppress AS "Suppress", realtime_schedule AS "Real-time"
          </query>
          <refresh>30s</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="wrap">true</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="ìƒíƒœ">
          <colorPalette type="map">{"âœ… ON":#53A051,"ğŸ”´ OFF":#DC4E41}</colorPalette>
        </format>
      </table>
      <html>
        <style>
          .control-button {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            min-width: 80px;
            border: none;
          }
          .btn-enable {
            background-color: #28a745;
            color: white;
          }
          .btn-disable {
            background-color: #dc3545;
            color: white;
          }
          .btn-enable:hover {
            background-color: #218838;
          }
          .btn-disable:hover {
            background-color: #c82333;
          }
          .alert-row {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            background-color: #f8f9fa;
            margin-bottom: 10px;
          }
          .alert-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
          }
          .alert-status {
            display: inline-block;
            padding: 3px 8px;
            margin-left: 10px;
            border-radius: 3px;
            font-size: 12px;
          }
          .status-enabled {
            background-color: #d4edda;
            color: #155724;
          }
          .status-disabled {
            background-color: #f8d7da;
            color: #721c24;
          }
          #status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
            display: none;
          }
          .success {
            background-color: #d4edda;
            color: #155724;
          }
          .error {
            background-color: #f8d7da;
            color: #721c24;
          }
          #alert-controls-container {
            min-height: 50px;
          }
          .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
          }
        </style>

        <div id="status-message"></div>
        <div id="alert-controls-container">
          <div class="loading">â³ Loading alerts...</div>
        </div>

        <script>
          require([
            'splunkjs/mvc',
            'splunkjs/mvc/simplexml/ready!'
          ], function(mvc) {

            // Load existing alerts dynamically
            function loadAlerts() {
              var service = mvc.createService();
              var container = document.getElementById('alert-controls-container');

              service.get(
                '/servicesNS/nobody/search/saved/searches',
                { search: 'title=FortiGate_*', count: 100 },
                function(err, response) {
                  if (err) {
                    container.innerHTML = '&lt;div class="error"&gt;âŒ Failed to load alerts: ' + err.message + '&lt;/div&gt;';
                    return;
                  }

                  var alerts = [];
                  if (response.data &amp;&amp; response.data.entry) {
                    alerts = response.data.entry;
                  }

                  if (alerts.length === 0) {
                    container.innerHTML = '&lt;div class="loading"&gt;ğŸ“­ No FortiGate alerts found&lt;/div&gt;';
                    return;
                  }

                  // Build dynamic control buttons
                  var html = '';
                  alerts.forEach(function(alert) {
                    var name = alert.name;
                    var disabled = alert.content.disabled === '1';
                    var statusClass = disabled ? 'status-disabled' : 'status-enabled';
                    var statusText = disabled ? 'ğŸ”´ Disabled' : 'âœ… Enabled';

                    // Determine icon based on alert name
                    var icon = 'ğŸ“Œ';
                    if (name.indexOf('Config_Change') &gt;= 0) icon = 'ğŸ“';
                    else if (name.indexOf('Critical_Event') &gt;= 0) icon = 'ğŸ”´';
                    else if (name.indexOf('HA_Event') &gt;= 0) icon = 'ğŸ”„';

                    html += '&lt;div class="alert-row"&gt;';
                    html += '&lt;div class="alert-name"&gt;' + icon + ' ' + name;
                    html += '&lt;span class="alert-status ' + statusClass + '"&gt;' + statusText + '&lt;/span&gt;';
                    html += '&lt;/div&gt;';
                    html += '&lt;button class="control-button btn-enable" onclick="toggleAlert(\'' + name + '\', 0)"&gt;ON&lt;/button&gt;';
                    html += '&lt;button class="control-button btn-disable" onclick="toggleAlert(\'' + name + '\', 1)"&gt;OFF&lt;/button&gt;';
                    html += '&lt;/div&gt;';
                  });

                  container.innerHTML = html;
                }
              );
            }

            // Initial load
            loadAlerts();

            // Toggle alert on/off
            window.toggleAlert = function(alertName, disabledValue) {
              var service = mvc.createService();  // Auto-detects current Splunk host
              var statusDiv = document.getElementById('status-message');
              var action = disabledValue === 0 ? 'ENABLED' : 'DISABLED';

              statusDiv.innerHTML = 'â³ Processing...';
              statusDiv.className = '';
              statusDiv.style.display = 'block';

              service.post(
                '/servicesNS/nobody/search/saved/searches/' + encodeURIComponent(alertName),
                { disabled: disabledValue },
                function(err, response) {
                  if (err) {
                    statusDiv.innerHTML = 'âŒ Error: ' + err.message;
                    statusDiv.className = 'error';
                  } else {
                    statusDiv.innerHTML = 'âœ… ' + alertName + ' ' + action + ' successfully!';
                    statusDiv.className = 'success';

                    // Refresh controls and status table
                    setTimeout(function() {
                      loadAlerts();  // Reload controls to show updated status
                      mvc.Components.get('element1').startSearch();
                    }, 500);
                  }

                  setTimeout(function() {
                    statusDiv.style.display = 'none';
                  }, 3000);
                }
              );
            };

          });
        </script>

        <p style="margin-top: 20px;"><b>âš™ï¸ Alternative Methods:</b></p>
        <ul>
          <li><b>Web UI:</b> Settings â†’ Searches, reports, and alerts â†’ Alert í´ë¦­ â†’ Enable ì²´í¬ë°•ìŠ¤</li>
          <li><b>REST API:</b> <code>curl -k -u admin:password -d 'disabled=0' https://YOUR_SPLUNK_HOST:8089/servicesNS/nobody/search/saved/searches/[ALERT_NAME]</code></li>
        </ul>
      </html>
    </panel>
  </row>

  <!-- ========== ì„¤ì • ë³€ê²½ ì„¹ì…˜ ========== -->

  <!-- Row 1: ì„¤ì • ë³€ê²½ í†µê³„ -->
  <row>
    <panel>
      <title>ğŸ“ ì„¤ì • ë³€ê²½</title>
      <single>
        <search>
          <query>
index=fortianalyzer earliest=$time_picker.earliest$ latest=$time_picker.latest$ type=event subtype=system (logid=0100044546 OR logid=0100044547 OR cfgpath=*)
| stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x53A051","0xF8BE34","0xDC4E41"]</option>
        <option name="rangeValues">[0,50,100]</option>
        <option name="useColors">1</option>
      </single>
    </panel>

    <panel>
      <title>ğŸ‘¤ ê´€ë¦¬ì ìˆ˜</title>
      <single>
        <search>
          <query>
index=fortianalyzer earliest=$time_picker.earliest$ latest=$time_picker.latest$ type=event subtype=system user=* (logid=0100044546 OR cfgpath=*)
| stats dc(user) as count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>

    <panel>
      <title>âš ï¸ Warning ì´ìƒ</title>
      <single>
        <search>
          <query>
index=fortianalyzer earliest=$time_picker.earliest$ latest=$time_picker.latest$ type=event subtype=system (level=warning OR level=error OR level=critical OR level=alert OR level=emergency)
| stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x53A051","0xF8BE34","0xDC4E41"]</option>
        <option name="rangeValues">[0,10,50]</option>
        <option name="useColors">1</option>
      </single>
    </panel>

    <panel>
      <title>ğŸ–¥ï¸ ì¥ë¹„ ìˆ˜</title>
      <single>
        <search>
          <query>
index=fortianalyzer earliest=$time_picker.earliest$ latest=$time_picker.latest$ type=event subtype=system
| stats dc(devname) as count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
  </row>

  <!-- Row 2: ì„¤ì • ë³€ê²½ ìƒì„¸ -->
  <row>
    <panel>
      <title>ğŸ“‹ ì„¤ì • ë³€ê²½ ë‚´ì—­ (ìµœê·¼ 50ê°œ)</title>
      <table>
        <search>
          <query>
index=fortianalyzer earliest=$time_picker.earliest$ latest=$time_picker.latest$ type=event subtype=system (logid=0100044546 OR logid=0100044547 OR cfgpath=*)
| eval event_time = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval device = coalesce(devname, "Unknown")
| eval admin = coalesce(user, "system")
| eval access_method = coalesce(ui, "N/A")
| eval change_type = case(
    match(cfgpath, "firewall\.policy") OR match(cfgpath, "firewall\.rule"), "ì •ì±…",
    match(cfgpath, "firewall\.address") OR match(cfgpath, "firewall\.addrgrp"), "ì£¼ì†Œê°ì²´",
    match(cfgpath, "firewall\.service") OR match(cfgpath, "firewall\.servicegrp"), "ì„œë¹„ìŠ¤ê°ì²´",
    match(cfgpath, "system\.") OR match(cfgpath, "log\."), "ì‹œìŠ¤í…œì„¤ì •",
    isnotnull(cfgpath), "ê¸°íƒ€ì„¤ì •",
    1=1, "ì„¤ì •ë³€ê²½")
| eval action_type = coalesce(action, "modify")
| eval object_name = coalesce(cfgobj, "")
| eval change_detail = if(isnotnull(cfgattr) AND len(cfgattr) &lt; 300, cfgattr, "")
| eval description = coalesce(logdesc, msg, cfgpath, "Configuration change")
| eval line1 = "*FortiGate " + change_type + " ë³€ê²½: " + action_type + "*"
| eval line2 = "ê´€ë¦¬ì: " + admin
| eval line3 = "ì¥ë¹„: " + device
| eval line4 = "ì ‘ì†: " + access_method
| eval line5 = "ê°ì²´: " + object_name
| eval line6 = "ê²½ë¡œ: " + coalesce(cfgpath, "N/A")
| eval line7 = "ë³€ê²½ë‚´ìš©: " + if(isnotnull(change_detail) AND change_detail!="", change_detail, "N/A")
| eval alert_message = line1 + " | " + line2 + " | " + line3 + " | " + line4 + " | " + line5 + " | " + line6 + " | " + line7
| fields - line1, line2, line3, line4, line5, line6, line7
| table event_time, device, admin, access_method, change_type, action_type, object_name, change_detail, alert_message, description, cfgpath, logid
| rename event_time as "ì‹œê°„", device as "ì¥ë¹„", admin as "ê´€ë¦¬ì", access_method as "ì ‘ì†ë°©ë²•", change_type as "ë³€ê²½ìœ í˜•", action_type as "ì‘ì—…", object_name as "ê°ì²´ëª…", change_detail as "ë³€ê²½ìƒì„¸", alert_message as "ì•Œë¦¼ë©”ì‹œì§€", description as "ì„¤ëª…"
| head 50
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">50</option>
        <option name="drilldown">cell</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="ë³€ê²½ìœ í˜•">
          <colorPalette type="map">{"ì •ì±…":#F7BC38,"ì£¼ì†Œê°ì²´":#65A637,"ì„œë¹„ìŠ¤ê°ì²´":#6DB7C6,"ì‹œìŠ¤í…œì„¤ì •":#A569BD,"ê¸°íƒ€ì„¤ì •":#8B4789,"ì„¤ì •ë³€ê²½":#87CEEB}</colorPalette>
        </format>
        <format type="color" field="ì‘ì—…">
          <colorPalette type="map">{"Delete":#DC4E41,"Add":#53A051,"Edit":#F8BE34,"modify":#87CEEB,"Set":#6DB7C6}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 3: ì„¤ì • ë³€ê²½ ì°¨íŠ¸ -->
  <row>
    <panel>
      <title>ğŸ“Š ì„¤ì • ë³€ê²½ ì¶”ì´</title>
      <chart>
        <search>
          <query>
index=fortianalyzer earliest=$time_picker.earliest$ latest=$time_picker.latest$ type=event subtype=system (logid=0100044546 OR cfgpath=*)
| timechart span=1h count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.axisTitleY.text">ë³€ê²½ íšŸìˆ˜</option>
        <option name="charting.seriesColors">[0x6DB7C6]</option>
      </chart>
    </panel>

    <panel>
      <title>ğŸ“Š ìœ í˜•ë³„ í†µê³„</title>
      <chart>
        <search>
          <query>
index=fortianalyzer earliest=$time_picker.earliest$ latest=$time_picker.latest$ type=event subtype=system (logid=0100044546 OR cfgpath=*)
| eval change_type = case(
    match(cfgpath, "firewall\.policy") OR match(cfgpath, "firewall\.rule"), "ì •ì±…",
    match(cfgpath, "firewall\.address") OR match(cfgpath, "firewall\.addrgrp"), "ì£¼ì†Œê°ì²´",
    match(cfgpath, "firewall\.service") OR match(cfgpath, "firewall\.servicegrp"), "ì„œë¹„ìŠ¤ê°ì²´",
    match(cfgpath, "system\.") OR match(cfgpath, "log\."), "ì‹œìŠ¤í…œì„¤ì •",
    1=1, "ê¸°íƒ€")
| stats count by change_type
| rename change_type as "ë³€ê²½ìœ í˜•"
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>

  <!-- ========== ìš´ì˜ ì´ë²¤íŠ¸ ì„¹ì…˜ ========== -->

  <!-- Row 4: ìš´ì˜ ì´ë²¤íŠ¸ ìƒì„¸ -->
  <row>
    <panel>
      <title>ğŸ–¥ï¸ Critical ìš´ì˜ ì´ë²¤íŠ¸ (Update/Host Fail ì œì™¸, ìµœê·¼ 50ê°œ)</title>
      <table>
        <search>
          <query>
index=fortianalyzer earliest=$time_picker.earliest$ latest=$time_picker.latest$ type=event subtype=system level=critical logid!=0100044546 logid!=0100044547 NOT cfgpath=*
| search NOT msg="*Update Fail*" NOT msg="*Host Fail*"
| eval event_time = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval device = coalesce(devname, "Unknown")
| eval severity = coalesce(level, "critical")
| eval event_type = case(
    match(logid, "^0104"), "ì‹œìŠ¤í…œìƒíƒœ",
    match(logid, "^0103"), "HAì´ë²¤íŠ¸",
    match(logid, "^0105"), "ì¸í„°í˜ì´ìŠ¤",
    match(logid, "^0106"), "ì„±ëŠ¥í†µê³„",
    match(logid, "^0107"), "ë¡œê·¸",
    match(logid, "^0108"), "ì¸ì¦",
    match(logid, "^0109"), "VPN",
    1=1, "ê¸°íƒ€")
| eval description = coalesce(logdesc, msg, "Critical event")
| eval line1 = "*FortiGate " + upper(severity) + " - " + event_type + "*"
| eval line2 = "ì¥ë¹„: " + device
| eval line3 = "LogID: " + logid
| eval line4 = "ì„¤ëª…: " + description
| eval alert_message = line1 + " | " + line2 + " | " + line3 + " | " + line4
| fields - line1, line2, line3, line4
| table event_time, device, event_type, severity, logid, description, alert_message
| rename event_time as "ì‹œê°„", device as "ì¥ë¹„", event_type as "ì´ë²¤íŠ¸ìœ í˜•", severity as "ì‹¬ê°ë„", description as "ì„¤ëª…", alert_message as "ì•Œë¦¼ë©”ì‹œì§€"
| head 50
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">50</option>
        <option name="drilldown">cell</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="ì‹¬ê°ë„">
          <colorPalette type="map">{"emergency":#DC4E41,"alert":#DC4E41,"critical":#DC4E41,"error":#F8BE34,"warning":#F7BC38,"notice":#6DB7C6,"information":#53A051,"info":#53A051,"debug":#87CEEB}</colorPalette>
        </format>
        <format type="color" field="ì´ë²¤íŠ¸ìœ í˜•">
          <colorPalette type="map">{"ì‹œìŠ¤í…œìƒíƒœ":#6DB7C6,"HAì´ë²¤íŠ¸":#F7BC38,"ì¸í„°í˜ì´ìŠ¤":#65A637,"ì„±ëŠ¥í†µê³„":#A569BD,"ë¡œê·¸":#87CEEB,"ì¸ì¦":#F8BE34,"VPN":#8B4789,"ê¸°íƒ€":#CCCCCC}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 5: ìš´ì˜ ì´ë²¤íŠ¸ ì°¨íŠ¸ -->
  <row>
    <panel>
      <title>ğŸ“ˆ ì´ë²¤íŠ¸ ì¶”ì´</title>
      <chart>
        <search>
          <query>
index=fortianalyzer earliest=$time_picker.earliest$ latest=$time_picker.latest$ type=event subtype=system logid!=0100044546 logid!=0100044547 NOT cfgpath=*
| timechart span=1h count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.axisTitleY.text">ì´ë²¤íŠ¸ ìˆ˜</option>
        <option name="charting.seriesColors">[0x6DB7C6]</option>
      </chart>
    </panel>

    <panel>
      <title>âš ï¸ ì‹¬ê°ë„ë³„ ë¶„í¬</title>
      <chart>
        <search>
          <query>
index=fortianalyzer earliest=$time_picker.earliest$ latest=$time_picker.latest$ type=event subtype=system logid!=0100044546 logid!=0100044547 NOT cfgpath=*
| eval severity = coalesce(level, "info")
| stats count by severity
| rename severity as "ì‹¬ê°ë„"
| sort -count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.axisTitleY.text">ì´ë²¤íŠ¸ ìˆ˜</option>
        <option name="charting.seriesColors">[0xF7BC38,0xDC4E41,0x53A051,0x6DB7C6]</option>
      </chart>
    </panel>
  </row>

  <!-- Row 6: Critical/Error ì´ë²¤íŠ¸ -->
  <row>
    <panel>
      <title>ğŸš¨ Critical ì´ë²¤íŠ¸ë§Œ (Update/Host Fail ì œì™¸, ìµœê·¼ 30ê°œ)</title>
      <table>
        <search>
          <query>
index=fortianalyzer earliest=$time_picker.earliest$ latest=$time_picker.latest$ type=event subtype=system level=critical
| search NOT msg="*Update Fail*" NOT msg="*Host Fail*"
| eval event_time = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval device = coalesce(devname, "Unknown")
| eval severity = coalesce(level, "critical")
| eval event_type = case(
    match(logid, "^0103"), "HA",
    match(logid, "^0104"), "ì‹œìŠ¤í…œ",
    match(logid, "^0105"), "ì¸í„°í˜ì´ìŠ¤",
    match(logid, "^0106"), "ì„±ëŠ¥",
    1=1, "ê¸°íƒ€")
| eval description = coalesce(logdesc, msg, "Critical event")
| eval line1 = "*FortiGate " + upper(severity) + " - " + event_type + "*"
| eval line2 = "ì¥ë¹„: " + device
| eval line3 = "LogID: " + logid
| eval line4 = "ì„¤ëª…: " + description
| eval alert_message = line1 + " | " + line2 + " | " + line3 + " | " + line4
| fields - line1, line2, line3, line4
| table event_time, device, severity, logid, description, alert_message
| rename event_time as "ì‹œê°„", device as "ì¥ë¹„", severity as "ì‹¬ê°ë„", description as "ì„¤ëª…", alert_message as "ì•Œë¦¼ë©”ì‹œì§€"
| head 30
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">30</option>
        <option name="drilldown">cell</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="ì‹¬ê°ë„">
          <colorPalette type="map">{"emergency":#DC4E41,"alert":#DC4E41,"critical":#DC4E41,"error":#F8BE34}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

</form>
