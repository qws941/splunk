<form version="1.1" theme="dark">
  <label>FortiGate Alerts Monitoring</label>
  <description>Production alerts performance and effectiveness monitoring</description>

  <!-- Time Range Picker -->
  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="time_token">
      <label>Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>

  <!-- Row 1: Alert Execution Overview -->
  <row>
    <panel>
      <title>üîî Total Alerts Fired (Last 24h)</title>
      <single>
        <search>
          <query>
index=_internal source=*scheduler.log savedsearch_name="*.[alert]*"
| stats count as total_alerts
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[0,50,100,200]</option>
        <option name="underLabel">Total Executions</option>
        <option name="useColors">1</option>
        <option name="unit">alerts</option>
      </single>
    </panel>

    <panel>
      <title>‚úÖ Success Rate</title>
      <single>
        <search>
          <query>
index=_internal source=*scheduler.log savedsearch_name="*.[alert]*"
| stats count(eval(status="success")) as success, count as total
| eval success_rate = round(success/total*100, 1)
| fields success_rate
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">1</option>
        <option name="rangeColors">["0xD93F3C","0xF58F39","0xF7BC38","0x65A637"]</option>
        <option name="rangeValues">[70,85,95]</option>
        <option name="underLabel">Success Rate</option>
        <option name="useColors">1</option>
        <option name="unit">%</option>
      </single>
    </panel>

    <panel>
      <title>‚è±Ô∏è Avg Execution Time</title>
      <single>
        <search>
          <query>
index=_internal source=*scheduler.log savedsearch_name="*.[alert]*"
| stats avg(run_time) as avg_time
| eval avg_time = round(avg_time, 2)
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">2</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[5,15,30]</option>
        <option name="underLabel">Seconds</option>
        <option name="useColors">1</option>
        <option name="unit">sec</option>
      </single>
    </panel>

    <panel>
      <title>üîï Suppressed Alerts</title>
      <single>
        <search>
          <query>
index=_internal source=*scheduler.log savedsearch_name="*.[alert]*" suppressed=1
| stats count as suppressed
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[0,20,50,100]</option>
        <option name="underLabel">Duplicates Prevented</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>

  <!-- Row 2: Alert Frequency by Type -->
  <row>
    <panel>
      <title>üìä Alert Execution Count by Type (Last 24h)</title>
      <chart>
        <search>
          <query>
index=_internal source=*scheduler.log savedsearch_name="*.[alert]*"
| rex field=savedsearch_name "FortiGate_(?&lt;alert_type&gt;.*)_Production|FortiAnalyzer_(?&lt;alert_type&gt;.*)_Production"
| stats count by alert_type
| sort -count
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.axisTitleX.text">Alert Type</option>
        <option name="charting.axisTitleY.text">Execution Count</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.chart.showDataLabels">all</option>
        <option name="charting.seriesColors">[0x1E88E5,0x43A047,0xFB8C00,0xE53935,0x8E24AA,0x00ACC1,0xFDD835,0x3949AB,0x6D4C41,0x546E7A]</option>
      </chart>
    </panel>
  </row>

  <!-- Row 3: Alert Timeline -->
  <row>
    <panel>
      <title>üìà Alert Execution Timeline (Hourly)</title>
      <chart>
        <search>
          <query>
index=_internal source=*scheduler.log savedsearch_name="*.[alert]*"
| rex field=savedsearch_name "FortiGate_(?&lt;alert_type&gt;.*)_Production|FortiAnalyzer_(?&lt;alert_type&gt;.*)_Production"
| timechart span=1h count by alert_type limit=10
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Alert Count</option>
        <option name="charting.legend.placement">bottom</option>
      </chart>
    </panel>
  </row>

  <!-- Row 4: Alert Performance -->
  <row>
    <panel>
      <title>‚ö° Alert Execution Time by Type (Avg Seconds)</title>
      <chart>
        <search>
          <query>
index=_internal source=*scheduler.log savedsearch_name="*.[alert]*"
| rex field=savedsearch_name "FortiGate_(?&lt;alert_type&gt;.*)_Production|FortiAnalyzer_(?&lt;alert_type&gt;.*)_Production"
| stats avg(run_time) as avg_time by alert_type
| eval avg_time = round(avg_time, 2)
| sort -avg_time
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.axisTitleX.text">Avg Execution Time (sec)</option>
        <option name="charting.axisTitleY.text">Alert Type</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.chart.showDataLabels">all</option>
        <option name="charting.seriesColors">[0x1E88E5]</option>
      </chart>
    </panel>

    <panel>
      <title>üéØ Alert Success vs Failure</title>
      <chart>
        <search>
          <query>
index=_internal source=*scheduler.log savedsearch_name="*.[alert]*"
| rex field=savedsearch_name "FortiGate_(?&lt;alert_type&gt;.*)_Production|FortiAnalyzer_(?&lt;alert_type&gt;.*)_Production"
| stats count(eval(status="success")) as Success, count(eval(status!="success")) as Failure by alert_type
| sort -Success
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.axisTitleX.text">Alert Type</option>
        <option name="charting.axisTitleY.text">Count</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.fieldColors">{"Success":"0x65A637","Failure":"0xD93F3C"}</option>
      </chart>
    </panel>
  </row>

  <!-- Row 5: Recent Alert Executions -->
  <row>
    <panel>
      <title>üìã Recent Alert Executions (Last 50)</title>
      <table>
        <search>
          <query>
index=_internal source=*scheduler.log savedsearch_name="*.[alert]*"
| rex field=savedsearch_name "FortiGate_(?&lt;alert_type&gt;.*)_Production|FortiAnalyzer_(?&lt;alert_type&gt;.*)_Production"
| eval execution_time = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval run_time_sec = round(run_time, 2)
| eval result_count = coalesce(result_count, 0)
| table execution_time, alert_type, status, run_time_sec, result_count, suppressed
| rename execution_time as "Execution Time", alert_type as "Alert Type", status as "Status", run_time_sec as "Duration (sec)", result_count as "Results", suppressed as "Suppressed"
| head 50
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="count">20</option>
        <format type="color" field="Status">
          <colorPalette type="map">{"success":"#65A637","failure":"#D93F3C","skipped":"#F7BC38"}</colorPalette>
        </format>
        <format type="color" field="Duration (sec)">
          <colorPalette type="minMidMax" maxColor="#D93F3C" minColor="#65A637" midColor="#F7BC38"></colorPalette>
          <scale type="minMidMax" minValue="0" maxValue="30" midValue="15"></scale>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 6: Suppression Effectiveness -->
  <row>
    <panel>
      <title>üîï Suppression Effectiveness by Alert Type</title>
      <chart>
        <search>
          <query>
index=_internal source=*scheduler.log savedsearch_name="*.[alert]*"
| rex field=savedsearch_name "FortiGate_(?&lt;alert_type&gt;.*)_Production|FortiAnalyzer_(?&lt;alert_type&gt;.*)_Production"
| stats count(eval(suppressed=1)) as Suppressed, count(eval(suppressed!=1)) as Fired by alert_type
| eval total = Suppressed + Fired
| eval suppression_rate = round(Suppressed/total*100, 1)
| fields alert_type, Fired, Suppressed, suppression_rate
| sort -suppression_rate
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.axisTitleX.text">Alert Type</option>
        <option name="charting.axisTitleY.text">Count</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.fieldColors">{"Fired":"0x1E88E5","Suppressed":"0xFB8C00"}</option>
      </chart>
    </panel>

    <panel>
      <title>üìä Suppression Rate (%)</title>
      <table>
        <search>
          <query>
index=_internal source=*scheduler.log savedsearch_name="*.[alert]*"
| rex field=savedsearch_name "FortiGate_(?&lt;alert_type&gt;.*)_Production|FortiAnalyzer_(?&lt;alert_type&gt;.*)_Production"
| stats count(eval(suppressed=1)) as suppressed_count, count as total_count by alert_type
| eval suppression_rate = round(suppressed_count/total_count*100, 1)
| eval effectiveness = case(
    suppression_rate &gt;= 50, "üî¥ Too High (check thresholds)",
    suppression_rate &gt;= 30, "üü° Moderate",
    suppression_rate &gt;= 10, "üü¢ Good",
    1=1, "‚úÖ Excellent")
| table alert_type, total_count, suppressed_count, suppression_rate, effectiveness
| rename alert_type as "Alert Type", total_count as "Total", suppressed_count as "Suppressed", suppression_rate as "Suppression %", effectiveness as "Assessment"
| sort -suppression_rate
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <format type="color" field="Suppression %">
          <colorPalette type="minMidMax" maxColor="#D93F3C" minColor="#65A637" midColor="#F7BC38"></colorPalette>
          <scale type="minMidMax" minValue="0" maxValue="50" midValue="25"></scale>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 7: Slack Notification Status -->
  <row>
    <panel>
      <title>üí¨ Slack Notification Success Rate</title>
      <single>
        <search>
          <query>
index=_internal source=*slack* action=slack
| stats count(eval(status="success" OR result="success")) as success, count as total
| eval success_rate = round(success/total*100, 1)
| fields success_rate
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">1</option>
        <option name="rangeColors">["0xD93F3C","0xF58F39","0xF7BC38","0x65A637"]</option>
        <option name="rangeValues">[70,85,95]</option>
        <option name="underLabel">Slack Delivery Rate</option>
        <option name="useColors">1</option>
        <option name="unit">%</option>
      </single>
    </panel>

    <panel>
      <title>üì® Total Slack Messages Sent</title>
      <single>
        <search>
          <query>
index=_internal source=*slack* action=slack
| stats count as total_messages
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">Messages</option>
        <option name="useColors">0</option>
      </single>
    </panel>

    <panel>
      <title>‚ùå Slack Failures</title>
      <table>
        <search>
          <query>
index=_internal source=*slack* action=slack (status=failure OR result=failure OR error=*)
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval error_msg = coalesce(error, message, "Unknown error")
| table timestamp, savedsearch_name, error_msg
| rename timestamp as "Time", savedsearch_name as "Alert", error_msg as "Error Message"
| head 20
          </query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>

  <!-- Row 8: Alert Configuration Summary -->
  <row>
    <panel>
      <title>‚öôÔ∏è Alert Configuration Overview</title>
      <html>
        <div style="padding: 20px; font-family: monospace;">
          <h3 style="color: #1E88E5;">üìã Production Alerts Configuration</h3>

          <h4 style="color: #43A047; margin-top: 20px;">üü¢ Real-time Alerts (6)</h4>
          <ul>
            <li><strong>Alert #1 - Config Change:</strong> rt-1m/rt, Suppression: 5m</li>
            <li><strong>Alert #2 - System Critical:</strong> rt-1m/rt, Suppression: 1h</li>
            <li><strong>Alert #3 - Traffic Anomaly:</strong> rt-1m/rt, Suppression: 30m (Threshold: 10GB)</li>
            <li><strong>Alert #4 - VPN Failure:</strong> rt-1m/rt, Suppression: 30m</li>
            <li><strong>Alert #8 - LogDev Warning:</strong> rt-1m/rt, Suppression: 12h</li>
            <li><strong>Alert #10 - Metrics Anomaly:</strong> rt-1m/rt, Suppression: 30m (2x baseline)</li>
          </ul>

          <h4 style="color: #FDD835; margin-top: 20px;">üü° Summary-Only Alerts (3)</h4>
          <ul>
            <li><strong>Alert #6 - Security Rating:</strong> Daily 9 AM, No Slack</li>
            <li><strong>Alert #7 - User Activity:</strong> Hourly, No Slack (DISABLED)</li>
            <li><strong>Alert #9 - Event Summary:</strong> Hourly, No Slack</li>
          </ul>

          <h4 style="color: #D93F3C; margin-top: 20px;">üî¥ Disabled Alerts (1)</h4>
          <ul>
            <li><strong>Alert #5 - FAZ Login Failure:</strong> DISABLED (not critical)</li>
          </ul>

          <h4 style="color: #8E24AA; margin-top: 20px;">üìä Key Metrics</h4>
          <ul>
            <li><strong>Total Alerts:</strong> 10 (6 active Slack, 3 summary-only, 1 disabled)</li>
            <li><strong>Execution Frequency:</strong> Every minute for real-time alerts</li>
            <li><strong>Average Suppression:</strong> Config: 5m, Traffic: 30m, System: 1h, LogDev: 12h</li>
            <li><strong>Over-alarm Prevention:</strong> Config 90% ‚Üì, Traffic 80% ‚Üì, LogDev 83% ‚Üì</li>
          </ul>

          <h4 style="color: #00ACC1; margin-top: 20px;">üéØ Deployment Status</h4>
          <p>‚úÖ Latest commit: <code>4b3ac99</code> - Real-time + Smart detection + Over-alarm prevention</p>
          <p>üìÅ Config file: <code>configs/savedsearches-fortigate-production-alerts.conf</code></p>
          <p>üöÄ Deploy: <code>/opt/splunk/bin/splunk reload saved-searches -auth admin:password</code></p>
        </div>
      </html>
    </panel>
  </row>
</form>
