<?xml version="1.0" encoding="UTF-8"?>
<form version="1.1" theme="dark">
  <label>ðŸ”” Slack Alert Control for Correlation Rules</label>
  <description>Control Slack notifications for security correlation rules. Enable/disable alerts individually or all at once.</description>

  <row>
    <panel>
      <title>Slack Alert Status &amp; Controls</title>
      <html>
        <div id="slack-control-panel">
          <div style="margin: 20px 0; padding: 20px; background: #f5f5f5; border-radius: 8px;">
            <h3 style="margin-top: 0;">ðŸ“Š Correlation Rules Alert Status</h3>
            <div id="status-container" style="margin: 15px 0;">Loading...</div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
              <button onclick="toggleAllSlackAlerts('enable')" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">âœ… Enable All Alerts</button>
              <button onclick="toggleAllSlackAlerts('disable')" style="padding: 12px 24px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">ðŸ”´ Disable All Alerts</button>
              <button onclick="refreshStatus()" style="padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">ðŸ”„ Refresh Status</button>
            </div>

            <div id="individual-controls" style="margin-top: 25px;">
              <h4>Individual Rule Controls</h4>
              <div id="rules-container"></div>
            </div>

            <div id="result-message" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
          </div>
        </div>

        <script><![CDATA[
require(['jquery', 'splunkjs/ready!'], function($, mvc) {
    const CORRELATION_RULES = [
        'Correlation_Multi_Factor_Threat_Score',
        'Correlation_Repeated_High_Risk_Events',
        'Correlation_Weak_Signal_Combination',
        'Correlation_Geo_Attack_Pattern',
        'Correlation_Time_Based_Anomaly',
        'Correlation_Cross_Event_Type'
    ];

    const RULE_LABELS = {
        'Correlation_Multi_Factor_Threat_Score': 'ðŸŽ¯ Multi-Factor Threat Score',
        'Correlation_Repeated_High_Risk_Events': 'ðŸ” Repeated High Risk Events',
        'Correlation_Weak_Signal_Combination': 'ðŸ“¡ Weak Signal Combination',
        'Correlation_Geo_Attack_Pattern': 'ðŸŒ Geo Attack Pattern',
        'Correlation_Time_Based_Anomaly': 'â° Time-Based Anomaly',
        'Correlation_Cross_Event_Type': 'ðŸ”€ Cross Event Type'
    };

    let currentStatus = {};

    function showMessage(message, type) {
        const resultDiv = $('#result-message');
        resultDiv.removeClass('alert-success alert-danger alert-info')
                 .addClass('alert-' + type)
                 .text(message)
                 .show();
        setTimeout(() => resultDiv.fadeOut(), 5000);
    }

    function refreshStatus() {
        $('#status-container').html('<div style="color: #007bff;">ðŸ”„ Loading status...</div>');

        let completed = 0;
        const total = CORRELATION_RULES.length;

        CORRELATION_RULES.forEach(function(ruleName) {
            $.ajax({
                url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ruleName,
                type: 'GET',
                success: function(response) {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(response, 'text/xml');
                    const slackValue = $(xmlDoc).find('s\\:key[name="action.slack"]').text();
                    currentStatus[ruleName] = slackValue === '1';

                    completed++;
                    if (completed === total) {
                        renderStatus();
                    }
                },
                error: function() {
                    currentStatus[ruleName] = false;
                    completed++;
                    if (completed === total) {
                        renderStatus();
                    }
                }
            });
        });
    }

    function renderStatus() {
        const enabled = Object.values(currentStatus).filter(v => v).length;
        const total = CORRELATION_RULES.length;

        let statusHtml = '<div style="font-size: 18px; font-weight: bold; color: ';
        statusHtml += enabled === total ? '#28a745' : enabled === 0 ? '#dc3545' : '#f7bc38';
        statusHtml += ';">' + enabled + ' / ' + total + ' rules enabled</div>';

        $('#status-container').html(statusHtml);

        let rulesHtml = '';
        CORRELATION_RULES.forEach(function(ruleName) {
            const isEnabled = currentStatus[ruleName];
            const statusBadge = isEnabled ?
                '<span style="color: #28a745; font-weight: bold;">ðŸŸ¢ ON</span>' :
                '<span style="color: #dc3545; font-weight: bold;">ðŸ”´ OFF</span>';

            rulesHtml += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; margin: 5px 0; background: white; border-radius: 4px; border: 1px solid #ddd;">';
            rulesHtml += '<span style="flex: 1;">' + RULE_LABELS[ruleName] + '</span>';
            rulesHtml += '<span style="width: 80px; text-align: center;">' + statusBadge + '</span>';
            rulesHtml += '<button onclick="toggleSingleRule(\'' + ruleName + '\', ' + !isEnabled + ')" style="padding: 6px 16px; background: ' + (isEnabled ? '#dc3545' : '#28a745') + '; color: white; border: none; border-radius: 4px; cursor: pointer;">';
            rulesHtml += isEnabled ? 'Disable' : 'Enable';
            rulesHtml += '</button>';
            rulesHtml += '</div>';
        });

        $('#rules-container').html(rulesHtml);
    }

    window.toggleAllSlackAlerts = function(action) {
        const slackValue = action === 'enable' ? '1' : '0';
        const actionText = action === 'enable' ? 'Enabling' : 'Disabling';

        showMessage(actionText + ' all Slack alerts...', 'info');

        let completed = 0;
        const total = CORRELATION_RULES.length;

        CORRELATION_RULES.forEach(function(ruleName, index) {
            setTimeout(function() {
                $.ajax({
                    url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ruleName,
                    type: 'POST',
                    data: {
                        'action.slack': slackValue
                    },
                    success: function() {
                        currentStatus[ruleName] = action === 'enable';
                        completed++;
                        if (completed === total) {
                            showMessage('âœ… Successfully ' + (action === 'enable' ? 'enabled' : 'disabled') + ' all Slack alerts', 'success');
                            refreshStatus();
                        }
                    },
                    error: function(xhr) {
                        completed++;
                        if (completed === total) {
                            showMessage('âš ï¸ Some alerts failed to update. Check permissions.', 'danger');
                            refreshStatus();
                        }
                    }
                });
            }, index * 200);
        });
    };

    window.toggleSingleRule = function(ruleName, enable) {
        const slackValue = enable ? '1' : '0';
        const actionText = enable ? 'Enabling' : 'Disabling';

        showMessage(actionText + ' ' + RULE_LABELS[ruleName] + '...', 'info');

        $.ajax({
            url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ruleName,
            type: 'POST',
            data: {
                'action.slack': slackValue
            },
            success: function() {
                currentStatus[ruleName] = enable;
                showMessage('âœ… Successfully ' + (enable ? 'enabled' : 'disabled') + ' ' + RULE_LABELS[ruleName], 'success');
                renderStatus();
            },
            error: function() {
                showMessage('âŒ Failed to update ' + RULE_LABELS[ruleName] + '. Check permissions.', 'danger');
            }
        });
    };

    window.refreshStatus = refreshStatus;
    refreshStatus();
});
        ]]></script>

        <style>
.alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        </style>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>ðŸ“‹ Usage Instructions</title>
      <html>
        <div style="padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
          <h4 style="margin-top: 0;">How to Use This Dashboard</h4>
          <ul style="line-height: 1.8;">
            <li><strong>âœ… Enable All Alerts:</strong> Turn on Slack notifications for all 6 correlation rules</li>
            <li><strong>ðŸ”´ Disable All Alerts:</strong> Turn off Slack notifications for all rules (useful during maintenance)</li>
            <li><strong>ðŸ”„ Refresh Status:</strong> Reload current alert status from Splunk</li>
            <li><strong>Individual Controls:</strong> Toggle each rule independently using the Enable/Disable buttons</li>
          </ul>
          <p style="margin-bottom: 0;"><strong>Note:</strong> Changes take effect immediately. The correlation rules continue to run; only Slack notifications are controlled.</p>
        </div>
      </html>
    </panel>
  </row>
</form>
