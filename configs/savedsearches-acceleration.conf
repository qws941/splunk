# Splunk Saved Searches - Search Acceleration & Summary Indexing
# Location: $SPLUNK_HOME/etc/apps/fortigate/local/savedsearches.conf
#
# These saved searches provide accelerated access to FortiGate analytics through:
# 1. Summary Indexing - Pre-calculated daily/hourly statistics
# 2. Report Acceleration - Cached results for frequent queries
# 3. Scheduled Reports - Regular statistical summaries
#
# Installation:
# 1. Merge this file with existing savedsearches.conf (or create new)
# 2. Reload Splunk: splunk restart splunkweb
# 3. Verify in Splunk Web UI: Settings → Searches, reports, and alerts
#
# Performance Impact:
# - Query speed: 10-50x faster for historical data
# - Storage cost: ~5-10% of raw data size
# - CPU usage: Minimal (scheduled during off-peak hours)
#
# Phase 3.3 - Search Acceleration

# ============================================================================
# Category 1: Summary Indexing (Daily Statistics)
# ============================================================================
# Pre-calculated statistics stored in dedicated summary index for fast retrieval

[Fortinet_Daily_Security_Summary]
description = Daily security event statistics summary (severity, action, device)
search = index=fw earliest=-1d@d latest=@d \
| stats count as event_count, \
    sum(bytes_sent) as total_bytes_sent, \
    sum(bytes_received) as total_bytes_received, \
    dc(src_ip) as unique_src_ips, \
    dc(dst_ip) as unique_dst_ips \
  by severity, action, devname, date_mday, date_month, date_year \
| eval summary_date = date_year."-".date_month."-".date_mday \
| collect index=summary_fw addtime=true marker="search_name=Fortinet_Daily_Security_Summary"

# Schedule: Run daily at 1 AM
cron_schedule = 0 1 * * *
enableSched = 1

# Alert settings (optional notification on completion)
alert.track = 0
dispatch.earliest_time = -1d@d
dispatch.latest_time = @d

# Acceleration (caching for fast re-run)
auto_summarize = 1
auto_summarize.dispatch.earliest_time = -7d

# ============================================================================
[Fortinet_Hourly_Traffic_Summary]
description = Hourly traffic analysis summary (bandwidth, protocols, top talkers)
search = index=fw earliest=-1h@h latest=@h \
| stats sum(bytes_sent) as bytes_sent, \
    sum(bytes_received) as bytes_received, \
    count as session_count, \
    values(protocol) as protocols, \
    values(service) as services \
  by src_ip, dst_ip, date_hour, date_mday, date_month \
| eval summary_hour = date_month."/".date_mday." ".date_hour.":00" \
| collect index=summary_fw addtime=true marker="search_name=Fortinet_Hourly_Traffic_Summary"

# Schedule: Run hourly at 5 minutes past the hour
cron_schedule = 5 * * * *
enableSched = 1

dispatch.earliest_time = -1h@h
dispatch.latest_time = @h

auto_summarize = 1
auto_summarize.dispatch.earliest_time = -7d

# ============================================================================
[Fortinet_Attack_Type_Summary]
description = Daily summary of attack types and counts for threat analysis
search = index=fw (msg="*intrusion*" OR msg="*malware*" OR msg="*SQL*" OR msg="*brute*") earliest=-1d@d latest=@d \
| eval attack_type = case( \
    msg LIKE "%intrusion%" OR msg LIKE "%IPS%", "intrusion_attempt", \
    msg LIKE "%malware%" OR msg LIKE "%virus%", "malware_detected", \
    msg LIKE "%SQL%" OR msg LIKE "%injection%", "web_attack", \
    msg LIKE "%brute%" OR msg LIKE "%login fail%", "brute_force", \
    1=1, "other" \
  ) \
| stats count as attack_count, \
    dc(src_ip) as unique_attackers, \
    values(src_ip) as attacker_ips \
  by attack_type, date_mday, date_month, date_year \
| eval summary_date = date_year."-".date_month."-".date_mday \
| collect index=summary_fw addtime=true marker="search_name=Fortinet_Attack_Type_Summary"

# Schedule: Run daily at 2 AM
cron_schedule = 0 2 * * *
enableSched = 1

dispatch.earliest_time = -1d@d
dispatch.latest_time = @d

auto_summarize = 1
auto_summarize.dispatch.earliest_time = -7d

# ============================================================================
# Category 2: Report Acceleration (Frequently Used Queries)
# ============================================================================
# Cached results for queries used in dashboards and reports

[Fortinet_Blocked_IPs_24h]
description = Top blocked source IPs in last 24 hours (used in dashboard Row 1)
search = index=fw action=deny earliest=-24h \
| stats count as block_count, \
    latest(_time) as last_seen, \
    values(dst_ip) as targets, \
    values(service) as attempted_services \
  by src_ip \
| sort - block_count \
| head 100

# Acceleration settings
auto_summarize = 1
auto_summarize.dispatch.earliest_time = -7d
auto_summarize.cron_schedule = */15 * * * *
auto_summarize.suspend_period = 24h
auto_summarize.timespan = 1h

# Scheduling (regular updates)
cron_schedule = */15 * * * *
enableSched = 1
dispatch.earliest_time = -24h
dispatch.latest_time = now

# ============================================================================
[Fortinet_Critical_Events_7d]
description = Critical security events over last 7 days (dashboard summary panel)
search = index=fw severity=critical earliest=-7d \
| eval attack_type = case( \
    msg LIKE "%intrusion%" OR msg LIKE "%IPS%", "intrusion_attempt", \
    msg LIKE "%malware%" OR msg LIKE "%virus%", "malware_detected", \
    msg LIKE "%exfiltration%" OR msg LIKE "%data leak%", "data_exfiltration", \
    1=1, "other" \
  ) \
| stats count as event_count, \
    dc(src_ip) as unique_sources, \
    latest(_time) as last_occurrence \
  by attack_type, devname \
| sort - event_count

auto_summarize = 1
auto_summarize.dispatch.earliest_time = -30d
auto_summarize.cron_schedule = */30 * * * *
auto_summarize.timespan = 1d

cron_schedule = */30 * * * *
enableSched = 1
dispatch.earliest_time = -7d
dispatch.latest_time = now

# ============================================================================
[Fortinet_Top_Talkers_1h]
description = Top bandwidth consumers in last hour (traffic analysis)
search = index=fw earliest=-1h \
| eval total_bytes = coalesce(bytes_sent, 0) + coalesce(bytes_received, 0) \
| stats sum(total_bytes) as total_traffic, \
    sum(bytes_sent) as outbound, \
    sum(bytes_received) as inbound, \
    count as sessions \
  by src_ip, dst_ip \
| sort - total_traffic \
| head 50 \
| eval total_traffic_mb = round(total_traffic / 1024 / 1024, 2) \
| eval outbound_mb = round(outbound / 1024 / 1024, 2) \
| eval inbound_mb = round(inbound / 1024 / 1024, 2)

auto_summarize = 1
auto_summarize.dispatch.earliest_time = -7d
auto_summarize.cron_schedule = */5 * * * *
auto_summarize.timespan = 1h

cron_schedule = */5 * * * *
enableSched = 1
dispatch.earliest_time = -1h
dispatch.latest_time = now

# ============================================================================
[Fortinet_Allowed_High_Risk_IPs]
description = Allowed traffic from high-risk IPs (requires AbuseIPDB lookup)
search = index=fw action=allow earliest=-1h \
| stats count as allowed_count, sum(bytes_sent) as bytes_sent by src_ip \
| lookup abuseipdb_lookup.csv ip AS src_ip OUTPUT abuse_score, country, isp \
| where abuse_score > 50 \
| sort - abuse_score \
| head 20

auto_summarize = 1
auto_summarize.dispatch.earliest_time = -7d
auto_summarize.cron_schedule = */10 * * * *
auto_summarize.timespan = 1h

cron_schedule = */10 * * * *
enableSched = 1
dispatch.earliest_time = -1h
dispatch.latest_time = now

# ============================================================================
# Category 3: Scheduled Reports (Email/PDF Generation)
# ============================================================================
# Regular reports for stakeholders and compliance

[Fortinet_Weekly_Security_Report]
description = Weekly executive security summary (PDF report sent every Monday)
search = index=fw earliest=-7d@w1 latest=@w1 \
| stats count as total_events, \
    sum(eval(if(action="deny", 1, 0))) as blocked, \
    sum(eval(if(action="allow", 1, 0))) as allowed, \
    sum(eval(if(severity="critical", 1, 0))) as critical, \
    sum(eval(if(severity="high", 1, 0))) as high \
| eval block_rate = round((blocked / total_events) * 100, 2) \
| eval critical_rate = round((critical / total_events) * 100, 2) \
| appendcols [ \
    search index=fw earliest=-7d@w1 latest=@w1 action=deny \
    | top limit=10 src_ip \
    | rename src_ip as "Top Blocked IP", count as "Block Count" \
  ] \
| table total_events, blocked, allowed, block_rate, critical, high, critical_rate, "Top Blocked IP", "Block Count"

# Schedule: Every Monday at 8 AM
cron_schedule = 0 8 * * 1
enableSched = 1

# Email action
action.email = 1
action.email.to = security-team@jclee.me
action.email.subject = Fortinet Weekly Security Report
action.email.format = pdf
action.email.sendpdf = 1
action.email.inline = 1

dispatch.earliest_time = -7d@w1
dispatch.latest_time = @w1

# Alert condition (always send)
counttype = always

# ============================================================================
[Fortinet_Monthly_Threat_Intelligence_Report]
description = Monthly threat intelligence summary with external enrichment
search = index=fw earliest=-30d@d latest=@d \
| lookup abuseipdb_lookup.csv ip AS src_ip OUTPUT abuse_score, country \
| lookup virustotal_lookup.csv hash AS filehash OUTPUT detection_rate, malware_type \
| stats count as events, \
    dc(src_ip) as unique_ips, \
    avg(abuse_score) as avg_abuse_score, \
    sum(eval(if(detection_rate > 0, 1, 0))) as malware_detections \
  by country \
| sort - events \
| head 20

# Schedule: First day of every month at 9 AM
cron_schedule = 0 9 1 * *
enableSched = 1

action.email = 1
action.email.to = security-team@jclee.me, management@jclee.me
action.email.subject = Fortinet Monthly Threat Intelligence Report
action.email.format = pdf
action.email.sendpdf = 1

dispatch.earliest_time = -30d@d
dispatch.latest_time = @d

counttype = always

# ============================================================================
# Category 4: Optimized Dashboard Queries (Base Searches)
# ============================================================================
# Pre-calculated searches for dashboard panels to share computation

[Fortinet_Dashboard_Base_Search]
description = Base search for dashboard panels (shared across multiple panels)
search = index=fw \
| eval severity = case( \
    level="critical", "critical", \
    level="high", "high", \
    level="medium", "medium", \
    1=1, "low" \
  ) \
| eval event_category = case( \
    action="deny", "blocked", \
    action="allow", "allowed", \
    1=1, "other" \
  ) \
| eval attack_type = case( \
    msg LIKE "%intrusion%" OR msg LIKE "%IPS%", "intrusion_attempt", \
    msg LIKE "%malware%" OR msg LIKE "%virus%", "malware_detected", \
    msg LIKE "%SQL%" OR msg LIKE "%injection%", "web_attack", \
    msg LIKE "%brute%" OR msg LIKE "%login fail%", "brute_force", \
    1=1, "other" \
  )

# Acceleration (fast re-runs)
auto_summarize = 1
auto_summarize.dispatch.earliest_time = -7d
auto_summarize.cron_schedule = */10 * * * *
auto_summarize.timespan = 1h

# Not scheduled (used as base search in dashboard XML)
enableSched = 0

# ============================================================================
# IMPORTANT NOTES
# ============================================================================
#
# 1. Summary Index Setup:
#    Before enabling summary indexing searches, create the summary index:
#
#    Settings → Indexes → New Index
#    Index Name: summary_fw
#    Index Data Type: Events
#    Max Size: 10 GB (adjust based on retention needs)
#
# 2. Acceleration Storage:
#    - Formula: (Raw data size) * 0.05 * (Report count)
#    - Example: 100GB raw * 0.05 * 5 reports = 25GB summary storage
#
# 3. Acceleration Build Times:
#    - Initial build: 30 minutes - 2 hours (depends on data volume)
#    - Incremental updates: 1-5 minutes per run
#    - Check progress: Settings → Searches, reports, and alerts → View details
#
# 4. Query Usage in Dashboards:
#    Dashboard panels can reference saved searches:
#
#    <search ref="Fortinet_Blocked_IPs_24h"/>
#
#    This uses the accelerated/cached results instead of re-running the query.
#
# 5. Performance Tuning:
#    - auto_summarize.timespan: Bucket size for summary data
#      * Smaller = More granular but larger storage
#      * Larger = Less granular but smaller storage
#
#    - auto_summarize.cron_schedule: Frequency of acceleration updates
#      * More frequent = Fresher data but higher CPU usage
#      * Less frequent = Lower CPU but stale data
#
# 6. Monitoring Acceleration:
#    index=_internal source=*scheduler.log savedsearch_name=Fortinet_*
#    | stats avg(run_time) as avg_runtime, max(run_time) as max_runtime by savedsearch_name
#
# 7. Disabling Acceleration:
#    If acceleration causes issues (disk space, CPU), disable per search:
#    auto_summarize = 0
#
#    Or globally in limits.conf:
#    [scheduler]
#    auto_summary_perc = 0
#
# 8. Best Practices:
#    - Use summary indexing for daily/weekly aggregations
#    - Use report acceleration for frequent dashboard queries
#    - Set cron_schedule during off-peak hours (1-5 AM)
#    - Monitor disk usage: df -h $SPLUNK_HOME/var/lib/splunk/summary/
#
# 9. Troubleshooting:
#    - Acceleration not running: Check scheduler logs
#    - High disk usage: Reduce retention or disable unused reports
#    - Slow queries: Increase auto_summarize.timespan
#
# 10. Migration Strategy:
#     Phase 1: Enable summary indexing (low risk)
#     Phase 2: Enable report acceleration for top 5 queries
#     Phase 3: Monitor performance and adjust cron schedules
#     Phase 4: Expand acceleration to all dashboard queries
#
# ============================================================================
