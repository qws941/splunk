# Splunk Saved Searches - FortiGate Auto-Block Alert Actions
# Location: $SPLUNK_HOME/etc/apps/fortigate/local/savedsearches.conf
#
# These saved searches automatically trigger IP blocking on FortiGate
# when malicious activity is detected in FortiGate logs.
#
# Installation:
# 1. Copy this file to $SPLUNK_HOME/etc/apps/fortigate/local/savedsearches.conf
# 2. Reload Splunk: splunk restart splunkweb
# 3. Verify in Splunk Web UI: Settings → Searches, reports, and alerts
#
# Phase 3.2 - Automated Response Actions

# ============================================================================
# Alert 1: Auto-Block High-Risk IPs (AbuseIPDB Score > 90)
# ============================================================================
[FortiGate_AutoBlock_HighRisk_IPs]
description = Automatically block IPs with AbuseIPDB abuse_score > 90 that have recent denied traffic
search = index=fw action=deny earliest=-5m \
| stats count as event_count by srcip \
| lookup abuseipdb_lookup.csv ip AS srcip OUTPUT abuse_score, country, isp \
| where abuse_score >= 90 \
| where event_count >= 5 \
| eval reason = "High-risk IP (Abuse Score: " + abuse_score + ", Events: " + event_count + ")" \
| table srcip, abuse_score, country, isp, event_count, reason

# Schedule: Every 5 minutes
cron_schedule = */5 * * * *

# Enable alert
alert.track = 1
enableSched = 1

# Alert condition: Any results found
counttype = number of events
relation = greater than
quantity = 0

# Alert action: Run Python script
action.script = 1
action.script.filename = fortigate_auto_block.py

# Script parameters
action.script.param.action = block
action.script.param.ip_field = srcip
action.script.param.reason_field = reason
action.script.param.approval_required = false
action.script.param.source = splunk

# Alert severity
alert.severity = 5

# Alert digest mode: Individual alerts for each IP
alert.digest_mode = 0

# ============================================================================
# Alert 2: Auto-Block Malware File Sources (VirusTotal Detections)
# ============================================================================
[FortiGate_AutoBlock_Malware_Sources]
description = Automatically block source IPs that transmitted malware files (VirusTotal detection)
search = index=fw filehash=* earliest=-5m \
| lookup virustotal_lookup.csv hash AS filehash OUTPUT threat_category, malware_type, detection_rate \
| where threat_category="malicious" \
| stats count as malware_files, values(malware_type) as malware_types by srcip \
| where malware_files >= 1 \
| eval reason = "Malware source (" + malware_files + " files, Types: " + malware_types + ")" \
| table srcip, malware_files, malware_types, reason

# Schedule: Every 10 minutes
cron_schedule = */10 * * * *

# Enable alert
alert.track = 1
enableSched = 1

# Alert condition: Any results found
counttype = number of events
relation = greater than
quantity = 0

# Alert action: Run Python script
action.script = 1
action.script.filename = fortigate_auto_block.py

# Script parameters
action.script.param.action = block
action.script.param.ip_field = srcip
action.script.param.reason_field = reason
action.script.param.approval_required = false
action.script.param.source = splunk

# Alert severity
alert.severity = 5

# Alert digest mode: Individual alerts
alert.digest_mode = 0

# ============================================================================
# Alert 3: Auto-Block Brute Force Attackers
# ============================================================================
[FortiGate_AutoBlock_BruteForce]
description = Automatically block IPs with excessive failed login attempts
search = index=fw (msg="*Login Fail*" OR msg="*Authentication fail*") earliest=-10m \
| stats count as failed_attempts by srcip \
| where failed_attempts >= 10 \
| eval reason = "Brute force attack (" + failed_attempts + " failed login attempts)" \
| table srcip, failed_attempts, reason

# Schedule: Every 10 minutes
cron_schedule = */10 * * * *

# Enable alert
alert.track = 1
enableSched = 1

# Alert condition: Any results found
counttype = number of events
relation = greater than
quantity = 0

# Alert action: Run Python script
action.script = 1
action.script.filename = fortigate_auto_block.py

# Script parameters
action.script.param.action = block
action.script.param.ip_field = srcip
action.script.param.reason_field = reason
action.script.param.approval_required = false
action.script.param.source = splunk

# Alert severity
alert.severity = 4

# Alert digest mode: Individual alerts
alert.digest_mode = 0

# ============================================================================
# Maintenance: Auto-Unblock Expired Blocks
# ============================================================================
[FortiGate_AutoUnblock_Expired]
description = Automatically unblock IPs after 24 hours (scheduled maintenance)
search = | makeresults | eval dummy=1

# Schedule: Every hour
cron_schedule = 0 * * * *

# Enable alert
alert.track = 1
enableSched = 1

# Alert condition: Always trigger
counttype = always

# Alert action: Run Python script
action.script = 1
action.script.filename = fortigate_auto_block.py

# Script parameters
action.script.param.action = check-auto-unblock
action.script.param.source = splunk

# Alert severity
alert.severity = 2

# ============================================================================
# IMPORTANT NOTES
# ============================================================================
#
# 1. Script Location:
#    Place fortigate_auto_block.py in:
#    $SPLUNK_HOME/etc/apps/fortigate/bin/fortigate_auto_block.py
#
# 2. Environment Variables:
#    Set in $SPLUNK_HOME/etc/apps/fortigate/local/app.conf:
#    [default]
#    FORTIGATE_HOST = fortigate.jclee.me
#    FORTIGATE_PORT = 443
#    FORTIGATE_API_TOKEN = YOUR_API_TOKEN_HERE
#    FORTIGATE_VDOM = root
#    AUTO_UNBLOCK_HOURS = 24
#    SLACK_WEBHOOK_URL = YOUR_SLACK_WEBHOOK_URL
#
# 3. Permissions:
#    chmod +x $SPLUNK_HOME/etc/apps/fortigate/bin/fortigate_auto_block.py
#    chown splunk:splunk $SPLUNK_HOME/etc/apps/fortigate/bin/fortigate_auto_block.py
#
# 4. Testing:
#    Manual test: splunk cmd python fortigate_auto_block.py --action block --ip 192.168.1.100
#    Alert test: Settings → Searches, reports, and alerts → Run manually
#
# 5. Safety:
#    - Whitelist critical IPs in lookups/ip_whitelist.csv
#    - Use --approval-required for production
#    - Monitor audit log: logs/fortigate_auto_block.log
#
# 6. Rollback:
#    - List blocked IPs: python fortigate_auto_block.py --action list-blocked
#    - Manual unblock: python fortigate_auto_block.py --action unblock --ip X.X.X.X
