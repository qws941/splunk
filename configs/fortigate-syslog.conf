###############################################################################
# FortiGate → Splunk via Syslog (Traditional Method)
#
# FortiGate에서 Syslog를 사용하여 Splunk로 로그 전송
# FortiGate → Syslog (UDP/TCP) → Splunk Universal Forwarder → Splunk
###############################################################################

###############################################################################
# Prerequisites
###############################################################################

# 1. Splunk Universal Forwarder installed on syslog server
# 2. Network connectivity: FortiGate → Syslog Server (Port 514)
# 3. Firewall rules allow UDP/TCP 514
# 4. Splunk fw index created


###############################################################################
# Part 1: Basic Syslog Configuration (Single Server)
###############################################################################

config log syslogd setting
    # Enable Syslog
    set status enable

    # Syslog Server
    set server "YOUR_SYSLOG_SERVER_IP"        # IP or FQDN
    set port 514                               # Standard syslog port

    # Protocol
    set mode udp                               # udp | reliable (TCP)

    # Format
    set format default                         # default | csv | cef | rfc5424
    set facility local7                        # Syslog facility

    # Encoding
    set enc-algorithm disable                  # disable | high | low (for encrypted syslog)

    # CSV Specific (if format=csv)
    set csv disable

    # Source IP (optional)
    set source-ip ""                           # Leave empty for auto-select

    # Interface (optional)
    set interface ""                           # Specific outgoing interface
end


###############################################################################
# Part 2: Reliable Syslog (TCP) - Recommended for Production
###############################################################################

config log syslogd setting
    set status enable
    set server "YOUR_SYSLOG_SERVER_IP"
    set port 514
    set mode reliable                          # TCP for guaranteed delivery
    set format rfc5424                         # Structured syslog format
    set facility local7

    # SSL/TLS Encryption (optional)
    set enc-algorithm high                     # AES-256
    set certificate "Fortinet_CA_SSL"          # Client certificate

    # Connection Settings
    set max-log-rate 0                         # 0 = unlimited
    set source-ip ""
end


###############################################################################
# Part 3: Multiple Syslog Servers (High Availability)
###############################################################################

config log syslogd override-setting
    edit "syslog-primary"
        set status enable
        set server "YOUR_PRIMARY_SYSLOG_IP"
        set port 514
        set mode reliable
        set format rfc5424
        set facility local7
        set priority high                      # High priority
    next

    edit "syslog-secondary"
        set status enable
        set server "YOUR_SECONDARY_SYSLOG_IP"
        set port 514
        set mode reliable
        set format rfc5424
        set facility local7
        set priority low                       # Backup server
    next
end


###############################################################################
# Part 4: Log Filtering (What to Send)
###############################################################################

config log syslogd filter
    # Traffic Logs
    set forward-traffic enable                 # Forwarded traffic
    set local-traffic enable                   # Local traffic
    set multicast-traffic enable               # Multicast
    set sniffer-traffic enable                 # Sniffer
    set ztna-traffic enable                    # ZTNA

    # Security Logs
    set anomaly enable                         # Anomaly detection
    set netscan-discovery disable              # Network scan
    set netscan-vulnerability disable          # Vulnerability scan

    # Application Logs
    set voip enable                            # VoIP
    set gtp enable                             # GTP
    set free-style disable                     # Free-style

    # Severity Filter
    set severity information                   # emergency | alert | critical | error | warning | notification | information | debug

    # Filter String
    set filter-type include                    # include | exclude
    set filter "severity>=warning"             # SPL-like filter
end


###############################################################################
# Part 5: Advanced Filtering Examples
###############################################################################

# Example 1: Only Critical Security Events
config log syslogd filter
    set severity critical
    set filter "type=utm OR type=event"
    set filter-type include
end

# Example 2: Exclude Noisy Logs
config log syslogd filter
    set filter "NOT msg contains 'Update Fail' AND NOT msg contains 'Login Fail'"
    set filter-type exclude
end

# Example 3: Specific Log Types
config log syslogd filter
    set dns enable
    set ssh enable
    set ssl enable
    set filter "logid=0000000013 OR logid=0001000014"  # Specific log IDs
end


###############################################################################
# Part 6: Custom Log Format (CSV for Easy Parsing)
###############################################################################

config log syslogd setting
    set status enable
    set server "YOUR_SYSLOG_SERVER_IP"
    set port 514
    set mode reliable
    set format csv                             # CSV format
    set csv enable

    # CSV Configuration
    set custom-field-name field1 field2 field3
    set custom-field-value $date $time $devname
end


###############################################################################
# Part 7: CEF Format (ArcSight Compatible)
###############################################################################

config log syslogd setting
    set status enable
    set server "YOUR_SYSLOG_SERVER_IP"
    set port 514
    set mode reliable
    set format cef                             # Common Event Format
    set facility local7
end


###############################################################################
# Part 8: Memory Buffering (Local Cache)
###############################################################################

config log memory setting
    # Enable local memory buffering
    set status enable

    # Disk Full Behavior
    set diskfull overwrite                     # overwrite | nolog

end

config log memory filter
    # Same filtering options as syslog
    set severity information
    set forward-traffic enable
    set local-traffic enable
end


###############################################################################
# Part 9: FortiAnalyzer Integration (Hybrid Approach)
###############################################################################

# Send to both Syslog AND FortiAnalyzer
config log fortianalyzer setting
    set status enable
    set server "YOUR_FORTIANALYZER_IP"
    set reliable enable
    set upload-option realtime
    set enc-algorithm high
    set conn-timeout 10
end

config log fortianalyzer filter
    # Same logs to both destinations
    set forward-traffic enable
    set local-traffic enable
    set severity information
end


###############################################################################
# Part 10: Splunk Universal Forwarder Configuration
###############################################################################

# On Syslog Server (Linux/Windows):

# Install Splunk Universal Forwarder:
# wget -O splunkforwarder.tgz 'https://download.splunk.com/...'
# tar -xvf splunkforwarder.tgz -C /opt
# /opt/splunkforwarder/bin/splunk start --accept-license

# Configure Syslog Input (inputs.conf):
# [udp://514]
# connection_host = ip
# sourcetype = fortigate:traffic
# index = fw
#
# [tcp://514]
# connection_host = ip
# sourcetype = fortigate:traffic
# index = fw

# Configure Forward to Splunk (outputs.conf):
# [tcpout]
# defaultGroup = splunk_indexers
#
# [tcpout:splunk_indexers]
# server = YOUR_SPLUNK_INDEXER:9997
# compressed = true

# Restart Forwarder:
# /opt/splunkforwarder/bin/splunk restart


###############################################################################
# Part 11: Validation and Testing
###############################################################################

# Test Syslog Connectivity
execute ping YOUR_SYSLOG_SERVER_IP

# Test Syslog Port
execute telnet YOUR_SYSLOG_SERVER_IP 514

# Check Syslog Configuration
get log syslogd setting
get log syslogd filter

# Enable Debug Logging
diagnose debug application syslogd -1
diagnose debug enable

# View Syslog Statistics
diagnose test application syslogd 1

# Display Real-time Logs
execute log filter category 0
execute log filter field severity warning
execute log display

# Check Syslog Connection Status
diagnose log stats


###############################################################################
# Part 12: Log Format Examples
###############################################################################

# Default Format:
# <134>date=2025-10-21 time=14:30:00 devname=FGT-MAIN-01 devid=FG100F12345678 logid=0000000013 type=traffic subtype=forward level=notice vd=root srcip=192.168.1.100 srcport=54321 dstip=8.8.8.8 dstport=443 action=accept

# RFC 5424 Format:
# <134>1 2025-10-21T14:30:00+09:00 FGT-MAIN-01 fortigate - - - date=2025-10-21 time=14:30:00 ...

# CSV Format:
# date,time,devname,devid,logid,type,subtype,level,srcip,dstip,action
# 2025-10-21,14:30:00,FGT-MAIN-01,FG100F12345678,0000000013,traffic,forward,notice,192.168.1.100,8.8.8.8,accept

# CEF Format:
# CEF:0|Fortinet|FortiGate|6.0.0|0000000013|traffic|notice|...


###############################################################################
# Part 13: Troubleshooting
###############################################################################

# Problem: Syslog Connection Refused
# Solution:
#   1. Check firewall rules: execute telnet YOUR_SYSLOG_IP 514
#   2. Verify syslog server is listening: netstat -an | grep 514
#   3. Check source IP routing: get router info routing-table all

# Problem: Logs Not Appearing in Splunk
# Solution:
#   1. Check Splunk UF is running: /opt/splunkforwarder/bin/splunk status
#   2. Verify inputs.conf has UDP/TCP 514 configured
#   3. Check Splunk index: index=fw | head 100
#   4. Review Splunk UF logs: tail -f /opt/splunkforwarder/var/log/splunk/splunkd.log

# Problem: Log Format Parsing Issues
# Solution:
#   1. Use sourcetype = fortigate:traffic (Splunk Add-on for Fortinet)
#   2. Install Fortinet TA: https://splunkbase.splunk.com/app/2846
#   3. Verify field extractions: | fieldsummary

# Problem: High Network Utilization
# Solution:
#   1. Enable filtering: set filter "severity>=warning"
#   2. Use compressed mode: set enc-algorithm high (for TCP)
#   3. Reduce log rate: set max-log-rate 10000


###############################################################################
# Part 14: Performance Tuning
###############################################################################

# Optimize Syslog Performance
config log syslogd setting
    set mode reliable                          # TCP for reliability
    set max-log-rate 50000                     # Limit to 50K logs/sec
    set source-ip "YOUR_MGMT_INTERFACE_IP"     # Dedicated management interface
end

# Buffering Configuration
config system global
    set log-buffer-size 1024                   # MB (default: 256)
end


###############################################################################
# Part 15: Security Best Practices
###############################################################################

# 1. Use Encrypted Syslog (TLS)
config log syslogd setting
    set mode reliable
    set enc-algorithm high
    set certificate "Fortinet_CA_SSL"
end

# 2. Dedicated Management Network
#    Use separate VLAN for log forwarding
#    Isolate from production traffic

# 3. Filter Sensitive Data
config log syslogd filter
    set filter "NOT msg contains 'password'"
end

# 4. Rate Limiting
#    Prevent log flooding attacks
#    set max-log-rate 10000

# 5. High Availability
#    Configure primary + secondary syslog servers
#    Use FortiAnalyzer as backup buffer


###############################################################################
# Part 16: Integration with Splunk Apps
###############################################################################

# Recommended Splunk Apps:
# 1. Splunk Add-on for Fortinet FortiGate (TA-fortinet)
#    https://splunkbase.splunk.com/app/2846
#
# 2. Fortinet Security Fabric App for Splunk
#    https://splunkbase.splunk.com/app/3646
#
# 3. CIM (Common Information Model)
#    Normalizes Fortinet logs to standard fields


###############################################################################
# Summary
###############################################################################

# This configuration provides:
# ✅ Traditional Syslog-based log forwarding
# ✅ Multiple syslog servers for HA
# ✅ Advanced filtering and formatting
# ✅ Splunk Universal Forwarder integration
# ✅ Performance tuning for high-volume logs
# ✅ Security best practices (TLS, filtering)

# Comparison: Syslog vs HEC Direct
#
# Syslog Method:
# ✅ Simple setup, industry standard
# ✅ No FortiAnalyzer required
# ✅ Works with any syslog receiver
# ❌ Requires Universal Forwarder
# ❌ Less structured data format
#
# HEC Direct (see fortianalyzer-hec-direct.conf):
# ✅ Native JSON format
# ✅ Direct to Splunk (no forwarder)
# ✅ Better performance
# ❌ Requires FortiAnalyzer
# ❌ More complex setup

# After applying this config:
# 1. Verify syslog: diagnose test application syslogd 1
# 2. Check Splunk UF: /opt/splunkforwarder/bin/splunk list forward-server
# 3. Search in Splunk: index=fw | head 100

