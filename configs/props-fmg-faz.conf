# Splunk Field Extraction for FortiManager and FortiAnalyzer
# Deploy to: $SPLUNK_HOME/etc/apps/search/local/props.conf
#
# Architecture:
#   - All data in index=fw
#   - Differentiate by sourcetype:
#     * sourcetype=fmg:config (Configuration changes)
#     * sourcetype=fmg:audit (Admin audit logs)
#     * sourcetype=fmg:device (Device inventory)
#     * sourcetype=faz:event (Security events)
#     * sourcetype=faz:traffic (Traffic logs)
#     * sourcetype=faz:utm (UTM logs - IPS/AV/Web)

# ==========================================
# FortiManager - Configuration Changes
# ==========================================
[fmg:config]
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_PREFIX = "timestamp"\s*:\s*"
TIME_FORMAT = %Y-%m-%dT%H:%M:%S
MAX_TIMESTAMP_LOOKAHEAD = 32
TRUNCATE = 10000
KV_MODE = json

# Field extractions for FMG config changes
EXTRACT-fmg_config_fields = "admin":"(?<admin_user>[^"]+)","adom":"(?<adom>[^"]+)","object":"(?<config_object>[^"]+)","operation":"(?<config_operation>[^"]+)","device":"(?<device_name>[^"]+)"

# Field aliases for consistency
FIELDALIAS-fmg_user = admin_user AS user
FIELDALIAS-fmg_action = config_operation AS action

# ==========================================
# FortiManager - Admin Audit Logs
# ==========================================
[fmg:audit]
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_PREFIX = logtime=
TIME_FORMAT = %s
MAX_TIMESTAMP_LOOKAHEAD = 16
TRUNCATE = 10000

# Field extractions for FMG audit logs
EXTRACT-fmg_audit_fields = logtime=(?<log_timestamp>\d+)\s+user="(?<admin_user>[^"]+)"\s+ui=(?<ui_type>\w+)\s+action="(?<admin_action>[^"]+)"\s+status="(?<status>[^"]+)"\s+msg="(?<msg>[^"]+)"

# Field aliases
FIELDALIAS-fmg_audit_user = admin_user AS user
FIELDALIAS-fmg_audit_action = admin_action AS action

# ==========================================
# FortiManager - Device Inventory
# ==========================================
[fmg:device]
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_PREFIX = "timestamp"\s*:\s*"
TIME_FORMAT = %Y-%m-%dT%H:%M:%S
MAX_TIMESTAMP_LOOKAHEAD = 32
TRUNCATE = 10000
KV_MODE = json

# Field extractions for device inventory
EXTRACT-fmg_device_fields = "name":"(?<device_name>[^"]+)","serial":"(?<serial_number>[^"]+)","version":"(?<os_version>[^"]+)","ha_mode":"(?<ha_mode>[^"]+)","conn_status":"(?<connection_status>[^"]+)","ip":"(?<device_ip>[^"]+)"

# Field aliases
FIELDALIAS-fmg_device_host = device_name AS host

# ==========================================
# FortiAnalyzer - Security Events
# ==========================================
[faz:event]
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_PREFIX = date=
TIME_FORMAT = %Y-%m-%d time=%H:%M:%S
MAX_TIMESTAMP_LOOKAHEAD = 32
TRUNCATE = 10000

# Field extractions for FAZ security events
EXTRACT-faz_event_fields = date=(?<event_date>[\d-]+)\s+time=(?<event_time>[\d:]+)\s+devname="(?<device_name>[^"]+)"\s+devid="(?<device_id>[^"]+)"\s+logid="(?<log_id>[^"]+)"\s+type="(?<log_type>[^"]+)"\s+subtype="(?<log_subtype>[^"]+)"\s+level="(?<severity>[^"]+)"\s+vd="(?<vdom>[^"]+)"\s+srcip=(?<src_ip>[\d.]+)\s+srcport=(?<src_port>\d+)\s+dstip=(?<dst_ip>[\d.]+)\s+dstport=(?<dst_port>\d+)\s+srcintf="(?<src_interface>[^"]+)"\s+dstintf="(?<dst_interface>[^"]+)"\s+action="(?<action>[^"]+)"\s+msg="(?<msg>[^"]+)"

# Field aliases for consistency with existing dashboards
FIELDALIAS-faz_event_source = src_ip AS src
FIELDALIAS-faz_event_dest = dst_ip AS dest
FIELDALIAS-faz_event_severity = severity AS log_level

# Lookup for threat intelligence (if AbuseIPDB integration exists)
LOOKUP-abuseipdb_src = abuseipdb_lookup ip AS src_ip OUTPUT abuse_score, country AS src_country
LOOKUP-abuseipdb_dst = abuseipdb_lookup ip AS dst_ip OUTPUT abuse_score AS dst_abuse_score, country AS dst_country

# ==========================================
# FortiAnalyzer - Traffic Logs
# ==========================================
[faz:traffic]
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_PREFIX = date=
TIME_FORMAT = %Y-%m-%d time=%H:%M:%S
MAX_TIMESTAMP_LOOKAHEAD = 32
TRUNCATE = 10000

# Field extractions for FAZ traffic logs
EXTRACT-faz_traffic_fields = date=(?<event_date>[\d-]+)\s+time=(?<event_time>[\d:]+)\s+devname="(?<device_name>[^"]+)"\s+srcip=(?<src_ip>[\d.]+)\s+srcport=(?<src_port>\d+)\s+dstip=(?<dst_ip>[\d.]+)\s+dstport=(?<dst_port>\d+)\s+proto=(?<protocol>\d+)\s+service="(?<service>[^"]+)"\s+policyid=(?<policy_id>\d+)\s+sentbyte=(?<bytes_sent>\d+)\s+rcvdbyte=(?<bytes_received>\d+)\s+duration=(?<session_duration>\d+)

# Field aliases
FIELDALIAS-faz_traffic_source = src_ip AS src
FIELDALIAS-faz_traffic_dest = dst_ip AS dest

# Calculated fields
EVAL-total_bytes = bytes_sent + bytes_received
EVAL-bytes_sent_mb = round(bytes_sent / 1024 / 1024, 2)
EVAL-bytes_received_mb = round(bytes_received / 1024 / 1024, 2)

# ==========================================
# FortiAnalyzer - UTM Logs (IPS/AV/Web/App Control)
# ==========================================
[faz:utm]
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_PREFIX = date=
TIME_FORMAT = %Y-%m-%d time=%H:%M:%S
MAX_TIMESTAMP_LOOKAHEAD = 32
TRUNCATE = 10000

# Field extractions for UTM logs
EXTRACT-faz_utm_fields = date=(?<event_date>[\d-]+)\s+time=(?<event_time>[\d:]+)\s+devname="(?<device_name>[^"]+)"\s+type="utm"\s+subtype="(?<utm_type>[^"]+)"\s+srcip=(?<src_ip>[\d.]+)\s+dstip=(?<dst_ip>[\d.]+)\s+attack="(?<attack_name>[^"]+)"\s+url="(?<url>[^"]+)"\s+attackid=(?<attack_id>\d+)\s+severity="(?<severity>[^"]+)"\s+action="(?<action>[^"]+)"

# Field aliases
FIELDALIAS-faz_utm_source = src_ip AS src
FIELDALIAS-faz_utm_dest = dst_ip AS dest
FIELDALIAS-faz_utm_threat = attack_name AS threat_name

# Calculated fields for threat classification
EVAL-is_critical_threat = if(severity IN ("critical","high"), 1, 0)
EVAL-threat_category = case(
    utm_type="ips", "Intrusion Prevention",
    utm_type="virus", "Antivirus",
    utm_type="webfilter", "Web Filtering",
    utm_type="app-ctrl", "Application Control",
    1=1, "Other")

# ==========================================
# Common Settings for All FortiManager/FortiAnalyzer Data
# ==========================================
[fmg:*]
# Common settings for all FMG sourcetypes
CHARSET = UTF-8
NO_BINARY_CHECK = true
ANNOTATE_PUNCT = false

[faz:*]
# Common settings for all FAZ sourcetypes
CHARSET = UTF-8
NO_BINARY_CHECK = true
ANNOTATE_PUNCT = false

# ==========================================
# Data Model Mapping
# ==========================================
# Security Events → Fortinet_Security data model
# Traffic Logs → Network_Traffic data model
# Config Changes → Change_Management data model

# ==========================================
# Dashboard Query Examples
# ==========================================
# FMG config changes in last 24h:
#   index=fw sourcetype=fmg:config earliest=-24h
#   | stats count by admin_user, config_operation, config_object
#
# FAZ security events with high severity:
#   index=fw sourcetype=faz:event severity IN ("critical","high") earliest=-1h
#   | stats count by src_ip, dst_ip, action, msg
#
# Device inventory status:
#   index=fw sourcetype=fmg:device
#   | dedup device_name
#   | table device_name, serial_number, os_version, ha_mode, connection_status
#
# Traffic top talkers:
#   index=fw sourcetype=faz:traffic earliest=-1h
#   | stats sum(total_bytes) as total_bytes by src_ip
#   | sort -total_bytes
#   | head 10

# ==========================================
# Migration Notes
# ==========================================
# Current: All data in index=fw
# Future: Can split to index=fmg + index=faz by:
#   1. Enable separate indexes in indexes-fmg-faz.conf
#   2. Update inputs.conf with index routing
#   3. Update dashboards with dual queries: (index=fw OR index=fmg) sourcetype=fmg:*
#   4. Deprecate index=fw after 90 days
