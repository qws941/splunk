<form version="1.1" theme="dark">
  <label>ğŸ›¡ï¸ FortiGate Security Dashboard</label>
  <description>Security monitoring - Traffic analysis, correlation detection, and config changes</description>

  <!-- Filters -->
  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="time_picker">
      <label>â° Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>

    <input type="dropdown" token="severity_filter">
      <label>ğŸ”´ Severity</label>
      <choice value="*">All</choice>
      <choice value="critical">Critical</choice>
      <choice value="high">High</choice>
      <choice value="medium">Medium</choice>
      <choice value="low">Low</choice>
      <default>*</default>
    </input>

    <input type="dropdown" token="action_filter">
      <label>âš¡ Action</label>
      <choice value="*">All</choice>
      <choice value="deny">Deny (ì°¨ë‹¨)</choice>
      <choice value="accept">Accept (í—ˆìš©)</choice>
      <default>*</default>
    </input>

    <input type="text" token="src_ip_filter">
      <label>ğŸ“ Source IP (optional)</label>
      <default>*</default>
    </input>
  </fieldset>

  <!-- Row 1: Executive Summary (KPIs) -->
  <row>
    <panel>
      <title>ğŸ“Š Total Events</title>
      <single>
        <search>
          <query>index=fw action=$action_filter$ severity=$severity_filter$ src_ip=$src_ip_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as total_events</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[1000,5000,10000,50000]</option>
        <option name="underLabel">Total Security Events</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
      </single>
    </panel>

    <panel>
      <title>ğŸš« Blocked Events</title>
      <single>
        <search>
          <query>index=fw action=deny severity=$severity_filter$ src_ip=$src_ip_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as blocked_events</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[100,500,1000]</option>
        <option name="underLabel">Deny Actions</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
      </single>
    </panel>

    <panel>
      <title>âœ… Allowed Events</title>
      <single>
        <search>
          <query>index=fw action=accept severity=$severity_filter$ src_ip=$src_ip_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as allowed_events</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38"]</option>
        <option name="rangeValues">[10000,50000]</option>
        <option name="underLabel">Accept Actions</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
      </single>
    </panel>

    <panel>
      <title>ğŸ”´ Critical Threats</title>
      <single>
        <search>
          <query>index=fw severity=critical action=$action_filter$ src_ip=$src_ip_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as critical_count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[10,50,100]</option>
        <option name="underLabel">Critical Severity</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
      </single>
    </panel>
  </row>

  <!-- Row 2: Trends (Traffic Over Time) -->
  <row>
    <panel>
      <title>ğŸ“ˆ Traffic Trend (Allowed vs Blocked)</title>
      <chart>
        <search>
          <query>index=fw action=$action_filter$ severity=$severity_filter$ src_ip=$src_ip_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| timechart span=10m count by action
| fillnull value=0</query>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Event Count</option>
        <option name="charting.fieldColors">{"accept":"#65A637","deny":"#D93F3C"}</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>

    <panel>
      <title>ğŸ¯ Severity Distribution</title>
      <chart>
        <search>
          <query>index=fw action=$action_filter$ src_ip=$src_ip_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count by severity
| sort -count</query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.fieldColors">{"critical":"#D93F3C","high":"#F58F39","medium":"#F7BC38","low":"#6DB7C6","info":"#65A637"}</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>
  </row>

  <!-- Row 3: Correlation Analysis -->
  <row>
    <panel>
      <title>ğŸ”— Correlation Detections (Last 24h)</title>
      <chart>
        <search>
          <query>index=summary_fw marker="correlation_detection=*" earliest=$time_picker.earliest$ latest=$time_picker.latest$
| rex field=marker "correlation_detection=(?&lt;correlation_type&gt;[^,]+)"
| timechart span=1h count by correlation_type</query>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Detection Count</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>

    <panel>
      <title>âš¡ Action Recommendations</title>
      <chart>
        <search>
          <query>index=summary_fw marker="correlation_detection=*" earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count by action_recommendation
| sort -count</query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.fieldColors">{"AUTO_BLOCK":"#D93F3C","REVIEW_AND_BLOCK":"#F58F39","MONITOR":"#6DB7C6"}</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>
  </row>

  <!-- Row 4: Top Threats -->
  <row>
    <panel>
      <title>ğŸ¯ Top 10 Source IPs (Most Active)</title>
      <table>
        <search>
          <query>index=fw action=$action_filter$ severity=$severity_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as event_count,
        dc(dst_ip) as unique_targets,
        values(severity) as severities,
        values(action) as actions
  by src_ip
| eval block_rate = round((tonumber(mvcount(mvfilter(actions=="deny"))) / mvcount(actions)) * 100, 2)
| sort -event_count
| head 10
| rename src_ip as "Source IP", event_count as "Event Count", unique_targets as "Unique Targets", severities as "Severity", block_rate as "Block Rate (%)"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="count">10</option>
        <format type="color" field="Block Rate (%)">
          <colorPalette type="minMidMax" minColor="#65A637" midColor="#F7BC38" maxColor="#D93F3C"></colorPalette>
          <scale type="minMidMax" minType="number" minValue="0" midType="number" midValue="50" maxType="number" maxValue="100"></scale>
        </format>
        <format type="number" field="Event Count">
          <option name="precision">0</option>
        </format>
      </table>
    </panel>

    <panel>
      <title>ğŸ”¥ Top Attack Types</title>
      <table>
        <search>
          <query>index=fw attack=* action=$action_filter$ severity=$severity_filter$ src_ip=$src_ip_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as attack_count,
        dc(src_ip) as unique_sources,
        values(severity) as severities
  by attack
| sort -attack_count
| head 10
| rename attack as "Attack Type", attack_count as "Count", unique_sources as "Unique Sources", severities as "Severity"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="count">10</option>
        <format type="number" field="Count">
          <option name="precision">0</option>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 5: Configuration Changes -->
  <row>
    <panel>
      <title>âš™ï¸ FortiGate Configuration Changes (ì„¤ì • ë³€ê²½ ì´ë ¥)</title>
      <table>
        <search>
          <query>index=fw (logdesc="Admin login successful" OR logdesc="*Configuration*" OR msg="*config*" OR action="config-change")
| eval change_time=strftime(_time, "%Y-%m-%d %H:%M:%S"),
       admin_user=coalesce(user, adminuser, "Unknown"),
       change_type=case(
           match(msg, "(?i)policy"), "Policy Change",
           match(msg, "(?i)address"), "Address Object",
           match(msg, "(?i)service"), "Service Object",
           match(msg, "(?i)route"), "Routing",
           match(msg, "(?i)interface"), "Interface",
           match(msg, "(?i)login"), "Admin Login",
           1=1, "Other Config"
       ),
       source_ip=coalesce(srcip, remip, "N/A")
| table change_time, admin_user, change_type, source_ip, msg
| head 20
| rename change_time as "Time", admin_user as "Admin User", change_type as "Change Type", source_ip as "Source IP", msg as "Details"</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="count">20</option>
        <format type="color" field="Change Type">
          <colorPalette type="map">{"Policy Change":"#D93F3C","Address Object":"#F58F39","Service Object":"#F7BC38","Admin Login":"#6DB7C6","Other Config":"#65A637"}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 6: Network Operations -->
  <row>
    <panel>
      <title>ğŸ”Œ Top 10 Protocols</title>
      <chart>
        <search>
          <query>index=fw action=$action_filter$ severity=$severity_filter$ src_ip=$src_ip_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count by proto
| sort -count
| head 10</query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisTitleX.text">Event Count</option>
        <option name="charting.axisTitleY.text">Protocol</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>

    <panel>
      <title>ğŸ”¢ Top 10 Destination Ports</title>
      <chart>
        <search>
          <query>index=fw action=$action_filter$ severity=$severity_filter$ src_ip=$src_ip_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count by dstport
| sort -count
| head 10</query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisTitleX.text">Event Count</option>
        <option name="charting.axisTitleY.text">Port</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>

    <panel>
      <title>ğŸ“œ Top 10 Firewall Policies (Most Hit)</title>
      <table>
        <search>
          <query>index=fw policyid=* action=$action_filter$ severity=$severity_filter$ src_ip=$src_ip_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as hit_count,
        values(action) as actions,
        dc(src_ip) as unique_sources
  by policyid
| sort -hit_count
| head 10
| rename policyid as "Policy ID", hit_count as "Hit Count", actions as "Actions", unique_sources as "Unique Sources"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="count">10</option>
        <format type="number" field="Hit Count">
          <option name="precision">0</option>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 7: Slack Notifications -->
  <row>
    <panel>
      <title>ğŸ“¢ Slack Alert History (Last 24h)</title>
      <table>
        <search>
          <query>index=_internal source=*scheduler.log action=alert_fired alert_actions=*slack*
| eval alert_time=strftime(_time, "%Y-%m-%d %H:%M:%S")
| table alert_time, savedsearch_name, app, alert_actions
| sort -_time
| head 20
| rename alert_time as "Alert Time", savedsearch_name as "Alert Name", app as "App", alert_actions as "Actions"</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="count">20</option>
      </table>
    </panel>
  </row>

  <!-- Row 8: Recent Blocked Traffic -->
  <row>
    <panel>
      <title>ğŸš« Recently Blocked Traffic (Last 100 Events)</title>
      <table>
        <search>
          <query>index=fw action=deny severity=$severity_filter$ src_ip=$src_ip_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| eval event_time=strftime(_time, "%Y-%m-%d %H:%M:%S")
| table event_time, src_ip, dst_ip, dstport, proto, severity, attack, msg
| head 100
| rename event_time as "Time", src_ip as "Source IP", dst_ip as "Dest IP", dstport as "Port", proto as "Protocol", severity as "Severity", attack as "Attack Type", msg as "Message"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="count">20</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="Severity">
          <colorPalette type="map">{"critical":"#D93F3C","high":"#F58F39","medium":"#F7BC38","low":"#6DB7C6"}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 9: Top Blocked Source IPs (Potential Attackers) -->
  <row>
    <panel>
      <title>âš ï¸ Top 20 Most Blocked Source IPs (Potential Attackers)</title>
      <table>
        <search>
          <query>index=fw action=deny severity=$severity_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as block_count,
        dc(dst_ip) as unique_targets,
        values(severity) as severities,
        values(attack) as attack_types,
        earliest(_time) as first_seen,
        latest(_time) as last_seen
  by src_ip
| eval first_seen=strftime(first_seen, "%Y-%m-%d %H:%M"),
       last_seen=strftime(last_seen, "%Y-%m-%d %H:%M"),
       duration=round((last_seen - first_seen) / 3600, 1)
| sort -block_count
| head 20
| rename src_ip as "Source IP", block_count as "Block Count", unique_targets as "Targets", severities as "Severity", attack_types as "Attack Types", first_seen as "First Seen", last_seen as "Last Seen"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="count">20</option>
        <option name="rowNumbers">true</option>
        <format type="number" field="Block Count">
          <option name="precision">0</option>
        </format>
        <format type="color" field="Block Count">
          <colorPalette type="minMidMax" minColor="#65A637" midColor="#F7BC38" maxColor="#D93F3C"></colorPalette>
          <scale type="minMidMax" minType="number" minValue="10" midType="number" midValue="100" maxType="number" maxValue="1000"></scale>
        </format>
      </table>
    </panel>
  </row>
</form>
