<?xml version="1.0" encoding="UTF-8"?>
<form version="1.1" theme="dark">
  <label>ğŸ¯ FAZ/FMG Unified Monitoring Dashboard</label>
  <description>FortiAnalyzer Critical Logs, FortiManager Configuration Changes &amp; Slack Alert Controls</description>

  <!-- Time Picker -->
  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="time_picker">
      <label>Time Range</label>
      <default>
        <earliest>-60m@m</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>

  <!-- Row 1: Slack Alert Control Panel -->
  <row>
    <panel>
      <title>ğŸ”” Slack Alert Control for FAZ/FMG Rules</title>
      <html>
        <div id="slack-control-panel">
          <div style="margin: 20px 0; padding: 20px; background: #f5f5f5; border-radius: 8px;">
            <h3 style="margin-top: 0;">ğŸ“Š Alert Status</h3>
            <div id="status-container" style="margin: 15px 0;">Loading...</div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
              <button onclick="toggleAllSlackAlerts('enable')" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">âœ… Enable All Alerts</button>
              <button onclick="toggleAllSlackAlerts('disable')" style="padding: 12px 24px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">ğŸ”´ Disable All Alerts</button>
              <button onclick="refreshStatus()" style="padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">ğŸ”„ Refresh Status</button>
            </div>

            <div id="individual-controls" style="margin-top: 25px;">
              <h4>Individual Rule Controls</h4>
              <div id="rules-container"></div>
            </div>

            <div id="result-message" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
          </div>
        </div>

        <script><![CDATA[
require(['jquery', 'splunkjs/ready!'], function($, mvc) {
    const ALERT_RULES = [
        'FAZ_Critical_Alerts',
        'FMG_Policy_Install',
        'FMG_Policy_CRUD',
        'FMG_Object_CRUD'
    ];

    const RULE_LABELS = {
        'FAZ_Critical_Alerts': 'ğŸ”´ FAZ Critical Alerts (Update Fail ì œì™¸)',
        'FMG_Policy_Install': 'ğŸ“¦ FMG Policy Install',
        'FMG_Policy_CRUD': 'ğŸ“ FMG Policy CRUD',
        'FMG_Object_CRUD': 'ğŸ”§ FMG Object CRUD'
    };

    let currentStatus = {};

    function showMessage(message, type) {
        const resultDiv = $('#result-message');
        resultDiv.removeClass('alert-success alert-danger alert-info')
                 .addClass('alert-' + type)
                 .text(message)
                 .show();
        setTimeout(() => resultDiv.fadeOut(), 5000);
    }

    function refreshStatus() {
        $('#status-container').html('<div style="color: #007bff;">ğŸ”„ Loading status...</div>');

        let completed = 0;
        const total = ALERT_RULES.length;

        ALERT_RULES.forEach(function(ruleName) {
            $.ajax({
                url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ruleName,
                type: 'GET',
                success: function(response) {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(response, 'text/xml');
                    const slackValue = $(xmlDoc).find('s\\:key[name="action.slack"]').text();
                    currentStatus[ruleName] = slackValue === '1';

                    completed++;
                    if (completed === total) {
                        renderStatus();
                    }
                },
                error: function() {
                    currentStatus[ruleName] = false;
                    completed++;
                    if (completed === total) {
                        renderStatus();
                    }
                }
            });
        });
    }

    function renderStatus() {
        const enabled = Object.values(currentStatus).filter(v => v).length;
        const total = ALERT_RULES.length;

        let statusHtml = '<div style="font-size: 18px; font-weight: bold; color: ';
        statusHtml += enabled === total ? '#28a745' : enabled === 0 ? '#dc3545' : '#f7bc38';
        statusHtml += ';">' + enabled + ' / ' + total + ' alerts enabled</div>';

        $('#status-container').html(statusHtml);

        let rulesHtml = '';
        ALERT_RULES.forEach(function(ruleName) {
            const isEnabled = currentStatus[ruleName];
            const statusBadge = isEnabled ?
                '<span style="color: #28a745; font-weight: bold;">ğŸŸ¢ ON</span>' :
                '<span style="color: #dc3545; font-weight: bold;">ğŸ”´ OFF</span>';

            rulesHtml += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; margin: 5px 0; background: white; border-radius: 4px; border: 1px solid #ddd;">';
            rulesHtml += '<span style="flex: 1;">' + RULE_LABELS[ruleName] + '</span>';
            rulesHtml += '<span style="width: 80px; text-align: center;">' + statusBadge + '</span>';
            rulesHtml += '<button onclick="toggleSingleRule(\'' + ruleName + '\', ' + !isEnabled + ')" style="padding: 6px 16px; background: ' + (isEnabled ? '#dc3545' : '#28a745') + '; color: white; border: none; border-radius: 4px; cursor: pointer;">';
            rulesHtml += isEnabled ? 'Disable' : 'Enable';
            rulesHtml += '</button>';
            rulesHtml += '</div>';
        });

        $('#rules-container').html(rulesHtml);
    }

    window.toggleAllSlackAlerts = function(action) {
        const slackValue = action === 'enable' ? '1' : '0';
        const actionText = action === 'enable' ? 'Enabling' : 'Disabling';

        showMessage(actionText + ' all Slack alerts...', 'info');

        let completed = 0;
        const total = ALERT_RULES.length;

        ALERT_RULES.forEach(function(ruleName, index) {
            setTimeout(function() {
                $.ajax({
                    url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ruleName,
                    type: 'POST',
                    data: {
                        'action.slack': slackValue
                    },
                    success: function() {
                        currentStatus[ruleName] = action === 'enable';
                        completed++;
                        if (completed === total) {
                            showMessage('âœ… Successfully ' + (action === 'enable' ? 'enabled' : 'disabled') + ' all Slack alerts', 'success');
                            refreshStatus();
                        }
                    },
                    error: function(xhr) {
                        completed++;
                        if (completed === total) {
                            showMessage('âš ï¸ Some alerts failed to update. Check permissions.', 'danger');
                            refreshStatus();
                        }
                    }
                });
            }, index * 200);
        });
    };

    window.toggleSingleRule = function(ruleName, enable) {
        const slackValue = enable ? '1' : '0';
        const actionText = enable ? 'Enabling' : 'Disabling';

        showMessage(actionText + ' ' + RULE_LABELS[ruleName] + '...', 'info');

        $.ajax({
            url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ruleName,
            type: 'POST',
            data: {
                'action.slack': slackValue
            },
            success: function() {
                currentStatus[ruleName] = enable;
                showMessage('âœ… Successfully ' + (enable ? 'enabled' : 'disabled') + ' ' + RULE_LABELS[ruleName], 'success');
                renderStatus();
            },
            error: function() {
                showMessage('âŒ Failed to update ' + RULE_LABELS[ruleName] + '. Check permissions.', 'danger');
            }
        });
    };

    window.refreshStatus = refreshStatus;
    refreshStatus();
});
        ]]></script>

        <style>
.alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        </style>
      </html>
    </panel>
  </row>

  <!-- Row 2: Summary Stats -->
  <row>
    <panel>
      <title>ğŸ”´ FAZ Critical Events (Last Hour)</title>
      <single>
        <search>
          <query>
index=fw sourcetype=faz:* earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search (severity=critical OR level=critical)
| search NOT msg="*Update Fail*"
| search NOT logid IN ("0100032001","0100032002","0100032003","0100032004","0100032005","0101039424","0101039425","0101039426","0101039427","0101039428","0102043008","0102043009","0102043010")
| stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xD93F3C"]</option>
        <option name="rangeValues">[0,5]</option>
        <option name="underLabel">Critical Events</option>
        <drilldown>
          <link target="_blank">/app/search/faz_critical_detail</link>
        </drilldown>
      </single>
    </panel>

    <panel>
      <title>ğŸ“¦ FMG Policy Installs</title>
      <single>
        <search>
          <query>
index=fw sourcetype=fmg:* earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search action=install OR msg="*install*policy*"
| stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38"]</option>
        <option name="rangeValues">[0,3]</option>
        <option name="underLabel">Install Events</option>
      </single>
    </panel>

    <panel>
      <title>ğŸ“ FMG Policy Changes</title>
      <single>
        <search>
          <query>
index=fw sourcetype=fmg:* earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search object="*policy*"
| search operation IN (add,set,delete,create,modify,remove)
| stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xD93F3C"]</option>
        <option name="rangeValues">[0,10]</option>
        <option name="underLabel">Policy CRUD</option>
      </single>
    </panel>

    <panel>
      <title>ğŸ”§ FMG Object Changes</title>
      <single>
        <search>
          <query>
index=fw sourcetype=fmg:* earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search object IN (address,service,vip,addrgrp,servgrp)
| search operation IN (add,set,delete,create,modify,remove)
| stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xD93F3C"]</option>
        <option name="rangeValues">[0,15]</option>
        <option name="underLabel">Object CRUD</option>
      </single>
    </panel>
  </row>

  <!-- Row 3: FAZ Critical Events Detail -->
  <row>
    <panel>
      <title>ğŸ”´ FAZ Critical Events Detail (Top 20)</title>
      <table>
        <search>
          <query>
index=fw sourcetype=faz:* earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search (severity=critical OR level=critical)
| search NOT msg="*Update Fail*"
| search NOT logid IN ("0100032001","0100032002","0100032003","0100032004","0100032005","0101039424","0101039425","0101039426","0101039427","0101039428","0102043008","0102043009","0102043010")
| eval time=strftime(_time, "%Y-%m-%d %H:%M:%S")
| table time, src_ip, dst_ip, severity, logid, msg, devname
| rename time AS "ì‹œê°„", src_ip AS "ì¶œë°œì§€ IP", dst_ip AS "ëª©ì ì§€ IP", severity AS "ì‹¬ê°ë„", logid AS "ë¡œê·¸ID", msg AS "ë©”ì‹œì§€", devname AS "ì¥ë¹„ëª…"
| head 20
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <format type="color" field="ì‹¬ê°ë„">
          <colorPalette type="map">{"critical":#D93F3C}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 4: FAZ Timeline -->
  <row>
    <panel>
      <title>ğŸ“Š FAZ Critical Events Timeline (Last 24 Hours)</title>
      <chart>
        <search>
          <query>
index=fw sourcetype=faz:* earliest=-24h latest=now
| search (severity=critical OR level=critical)
| search NOT msg="*Update Fail*"
| search NOT logid IN ("0100032001","0100032002","0100032003","0100032004","0100032005","0101039424","0101039425","0101039426","0101039427","0101039428","0102043008","0102043009","0102043010")
| timechart span=10m count by severity
          </query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Event Count</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.seriesColors">[0xD93F3C]</option>
        <option name="charting.chart.stackMode">stacked</option>
      </chart>
    </panel>
  </row>

  <!-- Row 5: FMG Policy Install History -->
  <row>
    <panel>
      <title>ğŸ“¦ FMG Policy Install History</title>
      <table>
        <search>
          <query>
index=fw sourcetype=fmg:* earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search action=install OR msg="*install*policy*"
| eval time=strftime(_time, "%Y-%m-%d %H:%M:%S")
| table time, user, adom, device, status, msg
| rename time AS "ì‹œê°„", user AS "ê´€ë¦¬ì", adom AS "ADOM", device AS "ì¥ë¹„", status AS "ìƒíƒœ", msg AS "ë©”ì‹œì§€"
| head 20
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="count">20</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <format type="color" field="ìƒíƒœ">
          <colorPalette type="map">{"success":#65A637,"failed":#D93F3C,"warning":#F7BC38}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 6: FMG Configuration Changes -->
  <row>
    <panel>
      <title>ğŸ“ FMG Policy Changes (CRUD Operations)</title>
      <table>
        <search>
          <query>
index=fw sourcetype=fmg:* earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search object="*policy*"
| search operation IN (add,set,delete,create,modify,remove)
| eval time=strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval operation_kr=case(
    operation="add" OR operation="create", "ìƒì„±",
    operation="set" OR operation="modify", "ìˆ˜ì •",
    operation="delete" OR operation="remove", "ì‚­ì œ",
    1=1, operation)
| table time, operation_kr, user, adom, object, msg
| rename time AS "ì‹œê°„", operation_kr AS "ì‘ì—…", user AS "ê´€ë¦¬ì", adom AS "ADOM", object AS "ê°ì²´", msg AS "ë©”ì‹œì§€"
| head 20
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="count">20</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <format type="color" field="ì‘ì—…">
          <colorPalette type="map">{"ìƒì„±":#65A637,"ìˆ˜ì •":#F7BC38,"ì‚­ì œ":#D93F3C}</colorPalette>
        </format>
      </table>
    </panel>

    <panel>
      <title>ğŸ”§ FMG Object Changes (CRUD Operations)</title>
      <table>
        <search>
          <query>
index=fw sourcetype=fmg:* earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search object IN (address,service,vip,addrgrp,servgrp)
| search operation IN (add,set,delete,create,modify,remove)
| eval time=strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval operation_kr=case(
    operation="add" OR operation="create", "ìƒì„±",
    operation="set" OR operation="modify", "ìˆ˜ì •",
    operation="delete" OR operation="remove", "ì‚­ì œ",
    1=1, operation)
| eval object_kr=case(
    object="address", "ì£¼ì†Œ",
    object="service", "ì„œë¹„ìŠ¤",
    object="vip", "VIP",
    object="addrgrp", "ì£¼ì†Œê·¸ë£¹",
    object="servgrp", "ì„œë¹„ìŠ¤ê·¸ë£¹",
    1=1, object)
| table time, operation_kr, object_kr, user, adom, name, msg
| rename time AS "ì‹œê°„", operation_kr AS "ì‘ì—…", object_kr AS "ê°ì²´íƒ€ì…", user AS "ê´€ë¦¬ì", adom AS "ADOM", name AS "ê°ì²´ëª…", msg AS "ë©”ì‹œì§€"
| head 20
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="count">20</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <format type="color" field="ì‘ì—…">
          <colorPalette type="map">{"ìƒì„±":#65A637,"ìˆ˜ì •":#F7BC38,"ì‚­ì œ":#D93F3C}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 7: Operation Statistics -->
  <row>
    <panel>
      <title>ğŸ“Š FMG Operations by Administrator (Last 24h)</title>
      <chart>
        <search>
          <query>
index=fw sourcetype=fmg:* earliest=-24h latest=now
| search (object="*policy*" OR object IN (address,service,vip,addrgrp,servgrp))
| search operation IN (add,set,delete,create,modify,remove)
| stats count by user
| sort -count
| head 10
          </query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>

    <panel>
      <title>ğŸ“Š FMG Operation Types (Last 24h)</title>
      <chart>
        <search>
          <query>
index=fw sourcetype=fmg:* earliest=-24h latest=now
| search (object="*policy*" OR object IN (address,service,vip,addrgrp,servgrp))
| search operation IN (add,set,delete,create,modify,remove)
| eval operation_kr=case(
    operation="add" OR operation="create", "ìƒì„±",
    operation="set" OR operation="modify", "ìˆ˜ì •",
    operation="delete" OR operation="remove", "ì‚­ì œ",
    1=1, operation)
| stats count by operation_kr
| sort -count
          </query>
          <earliest>-24h@h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.axisTitleX.text">Count</option>
        <option name="charting.axisTitleY.text">Operation Type</option>
        <option name="charting.seriesColors">[0x65A637,0xF7BC38,0xD93F3C]</option>
      </chart>
    </panel>
  </row>

  <!-- Row 8: Usage Instructions -->
  <row>
    <panel>
      <title>ğŸ“‹ Usage Instructions</title>
      <html>
        <div style="padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
          <h4 style="margin-top: 0;">ğŸ¯ ëŒ€ì‹œë³´ë“œ ì‚¬ìš© ë°©ë²•</h4>
          <ul style="line-height: 1.8;">
            <li><strong>âœ… Enable All Alerts:</strong> 4ê°œ ì•Œë¦¼ ê·œì¹™ì˜ Slack ì•Œë¦¼ ì¼ê´„ í™œì„±í™”</li>
            <li><strong>ğŸ”´ Disable All Alerts:</strong> ëª¨ë“  Slack ì•Œë¦¼ ì¼ê´„ ë¹„í™œì„±í™” (ìœ ì§€ë³´ìˆ˜ ì‹œ ìœ ìš©)</li>
            <li><strong>ğŸ”„ Refresh Status:</strong> í˜„ì¬ ì•Œë¦¼ ìƒíƒœ ìƒˆë¡œê³ ì¹¨</li>
            <li><strong>Individual Controls:</strong> ê° ê·œì¹™ë³„ ê°œë³„ í™œì„±í™”/ë¹„í™œì„±í™”</li>
          </ul>
          <h4>ğŸ“Š ëª¨ë‹ˆí„°ë§ ëŒ€ìƒ</h4>
          <ul style="line-height: 1.8;">
            <li><strong>ğŸ”´ FAZ Critical Alerts:</strong> FortiAnalyzer í¬ë¦¬í‹°ì»¬ ë¡œê·¸ (Update Fail ì œì™¸)</li>
            <li><strong>ğŸ“¦ FMG Policy Install:</strong> FortiManager ì •ì±… ì¸ìŠ¤í†¨ ì´ë²¤íŠ¸</li>
            <li><strong>ğŸ“ FMG Policy CRUD:</strong> ì •ì±… ìƒì„±/ìˆ˜ì •/ì‚­ì œ ì‘ì—…</li>
            <li><strong>ğŸ”§ FMG Object CRUD:</strong> ê°ì²´ (ì£¼ì†Œ/ì„œë¹„ìŠ¤/VIP/ê·¸ë£¹) ìƒì„±/ìˆ˜ì •/ì‚­ì œ ì‘ì—…</li>
          </ul>
          <p style="margin-bottom: 0;"><strong>ì°¸ê³ :</strong> ì•Œë¦¼ ON/OFF ë³€ê²½ ì‚¬í•­ì€ ì¦‰ì‹œ ì ìš©ë©ë‹ˆë‹¤. ê²€ìƒ‰ ê·œì¹™ì€ ê³„ì† ì‹¤í–‰ë˜ë©°, Slack ì•Œë¦¼ë§Œ ì œì–´ë©ë‹ˆë‹¤.</p>
        </div>
      </html>
    </panel>
  </row>

</form>
