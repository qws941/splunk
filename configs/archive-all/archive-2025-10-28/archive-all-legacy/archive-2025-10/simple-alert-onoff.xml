<?xml version="1.0" encoding="UTF-8"?>
<form version="1.1" theme="dark">
  <label>ğŸ”” Simple Alert ON/OFF</label>
  <description>ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ON/OFF ë²„íŠ¼</description>

  <row>
    <panel>
      <title>Test Alert Control</title>
      <html>
        <div style="padding: 30px; text-align: center;">
          <h2 style="margin-bottom: 20px;">ğŸ§ª Test Slack Alert</h2>

          <div id="status" style="margin: 20px 0; padding: 20px; background: #f0f0f0; border-radius: 8px; font-size: 18px;">
            Status: <span id="alert-status" style="font-weight: bold;">Loading...</span>
          </div>

          <div style="margin: 30px 0; display: flex; justify-content: center; gap: 20px;">
            <button id="btn-enable" onclick="setAlert('enable')"
              style="padding: 20px 40px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
              âœ… Enable Alert
            </button>

            <button id="btn-disable" onclick="setAlert('disable')"
              style="padding: 20px 40px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
              âŒ Disable Alert
            </button>
          </div>

          <div style="margin-top: 30px;">
            <button onclick="checkStatus()"
              style="padding: 12px 30px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
              ğŸ”„ Check Status
            </button>
          </div>

          <div id="message" style="margin-top: 20px; padding: 15px; border-radius: 6px; display: none;"></div>
        </div>

        <script><![CDATA[
require(['jquery', 'splunkjs/ready!'], function($, mvc) {
    const ALERT_NAME = 'Test_Simple_Slack_Alert';

    // í˜„ì¬ ìƒíƒœ í™•ì¸
    window.checkStatus = function() {
        $('#alert-status').text('Checking...');

        $.ajax({
            url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ALERT_NAME,
            type: 'GET',
            success: function(response) {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(response, 'text/xml');
                const slackEnabled = $(xmlDoc).find('s\\:key[name="action.slack"]').text();

                if (slackEnabled === '1') {
                    $('#alert-status').text('ğŸŸ¢ ENABLED').css('color', '#28a745');
                } else {
                    $('#alert-status').text('ğŸ”´ DISABLED').css('color', '#dc3545');
                }
            },
            error: function() {
                $('#alert-status').text('â“ Unknown').css('color', '#6c757d');
                showMessage('Error checking status', 'error');
            }
        });
    };

    // ì•Œë¦¼ ON/OFF ì„¤ì •
    window.setAlert = function(action) {
        const slackValue = (action === 'enable') ? '1' : '0';
        const actionText = (action === 'enable') ? 'Enabling' : 'Disabling';

        showMessage(actionText + ' alert...', 'info');

        $.ajax({
            url: '/en-US/splunkd/__raw/servicesNS/nobody/search/saved/searches/' + ALERT_NAME,
            type: 'POST',
            data: {
                'action.slack': slackValue
            },
            success: function() {
                const successText = (action === 'enable') ? 'âœ… Alert enabled!' : 'âŒ Alert disabled!';
                showMessage(successText, 'success');
                checkStatus();
            },
            error: function(xhr) {
                showMessage('âŒ Error: ' + xhr.statusText, 'error');
            }
        });
    };

    // ë©”ì‹œì§€ í‘œì‹œ
    function showMessage(text, type) {
        const colors = {
            'success': '#d4edda',
            'error': '#f8d7da',
            'info': '#d1ecf1'
        };

        $('#message')
            .text(text)
            .css({
                'background': colors[type] || '#f8f9fa',
                'display': 'block'
            });
    }

    // ì´ˆê¸° ìƒíƒœ í™•ì¸
    checkStatus();
});
        ]]></script>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>ğŸ“ Alert Configuration</title>
      <table>
        <search>
          <query>
| rest /services/saved/searches
| search title="Test_Simple_Slack_Alert"
| eval Status=if('action.slack'=1, "ğŸŸ¢ ENABLED", "ğŸ”´ DISABLED")
| eval Schedule=if(disabled=0, "âœ… Active", "âŒ Inactive")
| eval Channel='action.slack.param.channel'
| table title, Status, Schedule, Channel, cron_schedule
| rename title as "Alert Name", cron_schedule as "Cron Schedule"
          </query>
          <earliest>-5m</earliest>
          <latest>now</latest>
        </search>
      </table>
    </panel>
  </row>

</form>
