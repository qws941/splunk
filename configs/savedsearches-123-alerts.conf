# ================================================================
# FortiGate ì•Œë¦¼ ì„¤ì • (123.csv ì‹¤ì œ ë°ì´í„° ê¸°ë°˜)
# ================================================================
# ìƒì„±ì¼: 2025-11-02
# ë°ì´í„° ì†ŒìŠ¤: configs/123.csv (62ê±´ ë¡œê·¸ ë¶„ì„)
# ì¹´í…Œê³ ë¦¬: 7ê°œ (Traffic, System, VPN, FAZ, Security Rating, User, LogDev)
#
# ë°ì´í„° ë¶„í¬:
# - Traffic Events: 4ê±´ (6.5%)
# - System Events: 41ê±´ (66.1%) â† ê°€ì¥ ë§ìŒ
# - VPN Events: 9ê±´ (14.5%)
# - FAZ System Events: 4ê±´ (6.5%)
# - Security Rating: 2ê±´ (3.2%)
# - User Events: 1ê±´ (1.6%)
# - LogDev Events: 1ê±´ (1.6%)
# ================================================================

# ================================================================
# 1. Traffic Events ì•Œë¦¼ (LogID: 0000000011, 0000000015, 0000000020, 0002000012)
# ================================================================

[FortiGate_Traffic_Anomaly_123]
description = Traffic ì´ìƒ íŒ¨í„´ ê°ì§€ (ëŒ€ëŸ‰ íŠ¸ë˜í”½, ë¹„ì •ìƒ í¬íŠ¸)
disabled = 0
search = index=fw type="traffic" earliest=-5m \
| stats sum(sentbyte) as total_sent, sum(rcvdbyte) as total_rcvd, \
    dc(dstip) as unique_dest, dc(dstport) as unique_ports by srcip, devname \
| where total_sent > 1000000000 OR unique_dest > 100 OR unique_ports > 50 \
| eval alert_reason=case( \
    total_sent > 1000000000, "ëŒ€ëŸ‰ ì „ì†¡ (>1GB)", \
    unique_dest > 100, "ë‹¤ì¤‘ ëª©ì ì§€ ìŠ¤ìº”", \
    unique_ports > 50, "í¬íŠ¸ ìŠ¤ìº” ì˜ì‹¬" \
) \
| eval severity="high" \
| table _time, srcip, devname, total_sent, total_rcvd, unique_dest, unique_ports, alert_reason, severity

# Cron ì„¤ì • (5ë¶„ë§ˆë‹¤ ì‹¤í–‰)
cron_schedule = */5 * * * *
enableSched = 1
dispatch.earliest_time = -5m
dispatch.latest_time = now

# ì•Œë¦¼ ì„¤ì •
alert.track = 1
alert.condition = search count > 0
alert.suppress = 1
alert.suppress.fields = srcip, devname
alert.suppress.period = 30m

# Slack ì•Œë¦¼
action.slack = 1
action.slack.param.channel = #security-firewall-alert
action.slack.param.message = {
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "ğŸš¨ Traffic ì´ìƒ íŒ¨í„´ ê°ì§€",
        "emoji": true
      }
    },
    {
      "type": "section",
      "fields": [
        {"type": "mrkdwn", "text": "*ì¶œë°œì§€ IP:*\n$result.srcip$"},
        {"type": "mrkdwn", "text": "*ë””ë°”ì´ìŠ¤:*\n$result.devname$"},
        {"type": "mrkdwn", "text": "*ì „ì†¡ëŸ‰:*\n$result.total_sent$ bytes"},
        {"type": "mrkdwn", "text": "*ëª©ì ì§€:*\n$result.unique_dest$ê°œ"},
        {"type": "mrkdwn", "text": "*í¬íŠ¸:*\n$result.unique_ports$ê°œ"},
        {"type": "mrkdwn", "text": "*ì‚¬ìœ :*\n$result.alert_reason$"}
      ]
    },
    {
      "type": "context",
      "elements": [
        {
          "type": "mrkdwn",
          "text": "ğŸ“Š Splunk: <https://splunk.jclee.me/app/search/search?q=search%20index%3Dfw%20type%3D%22traffic%22%20srcip%3D$result.srcip$|ìƒì„¸ ë³´ê¸°>"
        }
      ]
    }
  ]
}

# ================================================================
# 2. System Events - Critical ì•Œë¦¼ (LogID: 0100041001 ë“±)
# ================================================================

[FortiGate_System_Critical_123]
description = ì‹œìŠ¤í…œ Critical ì´ë²¤íŠ¸ ì•Œë¦¼ (ì—…ë°ì´íŠ¸ ì‹¤íŒ¨, í•˜ë“œì›¨ì–´ ì˜¤ë¥˜)
disabled = 0
search = index=fw subtype="system" level IN ("critical","alert","error") earliest=-15m \
| eval event_type=case( \
    logid="0100041001", "ì—…ë°ì´íŠ¸ ì‹¤íŒ¨", \
    logid="0100040704", "ì„±ëŠ¥ ì´ìŠˆ", \
    logid="0100046600", "HA ë™ê¸°í™” ì˜¤ë¥˜", \
    logid="0100053400" OR logid="0100053401", "ë©”ëª¨ë¦¬ ë¶€ì¡±", \
    logid="0100032001" OR logid="0100032002", "ì¸í„°í˜ì´ìŠ¤ ë‹¤ìš´", \
    1=1, "ê¸°íƒ€ ì‹œìŠ¤í…œ ì˜¤ë¥˜" \
) \
| eval msg_short=substr(msg, 1, 100) \
| table _time, devname, logid, level, event_type, msg_short, user, object

# Cron ì„¤ì • (15ë¶„ë§ˆë‹¤ ì‹¤í–‰)
cron_schedule = */15 * * * *
enableSched = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now

# ì•Œë¦¼ ì„¤ì •
alert.track = 1
alert.condition = search count > 0
alert.suppress = 1
alert.suppress.fields = devname, logid
alert.suppress.period = 1h

# Slack ì•Œë¦¼
action.slack = 1
action.slack.param.channel = #security-firewall-alert
action.slack.param.message = {
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "ğŸ”´ ì‹œìŠ¤í…œ Critical ì´ë²¤íŠ¸",
        "emoji": true
      }
    },
    {
      "type": "section",
      "fields": [
        {"type": "mrkdwn", "text": "*ë””ë°”ì´ìŠ¤:*\n$result.devname$"},
        {"type": "mrkdwn", "text": "*LogID:*\n$result.logid$"},
        {"type": "mrkdwn", "text": "*ì‹¬ê°ë„:*\n$result.level$"},
        {"type": "mrkdwn", "text": "*ì´ë²¤íŠ¸ ìœ í˜•:*\n$result.event_type$"},
        {"type": "mrkdwn", "text": "*ì‹œê°„:*\n$result._time$"}
      ]
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*ë©”ì‹œì§€:*\n```$result.msg_short$```"
      }
    }
  ]
}

# ================================================================
# 3. System Events - Config Change ì•Œë¦¼ (LogID: 0100044547)
# ================================================================

[FortiGate_Config_Change_123]
description = ì„¤ì • ë³€ê²½ ì•Œë¦¼ (ì‹¤ì‹œê°„)
disabled = 0
search = index=fw subtype="system" logid="0100044547" earliest=-5m \
| eval change_summary=case( \
    match(msg, "(?i)policy"), "ë°©í™”ë²½ ì •ì±… ë³€ê²½", \
    match(msg, "(?i)interface"), "ì¸í„°í˜ì´ìŠ¤ ì„¤ì • ë³€ê²½", \
    match(msg, "(?i)route"), "ë¼ìš°íŒ… ë³€ê²½", \
    match(msg, "(?i)vpn"), "VPN ì„¤ì • ë³€ê²½", \
    match(msg, "(?i)user"), "ì‚¬ìš©ì ì„¤ì • ë³€ê²½", \
    1=1, "ê¸°íƒ€ ì„¤ì • ë³€ê²½" \
) \
| table _time, devname, user, cfgpath, cfgobj, cfgattr, change_summary, msg

# Cron ì„¤ì • (ì‹¤ì‹œê°„ - 1ë¶„ë§ˆë‹¤)
cron_schedule = * * * * *
enableSched = 1
dispatch.earliest_time = -1m
dispatch.latest_time = now

# ì•Œë¦¼ ì„¤ì •
alert.track = 1
alert.condition = search count > 0
alert.suppress = 1
alert.suppress.fields = devname, user, cfgpath
alert.suppress.period = 30s

# Slack ì•Œë¦¼
action.slack = 1
action.slack.param.channel = #security-firewall-alert
action.slack.param.message = {
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "âš™ï¸ FortiGate ì„¤ì • ë³€ê²½",
        "emoji": true
      }
    },
    {
      "type": "section",
      "fields": [
        {"type": "mrkdwn", "text": "*ë””ë°”ì´ìŠ¤:*\n$result.devname$"},
        {"type": "mrkdwn", "text": "*ì‚¬ìš©ì:*\n$result.user$"},
        {"type": "mrkdwn", "text": "*ë³€ê²½ ìœ í˜•:*\n$result.change_summary$"},
        {"type": "mrkdwn", "text": "*ê²½ë¡œ:*\n$result.cfgpath$"},
        {"type": "mrkdwn", "text": "*ê°ì²´:*\n$result.cfgobj$"},
        {"type": "mrkdwn", "text": "*ì†ì„±:*\n$result.cfgattr$"}
      ]
    }
  ]
}

# ================================================================
# 4. VPN Events ì•Œë¦¼ (LogID: 0101037122~0101037141)
# ================================================================

[FortiGate_VPN_Failure_123]
description = VPN ì—°ê²° ì‹¤íŒ¨ ë° ì¸ì¦ ì˜¤ë¥˜ ì•Œë¦¼
disabled = 0
search = index=fw subtype="vpn" (logid="0101037131" OR level="error") earliest=-10m \
| eval vpn_status=case( \
    logid="0101037131", "ì¸ì¦ ì‹¤íŒ¨", \
    logid="0101037124", "í„°ë„ ë‹¤ìš´", \
    logid="0101037134", "ì—°ê²° í•´ì œ", \
    level="error", "VPN ì˜¤ë¥˜", \
    1=1, "ì•Œ ìˆ˜ ì—†ìŒ" \
) \
| table _time, devname, logid, level, user, remip, vpn_status, reason, tunneltype, group

# Cron ì„¤ì • (10ë¶„ë§ˆë‹¤)
cron_schedule = */10 * * * *
enableSched = 1
dispatch.earliest_time = -10m
dispatch.latest_time = now

# ì•Œë¦¼ ì„¤ì •
alert.track = 1
alert.condition = search count > 0
alert.suppress = 1
alert.suppress.fields = devname, user, remip
alert.suppress.period = 30m

# Slack ì•Œë¦¼
action.slack = 1
action.slack.param.channel = #security-firewall-alert
action.slack.param.message = {
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "ğŸ” VPN ì—°ê²° ì‹¤íŒ¨",
        "emoji": true
      }
    },
    {
      "type": "section",
      "fields": [
        {"type": "mrkdwn", "text": "*ë””ë°”ì´ìŠ¤:*\n$result.devname$"},
        {"type": "mrkdwn", "text": "*ì‚¬ìš©ì:*\n$result.user$"},
        {"type": "mrkdwn", "text": "*ì›ê²© IP:*\n$result.remip$"},
        {"type": "mrkdwn", "text": "*ìƒíƒœ:*\n$result.vpn_status$"},
        {"type": "mrkdwn", "text": "*ì‚¬ìœ :*\n$result.reason$"},
        {"type": "mrkdwn", "text": "*LogID:*\n$result.logid$"}
      ]
    }
  ]
}

[FortiGate_VPN_Success_Monitoring_123]
description = VPN ì—°ê²° ì„±ê³µ ëª¨ë‹ˆí„°ë§ (ì •ë³´ì„±)
disabled = 0
search = index=fw subtype="vpn" (logid="0101037122" OR logid="0101037133" OR logid="0101037141") earliest=-1h \
| stats count as vpn_connections by devname, user, remip \
| where vpn_connections > 0 \
| eval info="VPN ì—°ê²° í™œì„±" \
| table _time, devname, user, remip, vpn_connections, info

# Cron ì„¤ì • (1ì‹œê°„ë§ˆë‹¤)
cron_schedule = 0 * * * *
enableSched = 1
dispatch.earliest_time = -1h
dispatch.latest_time = now

# ì•Œë¦¼ ì„¤ì • (ì •ë³´ì„±, Slack ë°œì†¡ ì•ˆ í•¨)
alert.track = 0
enableSched = 0

# ================================================================
# 5. FAZ System Events ì•Œë¦¼ (LogID: 08, 14, 17, 20)
# ================================================================

[FortiAnalyzer_Device_Login_Failure_123]
description = FortiAnalyzer ë””ë°”ì´ìŠ¤ ë¡œê·¸ì¸ ì‹¤íŒ¨ ì•Œë¦¼
disabled = 0
search = index=fw subtype="fazsys" devname=".self" (logid="17" OR logid="20") earliest=-15m \
| rex field=msg "Device (?<failed_device>\S+) login failed" \
| eval alert_msg="FortiAnalyzerê°€ " + failed_device + " ë””ë°”ì´ìŠ¤ì— ë¡œê·¸ì¸ ì‹¤íŒ¨" \
| table _time, logid, failed_device, alert_msg, msg

# Cron ì„¤ì • (15ë¶„ë§ˆë‹¤)
cron_schedule = */15 * * * *
enableSched = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now

# ì•Œë¦¼ ì„¤ì •
alert.track = 1
alert.condition = search count > 0
alert.suppress = 1
alert.suppress.fields = failed_device
alert.suppress.period = 2h

# Slack ì•Œë¦¼
action.slack = 1
action.slack.param.channel = #security-firewall-alert
action.slack.param.message = {
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "ğŸ—‚ï¸ FortiAnalyzer ë””ë°”ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨",
        "emoji": true
      }
    },
    {
      "type": "section",
      "fields": [
        {"type": "mrkdwn", "text": "*ì‹¤íŒ¨ ë””ë°”ì´ìŠ¤:*\n$result.failed_device$"},
        {"type": "mrkdwn", "text": "*LogID:*\n$result.logid$"},
        {"type": "mrkdwn", "text": "*ì‹œê°„:*\n$result._time$"}
      ]
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*ë©”ì‹œì§€:*\n```$result.msg$```"
      }
    },
    {
      "type": "context",
      "elements": [
        {
          "type": "mrkdwn",
          "text": "ğŸ’¡ FortiAnalyzerê°€ í•´ë‹¹ ë””ë°”ì´ìŠ¤ì— ë¡œê·¸ ìˆ˜ì§‘ì„ ìœ„í•´ ì ‘ì†ì„ ì‹œë„í–ˆìœ¼ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. REST API ìê²©ì¦ëª… ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”."
        }
      ]
    }
  ]
}

# ================================================================
# 6. Security Rating ì•Œë¦¼ (LogID: 0110052000, 0110052001)
# ================================================================

[FortiGate_Security_Rating_Low_123]
description = ë³´ì•ˆ ë“±ê¸‰ ë‚®ìŒ ì•Œë¦¼ (ì ìˆ˜ < 70 ë˜ëŠ” High ê±´ìˆ˜ > 5)
disabled = 0
search = index=fw subtype="security-rating" earliest=-1d \
| where crscore < 70 OR highcount > 5 \
| eval rating_status=case( \
    crscore < 50, "ë§¤ìš° ë‚®ìŒ (< 50)", \
    crscore < 70, "ë‚®ìŒ (50-70)", \
    highcount > 10, "High ìœ„í—˜ ë‹¤ìˆ˜ (>10)", \
    highcount > 5, "High ìœ„í—˜ ìˆìŒ (>5)", \
    1=1, "ì£¼ì˜ í•„ìš”" \
) \
| table _time, devname, logid, crscore, crlevel, highcount, mediumcount, lowcount, passedcount, rating_status

# Cron ì„¤ì • (1ì¼ 1íšŒ - ë§¤ì¼ ì˜¤ì „ 9ì‹œ)
cron_schedule = 0 9 * * *
enableSched = 1
dispatch.earliest_time = -1d
dispatch.latest_time = now

# ì•Œë¦¼ ì„¤ì •
alert.track = 1
alert.condition = search count > 0
alert.suppress = 1
alert.suppress.fields = devname
alert.suppress.period = 24h

# Slack ì•Œë¦¼
action.slack = 1
action.slack.param.channel = #security-firewall-alert
action.slack.param.message = {
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "ğŸ›¡ï¸ ë³´ì•ˆ ë“±ê¸‰ ë‚®ìŒ ê²½ê³ ",
        "emoji": true
      }
    },
    {
      "type": "section",
      "fields": [
        {"type": "mrkdwn", "text": "*ë””ë°”ì´ìŠ¤:*\n$result.devname$"},
        {"type": "mrkdwn", "text": "*ë“±ê¸‰ ì ìˆ˜:*\n$result.crscore$"},
        {"type": "mrkdwn", "text": "*ë“±ê¸‰ ë ˆë²¨:*\n$result.crlevel$"},
        {"type": "mrkdwn", "text": "*ìƒíƒœ:*\n$result.rating_status$"},
        {"type": "mrkdwn", "text": "*High ìœ„í—˜:*\n$result.highcount$ê±´"},
        {"type": "mrkdwn", "text": "*Medium ìœ„í—˜:*\n$result.mediumcount$ê±´"}
      ]
    },
    {
      "type": "context",
      "elements": [
        {
          "type": "mrkdwn",
          "text": "ğŸ“Š Low: $result.lowcount$ê±´ | Passed: $result.passedcount$ê±´"
        }
      ]
    }
  ]
}

# ================================================================
# 7. User Events ì•Œë¦¼ (LogID: 0102038012)
# ================================================================

[FortiGate_User_Activity_123]
description = ì‚¬ìš©ì í™œë™ ëª¨ë‹ˆí„°ë§
disabled = 0
search = index=fw subtype="user" earliest=-1h \
| stats count as activity_count by devname, user, action \
| where activity_count > 0 \
| table _time, devname, user, action, activity_count

# Cron ì„¤ì • (1ì‹œê°„ë§ˆë‹¤)
cron_schedule = 0 * * * *
enableSched = 1
dispatch.earliest_time = -1h
dispatch.latest_time = now

# ì•Œë¦¼ ì„¤ì • (ì •ë³´ì„±, ì„ê³„ì¹˜ ì—†ìŒ)
alert.track = 0
enableSched = 0

# ================================================================
# 8. LogDev Events ì•Œë¦¼ (LogID: 220001)
# ================================================================

[FortiAnalyzer_LogDev_Warning_123]
description = FortiAnalyzer ë¡œê·¸ ë””ë°”ì´ìŠ¤ ê²½ê³ 
disabled = 0
search = index=fw subtype="logdev" devname=".self" level IN ("warning","error","critical") earliest=-30m \
| eval issue_type=case( \
    match(msg, "(?i)offline"), "ë””ë°”ì´ìŠ¤ ì˜¤í”„ë¼ì¸", \
    match(msg, "(?i)disk"), "ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡±", \
    match(msg, "(?i)connection"), "ì—°ê²° ì˜¤ë¥˜", \
    1=1, "ê¸°íƒ€ ë¡œê·¸ ë””ë°”ì´ìŠ¤ ì´ìŠˆ" \
) \
| table _time, logid, level, issue_type, msg, status

# Cron ì„¤ì • (30ë¶„ë§ˆë‹¤)
cron_schedule = */30 * * * *
enableSched = 1
dispatch.earliest_time = -30m
dispatch.latest_time = now

# ì•Œë¦¼ ì„¤ì •
alert.track = 1
alert.condition = search count > 0
alert.suppress = 1
alert.suppress.fields = logid
alert.suppress.period = 2h

# Slack ì•Œë¦¼
action.slack = 1
action.slack.param.channel = #security-firewall-alert
action.slack.param.message = {
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "ğŸ“¡ FortiAnalyzer ë¡œê·¸ ë””ë°”ì´ìŠ¤ ê²½ê³ ",
        "emoji": true
      }
    },
    {
      "type": "section",
      "fields": [
        {"type": "mrkdwn", "text": "*LogID:*\n$result.logid$"},
        {"type": "mrkdwn", "text": "*ì‹¬ê°ë„:*\n$result.level$"},
        {"type": "mrkdwn", "text": "*ì´ìŠˆ ìœ í˜•:*\n$result.issue_type$"},
        {"type": "mrkdwn", "text": "*ì‹œê°„:*\n$result._time$"}
      ]
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*ë©”ì‹œì§€:*\n```$result.msg$```"
      }
    }
  ]
}

# ================================================================
# 9. í†µí•© ëŒ€ì‹œë³´ë“œ ì—°ë™ (123.csv ê¸°ë°˜ ì „ì²´ ì´ë²¤íŠ¸ ëª¨ë‹ˆí„°ë§)
# ================================================================

[FortiGate_123_Event_Summary]
description = 123.csv ê¸°ë°˜ ì „ì²´ ì´ë²¤íŠ¸ ìš”ì•½ (1ì‹œê°„ë§ˆë‹¤)
disabled = 0
search = index=fw earliest=-1h \
| eval event_category=case( \
    type="traffic", "Traffic", \
    subtype="system", "System", \
    subtype="vpn", "VPN", \
    subtype="fazsys", "FAZ System", \
    subtype="security-rating", "Security Rating", \
    subtype="user", "User", \
    subtype="logdev", "LogDev", \
    1=1, "ê¸°íƒ€" \
) \
| stats count as event_count, \
    dc(devname) as unique_devices, \
    dc(logid) as unique_logids, \
    values(level) as severity_levels \
  by event_category \
| eval total_events=sum(event_count) \
| table event_category, event_count, unique_devices, unique_logids, severity_levels

# Cron ì„¤ì • (1ì‹œê°„ë§ˆë‹¤)
cron_schedule = 0 * * * *
enableSched = 1
dispatch.earliest_time = -1h
dispatch.latest_time = now

# Summary Indexì— ì €ì¥
action.summary_index = 1
action.summary_index._name = summary_fw
action.summary_index.inline = event_category,event_count,unique_devices,unique_logids,severity_levels

# ================================================================
# ë°°í¬ ì°¸ê³ ì‚¬í•­
# ================================================================
# 1. Slack ì±„ë„ ì„¤ì •: #security-firewall-alert ì±„ë„ ë¯¸ë¦¬ ìƒì„±
# 2. Slack App ì„¤ì •:
#    - OAuth Scopes: chat:write, channels:read, chat:write.public
#    - Bot Tokenì„ Splunk alert_actions.confì— ì„¤ì •
# 3. ì•Œë¦¼ ì–µì œ (suppress) ì‹œê°„:
#    - ì‹¤ì‹œê°„ (Config Change): 30ì´ˆ
#    - ì§§ì€ ì£¼ê¸° (Traffic): 30ë¶„
#    - ì¤‘ê°„ ì£¼ê¸° (System, VPN): 1~2ì‹œê°„
#    - ê¸´ ì£¼ê¸° (Security Rating): 24ì‹œê°„
# 4. Summary Index:
#    - FortiGate_123_Event_Summary â†’ summary_fw ì¸ë±ìŠ¤ì— ì €ì¥
#    - ëŒ€ì‹œë³´ë“œì—ì„œ ë¹ ë¥¸ ì¡°íšŒ ê°€ëŠ¥
# ================================================================
