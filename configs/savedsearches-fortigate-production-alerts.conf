# ================================================================
# FortiGate Production Alerts - LogID Based Routing
# ================================================================
# Created: 2025-11-02
# Data Source: configs/123.csv (62 log records from 14 devices)
# Integration: Combines LogID-based filtering with production data
# Reference: savedsearches-fortigate-alerts-logid-based.conf
#
# ‚öôÔ∏è CONFIGURATION GUIDE:
# ‚îú‚îÄ Slack Channel: Search "action.slack.param.channel" and replace with your channel
# ‚îú‚îÄ Suppress Period: Search "alert.suppress.period" to adjust duplicate suppression time
# ‚îú‚îÄ Index Name: Default "index=fw" - change if using different index name
# ‚îî‚îÄ Schedule: Real-time alerts use "cron_schedule = * * * * *" (every minute)
#
# üìä DATA DISTRIBUTION (from 123.csv):
# ‚îú‚îÄ System Events: 41 records (66.1%) ‚Üê Most common
# ‚îú‚îÄ VPN Events: 9 records (14.5%)
# ‚îú‚îÄ Traffic Events: 4 records (6.5%)
# ‚îú‚îÄ FAZ System Events: 4 records (6.5%)
# ‚îú‚îÄ Security Rating: 2 records (3.2%)
# ‚îú‚îÄ User Events: 1 record (1.6%)
# ‚îî‚îÄ LogDev Events: 1 record (1.6%)
#
# üîç KEY LOGID MAPPINGS:
# Config Changes: 0100044546 (CLI), 0100044547 (GUI)
# Traffic: 0000000011, 0000000015, 0000000020, 0002000012
# VPN: 0101037122-0101037141 range
# FAZ System: 08, 14, 17, 20
# Security Rating: 0110052000, 0110052001
# User: 0102038012
# LogDev: 220001
# System Critical: 0100041001, 0100040704, 0100046600, 0100053400, 0100053401
# ================================================================

#############################################
# 1. Config Change Alert (LogID Based)
# Matches: 0100044546 (CLI), 0100044547 (GUI)
# Real-time monitoring with 30s deduplication
#############################################

[001.alert_FortiGate_Config_Change]
description = Real-time FortiGate configuration change alerts (logid-based, Block Kit)
disabled = 0

# Real-time settings
cron_schedule = * * * * *
dispatch.earliest_time = rt-1m
dispatch.latest_time = rt
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
realtime_schedule = 1
request.ui_dispatch_view = search
schedule_priority = highest

# Alert settings
alert.track = 1
alert.digest_mode = 0
quantity = 0
relation = greater than

# üîï Duplicate Suppression (5 minutes per unique config change)
# Prevents same alert from firing multiple times during configuration work
# Uniqueness determined by: timestamp + device + admin user + config path changed
alert.suppress = 1
alert.suppress.fields = _time, device, user, cfgpath
alert.suppress.period = 5m

# Action settings
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.slack = 1
action.slack.param.channel = #security-firewall-alert
action.slack.param.message = $result.blockkit_json$
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0

# üîç Search Query (logid-based filtering only)
# INDEX: "fw" - change if using different index name
# Each config change triggers immediate alert (no deduplication in query)
search = index=fw type=event subtype=system \
    (logid=0100044546 OR logid=0100044547) \
| eval device = coalesce(devname, "unknown") \
| eval admin = coalesce(user, "system") \
| eval config_path = coalesce(cfgpath, "unknown") \
| eval access_method = case(logid="0100044546", "CLI", logid="0100044547", "GUI", 1=1, coalesce(ui, "N/A")) \
| eval action_type = coalesce(action, "Modified") \
| eval object_name = coalesce(cfgobj, "-") \
| eval details_raw = coalesce(cfgattr, "No details") \
| eval details = if(len(details_raw) > 150, substr(details_raw, 1, 147) + "...", details_raw) \
| eval severity = case( \
    like(config_path, "%firewall.policy%"), "HIGH", \
    like(config_path, "%vpn.%"), "HIGH", \
    like(config_path, "%router.%"), "MEDIUM", \
    1=1, "LOW") \
| eval color = case(severity="HIGH", "danger", severity="MEDIUM", "warning", 1=1, "good") \
| eval change_type = case( \
    like(config_path, "%firewall.policy%"), ":shield: Policy Change", \
    like(config_path, "%firewall.address%"), ":globe_with_meridians: Address Object", \
    like(config_path, "%firewall.service%"), ":package: Service Object", \
    like(config_path, "%system.interface%"), ":electric_plug: Interface Config", \
    like(config_path, "%router.%"), ":world_map: Routing Change", \
    like(config_path, "%vpn.%"), ":closed_lock_with_key: VPN Change", \
    1=1, ":wrench: Configuration Change") \
| eval timestamp_formatted = strftime(_time, "%Y-%m-%d %H:%M:%S %Z") \
| eval device_safe = replace(device, "\"", "'") \
| eval admin_safe = replace(admin, "\"", "'") \
| eval details_safe = replace(replace(details, "\"", "'"), "\\\\", "/") \
| eval config_path_safe = replace(config_path, "\"", "'") \
| eval object_name_safe = replace(object_name, "\"", "'") \
| eval blockkit_json = "{\"attachments\":[{\"color\":\"" + color + "\",\"blocks\":["
    + "{\"type\":\"header\",\"text\":{\"type\":\"plain_text\",\"text\":\"" + change_type + "\"}},"
    + "{\"type\":\"section\",\"fields\":["
    + "{\"type\":\"mrkdwn\",\"text\":\"*Device:*\\n" + device_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Severity:*\\n" + severity + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Admin:*\\n" + admin_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Method:*\\n" + access_method + "\"}"
    + "]},"
    + "{\"type\":\"section\",\"fields\":["
    + "{\"type\":\"mrkdwn\",\"text\":\"*Config Path:*\\n`" + config_path_safe + "`\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Object:*\\n" + object_name_safe + "\"}"
    + "]},"
    + "{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*Action:* " + action_type + "\\n*Details:* " + details_safe + "\"}},"
    + "{\"type\":\"context\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":clock3: " + timestamp_formatted + "\"}]}" + "]}]}"
| table _time, blockkit_json, device_safe, admin_safe, config_path_safe, severity


#############################################
# 2. System Critical Events (LogID Based)
# Matches: 0100046600 (HA sync), 0100053400/0100053401 (memory)
# ‚ùå REMOVED: 0100040704 (CPU/performance - too noisy)
# ‚ùå REMOVED: 0100041001 (update fail - maintenance noise)
# Real-time monitoring (every minute)
#############################################

[002.alert_FortiGate_System_Critical]
description = Real-time FortiGate system critical events (logid-based, Block Kit)
disabled = 1

# Real-time settings (EVERY MINUTE - no delay!)
cron_schedule = * * * * *
dispatch.earliest_time = rt-1m
dispatch.latest_time = rt
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
request.ui_dispatch_view = search
schedule_priority = high

# Alert settings
alert.track = 1
alert.digest_mode = 0
quantity = 0
relation = greater than

# üîï Duplicate Suppression (1 hour per device+logid)
alert.suppress = 1
alert.suppress.fields = devname, logid
alert.suppress.period = 1h

# Action settings
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.slack = 1
action.slack.param.channel = #security-firewall-alert
action.slack.param.message = $result.blockkit_json$
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0

# üîç Search Query (logid-based filtering only - CPU/login/update removed)
search = index=fw type=event subtype=system \
    (logid=0100046600 OR logid=0100053400 OR logid=0100053401) \
| eval device = coalesce(devname, "unknown") \
| eval event_type = case( \
    logid="0100046600", "HA Sync Error", \
    logid="0100053400" OR logid="0100053401", "Memory Critical", \
    1=1, "System Critical") \
| eval severity = "HIGH" \
| eval color = "danger" \
| eval icon = ":red_circle:" \
| eval description = coalesce(msg, logdesc, "No details") \
| eval description_short = if(len(description) > 200, substr(description, 1, 197) + "...", description) \
| eval timestamp_formatted = strftime(_time, "%Y-%m-%d %H:%M:%S %Z") \
| eval device_safe = replace(device, "\"", "'") \
| eval description_safe = replace(replace(description_short, "\"", "'"), "\\\\", "/") \
| eval event_type_safe = replace(event_type, "\"", "'") \
| dedup device, logid \
| eval blockkit_json = "{\"attachments\":[{\"color\":\"" + color + "\",\"blocks\":["
    + "{\"type\":\"header\",\"text\":{\"type\":\"plain_text\",\"text\":\"" + icon + " System Critical: " + event_type_safe + "\"}},"
    + "{\"type\":\"section\",\"fields\":["
    + "{\"type\":\"mrkdwn\",\"text\":\"*Device:*\\n" + device_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*LogID:*\\n`" + logid + "`\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Severity:*\\n" + severity + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Event Type:*\\n" + event_type_safe + "\"}"
    + "]},"
    + "{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*Details:*\\n" + description_safe + "\"}},"
    + "{\"type\":\"context\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":clock3: " + timestamp_formatted + "\"}]}" + "]}]}"
| table _time, blockkit_json, device_safe, event_type_safe, severity, logid


#############################################
# 3. Traffic Events (LogID Based)
# Matches: 0000000011, 0000000015 (session start),
#          0000000020 (session close), 0002000012 (multicast)
# Anomaly detection: Large transfers, port scans, multi-target
# Real-time monitoring (every minute)
#############################################

[003.alert_FortiGate_Traffic_Anomaly]
description = Traffic anomaly detection based on production LogIDs (logid-based, Block Kit)
disabled = 1

# Real-time settings (EVERY MINUTE)
cron_schedule = * * * * *
dispatch.earliest_time = rt-1m
dispatch.latest_time = rt
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
request.ui_dispatch_view = search
schedule_priority = high

# Alert settings
alert.track = 1
alert.digest_mode = 0
quantity = 0
relation = greater than

# üîï Duplicate Suppression (30 minutes per source IP + device)
alert.suppress = 1
alert.suppress.fields = srcip, devname
alert.suppress.period = 30m

# Action settings
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.slack = 1
action.slack.param.channel = #security-firewall-alert
action.slack.param.message = $result.blockkit_json$
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0

# üîç Search Query (logid-based filtering + anomaly detection)
search = index=fw type=traffic \
    (logid=0000000011 OR logid=0000000015 OR logid=0000000020 OR logid=0002000012) \
| stats sum(sentbyte) as total_sent, sum(rcvdbyte) as total_rcvd, \
    dc(dstip) as unique_dest, dc(dstport) as unique_ports by srcip, devname \
| where total_sent > 10000000000 OR unique_dest > 100 OR unique_ports > 50 \
| eval alert_reason = case( \
    total_sent > 10000000000, "Large Transfer (>10GB)", \
    unique_dest > 100, "Multi-Target Scan", \
    unique_ports > 50, "Port Scan Suspected", \
    1=1, "Traffic Anomaly") \
| eval severity = "HIGH" \
| eval color = "danger" \
| eval icon = ":warning:" \
| eval total_sent_mb = round(total_sent/1024/1024, 2) \
| eval total_rcvd_mb = round(total_rcvd/1024/1024, 2) \
| eval timestamp_formatted = strftime(now(), "%Y-%m-%d %H:%M:%S %Z") \
| eval srcip_safe = replace(srcip, "\"", "'") \
| eval devname_safe = replace(devname, "\"", "'") \
| eval alert_reason_safe = replace(alert_reason, "\"", "'") \
| eval blockkit_json = "{\"attachments\":[{\"color\":\"" + color + "\",\"blocks\":["
    + "{\"type\":\"header\",\"text\":{\"type\":\"plain_text\",\"text\":\"" + icon + " Traffic Anomaly Detected\"}},"
    + "{\"type\":\"section\",\"fields\":["
    + "{\"type\":\"mrkdwn\",\"text\":\"*Source IP:*\\n" + srcip_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Device:*\\n" + devname_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Sent:*\\n" + total_sent_mb + " MB\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Received:*\\n" + total_rcvd_mb + " MB\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Targets:*\\n" + unique_dest + " IPs\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Ports:*\\n" + unique_ports + " unique\"}"
    + "]},"
    + "{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*Reason:* " + alert_reason_safe + "\"}},"
    + "{\"type\":\"context\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":clock3: " + timestamp_formatted + "\"}]}" + "]}]}"
| table srcip, devname, total_sent_mb, total_rcvd_mb, unique_dest, unique_ports, alert_reason, blockkit_json


#############################################
# 4. VPN Events (LogID Based)
# Success: 0101037122, 0101037133, 0101037141
# Failure: 0101037131 (auth fail), 0101037124 (tunnel down), 0101037134 (disconnect)
# Monitors failures only, success logs to summary index
# Real-time monitoring (every minute)
#############################################

[004.alert_FortiGate_VPN_Failure]
description = Real-time VPN connection failures and auth errors (logid-based, Block Kit)
disabled = 0

# Real-time settings (EVERY MINUTE)
cron_schedule = * * * * *
dispatch.earliest_time = rt-1m
dispatch.latest_time = rt
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
request.ui_dispatch_view = search
schedule_priority = high

# Alert settings
alert.track = 1
alert.digest_mode = 0
quantity = 0
relation = greater than

# üîï Duplicate Suppression (30 minutes per user + remote IP)
alert.suppress = 1
alert.suppress.fields = user, remip
alert.suppress.period = 30m

# Action settings
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.slack = 1
action.slack.param.channel = #security-firewall-alert
action.slack.param.message = $result.blockkit_json$
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0

# üîç Search Query (logid-based filtering - failures only)
search = index=fw type=event subtype=vpn \
    (logid=0101037131 OR logid=0101037124 OR logid=0101037134) \
| eval device = coalesce(devname, "unknown") \
| eval vpn_user = coalesce(user, "N/A") \
| eval remote_ip = coalesce(remip, "-") \
| eval vpn_status = case( \
    logid="0101037131", "Authentication Failed", \
    logid="0101037124", "Tunnel Down", \
    logid="0101037134", "Disconnected", \
    1=1, "VPN Error") \
| eval severity = "HIGH" \
| eval color = "danger" \
| eval icon = ":closed_lock_with_key:" \
| eval vpn_reason = coalesce(reason, msg, "No reason provided") \
| eval vpn_type = coalesce(tunneltype, "N/A") \
| eval vpn_group = coalesce(group, "N/A") \
| eval timestamp_formatted = strftime(_time, "%Y-%m-%d %H:%M:%S %Z") \
| eval device_safe = replace(device, "\"", "'") \
| eval vpn_user_safe = replace(vpn_user, "\"", "'") \
| eval remote_ip_safe = replace(remote_ip, "\"", "'") \
| eval vpn_status_safe = replace(vpn_status, "\"", "'") \
| eval vpn_reason_safe = replace(replace(vpn_reason, "\"", "'"), "\\\\", "/") \
| dedup device, vpn_user, remote_ip \
| eval blockkit_json = "{\"attachments\":[{\"color\":\"" + color + "\",\"blocks\":["
    + "{\"type\":\"header\",\"text\":{\"type\":\"plain_text\",\"text\":\"" + icon + " VPN Connection Failed\"}},"
    + "{\"type\":\"section\",\"fields\":["
    + "{\"type\":\"mrkdwn\",\"text\":\"*Device:*\\n" + device_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*User:*\\n" + vpn_user_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Remote IP:*\\n" + remote_ip_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Status:*\\n" + vpn_status_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Tunnel Type:*\\n" + vpn_type + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Group:*\\n" + vpn_group + "\"}"
    + "]},"
    + "{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*Reason:* " + vpn_reason_safe + "\"}},"
    + "{\"type\":\"context\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":clock3: " + timestamp_formatted + "\"}]}" + "]}]}"
| table _time, blockkit_json, device_safe, vpn_user_safe, remote_ip_safe, vpn_status_safe, logid


#############################################
# 5. FortiAnalyzer System Events (LogID Based)
# Matches: 08, 14, 17, 20 (device login failures)
# Device ".self" indicates FortiAnalyzer's own events
#############################################

[005.alert_FortiAnalyzer_Device_Login_Failure]
description = FortiAnalyzer device login failures (DISABLED - not critical)
disabled = 1

# Scheduled settings (15 minutes)
cron_schedule = */15 * * * *
dispatch.earliest_time = rt-1m
dispatch.latest_time = rt
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
request.ui_dispatch_view = search
schedule_priority = low

# Alert settings (summary only, no alerts)
alert.track = 0

# Action settings (summary index only, no Slack)
action.summary_index = 1
action.summary_index._name = summary_fw
action.summary_index.inline = failed_device,logid,login_failure_count

# üîç Search Query (logid-based filtering, summary only)
search = index=fw subtype=fazsys devname=".self" \
    (logid="08" OR logid="14" OR logid="17" OR logid="20") \
| rex field=msg "Device (?<failed_device>\S+) login failed" \
| stats count as login_failure_count by failed_device, logid \
| eval event_category = "FAZ Device Login Failure" \
| table _time, failed_device, logid, login_failure_count, event_category


#############################################
# 6. Security Rating Events (LogID Based)
# Matches: 0110052000, 0110052001
# Daily summary at 9 AM KST
#############################################

[006.alert_FortiGate_Security_Rating_Low]
description = FortiGate security rating summary (daily, no alerts)
disabled = 0

# Scheduled settings (daily at 9 AM)
cron_schedule = 0 9 * * *
dispatch.earliest_time = -24h
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
request.ui_dispatch_view = search
schedule_priority = low

# Alert settings (summary only, no alerts)
alert.track = 0

# Action settings (summary index only, no Slack)
action.summary_index = 1
action.summary_index._name = summary_fw
action.summary_index.inline = device,rating_score,rating_level,high_count,medium_count,low_count

# üîç Search Query (logid-based filtering, summary only)
search = index=fw subtype=security-rating \
    (logid=0110052000 OR logid=0110052001) \
| eval device = coalesce(devname, "unknown") \
| eval rating_score = coalesce(crscore, 0) \
| eval rating_level = coalesce(crlevel, "N/A") \
| eval high_count = coalesce(highcount, 0) \
| eval medium_count = coalesce(mediumcount, 0) \
| eval low_count = coalesce(lowcount, 0) \
| dedup device \
| eval event_category = "Security Rating" \
| table _time, device, rating_score, rating_level, high_count, medium_count, low_count, event_category


#############################################
# 7. User Activity Events (LogID Based)
# Matches: 0102038012
# Informational only, no Slack alerts
#############################################

[007.alert_FortiGate_User_Activity]
description = User activity monitoring (logid-based, summary only)
disabled = 1  # ‚ùå DISABLED: User activity not critical

# Scheduled settings (1 hour)
cron_schedule = 0 * * * *
dispatch.earliest_time = -1h
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
request.ui_dispatch_view = search
schedule_priority = low

# Alert settings (informational, no alerts)
alert.track = 0

# Action settings (summary index only, no Slack)
action.summary_index = 1
action.summary_index._name = summary_fw
action.summary_index.inline = devname,user,action,activity_count

# üîç Search Query (logid-based filtering)
search = index=fw subtype=user logid=0102038012 \
| stats count as activity_count by devname, user, action \
| where activity_count > 0 \
| eval event_category = "User Activity" \
| table _time, devname, user, action, activity_count, event_category


#############################################
# 8. LogDev Events (LogID Based)
# Matches: 220001 (FortiAnalyzer log device warnings)
# Device ".self" indicates FortiAnalyzer's own events
# Real-time monitoring (every minute)
#############################################

[008.alert_FortiAnalyzer_LogDev_Warning]
description = FortiAnalyzer log device warnings (logid-based, Block Kit)
disabled = 0

# Real-time settings (EVERY MINUTE)
cron_schedule = * * * * *
dispatch.earliest_time = rt-1m
dispatch.latest_time = rt
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
request.ui_dispatch_view = search
schedule_priority = medium

# Alert settings
alert.track = 1
alert.digest_mode = 0
quantity = 0
relation = greater than

# üîï Duplicate Suppression (12 hours per logid)
alert.suppress = 1
alert.suppress.fields = logid
alert.suppress.period = 12h

# Action settings
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.slack = 1
action.slack.param.channel = #security-firewall-alert
action.slack.param.message = $result.blockkit_json$
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0

# üîç Search Query (logid-based filtering, FAZ self events only)
search = index=fw subtype=logdev devname=".self" logid=220001 level IN ("warning","error","critical") \
| eval issue_type = case( \
    like(msg, "%offline%"), "Device Offline", \
    like(msg, "%disk%"), "Disk Space Low", \
    like(msg, "%connection%"), "Connection Error", \
    1=1, "Log Device Issue") \
| eval severity_level = upper(level) \
| eval severity_color = case( \
    level="critical", "danger", \
    level="error", "danger", \
    level="warning", "warning", \
    1=1, "good") \
| eval icon = ":satellite:" \
| eval description = coalesce(msg, "No details") \
| eval device_status = coalesce(status, "N/A") \
| eval timestamp_formatted = strftime(_time, "%Y-%m-%d %H:%M:%S %Z") \
| eval issue_type_safe = replace(issue_type, "\"", "'") \
| eval description_safe = replace(replace(description, "\"", "'"), "\\\\", "/") \
| dedup logid, issue_type \
| eval blockkit_json = "{\"attachments\":[{\"color\":\"" + severity_color + "\",\"blocks\":["
    + "{\"type\":\"header\",\"text\":{\"type\":\"plain_text\",\"text\":\"" + icon + " FortiAnalyzer Log Device Warning\"}},"
    + "{\"type\":\"section\",\"fields\":["
    + "{\"type\":\"mrkdwn\",\"text\":\"*LogID:*\\n`" + logid + "`\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Severity:*\\n" + severity_level + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Issue Type:*\\n" + issue_type_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Status:*\\n" + device_status + "\"}"
    + "]},"
    + "{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*Message:*\\n" + description_safe + "\"}},"
    + "{\"type\":\"context\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":clock3: " + timestamp_formatted + "\"}]}" + "]}]}"
| table _time, blockkit_json, logid, severity_level, issue_type_safe


#############################################
# 9. Production Event Summary (Hourly Summary)
# All categories from 123.csv data
# Saves to summary_fw index for dashboard performance
#############################################

[009.alert_FortiGate_Event_Summary]
description = Hourly production event summary (all categories from 123.csv)
disabled = 0

# Scheduled settings (1 hour) - MATCHING TIME RANGE
cron_schedule = 0 * * * *
dispatch.earliest_time = -1h
dispatch.latest_time = now
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
request.ui_dispatch_view = search
schedule_priority = low

# Alert settings (summary only, no alerts)
alert.track = 0

# Action settings (summary index only)
action.summary_index = 1
action.summary_index._name = summary_fw
action.summary_index.inline = event_category,event_count,unique_devices,unique_logids,severity_levels

# üîç Search Query (all categories)
search = index=fw \
| eval event_category = case( \
    type="traffic", "Traffic", \
    subtype="system", "System", \
    subtype="vpn", "VPN", \
    subtype="fazsys", "FAZ System", \
    subtype="security-rating", "Security Rating", \
    subtype="user", "User", \
    subtype="logdev", "LogDev", \
    1=1, "Other") \
| stats count as event_count, \
    dc(devname) as unique_devices, \
    dc(logid) as unique_logids, \
    values(level) as severity_levels \
  by event_category \
| eval summary_marker = "production_hourly" \
| table event_category, event_count, unique_devices, unique_logids, severity_levels, summary_marker


#############################################
# 10. System Metrics Anomaly Detection (Dynamic Threshold)
# CPU/Memory/Traffic/Sessions 2x higher than 24h baseline
# Real-time monitoring (every minute)
#############################################

[010.alert_FortiGate_Metrics_Anomaly]
description = System metrics anomaly - 2x higher than baseline (CPU/Memory/Traffic/Sessions)
disabled = 0

# Real-time settings (EVERY MINUTE)
cron_schedule = * * * * *
dispatch.earliest_time = rt-1m
dispatch.latest_time = rt
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
realtime_schedule = 1
request.ui_dispatch_view = search
schedule_priority = high

# Alert settings
alert.track = 1
alert.digest_mode = 0
quantity = 0
relation = greater than

# üîï Duplicate Suppression (30 minutes per device)
alert.suppress = 1
alert.suppress.fields = devname
alert.suppress.period = 30m

# Action settings
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.slack = 1
action.slack.param.channel = #security-firewall-alert
action.slack.param.message = $result.blockkit_json$
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0

# üîç Search Query (Multi-metric anomaly detection - 2x baseline)
# Check: CPU, Memory, Sessions, Bandwidth (sent+received)
search = index=fw earliest=-1m latest=now \
| eval device = coalesce(devname, "unknown") \
| eval cpu_current = coalesce(cpu, 0) \
| eval mem_current = coalesce(mem, 0) \
| eval sessions_current = coalesce(session_count, sess_count, sessions, 0) \
| eval traffic_current = coalesce(sentbyte, 0) + coalesce(rcvdbyte, 0) \
| append [ \
    search index=fw earliest=-24h latest=-2m \
    | eval device = coalesce(devname, "unknown") \
    | stats avg(cpu) as cpu_baseline, \
            avg(mem) as mem_baseline, \
            avg(session_count) as sessions_baseline, \
            avg(eval(coalesce(sentbyte,0) + coalesce(rcvdbyte,0))) as traffic_baseline \
      by device \
] \
| stats values(cpu_current) as cpu_current, \
        values(mem_current) as mem_current, \
        values(sessions_current) as sessions_current, \
        values(traffic_current) as traffic_current, \
        max(cpu_baseline) as cpu_baseline, \
        max(mem_baseline) as mem_baseline, \
        max(sessions_baseline) as sessions_baseline, \
        max(traffic_baseline) as traffic_baseline \
  by device \
| eval cpu_anomaly = if(cpu_current > (cpu_baseline * 2), 1, 0) \
| eval mem_anomaly = if(mem_current > (mem_baseline * 2), 1, 0) \
| eval sessions_anomaly = if(sessions_current > (sessions_baseline * 2), 1, 0) \
| eval traffic_anomaly = if(traffic_current > (traffic_baseline * 2), 1, 0) \
| eval total_anomalies = cpu_anomaly + mem_anomaly + sessions_anomaly + traffic_anomaly \
| where total_anomalies > 0 \
| eval anomaly_types = case( \
    cpu_anomaly=1, "CPU", \
    1=1, "") \
    + if(mem_anomaly=1, if(anomaly_types="", "Memory", ", Memory"), "") \
    + if(sessions_anomaly=1, if(anomaly_types="", "Sessions", ", Sessions"), "") \
    + if(traffic_anomaly=1, if(anomaly_types="", "Traffic", ", Traffic"), "") \
| eval severity = case( \
    total_anomalies >= 3, "CRITICAL", \
    total_anomalies >= 2, "HIGH", \
    1=1, "MEDIUM") \
| eval color = case(severity="CRITICAL", "danger", severity="HIGH", "danger", 1=1, "warning") \
| eval icon = ":fire:" \
| eval cpu_ratio = if(cpu_baseline > 0, round(cpu_current / cpu_baseline, 2), 0) \
| eval mem_ratio = if(mem_baseline > 0, round(mem_current / mem_baseline, 2), 0) \
| eval sessions_ratio = if(sessions_baseline > 0, round(sessions_current / sessions_baseline, 2), 0) \
| eval traffic_ratio = if(traffic_baseline > 0, round(traffic_current / traffic_baseline, 2), 0) \
| eval timestamp_formatted = strftime(now(), "%Y-%m-%d %H:%M:%S %Z") \
| eval device_safe = replace(device, "\"", "'") \
| eval anomaly_types_safe = replace(anomaly_types, "\"", "'") \
| eval traffic_current_mb = round(traffic_current/1024/1024, 2) \
| eval traffic_baseline_mb = round(traffic_baseline/1024/1024, 2) \
| eval details = if(cpu_anomaly=1, "CPU: " + cpu_current + "% (baseline " + round(cpu_baseline,1) + "%, " + cpu_ratio + "x)", "") \
    + if(mem_anomaly=1, if(details="", "", " | ") + "Memory: " + mem_current + "% (baseline " + round(mem_baseline,1) + "%, " + mem_ratio + "x)", "") \
    + if(sessions_anomaly=1, if(details="", "", " | ") + "Sessions: " + sessions_current + " (baseline " + round(sessions_baseline,0) + ", " + sessions_ratio + "x)", "") \
    + if(traffic_anomaly=1, if(details="", "", " | ") + "Traffic: " + traffic_current_mb + " MB (baseline " + traffic_baseline_mb + " MB, " + traffic_ratio + "x)", "") \
| eval details_safe = replace(replace(details, "\"", "'"), "\\\\", "/") \
| eval blockkit_json = "{\"attachments\":[{\"color\":\"" + color + "\",\"blocks\":[" \
    + "{\"type\":\"header\",\"text\":{\"type\":\"plain_text\",\"text\":\"" + icon + " Metrics Anomaly: " + anomaly_types_safe + "\"}}," \
    + "{\"type\":\"section\",\"fields\":[" \
    + "{\"type\":\"mrkdwn\",\"text\":\"*Device:*\\n" + device_safe + "\"}," \
    + "{\"type\":\"mrkdwn\",\"text\":\"*Anomalies:*\\n" + total_anomalies + " metrics\"}," \
    + "{\"type\":\"mrkdwn\",\"text\":\"*Types:*\\n" + anomaly_types_safe + "\"}," \
    + "{\"type\":\"mrkdwn\",\"text\":\"*Severity:*\\n" + severity + "\"}" \
    + "]}," \
    + "{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*Details:*\\n" + details_safe + "\"}}," \
    + "{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*Analysis:* " + total_anomalies + " metric(s) are 2x+ higher than 24-hour baseline. Check for attacks, process spikes, or capacity issues.\"}}," \
    + "{\"type\":\"context\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":clock3: " + timestamp_formatted + "\"}]}" + "]}]}" \
| table device, anomaly_types, severity, total_anomalies, details, blockkit_json


# ================================================================
# üìö CONFIGURATION NOTES & BEST PRACTICES
# ================================================================
#
# üîß Quick Configuration Changes:
#    üîç Search for "‚öôÔ∏è CHANGEME" to find all customizable settings
#    üìå Key settings to review:
#       ‚îú‚îÄ Slack channel: action.slack.param.channel = #your-channel
#       ‚îú‚îÄ Index name: search = index=YOUR_INDEX_NAME
#       ‚îú‚îÄ Suppress period: alert.suppress.period = 30s|2m|1h|24h
#       ‚îî‚îÄ Enable/disable: disabled = 0 (enabled) or disabled = 1 (disabled)
#
# üîî Slack Action Configuration (Web UI):
#    Settings ‚Üí Searches, reports, and alerts ‚Üí Select alert ‚Üí Edit ‚Üí Add Actions ‚Üí Slack
#    ‚ö†Ô∏è Must invite Slack bot to channel BEFORE enabling alerts
#    ‚ö†Ô∏è OAuth Scopes required: chat:write, channels:read, chat:write.public
#
# ‚è±Ô∏è Scheduling Strategy:
#    Real-time (1 min):    Config changes (immediate notification)
#    Frequent (5-10 min):  Traffic anomalies, VPN failures
#    Moderate (15-30 min): System critical, FAZ events, LogDev warnings
#    Daily (9 AM):         Security rating summary
#    Hourly:               User activity, event summary (to summary_fw index)
#
# üîï Suppression Strategy:
#    30 seconds:  Config changes (immediate + short dedup)
#    30 minutes:  Traffic anomalies, VPN failures (prevent alert storms)
#    1 hour:      System critical events (frequent but not too noisy)
#    2 hours:     FAZ login failures, LogDev warnings (maintenance events)
#    24 hours:    Security rating (once per day reminder)
#
# üìä Monitor Alert Performance:
#    # Check execution time and status
#    index=_internal source=*scheduler.log savedsearch_name="FortiGate_*_Production"
#    | stats avg(run_time) as avg_runtime_sec, count by savedsearch_name, status
#
# üß™ Manual Testing (from Splunk Search bar):
#    | savedsearch FortiGate_Config_Change_Production
#    | savedsearch FortiGate_System_Critical_Production
#    | savedsearch FortiGate_Traffic_Anomaly_Production
#    | savedsearch FortiGate_VPN_Failure_Production
#    | savedsearch FortiAnalyzer_Device_Login_Failure_Production
#    | savedsearch FortiGate_Security_Rating_Low_Production
#    | savedsearch FortiGate_User_Activity_Production
#    | savedsearch FortiAnalyzer_LogDev_Warning_Production
#    | savedsearch FortiGate_Production_Event_Summary
#
# üêõ Troubleshooting:
#    ‚ùå No alerts firing:
#       1. Check data: index=fw earliest=-1h | head 100
#       2. Check schedule: index=_internal source=*scheduler.log savedsearch_name="FortiGate_*_Production"
#       3. Verify Slack bot invited to channel
#    ‚ùå Too many alerts:
#       1. Increase alert.suppress.period values
#       2. Adjust logid filters to be more specific
#    ‚ùå Missing events:
#       1. Verify index=fw contains FortiGate/FAZ syslog data
#       2. Check logid values match your FortiOS/FAZ version
#
# üéØ LogID Reference Summary:
#    Config: 0100044546 (CLI), 0100044547 (GUI)
#    System: 0100041001, 0100040704, 0100046600, 0100053400, 0100053401
#    Traffic: 0000000011, 0000000015, 0000000020, 0002000012
#    VPN Fail: 0101037131, 0101037124, 0101037134
#    VPN Success: 0101037122, 0101037133, 0101037141
#    FAZ System: 08, 14, 17, 20
#    Security Rating: 0110052000, 0110052001
#    User: 0102038012
#    LogDev: 220001
#
# ================================================================
# END OF CONFIGURATION
# ================================================================
