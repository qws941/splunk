###############################################################################
# FortiGate to Splunk HEC Integration Configuration
#
# ⚠️  LEGACY CONFIGURATION - For Reference Only
# Current production setup uses Syslog → Splunk (index=fw)
# See: configs/fortigate-syslog.conf for current production method
#
# 이 파일은 FortiGate 방화벽에서 Splunk HEC로 로그를 전송하는 설정입니다.
#
# 적용 방법:
# 1. FortiGate CLI 또는 GUI에서 설정
# 2. 각 섹션별로 복사하여 FortiGate에 입력
# 3. Splunk에서 HEC 토큰 생성 후 사용
###############################################################################

###############################################################################
# 방법 1: FortiGate CLI 설정 (Syslog via Splunk Universal Forwarder)
###############################################################################

# ============================================================================
# Step 1: Syslog 서버 설정 (Splunk HEC 엔드포인트)
# ============================================================================

config log syslogd setting
    set status enable
    set server "YOUR_SPLUNK_HEC_HOST"
    set port 514
    set mode reliable
    set format rfc5424
    set facility local7
    set source-ip ""
    set enc-algorithm high
end

# 또는 여러 Syslog 서버 설정 (고가용성)
config log syslogd override-setting
    edit "splunk-primary"
        set status enable
        set server "YOUR_SPLUNK_HEC_HOST"
        set port 514
        set mode reliable
        set format rfc5424
    next
    edit "splunk-secondary"
        set status enable
        set server "YOUR_SPLUNK_HEC_HOST_BACKUP"
        set port 514
        set mode reliable
        set format rfc5424
    next
end

# ============================================================================
# Step 2: 로그 필터 설정 (어떤 로그를 Splunk로 보낼지)
# ============================================================================

# Traffic 로그 필터 (모든 트래픽)
config log syslogd filter
    set forward-traffic enable
    set local-traffic enable
    set multicast-traffic enable
    set sniffer-traffic enable
    set anomaly enable
    set voip enable
    set gtp enable
    set dns enable
    set ssh enable
    set ssl enable
end

# Security 로그 필터 (IPS, AntiVirus, WebFilter 등)
config log syslogd filter
    set severity information
    set filter-type include
    set filter "severity>=warning"
end

# ============================================================================
# Step 3: FortiAnalyzer 클라우드 로그 설정 (선택사항)
# ============================================================================

config log fortianalyzer setting
    set status enable
    set server "YOUR_FORTIANALYZER_IP"
    set reliable enable
    set upload-option realtime
    set enc-algorithm high
    set conn-timeout 10
end

# FortiAnalyzer 로그 필터
config log fortianalyzer filter
    set forward-traffic enable
    set local-traffic enable
    set severity information
end

# ============================================================================
# Step 4: Memory 로그 설정 (로컬 버퍼링)
# ============================================================================

config log memory setting
    set status enable
    set diskfull overwrite
end

config log memory filter
    set severity information
    set forward-traffic enable
    set local-traffic enable
end


###############################################################################
# 방법 2: FortiGate GUI 설정 가이드
###############################################################################

# GUI 경로:
# Log & Report → Log Settings → Remote Logging and Archiving
#
# 1. Enable Logging to Syslog: Enable
# 2. IP Address/FQDN: YOUR_SPLUNK_HEC_HOST
# 3. Port: 514 (또는 Custom)
# 4. Protocol: UDP 또는 Reliable (TCP)
# 5. Facility: local7
# 6. Log Format: RFC 5424
# 7. Apply


###############################################################################
# 방법 3: FortiGate → Splunk HEC Direct (REST API 사용)
###############################################################################

# FortiGate는 기본적으로 HEC를 직접 지원하지 않습니다.
# 대신 다음 방법을 사용하세요:
#
# Option A: Splunk Universal Forwarder (추천)
# - FortiGate → Syslog (Port 514) → Splunk UF → HEC → Splunk
# - Universal Forwarder가 Syslog를 받아서 HEC로 변환
#
# Option B: FortiAnalyzer Splunk Connector
# - FortiGate → FortiAnalyzer → Splunk Connector → HEC → Splunk
# - FortiAnalyzer에 내장된 Splunk Connector 사용
#
# Option C: Custom Script (이 프로젝트의 방식)
# - FortiGate → FortiAnalyzer → Node.js Script → HEC → Splunk
# - 본 프로젝트의 index.js 사용


###############################################################################
# 방법 4: FortiAnalyzer Splunk Connector 설정
###############################################################################

# FortiAnalyzer CLI 설정:

config system log-fetch client-profile
    edit "splunk-hec"
        set server-ip YOUR_SPLUNK_HEC_HOST
        set server-port 8088
        set secure-connection enable
        set client-key "YOUR_HEC_TOKEN"
        set data-format splunk-hec
        set log-type traffic utm event
        set status enable
    next
end

# Splunk Connector 활성화
config system log-fetch server-settings
    set status enable
    set sync-adom-config enable
end


###############################################################################
# 검증 및 테스트
###############################################################################

# 1. FortiGate에서 로그 전송 확인
diagnose debug application syslogd -1
diagnose debug enable

# 2. Syslog 연결 상태 확인
diagnose test application syslogd 1

# 3. FortiAnalyzer 연결 확인
diagnose test application fazd 1

# 4. 로그 전송 통계 확인
get log syslogd setting
get log fortianalyzer setting
diagnose log stats

# 5. 실시간 로그 보기
execute log filter category 0
execute log filter field severity warning
execute log display


###############################################################################
# Splunk 측 설정 (HEC Token 생성)
###############################################################################

# Splunk Web UI:
# Settings → Data Inputs → HTTP Event Collector → New Token
#
# Token Name: fortigate-hec
# Source type: fortigate:traffic
# Index: fw
#
# 생성 후 Token 값 복사:
# Token: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx


###############################################################################
# HEC 엔드포인트 테스트
###############################################################################

# FortiGate에서 cURL 테스트:
execute ping YOUR_SPLUNK_HEC_HOST
execute telnet YOUR_SPLUNK_HEC_HOST 8088

# Linux/Mac에서 HEC 테스트:
curl -k https://YOUR_SPLUNK_HEC_HOST:8088/services/collector/event \
  -H "Authorization: Splunk YOUR_HEC_TOKEN" \
  -d '{
    "event": "FortiGate Test Event",
    "sourcetype": "fortigate:traffic",
    "index": "fw",
    "source": "fortigate-test",
    "host": "fortigate-fw01"
  }'

# 기대 응답:
# {"text":"Success","code":0}


###############################################################################
# 주요 로그 타입 및 필드
###############################################################################

# Traffic Log Fields:
# - date, time, devname, devid, logid, type, subtype
# - level, vd, srcip, srcport, srcintf, srcintfrole
# - dstip, dstport, dstintf, dstintfrole
# - sessionid, proto, action, policyid, policytype
# - service, dstcountry, srccountry, trandisp, duration
# - sentbyte, rcvdbyte, sentpkt, rcvdpkt

# UTM Log Fields (IPS, AntiVirus, WebFilter):
# - date, time, devname, devid, logid, type, subtype
# - level, vd, srcip, dstip, srcport, dstport
# - attack, attackid, severity, ref, msg
# - virus, url, hostname, profile, action
# - filename, filesize, filetype, direction

# Event Log Fields:
# - date, time, devname, devid, logid, type, subtype
# - level, vd, logdesc, msg, action, status
# - user, group, authserver, reason


###############################################################################
# 트러블슈팅
###############################################################################

# 문제: Syslog 연결 실패
# 해결:
#   1. 방화벽 규칙 확인 (Port 514 UDP/TCP)
#   2. 네트워크 연결 확인: execute ping YOUR_SPLUNK_HEC_HOST
#   3. DNS 해상 확인: execute nslookup YOUR_SPLUNK_HEC_HOST

# 문제: 로그가 Splunk에 안 보임
# 해결:
#   1. Splunk에서 인덱스 확인: index=fw
#   2. HEC 상태 확인: https://YOUR_SPLUNK_HEC_HOST:8088/services/collector/health
#   3. FortiGate 로그 필터 확인: get log syslogd filter

# 문제: 로그 지연
# 해결:
#   1. mode를 reliable로 변경 (UDP → TCP)
#   2. FortiAnalyzer 사용 권장 (대용량 처리)
#   3. Batch 설정 조정


###############################################################################
# 참고 자료
###############################################################################

# FortiGate Administration Guide:
# https://docs.fortinet.com/document/fortigate/7.4.0/administration-guide

# Splunk Add-on for Fortinet FortiGate:
# https://splunkbase.splunk.com/app/2846

# FortiAnalyzer Administration Guide:
# https://docs.fortinet.com/document/fortianalyzer/7.4.0/administration-guide

# Splunk HTTP Event Collector Documentation:
# https://docs.splunk.com/Documentation/Splunk/latest/Data/UsetheHTTPEventCollector


###############################################################################
# 보안 권장사항
###############################################################################

# 1. TLS/SSL 암호화 사용
#    set enc-algorithm high
#    set secure-connection enable

# 2. 전용 네트워크 사용
#    Management VLAN 또는 Out-of-Band Management

# 3. HEC Token 보안 관리
#    - Token을 파일에 저장하지 말 것
#    - 주기적으로 Token 교체
#    - 최소 권한 원칙 적용

# 4. 로그 필터링
#    - 필요한 로그만 전송 (비용 절감)
#    - severity 기준 필터링
#    - 민감 정보 마스킹

# 5. 고가용성 구성
#    - Primary/Secondary Splunk 서버 설정
#    - FortiAnalyzer를 통한 버퍼링
#    - 로컬 디스크 백업


###############################################################################
# 마침
###############################################################################

# 이 설정 파일을 FortiGate에 적용하면:
# ✅ FortiGate → Splunk HEC로 실시간 로그 전송
# ✅ Traffic, UTM, Event 로그 모두 수집
# ✅ 고가용성 및 보안 구성
# ✅ Splunk 대시보드에서 실시간 모니터링

# 설정 완료 후 Splunk에서 확인:
# index=fw | head 100

