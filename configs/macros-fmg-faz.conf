# Splunk SPL Macros for FMG/FAZ Operations
# Purpose: Reusable, modular search patterns for dashboards, alerts, reports
# Deploy to: $SPLUNK_HOME/etc/apps/search/local/macros.conf
#
# Architecture:
#   - DRY principle (Don't Repeat Yourself)
#   - Single source of truth for search logic
#   - Easy maintenance (update once, applies everywhere)
#   - Performance optimization (consistent search patterns)

# ==========================================
# BASE INDEX & SOURCETYPE MACROS
# ==========================================

[fmg_base_search]
definition = index=fw sourcetype=fmg:*
iseval = 0

[faz_base_search]
definition = index=fw sourcetype=faz:*
iseval = 0

[fmg_config_search]
definition = index=fw sourcetype=fmg:config
iseval = 0

[fmg_audit_search]
definition = index=fw sourcetype=fmg:audit
iseval = 0

[fmg_device_search]
definition = index=fw sourcetype=fmg:device
iseval = 0

[faz_event_search]
definition = index=fw sourcetype=faz:event
iseval = 0

[faz_traffic_search]
definition = index=fw sourcetype=faz:traffic
iseval = 0

[faz_utm_search]
definition = index=fw sourcetype=faz:utm
iseval = 0

# ==========================================
# CRITICAL ALERT FILTERING (with LogID exclusions)
# ==========================================

[faz_filter_critical_alerts]
definition = severity="critical" NOT (logid IN ("0100032001","0100032002","0100032003","0100032004","0100032005","0101039424","0101039425","0101039426","0101039427","0101039428","0102043008","0102043009","0102043010","0104044001","0104044002","0104044003","0104044004","0103043200","0103043201","0103043202","0103043203","0100033100","0100033101","0100033102"))
iseval = 0

[faz_critical_events]
definition = `faz_event_search` `faz_filter_critical_alerts`
iseval = 0

[faz_critical_utm]
definition = `faz_utm_search` severity="critical"
iseval = 0

# ==========================================
# DEVICE STATUS MACROS
# ==========================================

[fmg_connected_devices]
definition = `fmg_device_search` connection_status="up" | dedup device_name
iseval = 0

[fmg_disconnected_devices]
definition = `fmg_device_search` connection_status="down" | dedup device_name
iseval = 0

[fmg_device_health_check]
definition = `fmg_device_search` | dedup device_name | eval health_status=case(connection_status="up" AND ha_mode IN ("active-active","active-passive"), "Healthy", connection_status="up", "Warning", 1=1, "Critical")
iseval = 0

# ==========================================
# TIME RANGE MACROS (for consistent time windows)
# ==========================================

[time_last_hour]
definition = earliest=-1h latest=now
iseval = 0

[time_last_24h]
definition = earliest=-24h@h latest=now
iseval = 0

[time_last_7d]
definition = earliest=-7d@d latest=now
iseval = 0

[time_last_30d]
definition = earliest=-30d@d latest=now
iseval = 0

# ==========================================
# ADMIN ACTIVITY MACROS
# ==========================================

[fmg_admin_success]
definition = `fmg_audit_search` status="success"
iseval = 0

[fmg_admin_failure]
definition = `fmg_audit_search` status="failure"
iseval = 0

[fmg_config_changes_by_admin(1)]
args = admin_name
definition = `fmg_config_search` admin_user="$admin_name$"
iseval = 0

# ==========================================
# THREAT DETECTION MACROS
# ==========================================

[faz_blocked_events]
definition = `faz_event_search` action="blocked"
iseval = 0

[faz_allowed_suspicious]
definition = `faz_event_search` action="allowed" severity IN ("critical","high")
iseval = 0

[faz_top_blocked_ips(1)]
args = limit
definition = `faz_blocked_events` | stats count as block_count by src_ip | sort -block_count | head $limit$
iseval = 0

# ==========================================
# TRAFFIC ANALYSIS MACROS
# ==========================================

[faz_traffic_top_talkers(1)]
args = limit
definition = `faz_traffic_search` | stats sum(eval(bytes_sent+bytes_received)) as total_bytes by src_ip | eval total_mb=round(total_bytes/1024/1024,2) | sort -total_mb | head $limit$
iseval = 0

[faz_traffic_by_service]
definition = `faz_traffic_search` | stats sum(eval(bytes_sent+bytes_received)) as total_bytes by service | eval total_gb=round(total_bytes/1024/1024/1024,2)
iseval = 0

# ==========================================
# PERFORMANCE METRICS MACROS
# ==========================================

[faz_event_rate]
definition = `faz_event_search` | bin _time span=1m | stats count as events_per_min by _time
iseval = 0

[fmg_config_change_rate]
definition = `fmg_config_search` | bin _time span=1h | stats count as changes_per_hour by _time
iseval = 0

# ==========================================
# FIELD EXTRACTION HELPERS
# ==========================================

[extract_device_info]
definition = eval device_info=device_name." (".device_ip.")"
iseval = 0

[extract_admin_info]
definition = eval admin_info=admin_user." via ".ui_type
iseval = 0

[extract_threat_info]
definition = eval threat_info=attack_name." (Severity: ".severity.")"
iseval = 0

# ==========================================
# DASHBOARD VISUALIZATION MACROS
# ==========================================

[format_timestamp]
definition = eval formatted_time=strftime(_time, "%Y-%m-%d %H:%M:%S")
iseval = 0

[format_bytes_to_mb]
definition = eval bytes_mb=round(bytes/1024/1024, 2)
iseval = 0

[format_bytes_to_gb]
definition = eval bytes_gb=round(bytes/1024/1024/1024, 2)
iseval = 0

[add_status_icon]
definition = eval status_icon=case(status="success" OR connection_status="up", "âœ…", status="failure" OR connection_status="down", "âŒ", 1=1, "âš ï¸")
iseval = 0

[add_severity_icon]
definition = eval severity_icon=case(severity="critical", "ðŸ”´", severity="high", "ðŸŸ ", severity="medium", "ðŸŸ¡", severity="low", "ðŸŸ¢", 1=1, "âšª")
iseval = 0

# ==========================================
# CORRELATION & ENRICHMENT MACROS
# ==========================================

[enrich_with_abuse_score]
definition = lookup abuseipdb_lookup ip AS src_ip OUTPUT abuse_score, country AS src_country
iseval = 0

[calculate_risk_score]
definition = eval risk_score=case(severity="critical" AND abuse_score>80, 100, severity="critical", 90, severity="high" AND abuse_score>60, 85, severity="high", 75, severity="medium", 50, 1=1, 25)
iseval = 0

# ==========================================
# ALERT CONDITION MACROS
# ==========================================

[alert_critical_threshold]
definition = where count > 10
iseval = 0

[alert_high_threshold]
definition = where count > 50
iseval = 0

[alert_device_down]
definition = where connection_status="down"
iseval = 0

# ==========================================
# REPORTING MACROS
# ==========================================

[fmg_daily_summary]
definition = `fmg_config_search` `time_last_24h` | stats count as config_changes, dc(admin_user) as active_admins, dc(device_name) as affected_devices
iseval = 0

[faz_security_summary]
definition = `faz_critical_events` `time_last_24h` | stats count as critical_events, dc(src_ip) as unique_sources, dc(dst_ip) as unique_targets
iseval = 0

# ==========================================
# PARAMETERIZED MACROS (Advanced)
# ==========================================

[faz_events_by_device(1)]
args = device_name
definition = `faz_event_search` device_name="$device_name$"
iseval = 0

[faz_events_by_severity(1)]
args = severity_level
definition = `faz_event_search` severity="$severity_level$"
iseval = 0

[fmg_changes_by_object(1)]
args = object_type
definition = `fmg_config_search` config_object="$object_type$"
iseval = 0

[time_range_custom(2)]
args = earliest_time, latest_time
definition = earliest=$earliest_time$ latest=$latest_time$
iseval = 0

# ==========================================
# COMPOSITE MACROS (combining multiple macros)
# ==========================================

[faz_critical_events_last_24h]
definition = `faz_critical_events` `time_last_24h`
iseval = 0

[fmg_config_changes_last_24h]
definition = `fmg_config_search` `time_last_24h`
iseval = 0

[faz_blocked_critical_last_hour]
definition = `faz_critical_events` `time_last_hour` action="blocked"
iseval = 0

# ==========================================
# DATA MODEL ACCELERATION MACROS
# ==========================================

[tstats_faz_events]
definition = | tstats count WHERE datamodel=Fortinet_Security.Security_Events
iseval = 0

[tstats_faz_critical]
definition = | tstats count WHERE datamodel=Fortinet_Security.Security_Events Security_Events.severity="critical"
iseval = 0

# ==========================================
# USAGE EXAMPLES
# ==========================================
# Dashboard panel query:
#   `faz_critical_events_last_24h`
#   | stats count by src_ip, dst_ip
#   | `format_timestamp`
#
# Alert search:
#   `faz_critical_events` `time_last_hour`
#   | stats count
#   | `alert_critical_threshold`
#
# Report:
#   `fmg_daily_summary`
#   | `faz_security_summary`
#   | table *

# ==========================================
# MAINTENANCE NOTES
# ==========================================
# - Update macros when search patterns change
# - Test macros after updates: | `macro_name`
# - Document business logic in comments
# - Version control this file (git)
# - Review macro performance quarterly
# - Deprecated macros: comment with [DEPRECATED] prefix
