###############################################################################
# FortiAnalyzer → Splunk HEC Direct Integration (Advanced)
#
# ⚠️  LEGACY CONFIGURATION - For Reference Only
# Current production setup uses Syslog → Splunk (index=fw)
# See: configs/fortigate-syslog.conf + configs/inputs.conf
#
# This file describes HEC-based ingestion (FortiAnalyzer required)
# FortiGate → FortiAnalyzer → Splunk HEC (REST API) → index=fw
###############################################################################

###############################################################################
# Prerequisites
###############################################################################

# 1. FortiAnalyzer Firmware: 6.4.0 이상
# 2. Splunk HEC Token 생성 완료
# 3. FortiGate에서 FortiAnalyzer로 로그 전송 설정 완료
# 4. Network 연결: FortiAnalyzer → Splunk (Port 8088 HTTPS)


###############################################################################
# Part 1: Splunk HEC Connector 프로파일 생성
###############################################################################

config system log-fetch client-profile
    edit "splunk-hec-primary"
        # Basic Settings
        set server-type splunk
        set server-ip "YOUR_SPLUNK_HEC_HOST"
        set server-port 8088
        set secure-connection enable

        # Authentication
        set client-key "YOUR_HEC_TOKEN_HERE"  # UUID format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

        # Data Format
        set data-format splunk-hec
        set peer-cert-cn "YOUR_SPLUNK_CN"     # Optional: SSL certificate CN validation

        # Log Types to Send
        set log-type traffic utm event         # All log categories
        # Available: traffic, utm, event, virus, webfilter, ips, emailfilter, dlp, app-ctrl, waf, gtp, dns, ssh, ssl

        # Filtering
        set sync-adom-config enable             # Sync ADOM configuration
        set upload-interval realtime            # realtime | hourly | daily
        set upload-option store-and-upload      # store-and-upload | realtime | 1-file-per-dev

        # Status
        set status enable
    next
end


###############################################################################
# Part 2: High Availability - Secondary HEC Server (Optional)
###############################################################################

config system log-fetch client-profile
    edit "splunk-hec-secondary"
        set server-type splunk
        set server-ip "YOUR_SPLUNK_HEC_BACKUP_HOST"
        set server-port 8088
        set secure-connection enable
        set client-key "YOUR_HEC_TOKEN_BACKUP"
        set data-format splunk-hec
        set log-type traffic utm event
        set upload-interval realtime
        set priority 2                          # Lower priority than primary
        set status enable
    next
end


###############################################################################
# Part 3: Global Connector Settings
###############################################################################

config system log-fetch server-settings
    # Enable Log Fetching Service
    set status enable

    # Sync ADOM Configuration
    set sync-adom-config enable

    # Connection Settings
    set max-conn-timeout 300                   # 5 minutes timeout
    set unencrypted-logging disable            # Force encryption

    # Performance Tuning
    set upload-max-conn 10                     # Max concurrent connections
    set max-logs-per-batch 5000                # Batch size (1000-10000)
    set upload-retry-max 3                     # Retry attempts on failure

    # Buffer Management
    set buffer-max-send 10000000               # 10MB buffer size
    set buffer-max-disk 100000000              # 100MB disk buffer
end


###############################################################################
# Part 4: Log Filtering (FortiAnalyzer Level)
###############################################################################

# Configure which logs to send to Splunk HEC
config log-fetch filter
    edit "splunk-critical-only"
        # Severity Filter
        set severity emergency alert critical   # Only critical events

        # Log Type Filter
        set log-type utm event                  # Security + Events only

        # Exclusions
        set filter "NOT msg contains 'Update Fail' AND NOT msg contains 'Login Fail'"

        # Status
        set status enable
    next

    edit "splunk-all-logs"
        # All severity levels
        set severity emergency alert critical error warning notification information debug

        # All log types
        set log-type traffic utm event

        # Apply to HEC profile
        set client-profile "splunk-hec-primary"

        # Status
        set status enable
    next
end


###############################################################################
# Part 5: Advanced HEC Options
###############################################################################

config system log-fetch client-profile
    edit "splunk-hec-advanced"
        set server-type splunk
        set server-ip "YOUR_SPLUNK_HEC_HOST"
        set server-port 8088
        set secure-connection enable
        set client-key "YOUR_HEC_TOKEN"
        set data-format splunk-hec

        # Advanced Settings
        set compress gzip                       # Compress data (gzip | deflate | none)
        set max-log-rate 100000                 # Max logs/sec (throttling)
        set retry-upload-interval 60            # Retry interval in seconds

        # HEC Metadata
        set sourcetype "fortianalyzer:traffic"  # Custom sourcetype
        set source "fortianalyzer-prod"         # Custom source
        set host-field devname                  # Use device name as host

        # Indexing
        set index "fw"                          # Default Splunk index

        # SSL/TLS
        set ssl-min-proto-version tls1-2        # TLS 1.2 minimum
        set certificate "Fortinet_CA_SSL"       # Optional: client certificate

        # Status
        set status enable
    next
end


###############################################################################
# Part 6: Event Transformation (JSON Format)
###############################################################################

# FortiAnalyzer automatically converts logs to JSON for HEC
# Standard HEC Payload Format:
# {
#   "time": 1234567890.123,
#   "host": "FGT-MAIN-01",
#   "source": "fortianalyzer",
#   "sourcetype": "fortianalyzer:traffic",
#   "index": "fw",
#   "event": {
#     "devname": "FGT-MAIN-01",
#     "devid": "FG100F12345678",
#     "logid": "0000000013",
#     "type": "traffic",
#     "subtype": "forward",
#     "level": "notice",
#     "vd": "root",
#     "srcip": "192.168.1.100",
#     "srcport": 54321,
#     "dstip": "8.8.8.8",
#     "dstport": 443,
#     "action": "accept",
#     ...
#   }
# }


###############################################################################
# Part 7: Monitoring and Validation
###############################################################################

# Check Connector Status
diagnose test application fazd 1

# View HEC Connection Statistics
diagnose log-fetch client-profile status splunk-hec-primary

# Monitor Upload Queue
diagnose log-fetch queue status

# View Recent Upload Logs
diagnose log-fetch upload-log list

# Test HEC Connectivity
diagnose test application log-fetch-client 1

# Check SSL Certificate
diagnose debug application log-fetch-client -1
diagnose debug enable

# View Real-time Upload Activity
execute log-fetch display


###############################################################################
# Part 8: Performance Tuning
###############################################################################

config system performance
    # Increase log processing capacity
    set max-log-forward-rate 100000            # Logs/sec
    set max-upload-bandwidth 100000            # KB/sec (100 MB/sec)
    set concurrent-upload-limit 10             # Parallel uploads
end

config system log-settings
    # Local buffering
    set buffer-mode memory
    set buffer-size 1024                       # MB
    set max-log-file-size 100                  # MB per file
    set max-log-file-num 10                    # Max files to keep
end


###############################################################################
# Part 9: Troubleshooting
###############################################################################

# Problem: HEC Connection Timeout
# Solution:
#   1. Check network connectivity: execute ping YOUR_SPLUNK_HEC_HOST
#   2. Verify port 8088 is open: execute telnet YOUR_SPLUNK_HEC_HOST 8088
#   3. Check SSL certificate: diagnose debug application log-fetch-client -1

# Problem: Authentication Failed (401)
# Solution:
#   1. Verify HEC token in Splunk: Settings → Data Inputs → HTTP Event Collector
#   2. Check token format: UUID with hyphens
#   3. Ensure HEC is enabled globally in Splunk

# Problem: Logs Not Appearing in Splunk
# Solution:
#   1. Check index exists: | metadata type=sources index=fw
#   2. Verify HEC endpoint health: curl https://SPLUNK:8088/services/collector/health
#   3. Check FortiAnalyzer upload logs: diagnose log-fetch upload-log list

# Problem: High Upload Lag
# Solution:
#   1. Increase max-logs-per-batch (default: 1000 → 5000)
#   2. Enable compression: set compress gzip
#   3. Add secondary HEC server for load balancing


###############################################################################
# Part 10: Splunk Side Configuration
###############################################################################

# HEC Token Settings (Splunk Web UI):
#
# Settings → Data Inputs → HTTP Event Collector → Global Settings
# ✓ All Tokens: Enabled
# ✓ Enable SSL: Yes
# ✓ HTTP Port Number: 8088
# ✓ Default Source: fortianalyzer
# ✓ Default Index: fw
#
# New Token:
# Name: fortianalyzer-hec
# Source type: fortianalyzer:traffic (or _json for auto-detection)
# Index: fw
# Advanced:
#   ✓ Use ACK: Enabled (for reliable delivery)
#   ✓ Enable Indexer Acknowledgment


###############################################################################
# Part 11: Testing HEC from FortiAnalyzer
###############################################################################

# Test HEC Endpoint (from Linux/Mac/Windows):
curl -k https://YOUR_SPLUNK_HEC_HOST:8088/services/collector/event \
  -H "Authorization: Splunk YOUR_HEC_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "time": 1234567890.123,
    "host": "fortianalyzer-test",
    "source": "manual-test",
    "sourcetype": "fortianalyzer:traffic",
    "index": "fw",
    "event": {
      "message": "FortiAnalyzer HEC Integration Test",
      "severity": "information",
      "test": true
    }
  }'

# Expected Response:
# {"text":"Success","code":0}

# Check in Splunk:
# index=fw sourcetype=fortianalyzer:traffic test=true


###############################################################################
# Part 12: Security Best Practices
###############################################################################

# 1. Use TLS 1.2+
#    set ssl-min-proto-version tls1-2
#    set secure-connection enable

# 2. Rotate HEC Tokens Regularly (every 90 days)
#    Create new token → Update config → Disable old token

# 3. Restrict HEC Access
#    Splunk: allowedTokens = [specific-token-list]
#    Firewall: Allow FortiAnalyzer IP → Splunk:8088 only

# 4. Enable HEC ACK (Indexer Acknowledgment)
#    Ensures logs are successfully indexed before deletion

# 5. Monitor HEC Performance
#    Splunk: index=_internal source=*splunkd.log component=HttpEventCollector

# 6. Encrypt Data in Transit
#    set compress gzip
#    set secure-connection enable

# 7. Use Dedicated Network (Management VLAN)
#    Separate data plane from log forwarding


###############################################################################
# Part 13: Reference Documentation
###############################################################################

# FortiAnalyzer Administration Guide:
# https://docs.fortinet.com/document/fortianalyzer/latest/administration-guide

# FortiAnalyzer JSON API:
# https://docs.fortinet.com/document/fortianalyzer/latest/json-rpc-api-reference

# Splunk HEC Documentation:
# https://docs.splunk.com/Documentation/Splunk/latest/Data/UsetheHTTPEventCollector

# Splunk Add-on for Fortinet:
# https://splunkbase.splunk.com/app/2846


###############################################################################
# Summary
###############################################################################

# This configuration provides:
# ✅ Direct FortiAnalyzer → Splunk HEC integration
# ✅ Real-time log forwarding (< 1 second latency)
# ✅ High availability with secondary HEC server
# ✅ Advanced filtering and transformation
# ✅ Performance tuning for high-volume environments
# ✅ Security hardening (TLS 1.2+, token rotation)
# ✅ Comprehensive monitoring and troubleshooting

# After applying this config:
# 1. Verify HEC connection: diagnose test application fazd 1
# 2. Monitor upload queue: diagnose log-fetch queue status
# 3. Check Splunk: index=fw | stats count by sourcetype

