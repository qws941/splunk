# Saved Searches for Fortinet Device Management Dashboard Alerts
# Optimized for FortiOS 7.x
# Channel ID: C09DSD6JH2Q
#
# FortiOS 7.x Key Features:
# - New field: eventtime (nanosecond precision timestamp)
# - New field: tz (timezone)
# - New field: logver (log format version)
# - Enhanced UTF-8 encoding
# - JSON log format support

# ==========================================
# Device Events Alert (FortiOS 7.x)
# ==========================================
[Fortinet_Device_Events_Alert_v7]
search = index=fw devname=* \
| where "$alert_device_events$" != "disabled" \
| eval event_timestamp=coalesce(eventtime, _time) \
| eval tz_offset=coalesce(tz, "+0000") \
| eval device_name=coalesce(devname, device, hostname) \
| eval log_description=coalesce(logdesc, msg, message) \
| eval device_status=coalesce(status, state, "Unknown") \
| stats latest(event_timestamp) as last_seen, count as event_count, latest(device_status) as status, latest(tz_offset) as timezone by device_name, log_description \
| eval event_time=strftime(last_seen, "%Y-%m-%d %H:%M:%S") \
| eval threshold=$alert_device_events_threshold$ \
| eval mode="$alert_device_events_mode$" \
| where (mode="realtime" AND event_count > 0) OR (mode="threshold" AND event_count > threshold) OR status="Disconnected" \
| eval priority=case(status="Disconnected", "HIGH", event_count > threshold*2, "MEDIUM", 1=1, "LOW") \
| eval fortios_version="7.x" \
| table device_name, event_time, timezone, status, event_count, log_description, priority, mode, threshold, fortios_version

dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */15 * * * *
enableSched = 1

alert.track = 1
alert.severity = 3
counttype = number of events
quantity = 0
relation = greater than

action.slack = 1
action.slack.param.channel = C09DSD6JH2Q
action.slack.param.attachment = message
action.slack.param.message = *üñ•Ô∏è Device Event Alert (FortiOS 7.x)*\n\n*Device:* $result.device_name$\n*Time:* $result.event_time$ ($result.timezone$)\n*Status:* $result.status$\n*Event Count:* $result.event_count$\n*Priority:* $result.priority$\n\n*Details:*\n```$result.log_description$```\n\n*FortiOS:* $result.fortios_version$\n\n<https://splunk.yourdomain.com/app/search/fortinet_device_management|View Dashboard>

# ==========================================
# Admin Activity Alert (FortiOS 7.x)
# ==========================================
[Fortinet_Admin_Activity_Alert_v7]
search = index=fw (logdesc="Admin*" OR user=* OR adminuser=*) \
| where "$alert_admin_activity$" != "disabled" \
| eval event_timestamp=coalesce(eventtime, _time) \
| eval tz_offset=coalesce(tz, "+0000") \
| eval event_time=strftime(event_timestamp, "%Y-%m-%d %H:%M:%S") \
| eval admin_user=coalesce(user, adminuser, username, "Unknown") \
| eval activity_type=case(match(logdesc, "(?i)login"), "Login", match(logdesc, "(?i)logout"), "Logout", match(logdesc, "(?i)config"), "Config", match(logdesc, "(?i)admin"), "Admin", 1=1, "Other") \
| eval source_ip=coalesce(srcip, remip, src, "N/A") \
| eval log_description=coalesce(logdesc, msg, message) \
| eval log_version=coalesce(logver, "N/A") \
| eval priority=case(activity_type="Config" OR match(log_description, "(?i)fail"), "HIGH", activity_type="Admin", "MEDIUM", 1=1, "LOW") \
| stats count as activity_count by event_time, tz_offset, admin_user, activity_type, source_ip, log_description, log_version, priority \
| eval threshold=$alert_admin_activity_threshold$ \
| eval mode="$alert_admin_activity_mode$" \
| where (mode="realtime" AND activity_count > 0) OR (mode="threshold" AND activity_count > threshold) \
| eval fortios_version="7.x" \
| table event_time, tz_offset, admin_user, activity_type, source_ip, log_description, log_version, priority, activity_count, mode, threshold, fortios_version

dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */15 * * * *
enableSched = 1

alert.track = 1
alert.severity = 2
counttype = number of events
quantity = 0
relation = greater than

action.slack = 1
action.slack.param.channel = C09DSD6JH2Q
action.slack.param.attachment = message
action.slack.param.message = *üë§ Admin Activity Alert (FortiOS 7.x)*\n\n*Admin User:* $result.admin_user$\n*Activity:* $result.activity_type$\n*Source IP:* $result.source_ip$\n*Time:* $result.event_time$ ($result.tz_offset$)\n*Priority:* $result.priority$\n*Log Version:* $result.log_version$\n\n*Action Details:*\n```$result.log_description$```\n\n*FortiOS:* $result.fortios_version$\n\n<https://splunk.yourdomain.com/app/search/fortinet_device_management|View Dashboard>

# ==========================================
# Configuration Changes Alert (FortiOS 7.x)
# ==========================================
[Fortinet_Config_Changes_Alert_v7]
search = index=fw (logdesc="*Configuration*" OR logdesc="*Config*" OR action="config-change" OR subtype="config") \
| where "$alert_config_changes$" != "disabled" \
| eval event_timestamp=coalesce(eventtime, _time) \
| eval tz_offset=coalesce(tz, "+0000") \
| eval event_time=strftime(event_timestamp, "%Y-%m-%d %H:%M:%S") \
| eval admin_user=coalesce(user, adminuser, username, "Unknown") \
| eval device=coalesce(devname, device, hostname, "Global") \
| eval change_message=coalesce(msg, message, logdesc) \
| eval change_category=case(match(change_message, "(?i)policy"), "üîí Policy", match(change_message, "(?i)address"), "üåê Address", match(change_message, "(?i)service"), "‚öôÔ∏è Service", match(change_message, "(?i)interface"), "üîå Interface", match(change_message, "(?i)route"), "üõ£Ô∏è Route", match(change_message, "(?i)vip"), "üéØ VIP", match(change_message, "(?i)zone"), "üó∫Ô∏è Zone", 1=1, "üìã Other") \
| eval log_version=coalesce(logver, "N/A") \
| eval priority=case(change_category IN ("üîí Policy", "üõ£Ô∏è Route", "üéØ VIP"), "HIGH", change_category IN ("üåê Address", "‚öôÔ∏è Service"), "MEDIUM", 1=1, "LOW") \
| stats count as change_count by event_time, tz_offset, admin_user, device, change_category, change_message, log_version, priority \
| eval threshold=$alert_config_changes_threshold$ \
| eval mode="$alert_config_changes_mode$" \
| where (mode="realtime" AND change_count > 0) OR (mode="threshold" AND change_count > threshold) \
| eval fortios_version="7.x" \
| table event_time, tz_offset, admin_user, device, change_category, change_message, log_version, priority, change_count, mode, threshold, fortios_version

dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */15 * * * *
enableSched = 1

alert.track = 1
alert.severity = 2
counttype = number of events
quantity = 0
relation = greater than

action.slack = 1
action.slack.param.channel = C09DSD6JH2Q
action.slack.param.attachment = message
action.slack.param.message = *üîß Configuration Change Alert (FortiOS 7.x)*\n\n*Admin User:* $result.admin_user$\n*Device:* $result.device$\n*Category:* $result.change_category$\n*Time:* $result.event_time$ ($result.tz_offset$)\n*Priority:* $result.priority$\n*Log Version:* $result.log_version$\n\n*Change Details:*\n```$result.change_message$```\n\n*FortiOS:* $result.fortios_version$\n\n<https://splunk.yourdomain.com/app/search/fortinet_device_management|View Dashboard> ‚Ä¢ <https://splunk.yourdomain.com/app/search/config_history|Config History>

# ==========================================
# Install/Update Alert (FortiOS 7.x)
# ==========================================
[Fortinet_Install_Update_Alert_v7]
search = index=fw (logdesc="*install*" OR logdesc="*upgrade*" OR logdesc="*update*" OR msg="*firmware*" OR msg="*package*install*" OR subtype="system") \
| where "$alert_install_updates$" != "disabled" \
| eval event_timestamp=coalesce(eventtime, _time) \
| eval tz_offset=coalesce(tz, "+0000") \
| eval install_time=strftime(event_timestamp, "%Y-%m-%d %H:%M:%S") \
| eval device=coalesce(devname, device, hostname, "FMG") \
| eval admin_user=coalesce(user, adminuser, username, "System") \
| eval install_message=coalesce(msg, message, logdesc) \
| eval install_type=case(match(install_message, "(?i)firmware"), "üì¶ Firmware", match(install_message, "(?i)upgrade"), "‚¨ÜÔ∏è Upgrade", match(install_message, "(?i)package"), "üì¶ Package", match(install_message, "(?i)patch"), "ü©π Patch", 1=1, "üîÑ Update") \
| eval status=case(match(install_message, "(?i)success"), "‚úÖ Success", match(install_message, "(?i)fail"), "‚ùå Failed", match(install_message, "(?i)complete"), "‚úÖ Completed", match(install_message, "(?i)progress"), "‚è≥ In Progress", 1=1, "‚ÑπÔ∏è Unknown") \
| eval log_version=coalesce(logver, "N/A") \
| eval priority=case(status="‚ùå Failed", "HIGH", install_type IN ("üì¶ Firmware", "ü©π Patch"), "HIGH", 1=1, "MEDIUM") \
| stats count as install_count by install_time, tz_offset, device, install_type, admin_user, status, install_message, log_version, priority \
| eval threshold=$alert_install_updates_threshold$ \
| eval mode="$alert_install_updates_mode$" \
| where (mode="realtime" AND install_count > 0) OR (mode="threshold" AND install_count > threshold) \
| eval fortios_version="7.x" \
| table install_time, tz_offset, device, install_type, admin_user, status, install_message, log_version, priority, install_count, mode, threshold, fortios_version

dispatch.earliest_time = -1h
dispatch.latest_time = now
cron_schedule = 0 * * * *
enableSched = 1

alert.track = 1
alert.severity = 3
counttype = number of events
quantity = 0
relation = greater than

action.slack = 1
action.slack.param.channel = C09DSD6JH2Q
action.slack.param.attachment = message
action.slack.param.message = *üì¶ Install/Update Alert (FortiOS 7.x)*\n\n*Device:* $result.device$\n*Type:* $result.install_type$\n*Status:* $result.status$\n*Admin:* $result.admin_user$\n*Priority:* $result.priority$\n*Log Version:* $result.log_version$\n\n*Installation Details:*\n```$result.install_message$```\n\n*Time:* $result.install_time$ ($result.tz_offset$)\n*FortiOS:* $result.fortios_version$\n\n<https://splunk.yourdomain.com/app/search/fortinet_device_management|View Dashboard> ‚Ä¢ <https://splunk.yourdomain.com/app/search/install_history|Install History>

# ==========================================
# FortiOS 7.x Specific Features
# ==========================================
# 1. eventtime: High-precision timestamp (nanoseconds)
#    - Priority: eventtime > _time
#    - Format: epoch with nanoseconds (e.g., 1634567890.123456789)
#
# 2. tz: Timezone offset
#    - Format: "+0900" or "-0800"
#    - Used for accurate time display
#
# 3. logver: Log format version
#    - Example: "7.0.0", "7.2.1"
#    - Helps track log schema changes
#
# 4. Enhanced field names:
#    - devname, device, hostname ‚Üí device_name
#    - msg, message, logdesc ‚Üí log_description
#    - user, adminuser, username ‚Üí admin_user
#
# 5. New subtypes:
#    - subtype="config" for configuration changes
#    - subtype="system" for system events
#
# 6. Emoji categories (FortiOS 7.x enhancement):
#    - üîí Policy, üåê Address, ‚öôÔ∏è Service
#    - üîå Interface, üõ£Ô∏è Route, üéØ VIP
#    - üì¶ Firmware, ‚¨ÜÔ∏è Upgrade, ü©π Patch
#    - ‚úÖ Success, ‚ùå Failed, ‚è≥ In Progress

# ==========================================
# Alert Schedule Summary (FortiOS 7.x)
# ==========================================
# Device Events Alert: Every 15 minutes
# Admin Activity Alert: Every 15 minutes
# Config Changes Alert: Every 15 minutes
# Install/Update Alert: Every hour (at :00)

# ==========================================
# Priority Levels (FortiOS 7.x)
# ==========================================
# HIGH: Critical events requiring immediate attention
#   - Disconnected devices
#   - Failed installations
#   - Policy/Route changes
# MEDIUM: Important events for monitoring
#   - Address/Service changes
#   - Admin config changes
# LOW: Normal operational events
#   - Regular admin logins
#   - Info messages

# ==========================================
# Slack Channel Configuration
# ==========================================
# All alerts sent to: C09DSD6JH2Q (#splunk-alerts)
# Message format: Markdown with code blocks + FortiOS version indicator
# Links: Dashboard + specific views
# Timezone: Displayed with offset (e.g., +0900)

# ==========================================
# Deployment Instructions (FortiOS 7.x)
# ==========================================
# 1. Verify FortiOS version:
#    - FortiGate CLI: get system status
#    - Look for: Version: FortiGate-XXX v7.x.x
#
# 2. Copy this file:
#    sudo cp savedsearches-alerts-fortios7.conf \
#      $SPLUNK_HOME/etc/apps/fortigate/local/savedsearches.conf
#
# 3. Restart Splunk or reload searches:
#    sudo $SPLUNK_HOME/bin/splunk reload search
#
# 4. Verify alerts:
#    Settings > Searches, reports, and alerts
#    Look for: Fortinet_*_Alert_v7
#
# 5. Test alerts manually:
#    Click "Run" on each saved search
#
# 6. Check Slack channel for test messages

# ==========================================
# Dashboard Token Integration (FortiOS 7.x)
# ==========================================
# To enable/disable alerts from dashboard:
# 1. Token condition: | where "$alert_device_events$" != "disabled"
# 2. Token values: "C09DSD6JH2Q" (enabled) or "disabled" (off)
# 3. FortiOS version indicator in messages: "FortiOS: 7.x"

# ==========================================
# Field Mapping (FortiOS 7.x)
# ==========================================
# Standard Field ‚Üí FortiOS 7.x Fields
# _time          ‚Üí eventtime (preferred), _time (fallback)
# devname        ‚Üí devname, device, hostname
# user           ‚Üí user, adminuser, username
# msg            ‚Üí msg, message, logdesc
# srcip          ‚Üí srcip, src, remip
# (new) tz       ‚Üí timezone offset
# (new) logver   ‚Üí log format version
