# Splunk Props Configuration
# Location: $SPLUNK_HOME/etc/apps/fortigate/local/props.conf
#
# Purpose: Define sourcetype parsing and automatic lookups

# ============================================================================
# FortiGate Syslog Sourcetype
# ============================================================================

[fortinet:fortigate:syslog]
# Line breaking
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TRUNCATE = 10000

# Timestamp extraction
TIME_PREFIX = date=
TIME_FORMAT = %Y-%m-%d time=%H:%M:%S
MAX_TIMESTAMP_LOOKAHEAD = 32
TZ = Asia/Seoul

# Field extractions
EXTRACT-fortigate_syslog = ^[^<]*<\d+>(?P<timestamp>[^,]+),\s*(?P<event_id>\d+),\s*(?P<severity>\w+),\s*date=(?P<date>\S+)\s+time=(?P<time>\S+)\s+(?P<message>.*)$

# Additional field extractions from message
EXTRACT-src_ip = src=(?P<src_ip>\d+\.\d+\.\d+\.\d+)
EXTRACT-dst_ip = dst=(?P<dst_ip>\d+\.\d+\.\d+\.\d+)
EXTRACT-action = action=(?P<action>\w+)
EXTRACT-service = service=(?P<service>\S+)
EXTRACT-msg = msg="(?P<msg>[^"]+)"

# Automatic lookups
LOOKUP-abuseipdb = abuseipdb_lookup ip AS src_ip OUTPUT abuse_score,country,isp,domain,last_reported,total_reports,distinct_users
LOOKUP-virustotal = virustotal_lookup ip AS src_ip OUTPUT vt_score,malicious_votes,suspicious_votes,harmless_votes,last_analysis_date
LOOKUP-geo_risk = geo_risk_lookup country OUTPUT country_name,geo_risk_score,risk_category

# Field aliases
FIELDALIAS-src = src AS src_ip
FIELDALIAS-dest = dst AS dst_ip

# Calculated fields
EVAL-risk_score = case(
    abuse_score >= 90, 95,
    abuse_score >= 80, 85,
    abuse_score >= 70, 75,
    abuse_score >= 50, 65,
    vt_score >= 8, 90,
    vt_score >= 5, 75,
    severity="critical", 80,
    severity="high", 65,
    severity="medium", 50,
    severity="low", 30,
    1=1, 20
)

EVAL-event_type = case(
    match(msg, "(?i)(sql.*injection|xss|cross.*site)"), "Web Attack",
    match(msg, "(?i)(brute.*force|failed.*login)"), "Brute Force",
    match(msg, "(?i)(port.*scan|reconnaissance)"), "Scanning",
    match(msg, "(?i)(dos|ddos|flood)"), "DoS Attack",
    match(msg, "(?i)(malware|virus|trojan)"), "Malware",
    action="deny", "Blocked Traffic",
    1=1, "Other"
)

# ============================================================================
# Summary Index Sourcetype
# ============================================================================

[summary_fw]
# No timestamp parsing needed (uses indexed time)
SHOULD_LINEMERGE = false
TRUNCATE = 10000

# Automatic lookup for blocked IPs
LOOKUP-blocked_ips = fortigate_blocked_ips src_ip OUTPUT blocked_time,block_reason,blocked_by

# ============================================================================
# FortiGate Event Sourcetype
# ============================================================================

[fortinet:fortigate:event]
SHOULD_LINEMERGE = false
TIME_PREFIX = eventtime=
TIME_FORMAT = %s
MAX_TIMESTAMP_LOOKAHEAD = 20
TZ = Asia/Seoul

# Same lookups as syslog
LOOKUP-abuseipdb = abuseipdb_lookup ip AS src_ip OUTPUT abuse_score,country,isp
LOOKUP-virustotal = virustotal_lookup ip AS src_ip OUTPUT vt_score,malicious_votes
LOOKUP-geo_risk = geo_risk_lookup country OUTPUT country_name,geo_risk_score

# ============================================================================
# CSV Lookup Files (For Manual Editing)
# ============================================================================

[source::...abuseipdb_lookup.csv]
sourcetype = csv

[source::...virustotal_lookup.csv]
sourcetype = csv

[source::...fortigate_blocked_ips.csv]
sourcetype = csv

[source::...fortigate_whitelist.csv]
sourcetype = csv

[source::...geo_risk_lookup.csv]
sourcetype = csv

[source::...attack_taxonomy.csv]
sourcetype = csv

[source::...slack_alert_toggle.csv]
sourcetype = csv
