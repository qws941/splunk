# FortiGate Real-time Alerts - LogID Based Routing
# All alerts use logid-based filtering (no text matching)
# Excludes: Login fail (0100032002), Update fail (0100046001/0100046002)
# Last updated: 2025-11-02
#
# ‚öôÔ∏è  CONFIGURATION GUIDE:
# ‚îú‚îÄ Slack Channel: Search "action.slack.param.channel" and replace with your channel
# ‚îú‚îÄ Suppress Period: Search "alert.suppress.period" to adjust duplicate suppression time
# ‚îú‚îÄ Index Name: Default "index=fw" - change if using different index name
# ‚îî‚îÄ Schedule: "cron_schedule = * * * * *" means every minute (real-time)
#
# üìã FIELD REFERENCE:
# ‚îú‚îÄ cfgpath    = Configuration path changed (e.g., "firewall.policy", "vpn.ipsec")
# ‚îú‚îÄ device     = FortiGate device name (devname field)
# ‚îú‚îÄ user       = Admin username who made the change
# ‚îú‚îÄ logid      = FortiGate log identifier (e.g., 0100044546 = CLI config change)
# ‚îî‚îÄ _time      = Event timestamp

#############################################
# LogID Reference (From Project + Fortinet Docs)
#############################################
# Config Changes:
#   0100044546: Config change via CLI
#   0100044547: Config change via GUI
#
# Interface Status:
#   0100032001: Interface link down
#   0100020007: Link monitor down
#
# HA Events:
#   0100020010: HA state change
#   0104043544: HA member state change
#   0104043545: HA configuration change
#
# Admin Activity (EXCLUDED from alerts):
#   0100032002: Admin login failed (EXCLUDED - per user request)
#
# System Updates (EXCLUDED from alerts):
#   0100046001: Firmware/Policy update failed (EXCLUDED - per user request)
#   0100046002: Policy package install failed (EXCLUDED - per user request)
#
# Device/System Events:
#   0103040*: Device hardware events (fan, power, temp)
#   0104*: System resource events (CPU, memory, disk)
#   0105*: Admin activity events (general)

#############################################
# 1. Config Change Alert (LogID Based)
#############################################

[FortiGate_Config_Change]
description = Real-time FortiGate configuration change alerts (logid-based, Block Kit)
disabled = 0

# Real-time settings
cron_schedule = * * * * *
dispatch.earliest_time = rt-1m
dispatch.latest_time = rt
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
realtime_schedule = 1
request.ui_dispatch_view = search
schedule_priority = highest

# Alert settings
alert.track = 1
alert.digest_mode = 0
quantity = 0
relation = greater than

# üîï Duplicate Suppression (30 seconds per unique config change)
# Prevents same alert from firing multiple times within 30 seconds
# Uniqueness determined by: timestamp + device + admin user + config path changed
alert.suppress = 1
alert.suppress.fields = _time, device, user, cfgpath
alert.suppress.period = 30s  # ‚öôÔ∏è CHANGEME: Adjust suppression window (e.g., 1m, 5m, 1h)

# Action settings
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.slack = 1
action.slack.param.channel = #security-firewall-alert  # ‚öôÔ∏è CHANGEME: Your Slack channel (must invite bot first)
action.slack.param.message = $result.blockkit_json$  # Uses Block Kit JSON format (rich formatting)
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0

# üîç Search Query (logid-based filtering only)
# ‚öôÔ∏è INDEX: "fw" - CHANGEME if using different index name
# Each config change triggers immediate alert (no deduplication in query)
search = index=fw type=event subtype=system \
    (logid=0100044546 OR logid=0100044547) \
| eval device = coalesce(devname, "unknown") \
| eval admin = coalesce(user, "system") \
| eval config_path = coalesce(cfgpath, "unknown") \
| eval access_method = case(logid="0100044546", "CLI", logid="0100044547", "GUI", 1=1, coalesce(ui, "N/A")) \
| eval action_type = coalesce(action, "Modified") \
| eval object_name = coalesce(cfgobj, "-") \
| eval details_raw = coalesce(cfgattr, "No details") \
| eval details = if(len(details_raw) > 150, substr(details_raw, 1, 147) + "...", details_raw) \
| eval severity = case( \
    like(config_path, "%firewall.policy%"), "HIGH", \
    like(config_path, "%vpn.%"), "HIGH", \
    like(config_path, "%router.%"), "MEDIUM", \
    1=1, "LOW") \
| eval color = case(severity="HIGH", "danger", severity="MEDIUM", "warning", 1=1, "good") \
| eval change_type = case( \
    like(config_path, "%firewall.policy%"), ":shield: Policy Change", \
    like(config_path, "%firewall.address%"), ":globe_with_meridians: Address Object", \
    like(config_path, "%firewall.service%"), ":package: Service Object", \
    like(config_path, "%system.interface%"), ":electric_plug: Interface Config", \
    like(config_path, "%router.%"), ":world_map: Routing Change", \
    like(config_path, "%vpn.%"), ":closed_lock_with_key: VPN Change", \
    1=1, ":wrench: Configuration Change") \
| eval timestamp_formatted = strftime(_time, "%Y-%m-%d %H:%M:%S %Z") \
| eval device_safe = replace(device, "\"", "'") \
| eval admin_safe = replace(admin, "\"", "'") \
| eval details_safe = replace(replace(details, "\"", "'"), "\\\\", "/") \
| eval config_path_safe = replace(config_path, "\"", "'") \
| eval object_name_safe = replace(object_name, "\"", "'") \
| eval blockkit_json = "{\"attachments\":[{\"color\":\"" + color + "\",\"blocks\":["
    + "{\"type\":\"header\",\"text\":{\"type\":\"plain_text\",\"text\":\"" + change_type + "\"}},"
    + "{\"type\":\"section\",\"fields\":["
    + "{\"type\":\"mrkdwn\",\"text\":\"*Device:*\\n" + device_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Severity:*\\n" + severity + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Admin:*\\n" + admin_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Method:*\\n" + access_method + "\"}"
    + "]},"
    + "{\"type\":\"section\",\"fields\":["
    + "{\"type\":\"mrkdwn\",\"text\":\"*Config Path:*\\n`" + config_path_safe + "`\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Object:*\\n" + object_name_safe + "\"}"
    + "]},"
    + "{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*Action:* " + action_type + "\\n*Details:* " + details_safe + "\"}},"
    + "{\"type\":\"context\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":clock3: " + timestamp_formatted + "\"}]}" + "]}]}"
| table _time, blockkit_json, device_safe, admin_safe, config_path_safe, severity


#############################################
# 2. Interface Status Alert (LogID Based)
#############################################

[FortiGate_Interface_Status]
description = Real-time FortiGate interface status alerts (logid-based, Block Kit)
disabled = 0

# Real-time settings
cron_schedule = * * * * *
dispatch.earliest_time = rt-1m
dispatch.latest_time = rt
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
realtime_schedule = 1
request.ui_dispatch_view = search
schedule_priority = highest

# Alert settings
alert.track = 1
alert.digest_mode = 0
quantity = 0
relation = greater than

# üîï Duplicate Suppression (2 minutes per interface)
# Prevents repeated alerts for same interface flapping
# Uniqueness determined by: device name + interface name
alert.suppress = 1
alert.suppress.fields = devname, interface
alert.suppress.period = 2m  # ‚öôÔ∏è CHANGEME: Adjust for flapping interfaces (e.g., 5m, 10m)

# Action settings
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.slack = 1
action.slack.param.channel = #security-firewall-alert  # ‚öôÔ∏è CHANGEME: Your Slack channel (must invite bot first)
action.slack.param.message = $result.blockkit_json$  # Uses Block Kit JSON format (rich formatting)
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0

# üîç Search Query (logid-based filtering only)
# ‚öôÔ∏è INDEX: "fw" - CHANGEME if using different index name
# Monitors interface DOWN events only (UP events not alerted)
search = index=fw type=event subtype=system \
    (logid=0100032001 OR logid=0100020007) \
| eval device = coalesce(devname, "unknown") \
| eval interface = coalesce(interface, port, "-") \
| eval status = case( \
    logid="0100032001", "DOWN", \
    logid="0100020007", "LINK_DOWN", \
    1=1, "UNKNOWN") \
| eval severity = "HIGH" \
| eval color = "danger" \
| eval status_icon = ":red_circle:" \
| eval reason = coalesce(msg, "No additional details") \
| eval timestamp_formatted = strftime(_time, "%Y-%m-%d %H:%M:%S %Z") \
| eval device_safe = replace(device, "\"", "'") \
| eval interface_safe = replace(interface, "\"", "'") \
| eval reason_safe = replace(replace(reason, "\"", "'"), "\\\\", "/") \
| dedup device, interface, status \
| eval blockkit_json = "{\"attachments\":[{\"color\":\"" + color + "\",\"blocks\":["
    + "{\"type\":\"header\",\"text\":{\"type\":\"plain_text\",\"text\":\"" + status_icon + " Interface Status: " + status + "\"}},"
    + "{\"type\":\"section\",\"fields\":["
    + "{\"type\":\"mrkdwn\",\"text\":\"*Device:*\\n" + device_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Interface:*\\n`" + interface_safe + "`\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Status:*\\n" + status + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Severity:*\\n" + severity + "\"}"
    + "]},"
    + "{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*Details:*\\n" + reason_safe + "\"}},"
    + "{\"type\":\"context\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":clock3: " + timestamp_formatted + "\"}]}" + "]}]}"
| table _time, blockkit_json, device_safe, interface_safe, status, severity


#############################################
# 3. HA Status Alert (LogID Based)
#############################################

[FortiGate_HA_Status]
description = Real-time FortiGate HA status change alerts (logid-based, Block Kit)
disabled = 0

# Real-time settings
cron_schedule = * * * * *
dispatch.earliest_time = rt-1m
dispatch.latest_time = rt
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
realtime_schedule = 1
request.ui_dispatch_view = search
schedule_priority = highest

# Alert settings
alert.track = 1
alert.digest_mode = 0
quantity = 0
relation = greater than

# üîï Duplicate Suppression (3 minutes per HA state change)
# Prevents repeated alerts during HA transition periods
# Uniqueness determined by: device name + HA state (master/slave/standalone)
alert.suppress = 1
alert.suppress.fields = devname, ha_state
alert.suppress.period = 3m  # ‚öôÔ∏è CHANGEME: Adjust for HA failover scenarios (e.g., 5m, 10m)

# Action settings
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.slack = 1
action.slack.param.channel = #security-firewall-alert  # ‚öôÔ∏è CHANGEME: Your Slack channel (must invite bot first)
action.slack.param.message = $result.blockkit_json$  # Uses Block Kit JSON format (rich formatting)
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0

# üîç Search Query (logid-based filtering only)
# ‚öôÔ∏è INDEX: "fw" - CHANGEME if using different index name
search = index=fw type=event subtype=system \
    (logid=0100020010 OR logid=0104043544 OR logid=0104043545) \
| eval device = coalesce(devname, "unknown") \
| eval ha_state = coalesce(ha_state, to_state, "unknown") \
| eval from_state = coalesce(from_state, "-") \
| eval severity = case( \
    ha_state="standalone", "HIGH", \
    ha_state="down", "HIGH", \
    ha_state="master" OR ha_state="primary", "GOOD", \
    ha_state="slave" OR ha_state="secondary", "GOOD", \
    1=1, "MEDIUM") \
| eval color = case(severity="HIGH", "danger", severity="GOOD", "good", 1=1, "warning") \
| eval status_icon = case( \
    ha_state="standalone" OR ha_state="down", ":red_circle:", \
    ha_state="master" OR ha_state="primary", ":large_green_circle:", \
    ha_state="slave" OR ha_state="secondary", ":large_blue_circle:", \
    1=1, ":large_yellow_circle:") \
| eval ha_member = coalesce(member, serial, "-") \
| eval reason = coalesce(msg, "No additional details") \
| eval timestamp_formatted = strftime(_time, "%Y-%m-%d %H:%M:%S %Z") \
| eval device_safe = replace(device, "\"", "'") \
| eval ha_state_safe = replace(ha_state, "\"", "'") \
| eval from_state_safe = replace(from_state, "\"", "'") \
| eval reason_safe = replace(replace(reason, "\"", "'"), "\\\\", "/") \
| dedup device, ha_state \
| eval blockkit_json = "{\"attachments\":[{\"color\":\"" + color + "\",\"blocks\":["
    + "{\"type\":\"header\",\"text\":{\"type\":\"plain_text\",\"text\":\"" + status_icon + " HA Status Change\"}},"
    + "{\"type\":\"section\",\"fields\":["
    + "{\"type\":\"mrkdwn\",\"text\":\"*Device:*\\n" + device_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Severity:*\\n" + severity + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Current State:*\\n" + ha_state_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Previous State:*\\n" + from_state_safe + "\"}"
    + "]},"
    + "{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*HA Member:* " + ha_member + "\\n*Details:* " + reason_safe + "\"}},"
    + "{\"type\":\"context\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":clock3: " + timestamp_formatted + "\"}]}" + "]}]}"
| table _time, blockkit_json, device_safe, ha_state_safe, from_state_safe, severity


#############################################
# 4. Device Events Alert (LogID Based)
#############################################

[FortiGate_Device_Events]
description = Real-time FortiGate device hardware events (logid-based, Block Kit)
disabled = 0

# Real-time settings
cron_schedule = * * * * *
dispatch.earliest_time = rt-1m
dispatch.latest_time = rt
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
realtime_schedule = 1
request.ui_dispatch_view = search
schedule_priority = highest

# Alert settings
alert.track = 1
alert.digest_mode = 0
quantity = 0
relation = greater than

# üîï Duplicate Suppression (24 hours per message)
# Prevents same message from alerting more than once per day
# Uniqueness determined by: message content (msg field)
# Useful for hardware/resource alerts that don't need constant reminders
alert.suppress = 1
alert.suppress.fields = msg
alert.suppress.period = 1d  # ‚öôÔ∏è CHANGEME: 1d=24h, 12h=half day, 1h=hourly

# Action settings
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.slack = 1
action.slack.param.channel = #security-firewall-alert  # ‚öôÔ∏è CHANGEME: Your Slack channel (must invite bot first)
action.slack.param.message = $result.blockkit_json$  # Uses Block Kit JSON format (rich formatting)
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0

# üîç Search Query (logid-based filtering only)
# ‚öôÔ∏è INDEX: "fw" - CHANGEME if using different index name
# Monitors hardware events: fan, power supply, temperature
search = index=fw type=event subtype=system \
    logid=0103040* \
| eval device = coalesce(devname, "unknown") \
| eval event_type = case( \
    like(msg, "%fan%"), "Fan Failure", \
    like(msg, "%power%"), "Power Supply", \
    like(msg, "%temperature%"), "Temperature", \
    like(msg, "%hardware%"), "Hardware Error", \
    1=1, "Device Event") \
| eval severity = case( \
    like(msg, "%fail%") OR like(msg, "%critical%"), "HIGH", \
    like(msg, "%warning%"), "MEDIUM", \
    1=1, "LOW") \
| eval color = case(severity="HIGH", "danger", severity="MEDIUM", "warning", 1=1, "good") \
| eval icon = case( \
    event_type="Fan Failure", ":dash:", \
    event_type="Power Supply", ":electric_plug:", \
    event_type="Temperature", ":thermometer:", \
    1=1, ":warning:") \
| eval description = coalesce(msg, logdesc, "No details") \
| eval timestamp_formatted = strftime(_time, "%Y-%m-%d %H:%M:%S %Z") \
| eval device_safe = replace(device, "\"", "'") \
| eval description_safe = replace(replace(description, "\"", "'"), "\\\\", "/") \
| dedup device, event_type, severity \
| eval blockkit_json = "{\"attachments\":[{\"color\":\"" + color + "\",\"blocks\":["
    + "{\"type\":\"header\",\"text\":{\"type\":\"plain_text\",\"text\":\"" + icon + " Device Event: " + event_type + "\"}},"
    + "{\"type\":\"section\",\"fields\":["
    + "{\"type\":\"mrkdwn\",\"text\":\"*Device:*\\n" + device_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Severity:*\\n" + severity + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*LogID:*\\n`" + logid + "`\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Event Type:*\\n" + event_type + "\"}"
    + "]},"
    + "{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*Details:*\\n" + description_safe + "\"}},"
    + "{\"type\":\"context\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":clock3: " + timestamp_formatted + "\"}]}" + "]}]}"
| table _time, blockkit_json, device_safe, event_type, severity, logid


#############################################
# 5. System Resource Alert (LogID Based)
#############################################

[FortiGate_System_Resource]
description = Real-time FortiGate system resource alerts (logid-based, Block Kit)
disabled = 0

# Real-time settings
cron_schedule = * * * * *
dispatch.earliest_time = rt-1m
dispatch.latest_time = rt
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
realtime_schedule = 1
request.ui_dispatch_view = search
schedule_priority = highest

# Alert settings
alert.track = 1
alert.digest_mode = 0
quantity = 0
relation = greater than

# üîï Duplicate Suppression (24 hours per message)
# Prevents same message from alerting more than once per day
# Uniqueness determined by: message content (msg field)
# Useful for hardware/resource alerts that don't need constant reminders
alert.suppress = 1
alert.suppress.fields = msg
alert.suppress.period = 1d  # ‚öôÔ∏è CHANGEME: 1d=24h, 12h=half day, 1h=hourly

# Action settings
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.slack = 1
action.slack.param.channel = #security-firewall-alert  # ‚öôÔ∏è CHANGEME: Your Slack channel (must invite bot first)
action.slack.param.message = $result.blockkit_json$  # Uses Block Kit JSON format (rich formatting)
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0

# üîç Search Query (logid-based filtering only)
# ‚öôÔ∏è INDEX: "fw" - CHANGEME if using different index name
# Monitors system resources: CPU, memory, disk, sessions
search = index=fw type=event subtype=system \
    logid=0104* \
| eval device = coalesce(devname, "unknown") \
| eval resource_type = case( \
    like(msg, "%cpu%") OR like(msg, "%CPU%"), "CPU", \
    like(msg, "%memory%") OR like(msg, "%Memory%"), "Memory", \
    like(msg, "%disk%") OR like(msg, "%Disk%"), "Disk", \
    like(msg, "%session%") OR like(msg, "%Session%"), "Sessions", \
    1=1, "System Resource") \
| eval severity = case( \
    like(msg, "%critical%") OR like(msg, "%high%"), "HIGH", \
    like(msg, "%warning%") OR like(msg, "%medium%"), "MEDIUM", \
    1=1, "LOW") \
| eval color = case(severity="HIGH", "danger", severity="MEDIUM", "warning", 1=1, "good") \
| eval icon = case( \
    resource_type="CPU", ":desktop_computer:", \
    resource_type="Memory", ":brain:", \
    resource_type="Disk", ":floppy_disk:", \
    resource_type="Sessions", ":link:", \
    1=1, ":chart_with_upwards_trend:") \
| eval description = coalesce(msg, logdesc, "No details") \
| eval timestamp_formatted = strftime(_time, "%Y-%m-%d %H:%M:%S %Z") \
| eval device_safe = replace(device, "\"", "'") \
| eval description_safe = replace(replace(description, "\"", "'"), "\\\\", "/") \
| dedup device, resource_type, severity \
| eval blockkit_json = "{\"attachments\":[{\"color\":\"" + color + "\",\"blocks\":["
    + "{\"type\":\"header\",\"text\":{\"type\":\"plain_text\",\"text\":\"" + icon + " Resource Alert: " + resource_type + "\"}},"
    + "{\"type\":\"section\",\"fields\":["
    + "{\"type\":\"mrkdwn\",\"text\":\"*Device:*\\n" + device_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Severity:*\\n" + severity + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*LogID:*\\n`" + logid + "`\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Resource Type:*\\n" + resource_type + "\"}"
    + "]},"
    + "{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*Details:*\\n" + description_safe + "\"}},"
    + "{\"type\":\"context\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":clock3: " + timestamp_formatted + "\"}]}" + "]}]}"
| table _time, blockkit_json, device_safe, resource_type, severity, logid


#############################################
# 6. Admin Activity Alert (LogID Based)
# INCLUDING login fail (0100032002) - 1 alert per day per message
#############################################

[FortiGate_Admin_Activity]
description = Real-time FortiGate admin activity alerts (logid-based, includes login fail, 1x per day per msg, Block Kit)
disabled = 0

# Real-time settings
cron_schedule = * * * * *
dispatch.earliest_time = rt-1m
dispatch.latest_time = rt
display.general.type = statistics
display.page.search.tab = statistics
enableSched = 1
realtime_schedule = 1
request.ui_dispatch_view = search
schedule_priority = highest

# Alert settings
alert.track = 1
alert.digest_mode = 0
quantity = 0
relation = greater than

# üîï Duplicate Suppression (24 hours per message)
# Prevents same message from alerting more than once per day
# Uniqueness determined by: message content (msg field)
# Useful for hardware/resource alerts that don't need constant reminders
alert.suppress = 1
alert.suppress.fields = msg
alert.suppress.period = 1d  # ‚öôÔ∏è CHANGEME: 1d=24h, 12h=half day, 1h=hourly

# Action settings
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.slack = 1
action.slack.param.channel = #security-firewall-alert  # ‚öôÔ∏è CHANGEME: Your Slack channel (must invite bot first)
action.slack.param.message = $result.blockkit_json$  # Uses Block Kit JSON format (rich formatting)
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0

# üîç Search Query (logid-based filtering only)
# ‚öôÔ∏è INDEX: "fw" - CHANGEME if using different index name
# Monitors admin activities including login failures (once per day per message)
search = index=fw type=event subtype=system \
    logid=0105* \
| eval device = coalesce(devname, "unknown") \
| eval admin = coalesce(user, "unknown") \
| eval activity_type = case( \
    like(msg, "%config%") OR like(msg, "%Config%"), "Configuration", \
    like(msg, "%login%") OR like(msg, "%Login%"), "Login", \
    like(msg, "%logout%") OR like(msg, "%Logout%"), "Logout", \
    like(msg, "%permission%") OR like(msg, "%Permission%"), "Permission", \
    1=1, "Admin Activity") \
| eval severity = case( \
    activity_type="Configuration", "MEDIUM", \
    activity_type="Permission", "HIGH", \
    1=1, "LOW") \
| eval color = case(severity="HIGH", "danger", severity="MEDIUM", "warning", 1=1, "good") \
| eval icon = case( \
    activity_type="Configuration", ":gear:", \
    activity_type="Login", ":key:", \
    activity_type="Logout", ":door:", \
    activity_type="Permission", ":shield:", \
    1=1, ":bust_in_silhouette:") \
| eval source_ip = coalesce(srcip, ui, "-") \
| eval description = coalesce(msg, logdesc, "No details") \
| eval timestamp_formatted = strftime(_time, "%Y-%m-%d %H:%M:%S %Z") \
| eval device_safe = replace(device, "\"", "'") \
| eval admin_safe = replace(admin, "\"", "'") \
| eval description_safe = replace(replace(description, "\"", "'"), "\\\\", "/") \
| dedup device, admin, activity_type \
| eval blockkit_json = "{\"attachments\":[{\"color\":\"" + color + "\",\"blocks\":["
    + "{\"type\":\"header\",\"text\":{\"type\":\"plain_text\",\"text\":\"" + icon + " Admin Activity: " + activity_type + "\"}},"
    + "{\"type\":\"section\",\"fields\":["
    + "{\"type\":\"mrkdwn\",\"text\":\"*Device:*\\n" + device_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Admin:*\\n" + admin_safe + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Source IP:*\\n" + source_ip + "\"},"
    + "{\"type\":\"mrkdwn\",\"text\":\"*Severity:*\\n" + severity + "\"}"
    + "]},"
    + "{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*Details:*\\n" + description_safe + "\"}},"
    + "{\"type\":\"context\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":clock3: " + timestamp_formatted + "\"}]}" + "]}]}"
| table _time, blockkit_json, device_safe, admin_safe, activity_type, severity


#############################################
# üìö IMPORTANT NOTES & CONFIGURATION GUIDE
#############################################

# 1Ô∏è‚É£ Alert Architecture
#    ‚úÖ All alerts use logid-based filtering (reliable, language-independent)
#    ‚ùå No text matching (avoids false positives from log message variations)
#
# 2Ô∏è‚É£ EXCLUDED LogIDs (per user request - NOT monitored):
#    ‚ùå 0100032002: Admin login failed (too noisy, excluded by request)
#    ‚ùå 0100046001: Firmware update failed (maintenance events)
#    ‚ùå 0100046002: Policy package install failed (FMG/FAZ events)
#
# 3Ô∏è‚É£ Quick Configuration Changes:
#    üîç Search for "‚öôÔ∏è CHANGEME" to find all customizable settings
#    üìå Key settings to review:
#       ‚îú‚îÄ Slack channel: action.slack.param.channel = #your-channel
#       ‚îú‚îÄ Index name: search = index=YOUR_INDEX_NAME
#       ‚îú‚îÄ Suppress period: alert.suppress.period = 30s|2m|3m|1d
#       ‚îî‚îÄ Enable/disable: disabled = 0 (enabled) or disabled = 1 (disabled)
#
# 4Ô∏è‚É£ Slack Action Configuration (Web UI):
#    Settings ‚Üí Searches, reports, and alerts ‚Üí Select alert ‚Üí Edit ‚Üí Add Actions ‚Üí Slack
#    ‚ö†Ô∏è Must invite Slack bot to channel BEFORE enabling alerts
#
# 5Ô∏è‚É£ Monitor Alert Performance:
#    # Check execution time and status
#    index=_internal source=*scheduler.log savedsearch_name="FortiGate_*"
#    | stats avg(run_time) as avg_runtime_sec, count by savedsearch_name, status
#
# 6Ô∏è‚É£ Manual Testing (from Splunk Search bar):
#    | savedsearch FortiGate_Config_Change
#    | savedsearch FortiGate_Interface_Status
#    | savedsearch FortiGate_HA_Status
#    | savedsearch FortiGate_Device_Events
#    | savedsearch FortiGate_System_Resource
#    | savedsearch FortiGate_Admin_Activity
#
# 7Ô∏è‚É£ Field Mapping Reference:
#    cfgpath  ‚Üí Configuration path (firewall.policy, vpn.ipsec, etc.)
#    devname  ‚Üí FortiGate device hostname
#    user     ‚Üí Admin username who made the change
#    logid    ‚Üí FortiGate log identifier (e.g., 0100044546 = CLI config change)
#    msg      ‚Üí Human-readable log message
#    _time    ‚Üí Event timestamp (Unix epoch)
#
# 8Ô∏è‚É£ Real-time Schedule Explained:
#    cron_schedule = * * * * *        ‚Üí Every minute
#    dispatch.earliest_time = rt-1m   ‚Üí Real-time search (1-minute sliding window)
#    dispatch.latest_time = rt        ‚Üí Real-time search window (now)
#    realtime_schedule = 1            ‚Üí Enable real-time execution
#
# 9Ô∏è‚É£ Suppression Strategy:
#    Config changes:   30 seconds  ‚Üí Immediate notification, short dedup
#    Interface events: 2 minutes   ‚Üí Prevent flapping alerts
#    HA events:        3 minutes   ‚Üí Allow transition period
#    Hardware/Resource: 24 hours   ‚Üí Once-per-day reminders only
#
# üîü Troubleshooting:
#    ‚ùå No alerts firing:
#       1. Check data: index=fw type=event subtype=system | head 10
#       2. Check schedule: index=_internal source=*scheduler.log savedsearch_name="FortiGate_Config_Change"
#       3. Verify Slack bot invited to channel
#    ‚ùå Too many alerts:
#       1. Increase alert.suppress.period values
#       2. Adjust logid filters to be more specific
#    ‚ùå Missing events:
#       1. Verify index=fw contains FortiGate syslog data
#       2. Check logid values match your FortiOS version
