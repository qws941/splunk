<?xml version="1.0" encoding="UTF-8"?>
<!--
Threat Intelligence Dashboard Panels (Phase 3.1)

These panels can be added to fortinet-dashboard.xml to enable
AbuseIPDB and VirusTotal threat intelligence enrichment.

Installation:
1. Copy desired panels from this file
2. Paste into fortinet-dashboard.xml at appropriate location
3. Adjust panel IDs to avoid conflicts
4. Reload dashboard in Splunk Web

Prerequisites:
- lookups/abuseipdb_lookup.csv populated
- lookups/virustotal_lookup.csv populated
- API fetch scripts configured and running

Created: 2025-10-21
Phase: 3.1 - External Threat Intelligence Integration
-->

<dashboard>
  <label>Threat Intelligence Panels (Add to Main Dashboard)</label>
  <description>FortiGate Security Dashboard - Threat Intelligence Integration</description>

  <!-- Row 1: Threat Intelligence Overview -->
  <row>
    <panel>
      <title>üìä Threat Intelligence Coverage</title>
      <single>
        <search>
          <query><![CDATA[
| inputlookup abuseipdb_lookup.csv
| stats count as total_ips,
        sum(eval(if(abuse_score > 50, 1, 0))) as high_risk_ips,
        sum(eval(if(is_whitelisted=="true", 1, 0))) as whitelisted_ips
| eval coverage_rate = round((total_ips / 1000) * 100, 2) + "%"
| fields total_ips
          ]]></query>
          <earliest>-24h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">IPs in AbuseIPDB Lookup</option>
        <option name="rangeColors">["0x32CD32","0xFFD700","0xFF6347","0xDC143C"]</option>
        <option name="height">150</option>
      </single>
    </panel>

    <panel>
      <title>ü¶† Malware Files Detected (VirusTotal)</title>
      <single>
        <search>
          <query><![CDATA[
| inputlookup virustotal_lookup.csv
| where threat_category IN ("malicious", "suspicious")
| stats count as malicious_files
          ]]></query>
          <earliest>-24h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">Files with Malware Detections</option>
        <option name="rangeColors">["0x32CD32","0xFFD700","0xFF6347","0xDC143C"]</option>
        <option name="rangeValues">[0,1,5]</option>
        <option name="height">150</option>
      </single>
    </panel>

    <panel>
      <title>üö® High-Risk Events (Abuse Score > 75)</title>
      <single>
        <search>
          <query><![CDATA[
index=fw
| stats count by srcip
| lookup abuseipdb_lookup.csv ip AS srcip OUTPUT abuse_score
| where abuse_score > 75
| stats count as high_risk_events
          ]]></query>
          <earliest>-24h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">Events from High-Risk IPs</option>
        <option name="rangeColors">["0x32CD32","0xFFD700","0xFF6347","0xDC143C"]</option>
        <option name="rangeValues">[0,10,50]</option>
        <option name="height">150</option>
      </single>
    </panel>
  </row>

  <!-- Row 2: IP Reputation Table -->
  <row>
    <panel>
      <title>üö´ High-Risk IPs (AbuseIPDB Abuse Score &gt; 50)</title>
      <table>
        <search>
          <query><![CDATA[
index=fw
| stats count as event_count by srcip
| lookup abuseipdb_lookup.csv ip AS srcip OUTPUT abuse_score, country, isp, total_reports, is_whitelisted
| where abuse_score > 50
| eval risk_level = case(
    abuse_score >= 90, "Critical",
    abuse_score >= 75, "High",
    abuse_score >= 50, "Medium",
    1=1, "Low"
  )
| table srcip, abuse_score, risk_level, country, isp, total_reports, event_count, is_whitelisted
| sort - abuse_score
| head 20
          ]]></query>
          <earliest>-24h</earliest>
          <latest>now</latest>
        </search>

        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <option name="dataOverlayMode">none</option>

        <!-- Color formatting -->
        <format type="color" field="risk_level">
          <colorPalette type="map">{"Critical":#DC143C,"High":#FF6347,"Medium":#FFD700,"Low":#32CD32}</colorPalette>
        </format>

        <format type="color" field="abuse_score">
          <colorPalette type="minMidMax" maxColor="#DC143C" midColor="#FFD700" minColor="#32CD32"></colorPalette>
          <scale type="minMidMax" minValue="0" midValue="50" maxValue="100"></scale>
        </format>

        <format type="color" field="is_whitelisted">
          <colorPalette type="map">{"true":#32CD32,"false":#DC143C}</colorPalette>
        </format>

        <!-- Drill-down to detailed events -->
        <drilldown>
          <link target="_blank">
            /app/search/search?q=search index=fw srcip=$row.srcip$ earliest=-24h | table _time, srcip, dstip, action, msg | sort - _time
          </link>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Row 3: Malware Detection Summary -->
  <row>
    <panel>
      <title>ü¶† Malware Detection by Category (VirusTotal)</title>
      <chart>
        <search>
          <query><![CDATA[
| inputlookup virustotal_lookup.csv
| stats count by threat_category
| sort - count
          ]]></query>
          <earliest>-7d</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.backgroundColor">#FFFFFF</option>
        <option name="charting.fieldColors">{
          "malicious":"#DC143C",
          "suspicious":"#FF8C00",
          "clean":"#32CD32"
        }</option>
        <option name="height">350</option>
      </chart>
    </panel>

    <panel>
      <title>‚öîÔ∏è Malware Types Detected</title>
      <table>
        <search>
          <query><![CDATA[
| inputlookup virustotal_lookup.csv
| where threat_category IN ("malicious", "suspicious")
| stats count as detection_count by malware_type, threat_category
| sort - detection_count
| head 10
          ]]></query>
          <earliest>-7d</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="rowNumbers">true</option>

        <format type="color" field="threat_category">
          <colorPalette type="map">{"malicious":#DC143C,"suspicious":#FF8C00}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 4: Geographic Distribution -->
  <row>
    <panel>
      <title>üåç Malicious IP Sources by Country (AbuseIPDB Abuse Score &gt; 75)</title>
      <table>
        <search>
          <query><![CDATA[
index=fw
| stats count as event_count by srcip
| lookup abuseipdb_lookup.csv ip AS srcip OUTPUT abuse_score, country, isp
| where abuse_score > 75
| stats sum(event_count) as total_events,
        avg(abuse_score) as avg_abuse_score,
        dc(srcip) as unique_ips
  by country
| eval avg_abuse_score = round(avg_abuse_score, 1)
| sort - total_events
| head 15
          ]]></query>
          <earliest>-24h</earliest>
          <latest>now</latest>
        </search>

        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>

        <format type="color" field="avg_abuse_score">
          <colorPalette type="minMidMax" maxColor="#DC143C" midColor="#FF6347" minColor="#FFD700"></colorPalette>
          <scale type="minMidMax" minValue="75" midValue="87.5" maxValue="100"></scale>
        </format>

        <drilldown>
          <link target="_blank">
            /app/search/search?q=search index=fw | lookup abuseipdb_lookup.csv ip AS srcip OUTPUT country | search country="$row.country$" | table _time, srcip, dstip, action, msg
          </link>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Row 5: Threat Timeline -->
  <row>
    <panel>
      <title>üìà High-Risk IP Activity Timeline (Abuse Score &gt; 50)</title>
      <chart>
        <search>
          <query><![CDATA[
index=fw
| lookup abuseipdb_lookup.csv ip AS srcip OUTPUT abuse_score, country
| where abuse_score > 50
| eval risk_level = case(
    abuse_score >= 90, "Critical (90-100)",
    abuse_score >= 75, "High (75-89)",
    abuse_score >= 50, "Medium (50-74)",
    1=1, "Low (<50)"
  )
| timechart span=1h count by risk_level limit=4
          ]]></query>
          <earliest>-24h</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.backgroundColor">#FFFFFF</option>
        <option name="charting.legend.placement">top</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Event Count</option>
        <option name="charting.fieldColors">{
          "Critical (90-100)":"#DC143C",
          "High (75-89)":"#FF6347",
          "Medium (50-74)":"#FFD700",
          "Low (&lt;50)":"#32CD32"
        }</option>
        <option name="height">350</option>
      </chart>
    </panel>
  </row>

  <!-- Row 6: Detailed File Analysis -->
  <row>
    <panel>
      <title>üìÅ Detected Files with Malware (VirusTotal Analysis)</title>
      <table>
        <search>
          <query><![CDATA[
index=fw filehash=*
| lookup virustotal_lookup.csv hash AS filehash OUTPUT detection_rate, malware_type, threat_category, vendor_detections, file_type
| where threat_category IN ("malicious", "suspicious")
| table _time, filename, filehash, detection_rate, malware_type, threat_category, srcip, dstip, file_type, vendor_detections
| sort - _time
| head 50
          ]]></query>
          <earliest>-7d</earliest>
          <latest>now</latest>
        </search>

        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">false</option>

        <format type="color" field="threat_category">
          <colorPalette type="map">{"malicious":#DC143C,"suspicious":#FF8C00,"clean":#32CD32}</colorPalette>
        </format>

        <drilldown>
          <link target="_blank">
            /app/search/search?q=search index=fw filehash="$row.filehash$" | table _time, srcip, dstip, filename, msg
          </link>
        </drilldown>
      </table>
    </panel>
  </row>

</dashboard>
