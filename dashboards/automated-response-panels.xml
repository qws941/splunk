<?xml version="1.0" encoding="UTF-8"?>
<!--
Automated Response Dashboard Panels (Phase 3.2)

These panels can be added to fortinet-dashboard.xml to enable
FortiGate automated IP blocking and monitoring.

Installation:
1. Copy desired panels from this file
2. Paste into fortinet-dashboard.xml at appropriate location
3. Adjust panel IDs to avoid conflicts
4. Reload dashboard in Splunk Web

Prerequisites:
- fortigate_auto_block.py script installed
- FORTIGATE_API_TOKEN environment variable set
- lookups/ip_whitelist.csv populated
- savedsearches-auto-block.conf configured

Created: 2025-10-21
Phase: 3.2 - Automated Response Actions
-->

<dashboard>
  <label>Automated Response Panels (Add to Main Dashboard)</label>
  <description>FortiGate Auto-Block - Automated IP Blocking System</description>

  <!-- Row 1: Auto-Block Status Overview -->
  <row>
    <panel>
      <html>
        <h2 style="color: #DC143C; border-bottom: 2px solid #DC143C; padding-bottom: 5px;">üö´ Automated Response System</h2>
      </html>
    </panel>
  </row>

  <row>
    <panel>
      <title>üìä Currently Blocked IPs</title>
      <single>
        <search>
          <query><![CDATA[
| inputlookup blocked_ips.csv
| stats count as total_blocked
          ]]></query>
          <earliest>-24h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">IPs Blocked by Auto-Response</option>
        <option name="rangeColors">["0x32CD32","0xFFD700","0xFF6347","0xDC143C"]</option>
        <option name="rangeValues">[0,5,20]</option>
        <option name="height">150</option>
      </single>
    </panel>

    <panel>
      <title>üõ°Ô∏è Whitelisted IPs</title>
      <single>
        <search>
          <query><![CDATA[
| inputlookup ip_whitelist.csv
| stats count as total_whitelisted
          ]]></query>
          <earliest>-24h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">Protected IPs (Never Blocked)</option>
        <option name="rangeColors">["0x32CD32","0x32CD32","0x32CD32","0x32CD32"]</option>
        <option name="height">150</option>
      </single>
    </panel>

    <panel>
      <title>‚è±Ô∏è Auto-Unblocks Pending</title>
      <single>
        <search>
          <query><![CDATA[
| inputlookup blocked_ips.csv
| eval unblock_at_epoch = strptime(unblock_at, "%Y-%m-%dT%H:%M:%S")
| where unblock_at_epoch > now()
| stats count as pending_unblocks
          ]]></query>
          <earliest>-24h</earliest>
          <latest>now</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">Scheduled Auto-Unblocks (24h)</option>
        <option name="rangeColors">["0x32CD32","0xFFD700","0xFF6347"]</option>
        <option name="rangeValues">[0,10]</option>
        <option name="height">150</option>
      </single>
    </panel>
  </row>

  <!-- Row 2: Blocked IPs Table -->
  <row>
    <panel>
      <title>üö´ Currently Blocked IPs (Auto-Response System)</title>
      <table>
        <search>
          <query><![CDATA[
| inputlookup blocked_ips.csv
| eval blocked_at_formatted = strftime(strptime(blocked_at, "%Y-%m-%dT%H:%M:%S"), "%Y-%m-%d %H:%M:%S")
| eval unblock_at_formatted = strftime(strptime(unblock_at, "%Y-%m-%dT%H:%M:%S"), "%Y-%m-%d %H:%M:%S")
| eval time_remaining = round((strptime(unblock_at, "%Y-%m-%dT%H:%M:%S") - now()) / 3600, 1)
| eval status = if(time_remaining > 0, "Active", "Expired")
| table ip, blocked_at_formatted, unblock_at_formatted, time_remaining, reason, policy_id, blocked_by, status
| rename blocked_at_formatted as "Blocked At", unblock_at_formatted as "Unblock At", time_remaining as "Hours Remaining", reason as "Reason", policy_id as "Policy ID", blocked_by as "Blocked By", status as "Status"
| sort - "Blocked At"
          ]]></query>
          <earliest>-7d</earliest>
          <latest>now</latest>
        </search>

        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <option name="dataOverlayMode">none</option>

        <!-- Color formatting -->
        <format type="color" field="Status">
          <colorPalette type="map">{"Active":#DC143C,"Expired":#808080}</colorPalette>
        </format>

        <format type="color" field="Hours Remaining">
          <colorPalette type="minMidMax" maxColor="#32CD32" midColor="#FFD700" minColor="#DC143C"></colorPalette>
          <scale type="minMidMax" minValue="0" midValue="12" maxValue="24"></scale>
        </format>

        <!-- Drill-down: Show events from blocked IP -->
        <drilldown>
          <link target="_blank">
            /app/search/search?q=search index=fw srcip=$row.ip$ earliest=-24h | table _time, srcip, dstip, action, msg | sort - _time
          </link>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Row 3: Auto-Block Candidates (High-Risk IPs Not Yet Blocked) -->
  <row>
    <panel>
      <title>‚ö†Ô∏è Auto-Block Candidates (High-Risk IPs Not Yet Blocked)</title>
      <table>
        <search>
          <query><![CDATA[
index=fw action=deny earliest=-1h
| stats count as event_count, latest(_time) as last_seen by srcip
| lookup abuseipdb_lookup.csv ip AS srcip OUTPUT abuse_score, country, isp, is_whitelisted
| lookup blocked_ips.csv ip AS srcip OUTPUT ip as already_blocked
| where abuse_score >= 75
| where isnull(already_blocked)
| where is_whitelisted != "true"
| eval risk_level = case(
    abuse_score >= 90, "Critical",
    abuse_score >= 75, "High",
    1=1, "Medium"
  )
| eval last_seen_formatted = strftime(last_seen, "%Y-%m-%d %H:%M:%S")
| table srcip, abuse_score, risk_level, country, isp, event_count, last_seen_formatted
| rename srcip as "Source IP", abuse_score as "Abuse Score", risk_level as "Risk Level", country as "Country", isp as "ISP", event_count as "Events (1h)", last_seen_formatted as "Last Seen"
| sort - "Abuse Score"
| head 20
          ]]></query>
          <earliest>-1h</earliest>
          <latest>now</latest>
        </search>

        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>

        <!-- Color formatting -->
        <format type="color" field="Risk Level">
          <colorPalette type="map">{"Critical":#DC143C,"High":#FF6347,"Medium":#FFD700}</colorPalette>
        </format>

        <format type="color" field="Abuse Score">
          <colorPalette type="minMidMax" maxColor="#DC143C" midColor="#FF6347" minColor="#FFD700"></colorPalette>
          <scale type="minMidMax" minValue="75" midValue="87" maxValue="100"></scale>
        </format>

        <!-- Drill-down: Manual block action -->
        <drilldown>
          <link target="_blank">
            /app/search/search?q=search index=fw srcip=$row.Source IP$ earliest=-24h | table _time, srcip, dstip, action, msg | sort - _time
          </link>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Row 4: Auto-Block Activity Timeline -->
  <row>
    <panel>
      <title>üìà Auto-Block Activity (Last 7 Days)</title>
      <chart>
        <search>
          <query><![CDATA[
| inputlookup blocked_ips.csv
| eval blocked_at_epoch = strptime(blocked_at, "%Y-%m-%dT%H:%M:%S")
| eval _time = blocked_at_epoch
| bucket _time span=1d
| stats count as blocks_per_day by _time
| timechart span=1d sum(blocks_per_day) as "IPs Blocked"
          ]]></query>
          <earliest>-7d</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.backgroundColor">#FFFFFF</option>
        <option name="charting.legend.placement">top</option>
        <option name="charting.axisTitleX.text">Date</option>
        <option name="charting.axisTitleY.text">IPs Blocked</option>
        <option name="charting.seriesColors">[#DC143C]</option>
        <option name="height">300</option>
      </chart>
    </panel>

    <panel>
      <title>üìä Block Reasons Distribution</title>
      <chart>
        <search>
          <query><![CDATA[
| inputlookup blocked_ips.csv
| rex field=reason "^(?<reason_category>[^(]+)"
| stats count by reason_category
| sort - count
          ]]></query>
          <earliest>-7d</earliest>
          <latest>now</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.backgroundColor">#FFFFFF</option>
        <option name="charting.fieldColors">{
          "High-risk IP":"#DC143C",
          "Malware source":"#FF6347",
          "Brute force attack":"#FF8C00",
          "Other":"#808080"
        }</option>
        <option name="height">300</option>
      </chart>
    </panel>
  </row>

  <!-- Row 5: Audit Log (Last 50 Actions) -->
  <row>
    <panel>
      <title>üìú Auto-Block Audit Log (Last 50 Actions)</title>
      <table>
        <search>
          <query><![CDATA[
index=_internal source="*fortigate_auto_block.log" earliest=-7d
| spath
| table timestamp, action, ip, status, details
| rename timestamp as "Timestamp", action as "Action", ip as "IP Address", status as "Status", details as "Details"
| sort - Timestamp
| head 50
          ]]></query>
          <earliest>-7d</earliest>
          <latest>now</latest>
        </search>

        <option name="drilldown">none</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>

        <!-- Color formatting -->
        <format type="color" field="Status">
          <colorPalette type="map">{"success":#32CD32,"failed":#DC143C,"denied":#FFD700,"cancelled":#808080}</colorPalette>
        </format>

        <format type="color" field="Action">
          <colorPalette type="map">{"block":#DC143C,"unblock":#32CD32,"block_attempt":#FFD700}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 6: Manual Block/Unblock Panel -->
  <row>
    <panel>
      <html>
        <h3 style="color: #DC143C;">‚öôÔ∏è Manual Block/Unblock Actions</h3>
        <p>Use the commands below to manually block or unblock IP addresses:</p>

        <h4>üö´ Block IP Address:</h4>
        <pre style="background-color: #f5f5f5; padding: 10px; border-radius: 5px;">
python3 /home/jclee/app/splunk/scripts/fortigate_auto_block.py \
  --action block \
  --ip 192.168.1.100 \
  --reason "Manual block - suspicious activity" \
  --approval-required
        </pre>

        <h4>‚úÖ Unblock IP Address:</h4>
        <pre style="background-color: #f5f5f5; padding: 10px; border-radius: 5px;">
python3 /home/jclee/app/splunk/scripts/fortigate_auto_block.py \
  --action unblock \
  --ip 192.168.1.100
        </pre>

        <h4>üìã List Blocked IPs:</h4>
        <pre style="background-color: #f5f5f5; padding: 10px; border-radius: 5px;">
python3 /home/jclee/app/splunk/scripts/fortigate_auto_block.py \
  --action list-blocked
        </pre>

        <h4>‚è±Ô∏è Check Auto-Unblock Schedule:</h4>
        <pre style="background-color: #f5f5f5; padding: 10px; border-radius: 5px;">
python3 /home/jclee/app/splunk/scripts/fortigate_auto_block.py \
  --action check-auto-unblock
        </pre>

        <p style="color: #DC143C; margin-top: 20px;">
          <strong>‚ö†Ô∏è IMPORTANT:</strong> Always use <code>--approval-required</code> flag for manual blocks in production!
        </p>
      </html>
    </panel>
  </row>

</dashboard>
