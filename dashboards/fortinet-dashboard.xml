<form version="1.1">
  <label>ğŸ›¡ï¸ FortiGate ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</label>
  <description>Events | Traffic | Performance | Config | WCAG</description>

  <!-- Global Filters -->
  <fieldset submitButton="false">
    <input type="dropdown" token="device_filter" searchWhenChanged="true">
      <label>ì¥ë¹„ ì„ íƒ</label>
      <choice value="*">ì „ì²´</choice>
      <default>*</default>
      <fieldForLabel>devname</fieldForLabel>
      <fieldForValue>devname</fieldForValue>
      <search>
        <query>index=fw | stats count by devname | sort - count</query>
      </search>
    </input>
    <input type="time" token="time_picker">
      <label>ì‹œê°„ ë²”ìœ„</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="severity_filter" searchWhenChanged="true">
      <label>ì‹¬ê°ë„ í•„í„°</label>
      <choice value="*">ì „ì²´</choice>
      <choice value="critical">Critical</choice>
      <choice value="high">High</choice>
      <choice value="medium">Medium</choice>
      <choice value="low">Low</choice>
      <default>*</default>
    </input>
  </fieldset>

  <!-- Row 1: ğŸ“Š ë°©í™”ë²½ ë¡œê·¸ í˜„í™© -->
  <row>
    <panel>
      <title>ğŸ”´ Critical ì´ë²¤íŠ¸</title>
      <single>
        <search>
          <query>index=fw devname=$device_filter$ (level=critical OR level=alert OR level=emergency) earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search NOT msg="*Update Fail*"
| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[0,5,20]</option>
        <option name="underLabel">Critical Events</option>
      </single>
    </panel>
    <panel>
      <title>ğŸ›¡ï¸ ì°¨ë‹¨</title>
      <single>
        <search>
          <query>index=fw devname=$device_filter$ (action=deny OR action=block OR action=drop) earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x555555","0x65A637","0x6DB7C6","0xF7BC38"]</option>
        <option name="rangeValues">[100,1000,5000]</option>
        <option name="underLabel">Blocked Packets</option>
      </single>
    </panel>
    <panel>
      <title>ğŸŒ í™œì„± ì†ŒìŠ¤ IP</title>
      <single>
        <search>
          <query>index=fw devname=$device_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats dc(srcip) as unique_sources</query>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="useColors">1</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[100,500,1000]</option>
        <option name="underLabel">Unique IPs</option>
      </single>
    </panel>
    <panel>
      <title>ğŸ“ˆ ì „ì²´ ì´ë²¤íŠ¸</title>
      <single>
        <search>
          <query>index=fw devname=$device_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[0,1000,5000,10000]</option>
        <option name="underLabel">Total Events</option>
      </single>
    </panel>
    <panel>
      <title>âš™ï¸ ì„¤ì • ë³€ê²½</title>
      <single>
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100044547" OR logid="0100044546" OR logid="0100044545") earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[0,10,50]</option>
        <option name="underLabel">Config Changes</option>
      </single>
    </panel>
  </row>

  <!-- Row 2: ğŸ”’ ì‹œìŠ¤í…œ ë¡œê·¸ -->
  <row>
    <panel>
      <html>
        <h2 style="color: #6DB7C6; border-bottom: 2px solid #6DB7C6; padding-bottom: 5px;">ğŸ”’ ì‹œìŠ¤í…œ ë¡œê·¸</h2>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>ğŸ“Š ì´ë²¤íŠ¸ íƒ€ì„ë¼ì¸</title>
      <chart>
        <search>
          <query>index=fw devname=$device_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| eval severity_level = case(
    level="critical" OR level="alert" OR level="emergency", "Critical",
    level="warning" OR level="error", "High",
    level="notice" OR level="information", "Medium",
    1=1, "Low"
  )
| timechart span=1h count by severity_level</query>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.axisTitleX.text">ì‹œê°„</option>
        <option name="charting.axisTitleY.text">ì´ë²¤íŠ¸ ìˆ˜</option>
        <option name="charting.fieldColors">{"Critical":"0xD93F3C","High":"0xF58F39","Medium":"0xF7BC38","Low":"0x65A637"}</option>
        <option name="drilldown">none</option>
      </chart>
    </panel>
    <panel>
      <title>ğŸ¯ ì°¨ë‹¨ ìœ í˜• ë¶„í¬</title>
      <chart>
        <search>
          <query>index=fw devname=$device_filter$ (action=deny OR action=block) earliest=$time_picker.earliest$ latest=$time_picker.latest$
| eval block_category = case(
    match(type, "(?i)traffic"), "íŒ¨í‚· í•„í„°",
    match(type, "(?i)file"), "íŒŒì¼ í•„í„°",
    match(type, "(?i)webfilter"), "URL í•„í„°",
    match(type, "(?i)app"), "ì•± í•„í„°",
    1=1, "ê¸°íƒ€"
  )
| stats count by block_category
| sort - count</query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.seriesColors">[0xD93F3C,0xF58F39,0xF7BC38,0x6DB7C6,0x65A637]</option>
        <option name="drilldown">none</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>ğŸš¨ Top 10 ì°¨ë‹¨ëœ ì†ŒìŠ¤ IP</title>
      <table>
        <search>
          <query>index=fw devname=$device_filter$ (action=deny OR action=block) earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as blocked_count by srcip
| sort - blocked_count
| head 10
| eval ìˆœìœ„ = _serial
| table ìˆœìœ„, srcip, blocked_count
| rename srcip as "ì†ŒìŠ¤ IP", blocked_count as "ì°¨ë‹¨ íšŸìˆ˜"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rowNumbers">false</option>
        <option name="wrap">true</option>
        <option name="dataOverlayMode">heatmap</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>

  <!-- Row 4: ğŸ“¡ íŠ¸ë˜í”½ ë¡œê·¸ -->
  <row>
    <panel>
      <html>
        <h2 style="color: #6DB7C6; border-bottom: 2px solid #6DB7C6; padding-bottom: 5px;">ğŸ“¡ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ë¡œê·¸</h2>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>ğŸ“Š ëŒ€ì—­í­ ì‚¬ìš©ëŸ‰ ì¶”ì´</title>
      <chart>
        <search>
          <query>index=fw devname=$device_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| eval bytes_total = coalesce(sentbyte, 0) + coalesce(rcvdbyte, 0)
| timechart span=1h sum(bytes_total) as total_bytes
| eval total_mb = round(total_bytes/1024/1024, 2)
| fields _time, total_mb</query>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.axisTitleX.text">ì‹œê°„</option>
        <option name="charting.axisTitleY.text">MB</option>
        <option name="charting.seriesColors">[0x6DB7C6]</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="drilldown">none</option>
      </chart>
    </panel>
    <panel>
      <title>ğŸŒ í”„ë¡œí† ì½œ ë¶„í¬</title>
      <chart>
        <search>
          <query>index=fw devname=$device_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| eval protocol = coalesce(proto, service, "ê¸°íƒ€")
| stats count by protocol
| sort - count
| head 10</query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisTitleX.text">íŒ¨í‚· ìˆ˜</option>
        <option name="charting.seriesColors">[0x65A637]</option>
        <option name="drilldown">none</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>ğŸš€ Top 10 ì• í”Œë¦¬ì¼€ì´ì…˜</title>
      <table>
        <search>
          <query>index=fw devname=$device_filter$ app=* earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count as session_count, sum(sentbyte) as sent_bytes, sum(rcvdbyte) as rcvd_bytes by app
| eval total_mb = round((sent_bytes + rcvd_bytes)/1024/1024, 2)
| sort - session_count
| head 10
| table app, session_count, total_mb
| rename app as "ì• í”Œë¦¬ì¼€ì´ì…˜", session_count as "ì„¸ì…˜ ìˆ˜", total_mb as "íŠ¸ë˜í”½ (MB)"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <option name="dataOverlayMode">heatmap</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>

  <!-- Row 5: âš¡ ì„±ëŠ¥ ë°ì´í„° -->
  <row>
    <panel>
      <html>
        <h2 style="color: #F7BC38; border-bottom: 2px solid #F7BC38; padding-bottom: 5px;">âš¡ ë””ë°”ì´ìŠ¤ ì„±ëŠ¥ ë°ì´í„°</h2>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>ğŸ’» í‰ê·  CPU ì‚¬ìš©ë¥ </title>
      <single>
        <search>
          <query>index=fw devname=$device_filter$ cpu=* earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats avg(cpu) as avg_cpu
| eval avg_cpu = round(avg_cpu, 1)</query>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="useColors">1</option>
        <option name="unit">%</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[0,60,80]</option>
        <option name="underLabel">CPU Usage</option>
      </single>
    </panel>
    <panel>
      <title>ğŸ§  í‰ê·  ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ </title>
      <single>
        <search>
          <query>index=fw devname=$device_filter$ mem=* earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats avg(mem) as avg_mem
| eval avg_mem = round(avg_mem, 1)</query>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="useColors">1</option>
        <option name="unit">%</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[0,70,85]</option>
        <option name="underLabel">Memory Usage</option>
      </single>
    </panel>
    <panel>
      <title>ğŸ”Œ í™œì„± ì„¸ì…˜</title>
      <single>
        <search>
          <query>index=fw devname=$device_filter$ session=* earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats avg(session) as avg_sessions
| eval avg_sessions = round(avg_sessions, 0)</query>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="useColors">1</option>
        <option name="rangeColors">["0x6DB7C6","0x65A637","0xF7BC38"]</option>
        <option name="rangeValues">[0,5000]</option>
        <option name="underLabel">Active Sessions</option>
      </single>
    </panel>
    <panel>
      <title>ğŸ“¶ ë””ë°”ì´ìŠ¤ ìƒíƒœ</title>
      <single>
        <search>
          <query>index=fw devname=$device_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats dc(devname) as device_count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="useColors">1</option>
        <option name="rangeColors">["0x6DB7C6","0x65A637"]</option>
        <option name="rangeValues">[0]</option>
        <option name="underLabel">Active Devices</option>
      </single>
    </panel>
  </row>

  <!-- Row 6: ğŸ”§ ì„¤ì • ë¡œê·¸ -->
  <row>
    <panel>
      <html>
        <h2 style="color: #D93F3C; border-bottom: 2px solid #D93F3C; padding-bottom: 5px;">ğŸ”§ ì„¤ì • ë¡œê·¸</h2>
      </html>
    </panel>
  </row>
  <row>
    <panel>
      <title>ğŸ“¢ ì„¤ì • ë³€ê²½ ì´ë ¥</title>
      <table id="config_changes_table">
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100044547" OR logid="0100044546" OR logid="0100044545") earliest=$time_picker.earliest$ latest=$time_picker.latest$
| rex field=_raw "cfgpath=\"?(?&lt;cfg_path&gt;[^\"]+)\"?"
| rex field=_raw "cfgobj=\"?(?&lt;cfg_object&gt;[^\"]+)\"?"
| rex field=_raw "cfgattr=\"?(?&lt;cfg_attr&gt;[^\"]+)\"?"
| eval config_path = coalesce(cfgpath, cfg_path, "N/A")
| eval config_object = coalesce(cfgobj, cfg_object, "N/A")
| eval config_attr = coalesce(cfgattr, cfg_attr, "N/A")
| eval parsed_value = config_path + " / " + config_object + " [" + config_attr + "]"
| eval change_type = case(
    logid="0100044547", "ì‚­ì œ",
    logid="0100044546", "ìˆ˜ì •",
    logid="0100044545", "ì¶”ê°€",
    1=1, "ê¸°íƒ€"
  )
| eval path_category = case(
    match(config_path, "firewall\.policy"), "ë°©í™”ë²½ ì •ì±…",
    match(config_path, "vpn\.ipsec"), "IPSec VPN",
    match(config_path, "vpn\.ssl"), "SSL VPN",
    match(config_path, "system\.interface"), "ì¸í„°í˜ì´ìŠ¤",
    match(config_path, "router"), "ë¼ìš°íŒ…",
    match(config_path, "user"), "ì‚¬ìš©ì/ê·¸ë£¹",
    match(config_path, "firewall\.address"), "ì£¼ì†Œ ê°ì²´",
    match(config_path, "firewall\.service"), "ì„œë¹„ìŠ¤ ê°ì²´",
    1=1, "ê¸°íƒ€ ì„¤ì •"
  )
| eval access_method = coalesce(ui, "CLI")
| eval access_ip = coalesce(from_ip, remip, "N/A")
| dedup _time devname config_path config_object parsed_value
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| table timestamp, devname, user, change_type, path_category, config_object, parsed_value, access_method, access_ip
| sort - timestamp
| head 20</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">20</option>
      </table>
    </panel>
  </row>

  <!-- Slack ì•Œë¦¼ í…ŒìŠ¤íŠ¸ -->
  <row>
    <panel>
      <html>
        <h2 style="color: #65A637; border-bottom: 2px solid #65A637; padding-bottom: 5px;">ğŸ“¢ Slack ì•Œë¦¼ í…ŒìŠ¤íŠ¸</h2>
      </html>
    </panel>
  </row>

  <!-- Slack ì•Œë¦¼ í…ŒìŠ¤íŠ¸ -->
  <row>
    <panel>
      <title>ğŸ”´ Critical ì´ë²¤íŠ¸ ì•Œë¦¼</title>
      <table>
        <search>
          <query>index=fw (level=critical OR level=alert) earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search NOT msg="*Update Fail*" NOT msg="*Login Fail*"
| head 1
| eval emoji=case(
    level="critical" OR level="emergency", "ğŸ”´",
    level="alert", "ğŸŸ ",
    1=1, "âš ï¸"
  )
| eval slack_message=emoji + " *CRITICAL EVENT ALERT*\n" +
    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
    "*Device:* `" + devname + "`\n" +
    "*Severity:* " + upper(level) + "\n" +
    "*Time:* " + strftime(_time, "%Y-%m-%d %H:%M:%S") + "\n\n" +
    "*Error Message:*\n```" + msg + "```\n\n" +
    "_View in Splunk:_ <https://splunk.jclee.me/app/search|Dashboard>"
| sendalert slack param.message=slack_message
| table devname, level, msg</query>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
    <panel>
      <title>âš™ï¸ ì„¤ì • ë³€ê²½ ì•Œë¦¼</title>
      <table>
        <search>
          <query>index=fw (logid="0100044547" OR logid="0100044546" OR logid="0100044545") earliest=$time_picker.earliest$ latest=$time_picker.latest$
| head 1
| rex field=_raw "cfgpath=\"?(?&lt;cfg_path&gt;[^\"]+)\"?"
| eval change_type=case(
    logid="0100044545", "âœ… Added",
    logid="0100044546", "âœï¸ Edited",
    logid="0100044547", "ğŸ—‘ï¸ Deleted",
    1=1, "ğŸ“ Modified"
  )
| eval category=case(
    match(cfg_path, "firewall\.policy"), "ğŸ›¡ï¸ Firewall Policy",
    match(cfg_path, "system"), "âš™ï¸ System",
    match(cfg_path, "user"), "ğŸ‘¤ User/Group",
    1=1, "ğŸ“‚ Other"
  )
| eval slack_message="âš™ï¸ *CONFIGURATION CHANGE*\n" +
    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
    "*Device:* `" + devname + "`\n" +
    "*User:* *" + user + "*\n" +
    "*Category:* " + category + "\n" +
    "*Action:* " + change_type + "\n\n" +
    "*Config Path:*\n```" + cfg_path + "```\n\n" +
    "*Time:* " + strftime(_time, "%Y-%m-%d %H:%M:%S") + "\n" +
    "_View in Splunk:_ <https://splunk.jclee.me/app/search|Dashboard>"
| sendalert slack param.message=slack_message
| table devname, user, cfg_path</query>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>


</form>
