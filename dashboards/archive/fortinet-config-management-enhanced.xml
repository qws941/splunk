<dashboard version="1.1">
  <label>Fortinet ì„¤ì • ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ (ê°œì„ íŒ)</label>
  <description>FortiGate/FAZ/FMG ì„¤ì • ë³€ê²½ ë° ìš´ì˜ ëª¨ë‹ˆí„°ë§ - Slack ì•ŒëŒ ì—°ë™</description>

  <!-- ì „ì—­ í•„í„° -->
  <fieldset submitButton="false" autoRun="true">
    <input type="time" token="time_picker" searchWhenChanged="true">
      <label>ì‹œê°„ ë²”ìœ„</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>

    <input type="dropdown" token="device_filter" searchWhenChanged="true">
      <label>ì¥ë¹„ í•„í„°</label>
      <choice value="*">ëª¨ë“  ì¥ë¹„</choice>
      <default>*</default>
      <fieldForLabel>devname</fieldForLabel>
      <fieldForValue>devname</fieldForValue>
      <search>
        <query>index=fw | stats count by devname | sort devname</query>
        <earliest>-24h</earliest>
        <latest>now</latest>
      </search>
    </input>
  </fieldset>

  <!-- Row 1: ìš´ì˜ í˜„í™© ìš”ì•½ -->
  <row>
    <panel>
      <single>
        <title>ì „ì²´ ì´ë²¤íŠ¸</title>
        <search>
          <query>index=fw devname=$device_filter$ | stats count</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>

    <panel>
      <single>
        <title>ì„¤ì • ë³€ê²½</title>
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100044547" OR logid="0100044546" OR logid="0100044548" OR "Object attribute configured" OR "Configuration change") | dedup _time devname cfgpath cfgobj | stats count</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="colorBy">value</option>
        <option name="rangeColors">["0x53A051","0xF8BE34","0xDC4E41"]</option>
        <option name="rangeValues">[0,50,100]</option>
        <option name="useColors">1</option>
        <drilldown>
          <link target="_blank">/app/search/search?q=search index=fw (logid="0100044547" OR logid="0100044546" OR logid="0100044548") earliest=$time_picker.earliest$ latest=$time_picker.latest$</link>
        </drilldown>
      </single>
    </panel>

    <panel>
      <single>
        <title>ê´€ë¦¬ ì¥ë¹„</title>
        <search>
          <query>index=fw | stats dc(devname) as devices</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>

    <panel>
      <single>
        <title>Critical ì´ë²¤íŠ¸</title>
        <search>
          <query>index=fw devname=$device_filter$ (level="critical" OR level="emergency") NOT ("update fail" OR "update failed" OR "Update package failed") | dedup _time devname msg | stats count</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">all</option>
        <option name="colorBy">value</option>
        <option name="rangeColors">["0x53A051","0xF8BE34","0xDC4E41"]</option>
        <option name="rangeValues">[0,1,5]</option>
        <option name="useColors">1</option>
      </single>
    </panel>

    <panel>
      <single>
        <title>í™œì„± ê´€ë¦¬ì</title>
        <search>
          <query>index=fw devname=$device_filter$ user=* user!="N/A" | stats dc(user) as users</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
  </row>

  <!-- Row 2: ì„¤ì • ë³€ê²½ ì´ë ¥ (ì¤‘ë³µ ì œê±° ê°œì„ ) -->
  <row>
    <panel>
      <title>ì„¤ì • ë³€ê²½ ì´ë ¥ (cfgpath/cfgobj/cfgattr íŒŒì‹±) - ğŸ“¢ Slack ì•ŒëŒ ê°€ëŠ¥</title>
      <table>
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100044547" OR logid="0100044546" OR logid="0100044548" OR "Object attribute configured")
| rex field=_raw "cfgpath=\"?(?&lt;cfg_path&gt;[^\"]+)\"?"
| rex field=_raw "cfgobj=\"?(?&lt;cfg_object&gt;[^\"]+)\"?"
| rex field=_raw "cfgattr=\"?(?&lt;cfg_attribute&gt;[^\"]+)\"?"
| rex field=ui "(?&lt;access_method&gt;\w+)\((?&lt;access_ip&gt;[^\)]+)\)"

| rex field=cfg_attribute "subnet\[(?&lt;subnet_value&gt;[^\]]+)\]"
| rex field=cfg_attribute "port\[(?&lt;port_value&gt;[^\]]+)\]"
| rex field=cfg_attribute "member\[(?&lt;member_value&gt;[^\]]+)\]"

| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval config_path = coalesce(cfg_path, cfgpath)
| eval config_object = coalesce(cfg_object, cfgobj)
| eval config_attribute = coalesce(cfg_attribute, cfgattr)

| eval path_category = case(
    match(config_path, "firewall\.policy"), "ë°©í™”ë²½ ì •ì±…",
    match(config_path, "firewall\.address"), "ì£¼ì†Œ ê°ì²´",
    match(config_path, "firewall\.addrgrp"), "ì£¼ì†Œ ê·¸ë£¹",
    match(config_path, "firewall\.service"), "ì„œë¹„ìŠ¤ ê°ì²´",
    match(config_path, "vpn\.ipsec"), "IPSec VPN",
    match(config_path, "vpn\.ssl"), "SSL VPN",
    match(config_path, "system\.interface"), "ì¸í„°í˜ì´ìŠ¤",
    match(config_path, "system\.admin"), "ê´€ë¦¬ì",
    match(config_path, "system\.global"), "ì „ì—­ ì„¤ì •",
    1=1, coalesce(config_path, "ê¸°íƒ€"))

| eval change_type = case(
    action="Delete", "ì‚­ì œ",
    action="Add", "ì¶”ê°€",
    action="Edit" OR action="Set", "ìˆ˜ì •",
    logid="0100044547", "ì†ì„± ì„¤ì •",
    logid="0100044546", "ê°ì²´ ìƒì„±",
    logid="0100044548", "ê°ì²´ ì‚­ì œ",
    1=1, "ë³€ê²½")

| eval parsed_value = case(
    isnotnull(subnet_value), "IP: " + subnet_value,
    isnotnull(port_value), "Port: " + port_value,
    isnotnull(member_value), "Member: " + member_value,
    isnotnull(config_attribute), config_attribute,
    1=1, "-")

| dedup _time devname config_path config_object parsed_value

| table timestamp, devname, user, change_type, path_category, config_path, config_object, parsed_value, access_method, access_ip, msg
| rename timestamp AS "ì‹œê°„", devname AS "ì¥ë¹„", user AS "ê´€ë¦¬ì", change_type AS "ì‘ì—…ìœ í˜•",
         path_category AS "ì„¤ì •ë¶„ë¥˜", config_path AS "ì„¤ì •ê²½ë¡œ", config_object AS "ê°ì²´ëª…",
         parsed_value AS "ì„¤ì •ê°’", access_method AS "ì ‘ì†ë°©ë²•", access_ip AS "ì ‘ì†IP", msg AS "ìƒì„¸ë©”ì‹œì§€"
| sort -ì‹œê°„
| head 50</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">20</option>
        <option name="drilldown">row</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="ì‘ì—…ìœ í˜•">
          <colorPalette type="map">{"ì‚­ì œ":#DC4E41,"ì¶”ê°€":#53A051,"ìˆ˜ì •":#F8BE34,"ì†ì„± ì„¤ì •":#87CEEB,"ê°ì²´ ìƒì„±":#90EE90,"ê°ì²´ ì‚­ì œ":#FFB6C1}</colorPalette>
        </format>
        <format type="color" field="ì„¤ì •ë¶„ë¥˜">
          <colorPalette type="map">{"ë°©í™”ë²½ ì •ì±…":#FF6B6B,"ì£¼ì†Œ ê°ì²´":#4ECDC4,"ì£¼ì†Œ ê·¸ë£¹":#45B7D1,"ì„œë¹„ìŠ¤ ê°ì²´":#96CEB4,"IPSec VPN":#FFEAA7,"SSL VPN":#FFA07A,"ì¸í„°í˜ì´ìŠ¤":#DDA0DD,"ê´€ë¦¬ì":#FF69B4,"ì „ì—­ ì„¤ì •":#FF1493}</colorPalette>
        </format>
        <drilldown>
          <link target="_blank">slack_alert?message=ì„¤ì •ë³€ê²½: $row.ì¥ë¹„$ - $row.ì„¤ì •ë¶„ë¥˜$ ($row.ê°ì²´ëª…$) by $row.ê´€ë¦¬ì$&amp;severity=medium</link>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Row 3: ë°©í™”ë²½ ì •ì±… ë³€ê²½ -->
  <row>
    <panel>
      <title>ë°©í™”ë²½ ì •ì±… ë³€ê²½ (firewall.policy) - ğŸ“¢ Slack ì•ŒëŒ ê°€ëŠ¥</title>
      <table>
        <search>
          <query>index=fw devname=$device_filter$ cfgpath="firewall.policy"
| rex field=_raw "cfgobj=\"?(?&lt;policy_name&gt;[^\"]+)\"?"
| rex field=_raw "cfgattr=\"?(?&lt;attribute&gt;[^\"]+)\"?"
| rex field=attribute "srcintf\[(?&lt;src_interface&gt;[^\]]+)\]"
| rex field=attribute "dstintf\[(?&lt;dst_interface&gt;[^\]]+)\]"
| rex field=attribute "srcaddr\[(?&lt;src_address&gt;[^\]]+)\]"
| rex field=attribute "dstaddr\[(?&lt;dst_address&gt;[^\]]+)\]"
| rex field=attribute "service\[(?&lt;service&gt;[^\]]+)\]"
| rex field=attribute "action\[(?&lt;policy_action&gt;[^\]]+)\]"

| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval policy_details = case(
    isnotnull(src_interface), "Source: " + src_interface,
    isnotnull(dst_interface), "Dest: " + dst_interface,
    isnotnull(src_address), "Src Addr: " + src_address,
    isnotnull(dst_address), "Dst Addr: " + dst_address,
    isnotnull(service), "Service: " + service,
    isnotnull(policy_action), "Action: " + policy_action,
    1=1, attribute)

| dedup _time devname policy_name policy_details

| table timestamp, devname, user, action, policy_name, policy_details, msg
| rename timestamp AS "ì‹œê°„", devname AS "ì¥ë¹„", user AS "ê´€ë¦¬ì", action AS "ì‘ì—…",
         policy_name AS "ì •ì±…ëª…", policy_details AS "ë³€ê²½ë‚´ìš©", msg AS "ì „ì²´ë©”ì‹œì§€"
| sort -ì‹œê°„
| head 30</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">15</option>
        <option name="drilldown">row</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="ì‘ì—…">
          <colorPalette type="map">{"Delete":#DC4E41,"Add":#53A051,"Edit":#F8BE34}</colorPalette>
        </format>
        <drilldown>
          <link target="_blank">slack_alert?message=ì •ì±…ë³€ê²½: $row.ì¥ë¹„$ - $row.ì •ì±…ëª…$ ($row.ì‘ì—…$) by $row.ê´€ë¦¬ì$&amp;severity=high</link>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Row 4: VPN ë° ì¸í„°í˜ì´ìŠ¤ ì„¤ì • -->
  <row>
    <panel>
      <title>VPN ì„¤ì • ë³€ê²½ - ğŸ“¢ Slack ì•ŒëŒ ê°€ëŠ¥</title>
      <table>
        <search>
          <query>index=fw devname=$device_filter$ (cfgpath="vpn.ipsec*" OR cfgpath="vpn.ssl*")
| rex field=_raw "cfgobj=\"?(?&lt;vpn_name&gt;[^\"]+)\"?"
| rex field=cfgattr "(?&lt;attr_name&gt;\w+)\[(?&lt;attr_value&gt;[^\]]+)\]"
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval vpn_type = case(match(cfgpath, "ipsec"), "IPSec", match(cfgpath, "ssl"), "SSL-VPN", 1=1, "VPN")
| dedup _time devname vpn_name attr_name
| table timestamp, devname, user, action, vpn_type, vpn_name, attr_name, attr_value
| rename timestamp AS "ì‹œê°„", devname AS "ì¥ë¹„", user AS "ê´€ë¦¬ì", action AS "ì‘ì—…",
         vpn_type AS "VPNìœ í˜•", vpn_name AS "VPNëª…", attr_name AS "ì†ì„±", attr_value AS "ê°’"
| sort -ì‹œê°„
| head 20</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="drilldown">row</option>
        <drilldown>
          <link target="_blank">slack_alert?message=VPNë³€ê²½: $row.ì¥ë¹„$ - $row.VPNëª…$ ($row.VPNìœ í˜•$) by $row.ê´€ë¦¬ì$&amp;severity=high</link>
        </drilldown>
      </table>
    </panel>

    <panel>
      <title>ì‹œìŠ¤í…œ ì¸í„°í˜ì´ìŠ¤ ë³€ê²½ - ğŸ“¢ Slack ì•ŒëŒ ê°€ëŠ¥</title>
      <table>
        <search>
          <query>index=fw devname=$device_filter$ cfgpath="system.interface"
| rex field=cfgattr "ip\[(?&lt;ip_addr&gt;[^\]]+)\]"
| rex field=cfgattr "status\[(?&lt;status&gt;[^\]]+)\]"
| rex field=cfgattr "alias\[(?&lt;alias&gt;[^\]]+)\]"
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval interface_config = case(
    isnotnull(ip_addr), "IP: " + ip_addr,
    isnotnull(status), "Status: " + status,
    isnotnull(alias), "Alias: " + alias,
    1=1, cfgattr)
| dedup _time devname cfgobj interface_config
| table timestamp, devname, user, action, cfgobj, interface_config
| rename timestamp AS "ì‹œê°„", devname AS "ì¥ë¹„", user AS "ê´€ë¦¬ì", action AS "ì‘ì—…",
         cfgobj AS "ì¸í„°í˜ì´ìŠ¤", interface_config AS "ì„¤ì •"
| sort -ì‹œê°„
| head 20</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="drilldown">row</option>
        <drilldown>
          <link target="_blank">slack_alert?message=ì¸í„°í˜ì´ìŠ¤ë³€ê²½: $row.ì¥ë¹„$ - $row.ì¸í„°í˜ì´ìŠ¤$ ($row.ì„¤ì •$) by $row.ê´€ë¦¬ì$&amp;severity=medium</link>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Row 5: ê´€ë¦¬ì í™œë™ -->
  <row>
    <panel>
      <title>ê´€ë¦¬ì ë¡œê·¸ì¸ í™œë™</title>
      <table>
        <search>
          <query>index=fw devname=$device_filter$ ("logged in" OR "logged out" OR logid="0100032101")
| rex field=ui "(?&lt;method&gt;\w+)\((?&lt;ip&gt;[^\)]+)\)"
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| dedup _time devname user ip
| table timestamp, devname, user, method, ip, msg
| rename timestamp AS "ì‹œê°„", devname AS "ì¥ë¹„", user AS "ê´€ë¦¬ì", method AS "ì ‘ì†ë°©ë²•", ip AS "ì ‘ì†IP", msg AS "ìƒíƒœ"
| sort -ì‹œê°„
| head 20</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>

    <panel>
      <title>ê´€ë¦¬ìë³„ ì„¤ì • ë³€ê²½ í†µê³„</title>
      <chart>
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100044547" OR logid="0100044546" OR logid="0100044548")
| dedup _time devname user action cfgpath
| stats count by user, action
| chart values(count) over user by action</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.fieldColors">{"Add":"#53A051","Edit":"#F8BE34","Delete":"#DC4E41","Set":"#87CEEB"}</option>
      </chart>
    </panel>
  </row>

  <!-- Row 6: Critical ì´ë²¤íŠ¸ (ì¤‘ë³µ ì œê±°) -->
  <row>
    <panel>
      <title>Critical ì´ë²¤íŠ¸ (Update Fail ì œì™¸) - ğŸ“¢ Slack ì•ŒëŒ ê°€ëŠ¥</title>
      <table>
        <search>
          <query>index=fw devname=$device_filter$ (level="critical" OR level="emergency")
NOT ("update fail" OR "update failed" OR "Update package failed")
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval severity = upper(level)
| eval event_category = case(
    match(_raw, "hardware|cpu|memory|disk"), "í•˜ë“œì›¨ì–´",
    match(_raw, "vpn|tunnel"), "VPN ì´ìŠˆ",
    match(_raw, "authentication|login"), "ì¸ì¦ ì‹¤íŒ¨",
    match(_raw, "system|daemon"), "ì‹œìŠ¤í…œ",
    1=1, "ê¸°íƒ€")
| dedup _time devname logdesc msg
| table timestamp, severity, event_category, devname, logdesc, msg
| rename timestamp AS "ì‹œê°„", severity AS "ì‹¬ê°ë„", event_category AS "ì´ë²¤íŠ¸ë¶„ë¥˜",
         devname AS "ì¥ë¹„", logdesc AS "ìœ í˜•", msg AS "ë©”ì‹œì§€"
| sort -ì‹œê°„
| head 30</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">15</option>
        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="ì‹¬ê°ë„">
          <colorPalette type="map">{"EMERGENCY":#FF0000,"CRITICAL":#DC4E41}</colorPalette>
        </format>
        <drilldown>
          <link target="_blank">slack_alert?message=CRITICAL: $row.ì¥ë¹„$ - $row.ì´ë²¤íŠ¸ë¶„ë¥˜$ ($row.ë©”ì‹œì§€$)&amp;severity=critical</link>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Row 7: ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ -->
  <row>
    <panel>
      <title>ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ (15ë¶„)</title>
      <table>
        <search>
          <query>index=fw devname=$device_filter$
| eval event_type = case(
    match(_raw, "Object attribute configured|logid=\"0100044547\"|logid=\"0100044546\"|logid=\"0100044548\""), "ì„¤ì •ë³€ê²½",
    match(_raw, "logged in|logged out"), "ë¡œê·¸ì¸",
    match(_raw, "critical|emergency"), "Critical",
    1=1, "ì‹œìŠ¤í…œ")
| eval timestamp = strftime(_time, "%H:%M:%S")
| rex field=_raw "cfgpath=\"?(?&lt;cfg&gt;[^\"]+)\"?"
| rex field=_raw "cfgobj=\"?(?&lt;obj&gt;[^\"]+)\"?"
| eval config_info = case(
    isnotnull(cfg) AND isnotnull(obj), cfg + "/" + obj,
    isnotnull(cfg), cfg,
    1=1, "-")
| dedup _time devname event_type config_info
| table timestamp, event_type, devname, user, config_info, msg
| rename timestamp AS "ì‹œê°„", event_type AS "ìœ í˜•", devname AS "ì¥ë¹„",
         user AS "ì‚¬ìš©ì", config_info AS "ì„¤ì •ì •ë³´", msg AS "ë‚´ìš©"
| head 25</query>
          <earliest>-15m</earliest>
          <latest>now</latest>
          <refresh>30s</refresh>
        </search>
        <option name="count">20</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="ìœ í˜•">
          <colorPalette type="map">{"ì„¤ì •ë³€ê²½":#F8BE34,"Critical":#FF0000,"ë¡œê·¸ì¸":#87CEEB,"ì‹œìŠ¤í…œ":#90EE90}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

</dashboard>
