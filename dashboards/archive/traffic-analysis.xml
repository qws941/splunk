<dashboard version="1.1">
  <label>Network Traffic Analysis</label>
  <description>Comprehensive network traffic monitoring and analysis</description>

  <!-- Row 1: Traffic Metrics -->
  <row>
    <panel>
      <title>Total Traffic (Last Hour)</title>
      <single>
        <search>
          <query>index=fortigate_security earliest=-1h
| stats sum(sent_bytes) as sent, sum(rcvd_bytes) as received
| eval total_gb=round((sent+received)/1024/1024/1024, 2)
| fields total_gb</query>
          <refresh>30s</refresh>
        </search>
        <option name="underLabel">GB</option>
        <option name="drilldown">none</option>
      </single>
    </panel>

    <panel>
      <title>Active Sessions</title>
      <single>
        <search>
          <query>index=fortigate_security earliest=-5m | stats count</query>
          <refresh>30s</refresh>
        </search>
        <option name="underLabel">Sessions</option>
      </single>
    </panel>

    <panel>
      <title>Connections/Sec</title>
      <single>
        <search>
          <query>index=fortigate_security earliest=-1m
| stats count as connections
| eval conn_per_sec=connections/60
| fields conn_per_sec</query>
          <refresh>10s</refresh>
        </search>
        <option name="underLabel">conn/s</option>
      </single>
    </panel>

    <panel>
      <title>Unique Sources</title>
      <single>
        <search>
          <query>index=fortigate_security earliest=-1h | stats dc(src_ip)</query>
          <refresh>1m</refresh>
        </search>
        <option name="underLabel">IPs</option>
      </single>
    </panel>
  </row>

  <!-- Row 2: Bandwidth Timeline -->
  <row>
    <panel>
      <title>Bandwidth Usage Timeline (Last 4 Hours)</title>
      <chart>
        <search>
          <query>index=fortigate_security earliest=-4h
| bucket _time span=5m
| stats sum(sent_bytes) as sent, sum(rcvd_bytes) as received by _time
| eval sent_mbps=round(sent*8/1024/1024/300, 2)
| eval received_mbps=round(received*8/1024/1024/300, 2)
| timechart span=5m avg(sent_mbps) as "Outbound", avg(received_mbps) as "Inbound"</query>
          <refresh>1m</refresh>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.axisTitleY.text">Mbps</option>
        <option name="charting.legend.placement">bottom</option>
      </chart>
    </panel>
  </row>

  <!-- Row 3: Top Talkers and Applications -->
  <row>
    <panel>
      <title>Top Bandwidth Consumers</title>
      <table>
        <search>
          <query>index=fortigate_security earliest=-1h
| stats sum(sent_bytes) as sent, sum(rcvd_bytes) as received by src_ip
| eval total_mb=round((sent+received)/1024/1024, 2)
| sort -total_mb
| head 15
| rename src_ip as "Source IP", total_mb as "Total MB"</query>
          <refresh>1m</refresh>
        </search>
        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>

    <panel>
      <title>Top Applications</title>
      <table>
        <search>
          <query>index=fortigate_security app=* earliest=-1h
| stats sum(sent_bytes) as sent, sum(rcvd_bytes) as received, count as sessions by app
| eval total_mb=round((sent+received)/1024/1024, 2)
| sort -total_mb
| head 15
| rename app as "Application", total_mb as "Total MB", sessions as "Sessions"</query>
          <refresh>1m</refresh>
        </search>
        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>

  <!-- Row 4: Protocol Distribution -->
  <row>
    <panel>
      <title>Traffic by Protocol</title>
      <chart>
        <search>
          <query>index=fortigate_security earliest=-1h
| stats sum(sent_bytes) as sent, sum(rcvd_bytes) as received by proto
| eval total_mb=round((sent+received)/1024/1024, 2)
| sort -total_mb
| head 10</query>
          <refresh>1m</refresh>
        </search>
        <option name="charting.chart">pie</option>
      </chart>
    </panel>

    <panel>
      <title>Traffic by Service Port</title>
      <chart>
        <search>
          <query>index=fortigate_security service=* earliest=-1h
| stats sum(sent_bytes) as bytes by service
| eval mb=round(bytes/1024/1024, 2)
| sort -mb
| head 10</query>
          <refresh>1m</refresh>
        </search>
        <option name="charting.chart">bar</option>
      </chart>
    </panel>
  </row>

  <!-- Row 5: Hourly Pattern -->
  <row>
    <panel>
      <title>24-Hour Traffic Pattern</title>
      <chart>
        <search>
          <query>index=fortigate_security earliest=-24h
| bucket _time span=1h
| stats sum(sent_bytes) as sent, sum(rcvd_bytes) as received by _time
| eval traffic_gb=round((sent+received)/1024/1024/1024, 2)
| timechart span=1h sum(traffic_gb) as "Traffic (GB)"</query>
          <refresh>5m</refresh>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.axisTitleY.text">Traffic (GB)</option>
      </chart>
    </panel>
  </row>
</dashboard>