<dashboard version="1.1" script="slack_integration.js">
  <label>Fortinet ì„¤ì • ê´€ë¦¬ (PRD - Slack í†µí•©)</label>
  <description>FAZ/FMG ì„¤ì • ë³€ê²½ ëª¨ë‹ˆí„°ë§ with Slack ì‹¤ì‹œê°„ ì•Œë¦¼ (ì¬ê¸°ë™ ë¶ˆí•„ìš”)</description>

  <!-- Slack Webhook ì„¤ì • íŒ¨ë„ -->
  <row>
    <panel>
      <html>
        <div style="padding: 15px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
          <h3 style="margin-top: 0; color: #333;">ğŸ“¢ Slack ì•Œë¦¼ ì„¤ì •</h3>
          <div style="display: flex; gap: 10px; align-items: center;">
            <label style="min-width: 120px; font-weight: bold;">Webhook URL:</label>
            <input
              type="text"
              id="slack-webhook-url"
              placeholder="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
              style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
            />
            <button
              id="test-slack-btn"
              style="padding: 8px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
              ì—°ê²° í…ŒìŠ¤íŠ¸
            </button>
            <button
              id="save-slack-btn"
              style="padding: 8px 20px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
              ì €ì¥
            </button>
          </div>
          <div id="slack-status" style="margin-top: 10px; padding: 8px; border-radius: 4px; display: none;"></div>
          <div style="margin-top: 10px; font-size: 12px; color: #666;">
            ğŸ’¡ <strong>ì‚¬ìš©ë²•:</strong>
            <ul style="margin: 5px 0 0 20px;">
              <li>Slack Webhook URL ì…ë ¥ â†’ ì €ì¥</li>
              <li>ëŒ€ì‹œë³´ë“œ í…Œì´ë¸”ì—ì„œ ğŸ“¢ í‘œì‹œëœ í–‰ í´ë¦­ â†’ ìë™ìœ¼ë¡œ Slack ì•Œë¦¼ ì „ì†¡</li>
              <li>ë¸Œë¼ìš°ì €ì— ë¡œì»¬ ì €ì¥ (Splunk ì¬ê¸°ë™ ë¶ˆí•„ìš”)</li>
            </ul>
          </div>
        </div>

        <script type="text/javascript">
          // Slack Webhook URL ê´€ë¦¬
          const STORAGE_KEY = 'fortinet_slack_webhook_url';

          function getStoredWebhookUrl() {
            return localStorage.getItem(STORAGE_KEY) || '';
          }

          function setWebhookUrl(url) {
            localStorage.setItem(STORAGE_KEY, url);
          }

          function showStatus(message, isError) {
            const statusDiv = document.getElementById('slack-status');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            statusDiv.style.background = isError ? '#ffebee' : '#e8f5e9';
            statusDiv.style.color = isError ? '#c62828' : '#2e7d32';
            statusDiv.style.border = isError ? '1px solid #ef5350' : '1px solid #66bb6a';

            setTimeout(() => {
              statusDiv.style.display = 'none';
            }, 5000);
          }

          // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ URL ë³µì›
          document.addEventListener('DOMContentLoaded', function() {
            const urlInput = document.getElementById('slack-webhook-url');
            urlInput.value = getStoredWebhookUrl();

            // ì €ì¥ ë²„íŠ¼
            document.getElementById('save-slack-btn').addEventListener('click', function() {
              const url = urlInput.value.trim();
              if (url) {
                setWebhookUrl(url);
                showStatus('âœ… Webhook URL ì €ì¥ ì™„ë£Œ', false);
              } else {
                showStatus('âŒ URLì„ ì…ë ¥í•˜ì„¸ìš”', true);
              }
            });

            // í…ŒìŠ¤íŠ¸ ë²„íŠ¼
            document.getElementById('test-slack-btn').addEventListener('click', function() {
              const url = urlInput.value.trim();
              if (!url) {
                showStatus('âŒ Webhook URLì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”', true);
                return;
              }

              const payload = {
                text: 'ğŸ§ª *Splunk Dashboard ì—°ê²° í…ŒìŠ¤íŠ¸*',
                attachments: [{
                  color: '#2196F3',
                  title: 'Fortinet ì„¤ì • ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ',
                  text: 'Slack ì—°ë™ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.',
                  footer: 'Splunk Dashboard Integration',
                  ts: Math.floor(Date.now() / 1000)
                }]
              };

              fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              })
              .then(response => {
                if (response.ok) {
                  showStatus('âœ… Slack ì—°ê²° ì„±ê³µ!', false);
                  setWebhookUrl(url);
                } else {
                  showStatus('âŒ Slack ì—°ê²° ì‹¤íŒ¨: HTTP ' + response.status, true);
                }
              })
              .catch(error => {
                showStatus('âŒ ì—°ê²° ì˜¤ë¥˜: ' + error.message, true);
              });
            });
          });

          // Drilldown ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì „ì—­)
          require([
            'splunkjs/mvc',
            'splunkjs/mvc/simplexml/ready!'
          ], function(mvc) {
            // ëª¨ë“  í…Œì´ë¸” ë·° ê°€ì ¸ì˜¤ê¸°
            const tables = mvc.Components.getInstances().filter(c => c.name && c.name.includes('table'));

            tables.forEach(function(table) {
              table.on('click', function(e) {
                e.preventDefault();

                const webhookUrl = getStoredWebhookUrl();
                if (!webhookUrl) {
                  alert('âš ï¸ Slack Webhook URLì„ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”');
                  return;
                }

                // í´ë¦­í•œ í–‰ ë°ì´í„° ì¶”ì¶œ
                const rowData = e.data || {};
                const row = {};

                // ëª¨ë“  í•„ë“œë¥¼ row ê°ì²´ë¡œ ë³€í™˜
                Object.keys(rowData).forEach(key => {
                  if (key.startsWith('row.')) {
                    row[key.replace('row.', '')] = rowData[key];
                  } else {
                    row[key] = rowData[key];
                  }
                });

                // Slack ë©”ì‹œì§€ ìƒì„±
                let message = 'ğŸ”” *Fortinet Dashboard ì•Œë¦¼*\n\n';
                let severity = 'medium';
                let color = '#F8BE34'; // medium = orange

                // íŒ¨ë„ íƒ€ì…ë³„ ë©”ì‹œì§€ ë° ì‹¬ê°ë„ ê²°ì •
                if (row['ì„¤ì •ë¶„ë¥˜']) {
                  message = `ğŸ› ï¸ *ì„¤ì • ë³€ê²½ ê°ì§€*\n`;
                  severity = row['ì‘ì—…ìœ í˜•'] === 'ì‚­ì œ' ? 'high' : 'medium';
                } else if (row['ì •ì±…ëª…']) {
                  message = `ğŸ”¥ *ë°©í™”ë²½ ì •ì±… ë³€ê²½*\n`;
                  severity = 'high';
                } else if (row['VPNëª…']) {
                  message = `ğŸ” *VPN ì„¤ì • ë³€ê²½*\n`;
                  severity = 'high';
                } else if (row['ì‹¬ê°ë„']) {
                  message = `ğŸš¨ *Critical ì´ë²¤íŠ¸*\n`;
                  severity = 'critical';
                }

                // ì‹¬ê°ë„ë³„ ìƒ‰ìƒ
                if (severity === 'critical') color = '#DC4E41'; // red
                else if (severity === 'high') color = '#F8BE34'; // orange
                else if (severity === 'medium') color = '#87CEEB'; // blue
                else color = '#53A051'; // green

                // ì´ëª¨ì§€
                const emoji = {
                  critical: 'ğŸ”´',
                  high: 'ğŸŸ ',
                  medium: 'ğŸŸ¡',
                  low: 'ğŸŸ¢'
                }[severity] || 'âšª';

                // Slack payload ìƒì„±
                const fields = [];
                Object.keys(row).forEach(key => {
                  if (row[key] && key !== '_time' && key !== '_raw') {
                    fields.push({
                      title: key,
                      value: String(row[key]),
                      short: String(row[key]).length < 30
                    });
                  }
                });

                const payload = {
                  text: emoji + ' ' + message,
                  attachments: [{
                    color: color,
                    title: severity.toUpperCase() + ' Alert',
                    fields: fields,
                    footer: 'Fortinet Dashboard Alert',
                    ts: Math.floor(Date.now() / 1000)
                  }]
                };

                // Slackìœ¼ë¡œ ì „ì†¡
                fetch(webhookUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                })
                .then(response => {
                  if (response.ok) {
                    showStatus('âœ… Slack ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ', false);
                  } else {
                    showStatus('âŒ Slack ì „ì†¡ ì‹¤íŒ¨: HTTP ' + response.status, true);
                  }
                })
                .catch(error => {
                  showStatus('âŒ ì „ì†¡ ì˜¤ë¥˜: ' + error.message, true);
                });
              });
            });
          });
        </script>
      </html>
    </panel>
  </row>

  <!-- ì „ì—­ í•„í„° -->
  <fieldset submitButton="false" autoRun="true">
    <input type="time" token="time_picker" searchWhenChanged="true">
      <label>ì‹œê°„ ë²”ìœ„</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>

    <input type="dropdown" token="device_filter" searchWhenChanged="true">
      <label>ì¥ë¹„ í•„í„°</label>
      <choice value="*">ëª¨ë“  ì¥ë¹„</choice>
      <default>*</default>
      <fieldForLabel>devname</fieldForLabel>
      <fieldForValue>devname</fieldForValue>
      <search>
        <query>index=fw | stats count by devname | sort devname</query>
        <earliest>-24h</earliest>
        <latest>now</latest>
      </search>
    </input>
  </fieldset>

  <!-- Row 1: ìš´ì˜ í˜„í™© ìš”ì•½ -->
  <row>
    <panel>
      <single>
        <title>ì „ì²´ ì´ë²¤íŠ¸</title>
        <search>
          <query>index=fw devname=$device_filter$ | stats count</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>

    <panel>
      <single>
        <title>ì„¤ì • ë³€ê²½</title>
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100044547" OR logid="0100044546" OR logid="0100044548" OR "Object attribute configured" OR "Configuration change") | dedup _time devname cfgpath cfgobj | stats count</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="colorBy">value</option>
        <option name="rangeColors">["0x53A051","0xF8BE34","0xDC4E41"]</option>
        <option name="rangeValues">[0,50,100]</option>
        <option name="useColors">1</option>
      </single>
    </panel>

    <panel>
      <single>
        <title>ê´€ë¦¬ ì¥ë¹„</title>
        <search>
          <query>index=fw | stats dc(devname) as devices</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>

    <panel>
      <single>
        <title>Critical ì´ë²¤íŠ¸</title>
        <search>
          <query>index=fw devname=$device_filter$ (level="critical" OR level="emergency") NOT ("update fail" OR "update failed" OR "Update package failed") | dedup _time devname msg | stats count</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="colorBy">value</option>
        <option name="rangeColors">["0x53A051","0xF8BE34","0xDC4E41"]</option>
        <option name="rangeValues">[0,1,5]</option>
        <option name="useColors">1</option>
      </single>
    </panel>

    <panel>
      <single>
        <title>í™œì„± ê´€ë¦¬ì</title>
        <search>
          <query>index=fw devname=$device_filter$ user=* user!="N/A" | stats dc(user) as users</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
  </row>

  <!-- Row 2: ì„¤ì • ë³€ê²½ ì´ë ¥ (ğŸ“¢ Slack ì•ŒëŒ ê°€ëŠ¥) -->
  <row>
    <panel>
      <title>ğŸ“¢ ì„¤ì • ë³€ê²½ ì´ë ¥ (í´ë¦­ â†’ Slack ì•Œë¦¼)</title>
      <table id="config-changes-table">
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100044547" OR logid="0100044546" OR logid="0100044548" OR "Object attribute configured")
| rex field=_raw "cfgpath=\"?(?&lt;cfg_path&gt;[^\"]+)\"?"
| rex field=_raw "cfgobj=\"?(?&lt;cfg_object&gt;[^\"]+)\"?"
| rex field=_raw "cfgattr=\"?(?&lt;cfg_attribute&gt;[^\"]+)\"?"
| rex field=ui "(?&lt;access_method&gt;\w+)\((?&lt;access_ip&gt;[^\)]+)\)"

| rex field=cfg_attribute "subnet\[(?&lt;subnet_value&gt;[^\]]+)\]"
| rex field=cfg_attribute "port\[(?&lt;port_value&gt;[^\]]+)\]"
| rex field=cfg_attribute "member\[(?&lt;member_value&gt;[^\]]+)\]"

| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval config_path = coalesce(cfg_path, cfgpath)
| eval config_object = coalesce(cfg_object, cfgobj)
| eval config_attribute = coalesce(cfg_attribute, cfgattr)

| eval path_category = case(
    match(config_path, "firewall\.policy"), "ë°©í™”ë²½ ì •ì±…",
    match(config_path, "firewall\.address"), "ì£¼ì†Œ ê°ì²´",
    match(config_path, "firewall\.addrgrp"), "ì£¼ì†Œ ê·¸ë£¹",
    match(config_path, "firewall\.service"), "ì„œë¹„ìŠ¤ ê°ì²´",
    match(config_path, "vpn\.ipsec"), "IPSec VPN",
    match(config_path, "vpn\.ssl"), "SSL VPN",
    match(config_path, "system\.interface"), "ì¸í„°í˜ì´ìŠ¤",
    match(config_path, "system\.admin"), "ê´€ë¦¬ì",
    match(config_path, "system\.global"), "ì „ì—­ ì„¤ì •",
    1=1, coalesce(config_path, "ê¸°íƒ€"))

| eval change_type = case(
    action="Delete", "ì‚­ì œ",
    action="Add", "ì¶”ê°€",
    action="Edit" OR action="Set", "ìˆ˜ì •",
    logid="0100044547", "ì†ì„± ì„¤ì •",
    logid="0100044546", "ê°ì²´ ìƒì„±",
    logid="0100044548", "ê°ì²´ ì‚­ì œ",
    1=1, "ë³€ê²½")

| eval parsed_value = case(
    isnotnull(subnet_value), "IP: " + subnet_value,
    isnotnull(port_value), "Port: " + port_value,
    isnotnull(member_value), "Member: " + member_value,
    isnotnull(config_attribute), config_attribute,
    1=1, "-")

| dedup _time devname config_path config_object parsed_value

| table timestamp, devname, user, change_type, path_category, config_path, config_object, parsed_value, access_method, access_ip
| rename timestamp AS "ì‹œê°„", devname AS "ì¥ë¹„", user AS "ê´€ë¦¬ì", change_type AS "ì‘ì—…ìœ í˜•",
         path_category AS "ì„¤ì •ë¶„ë¥˜", config_path AS "ì„¤ì •ê²½ë¡œ", config_object AS "ê°ì²´ëª…",
         parsed_value AS "ì„¤ì •ê°’", access_method AS "ì ‘ì†ë°©ë²•", access_ip AS "ì ‘ì†IP"
| sort -ì‹œê°„
| head 50</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">20</option>
        <option name="drilldown">row</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="ì‘ì—…ìœ í˜•">
          <colorPalette type="map">{"ì‚­ì œ":#DC4E41,"ì¶”ê°€":#53A051,"ìˆ˜ì •":#F8BE34,"ì†ì„± ì„¤ì •":#87CEEB,"ê°ì²´ ìƒì„±":#90EE90,"ê°ì²´ ì‚­ì œ":#FFB6C1}</colorPalette>
        </format>
        <format type="color" field="ì„¤ì •ë¶„ë¥˜">
          <colorPalette type="map">{"ë°©í™”ë²½ ì •ì±…":#FF6B6B,"ì£¼ì†Œ ê°ì²´":#4ECDC4,"ì£¼ì†Œ ê·¸ë£¹":#45B7D1,"ì„œë¹„ìŠ¤ ê°ì²´":#96CEB4,"IPSec VPN":#FFEAA7,"SSL VPN":#FFA07A,"ì¸í„°í˜ì´ìŠ¤":#DDA0DD,"ê´€ë¦¬ì":#FF69B4,"ì „ì—­ ì„¤ì •":#FF1493}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 3: ë°©í™”ë²½ ì •ì±… ë³€ê²½ (ğŸ“¢ Slack ì•ŒëŒ ê°€ëŠ¥) -->
  <row>
    <panel>
      <title>ğŸ“¢ ë°©í™”ë²½ ì •ì±… ë³€ê²½ (í´ë¦­ â†’ Slack ì•Œë¦¼)</title>
      <table id="policy-changes-table">
        <search>
          <query>index=fw devname=$device_filter$ cfgpath="firewall.policy"
| rex field=_raw "cfgobj=\"?(?&lt;policy_name&gt;[^\"]+)\"?"
| rex field=_raw "cfgattr=\"?(?&lt;attribute&gt;[^\"]+)\"?"
| rex field=attribute "srcintf\[(?&lt;src_interface&gt;[^\]]+)\]"
| rex field=attribute "dstintf\[(?&lt;dst_interface&gt;[^\]]+)\]"
| rex field=attribute "srcaddr\[(?&lt;src_address&gt;[^\]]+)\]"
| rex field=attribute "dstaddr\[(?&lt;dst_address&gt;[^\]]+)\]"
| rex field=attribute "service\[(?&lt;service&gt;[^\]]+)\]"
| rex field=attribute "action\[(?&lt;policy_action&gt;[^\]]+)\]"

| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval policy_details = case(
    isnotnull(src_interface), "Source: " + src_interface,
    isnotnull(dst_interface), "Dest: " + dst_interface,
    isnotnull(src_address), "Src Addr: " + src_address,
    isnotnull(dst_address), "Dst Addr: " + dst_address,
    isnotnull(service), "Service: " + service,
    isnotnull(policy_action), "Action: " + policy_action,
    1=1, attribute)

| dedup _time devname policy_name policy_details

| table timestamp, devname, user, action, policy_name, policy_details
| rename timestamp AS "ì‹œê°„", devname AS "ì¥ë¹„", user AS "ê´€ë¦¬ì", action AS "ì‘ì—…",
         policy_name AS "ì •ì±…ëª…", policy_details AS "ë³€ê²½ë‚´ìš©"
| sort -ì‹œê°„
| head 30</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">15</option>
        <option name="drilldown">row</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="ì‘ì—…">
          <colorPalette type="map">{"Delete":#DC4E41,"Add":#53A051,"Edit":#F8BE34}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 4: VPN ì„¤ì • ë³€ê²½ (ğŸ“¢ Slack ì•ŒëŒ ê°€ëŠ¥) -->
  <row>
    <panel>
      <title>ğŸ“¢ VPN ì„¤ì • ë³€ê²½ (í´ë¦­ â†’ Slack ì•Œë¦¼)</title>
      <table id="vpn-changes-table">
        <search>
          <query>index=fw devname=$device_filter$ (cfgpath="vpn.ipsec*" OR cfgpath="vpn.ssl*")
| rex field=_raw "cfgobj=\"?(?&lt;vpn_name&gt;[^\"]+)\"?"
| rex field=cfgattr "(?&lt;attr_name&gt;\w+)\[(?&lt;attr_value&gt;[^\]]+)\]"
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval vpn_type = case(match(cfgpath, "ipsec"), "IPSec", match(cfgpath, "ssl"), "SSL-VPN", 1=1, "VPN")
| dedup _time devname vpn_name attr_name
| table timestamp, devname, user, action, vpn_type, vpn_name, attr_name, attr_value
| rename timestamp AS "ì‹œê°„", devname AS "ì¥ë¹„", user AS "ê´€ë¦¬ì", action AS "ì‘ì—…",
         vpn_type AS "VPNìœ í˜•", vpn_name AS "VPNëª…", attr_name AS "ì†ì„±", attr_value AS "ê°’"
| sort -ì‹œê°„
| head 20</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="drilldown">row</option>
      </table>
    </panel>

    <panel>
      <title>ğŸ“¢ ì¸í„°í˜ì´ìŠ¤ ë³€ê²½ (í´ë¦­ â†’ Slack ì•Œë¦¼)</title>
      <table id="interface-changes-table">
        <search>
          <query>index=fw devname=$device_filter$ cfgpath="system.interface"
| rex field=cfgattr "ip\[(?&lt;ip_addr&gt;[^\]]+)\]"
| rex field=cfgattr "status\[(?&lt;status&gt;[^\]]+)\]"
| rex field=cfgattr "alias\[(?&lt;alias&gt;[^\]]+)\]"
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval interface_config = case(
    isnotnull(ip_addr), "IP: " + ip_addr,
    isnotnull(status), "Status: " + status,
    isnotnull(alias), "Alias: " + alias,
    1=1, cfgattr)
| dedup _time devname cfgobj interface_config
| table timestamp, devname, user, action, cfgobj, interface_config
| rename timestamp AS "ì‹œê°„", devname AS "ì¥ë¹„", user AS "ê´€ë¦¬ì", action AS "ì‘ì—…",
         cfgobj AS "ì¸í„°í˜ì´ìŠ¤", interface_config AS "ì„¤ì •"
| sort -ì‹œê°„
| head 20</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="drilldown">row</option>
      </table>
    </panel>
  </row>

  <!-- Row 5: Critical ì´ë²¤íŠ¸ (ğŸ“¢ Slack ì•ŒëŒ ê°€ëŠ¥) -->
  <row>
    <panel>
      <title>ğŸ“¢ Critical ì´ë²¤íŠ¸ (í´ë¦­ â†’ Slack ì•Œë¦¼)</title>
      <table id="critical-events-table">
        <search>
          <query>index=fw devname=$device_filter$ (level="critical" OR level="emergency")
NOT ("update fail" OR "update failed" OR "Update package failed")
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval severity = upper(level)
| eval event_category = case(
    match(_raw, "hardware|cpu|memory|disk"), "í•˜ë“œì›¨ì–´",
    match(_raw, "vpn|tunnel"), "VPN ì´ìŠˆ",
    match(_raw, "authentication|login"), "ì¸ì¦ ì‹¤íŒ¨",
    match(_raw, "system|daemon"), "ì‹œìŠ¤í…œ",
    1=1, "ê¸°íƒ€")
| dedup _time devname logdesc msg
| table timestamp, severity, event_category, devname, logdesc, msg
| rename timestamp AS "ì‹œê°„", severity AS "ì‹¬ê°ë„", event_category AS "ì´ë²¤íŠ¸ë¶„ë¥˜",
         devname AS "ì¥ë¹„", logdesc AS "ìœ í˜•", msg AS "ë©”ì‹œì§€"
| sort -ì‹œê°„
| head 30</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">15</option>
        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="ì‹¬ê°ë„">
          <colorPalette type="map">{"EMERGENCY":#FF0000,"CRITICAL":#DC4E41}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

  <!-- Row 6: ê´€ë¦¬ì í™œë™ -->
  <row>
    <panel>
      <title>ê´€ë¦¬ì ë¡œê·¸ì¸ í™œë™</title>
      <table>
        <search>
          <query>index=fw devname=$device_filter$ ("logged in" OR "logged out" OR logid="0100032101")
| rex field=ui "(?&lt;method&gt;\w+)\((?&lt;ip&gt;[^\)]+)\)"
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| dedup _time devname user ip
| table timestamp, devname, user, method, ip, msg
| rename timestamp AS "ì‹œê°„", devname AS "ì¥ë¹„", user AS "ê´€ë¦¬ì", method AS "ì ‘ì†ë°©ë²•", ip AS "ì ‘ì†IP", msg AS "ìƒíƒœ"
| sort -ì‹œê°„
| head 20</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>

    <panel>
      <title>ê´€ë¦¬ìë³„ ì„¤ì • ë³€ê²½ í†µê³„</title>
      <chart>
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100044547" OR logid="0100044546" OR logid="0100044548")
| dedup _time devname user action cfgpath
| stats count by user, action
| chart values(count) over user by action</query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.fieldColors">{"Add":"#53A051","Edit":"#F8BE34","Delete":"#DC4E41","Set":"#87CEEB"}</option>
      </chart>
    </panel>
  </row>

  <!-- Row 7: ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ -->
  <row>
    <panel>
      <title>ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ (15ë¶„, 30ì´ˆ ìë™ ê°±ì‹ )</title>
      <table>
        <search>
          <query>index=fw devname=$device_filter$
| eval event_type = case(
    match(_raw, "Object attribute configured|logid=\"0100044547\"|logid=\"0100044546\"|logid=\"0100044548\""), "ì„¤ì •ë³€ê²½",
    match(_raw, "logged in|logged out"), "ë¡œê·¸ì¸",
    match(_raw, "critical|emergency"), "Critical",
    1=1, "ì‹œìŠ¤í…œ")
| eval timestamp = strftime(_time, "%H:%M:%S")
| rex field=_raw "cfgpath=\"?(?&lt;cfg&gt;[^\"]+)\"?"
| rex field=_raw "cfgobj=\"?(?&lt;obj&gt;[^\"]+)\"?"
| eval config_info = case(
    isnotnull(cfg) AND isnotnull(obj), cfg + "/" + obj,
    isnotnull(cfg), cfg,
    1=1, "-")
| dedup _time devname event_type config_info
| table timestamp, event_type, devname, user, config_info, msg
| rename timestamp AS "ì‹œê°„", event_type AS "ìœ í˜•", devname AS "ì¥ë¹„",
         user AS "ì‚¬ìš©ì", config_info AS "ì„¤ì •ì •ë³´", msg AS "ë‚´ìš©"
| head 25</query>
          <earliest>-15m</earliest>
          <latest>now</latest>
          <refresh>30s</refresh>
        </search>
        <option name="count">20</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="ìœ í˜•">
          <colorPalette type="map">{"ì„¤ì •ë³€ê²½":#F8BE34,"Critical":#FF0000,"ë¡œê·¸ì¸":#87CEEB,"ì‹œìŠ¤í…œ":#90EE90}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

</dashboard>
