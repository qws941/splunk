<form version="1.1">
  <label>ğŸ” Fortinet ì„¤ì • ê´€ë¦¬ (PRD - Proxy Slack í†µí•©)</label>
  <description>FortiAnalyzer/FortiManager ì„¤ì • ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ - index=fw ê¸°ë°˜, ì¤‘ë³µ ì œê±°, Slack ì•Œë¦¼ (Proxy ì§€ì›) | âœ¨ WCAG ì¤€ìˆ˜ ë””ìì¸</description>

  <!-- Device Filter -->
  <fieldset submitButton="false">
    <input type="dropdown" token="device_filter" searchWhenChanged="true">
      <label>ì¥ë¹„ ì„ íƒ</label>
      <choice value="*">ì „ì²´</choice>
      <default>*</default>
      <fieldForLabel>devname</fieldForLabel>
      <fieldForValue>devname</fieldForValue>
      <search>
        <query>index=fw | stats count by devname | sort - count</query>
      </search>
    </input>
    <input type="time" token="time_picker">
      <label>ì‹œê°„ ë²”ìœ„</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>

  <!-- Row 1: ğŸ“Š ìš´ì˜ í˜„í™© ìš”ì•½ (WCAG ì¤€ìˆ˜ ìƒ‰ìƒ) -->
  <row>
    <panel>
      <title>ğŸ“ˆ ì „ì²´ ì´ë²¤íŠ¸</title>
      <single>
        <search>
          <query>index=fw devname=$device_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[0,1000,5000,10000]</option>
        <option name="underLabel">Total Events</option>
      </single>
    </panel>
    <panel>
      <title>âš™ï¸ ì„¤ì • ë³€ê²½</title>
      <single>
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100044547" OR logid="0100044546" OR logid="0100044545") earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[0,10,50]</option>
        <option name="underLabel">Config Changes</option>
      </single>
    </panel>
    <panel>
      <title>ğŸ–¥ï¸ ê´€ë¦¬ ì¥ë¹„</title>
      <single>
        <search>
          <query>index=fw devname=$device_filter$ earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats dc(devname) as device_count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x6DB7C6","0x65A637","0xF7BC38"]</option>
        <option name="rangeValues">[0,5]</option>
        <option name="underLabel">Devices</option>
      </single>
    </panel>
    <panel>
      <title>ğŸš¨ Critical ì´ë²¤íŠ¸</title>
      <single>
        <search>
          <query>index=fw devname=$device_filter$ (level=critical OR level=alert OR level=emergency) earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search NOT msg="*Update Fail*"
| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xD93F3C"]</option>
        <option name="rangeValues">[0,5]</option>
        <option name="underLabel">Critical Events</option>
      </single>
    </panel>
    <panel>
      <title>ğŸ‘¤ í™œì„± ê´€ë¦¬ì</title>
      <single>
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100044547" OR logid="0100032001" OR logid="0100032003") earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats dc(user) as admin_count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="useColors">1</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x6DB7C6","0x65A637","0xF7BC38","0xF58F39"]</option>
        <option name="rangeValues">[0,3,10]</option>
        <option name="underLabel">Active Admins</option>
      </single>
    </panel>
  </row>

  <!-- Row 1.5: ğŸ“Š íŠ¸ë Œë“œ ë¶„ì„ -->
  <row>
    <panel>
      <title>ğŸ“Š ì„¤ì • ë³€ê²½ íŠ¸ë Œë“œ (ì‹œê°„ëŒ€ë³„)</title>
      <chart>
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100044547" OR logid="0100044546" OR logid="0100044545") earliest=$time_picker.earliest$ latest=$time_picker.latest$
| eval change_type = case(
    logid="0100044547", "ì‚­ì œ",
    logid="0100044546", "ìˆ˜ì •",
    logid="0100044545", "ì¶”ê°€",
    1=1, "ê¸°íƒ€"
  )
| timechart span=1h count by change_type</query>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.axisTitleX.text">ì‹œê°„</option>
        <option name="charting.axisTitleY.text">ë³€ê²½ ê±´ìˆ˜</option>
        <option name="charting.fieldColors">{"ì‚­ì œ":"0xD93F3C","ìˆ˜ì •":"0xF7BC38","ì¶”ê°€":"0x65A637"}</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">preview</option>
      </chart>
    </panel>
    <panel>
      <title>ğŸ“Š ê´€ë¦¬ìë³„ í™œë™ ë¶„í¬</title>
      <chart>
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100044547" OR logid="0100044546" OR logid="0100044545") earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count by user
| sort - count
| head 10</query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisTitleX.text">ë³€ê²½ ê±´ìˆ˜</option>
        <option name="charting.axisTitleY.text">ê´€ë¦¬ì</option>
        <option name="charting.chart.barSpacing">5</option>
        <option name="charting.seriesColors">[0x6DB7C6]</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">preview</option>
      </chart>
    </panel>
  </row>

  <!-- Row 2: ğŸ“¢ ì„¤ì • ë³€ê²½ ì´ë ¥ (Slack ì•Œë¦¼) -->
  <row>
    <panel>
      <title>ğŸ“¢ ì„¤ì • ë³€ê²½ ì´ë ¥ (í´ë¦­ â†’ Slack ì•Œë¦¼)</title>
      <table id="config_changes_table">
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100044547" OR logid="0100044546" OR logid="0100044545") earliest=$time_picker.earliest$ latest=$time_picker.latest$
| rex field=_raw "cfgpath=\"?(?&lt;cfg_path&gt;[^\"]+)\"?"
| rex field=_raw "cfgobj=\"?(?&lt;cfg_object&gt;[^\"]+)\"?"
| rex field=_raw "cfgattr=\"?(?&lt;cfg_attr&gt;[^\"]+)\"?"
| eval config_path = coalesce(cfgpath, cfg_path, "N/A")
| eval config_object = coalesce(cfgobj, cfg_object, "N/A")
| eval config_attr = coalesce(cfgattr, cfg_attr, "N/A")
| eval parsed_value = config_path + " / " + config_object + " [" + config_attr + "]"
| eval change_type = case(
    logid="0100044547", "ì‚­ì œ",
    logid="0100044546", "ìˆ˜ì •",
    logid="0100044545", "ì¶”ê°€",
    1=1, "ê¸°íƒ€"
  )
| eval path_category = case(
    match(config_path, "firewall\.policy"), "ë°©í™”ë²½ ì •ì±…",
    match(config_path, "vpn\.ipsec"), "IPSec VPN",
    match(config_path, "vpn\.ssl"), "SSL VPN",
    match(config_path, "system\.interface"), "ì¸í„°í˜ì´ìŠ¤",
    match(config_path, "router"), "ë¼ìš°íŒ…",
    match(config_path, "user"), "ì‚¬ìš©ì/ê·¸ë£¹",
    match(config_path, "firewall\.address"), "ì£¼ì†Œ ê°ì²´",
    match(config_path, "firewall\.service"), "ì„œë¹„ìŠ¤ ê°ì²´",
    1=1, "ê¸°íƒ€ ì„¤ì •"
  )
| eval access_method = coalesce(ui, "CLI")
| eval access_ip = coalesce(from_ip, remip, "N/A")
| dedup _time devname config_path config_object parsed_value
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| table timestamp, devname, user, change_type, path_category, config_object, parsed_value, access_method, access_ip
| sort - timestamp
| head 20</query>
        </search>
        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">20</option>
        <option name="refresh.display">preview</option>
        <drilldown>
          <set token="slack_device">$row.devname$</set>
          <set token="slack_user">$row.user$</set>
          <set token="slack_change_type">$row.change_type$</set>
          <set token="slack_category">$row.path_category$</set>
          <set token="slack_object">$row.config_object$</set>
          <set token="slack_value">$row.parsed_value$</set>
          <set token="slack_method">$row.access_method$</set>
          <set token="slack_ip">$row.access_ip$</set>
          <set token="slack_time">$row.timestamp$</set>
          <set token="trigger_config_alert">1</set>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Row 2.5: ğŸ“‹ Slack í”„ë¡ì‹œ ì„¤ì • ë„êµ¬ -->
  <row>
    <panel>
      <title>ğŸ“‹ Slack í”„ë¡ì‹œ ì„¤ì • ê°€ì´ë“œ</title>
      <html>
        <div style="padding: 15px; background-color: #f8f9fa; border-left: 4px solid #6DB7C6; margin: 10px 0;">
          <h3 style="color: #333; margin-top: 0;">ğŸ”§ Slack ì•Œë¦¼ ì„¤ì • ë°©ë²•</h3>
          <p style="color: #666; line-height: 1.6;">
            ì´ ëŒ€ì‹œë³´ë“œì—ì„œ í–‰ì„ í´ë¦­í•˜ë©´ Slack ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤. ì•„ë˜ ë‹¨ê³„ë¥¼ ë”°ë¼ í”„ë¡ì‹œ ì„œë²„ë¥¼ ì„¤ì •í•˜ì„¸ìš”.
          </p>

          <h4 style="color: #333; margin-top: 15px;">1ï¸âƒ£ Slack Webhook URL ìƒì„±</h4>
          <pre style="background: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: 4px; overflow-x: auto;">
# Slack ì›Œí¬ìŠ¤í˜ì´ìŠ¤
1. https://api.slack.com/apps â†’ Create New App
2. Incoming Webhooks â†’ Activate
3. Add New Webhook â†’ ì±„ë„ ì„ íƒ (#splunk-alerts)
4. Webhook URL ë³µì‚¬
   https://hooks.slack.com/services/T00000000/B00000000/XXXX</pre>

          <h4 style="color: #333; margin-top: 15px;">2ï¸âƒ£ Splunk Alert Action ìƒì„±</h4>
          <pre style="background: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: 4px; overflow-x: auto;">
# Splunk Web UI
Settings â†’ Searches, reports, and alerts â†’ Alert actions
â†’ Create Alert Action

Name: fortinet_slack
Type: Webhook
Webhook URL: http://YOUR_PROXY:3000/slack
Method: POST</pre>

          <h4 style="color: #333; margin-top: 15px;">3ï¸âƒ£ í”„ë¡ì‹œ ì„œë²„ ì‹¤í–‰ (ì„ íƒì‚¬í•­)</h4>
          <pre style="background: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: 4px; overflow-x: auto;">
# Node.js í”„ë¡ì‹œ
cd /home/jclee/app/splunk
export SLACK_WEBHOOK_URL="YOUR_WEBHOOK_URL"
node domains/integration/slack-webhook-handler.js

# Listening on http://localhost:3000/slack</pre>

          <h4 style="color: #333; margin-top: 15px;">4ï¸âƒ£ í…ŒìŠ¤íŠ¸</h4>
          <pre style="background: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: 4px; overflow-x: auto;">
# CLI í…ŒìŠ¤íŠ¸
node scripts/slack-alert-cli.js \
  --webhook="YOUR_WEBHOOK_URL" \
  --test</pre>

          <div style="margin-top: 15px; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px;">
            <strong style="color: #155724;">âœ… ì„¤ì • ì™„ë£Œ í›„:</strong>
            <p style="color: #155724; margin: 5px 0 0 0;">
              ìœ„ "ğŸ“¢ ì„¤ì • ë³€ê²½ ì´ë ¥" í…Œì´ë¸”ì—ì„œ í–‰ì„ í´ë¦­í•˜ë©´ Slackìœ¼ë¡œ ìë™ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.
            </p>
          </div>

          <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
            <strong style="color: #856404;">ğŸ“– ìƒì„¸ ê°€ì´ë“œ:</strong>
            <p style="color: #856404; margin: 5px 0 0 0;">
              PROXY_SLACK_SETUP_GUIDE.md íŒŒì¼ ì°¸ê³ 
            </p>
          </div>
        </div>
      </html>
    </panel>
  </row>

  <!-- Row 3: ğŸ“‹ Slack ì¿¼ë¦¬ ë³µì‚¬ ë„êµ¬ -->
  <row depends="$trigger_config_alert$">
    <panel>
      <title>ğŸ“‹ Slack ì „ì†¡ ì¿¼ë¦¬ (ì•„ë˜ ë‚´ìš© ë³µì‚¬í•˜ì—¬ í”„ë¡ì‹œ ì„¤ì •)</title>
      <html>
        <div style="padding: 15px; background-color: #fff3cd; border-left: 4px solid #ffc107; margin: 10px 0;">
          <h4 style="color: #856404; margin-top: 0;">ğŸš€ ì´ ì¿¼ë¦¬ë¥¼ í”„ë¡ì‹œ ì„œë²„ì—ì„œ ì‚¬ìš©í•˜ì„¸ìš”</h4>
          <p style="color: #856404;">ì•„ë˜ ì¿¼ë¦¬ë¥¼ ë³µì‚¬í•˜ì—¬ Slack Webhook í”„ë¡ì‹œ ì„¤ì •ì— í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
      </html>
      <table>
        <search>
          <query>| makeresults
| eval alert_type="ì„¤ì •ë³€ê²½"
| eval device="$slack_device$"
| eval user="$slack_user$"
| eval change_type="$slack_change_type$"
| eval category="$slack_category$"
| eval object_name="$slack_object$"
| eval value="$slack_value$"
| eval access_method="$slack_method$"
| eval access_ip="$slack_ip$"
| eval timestamp="$slack_time$"
| eval severity=if(change_type="ì‚­ì œ", "high", "medium")
| eval slack_message="*[ì„¤ì •ë³€ê²½]* " + category + "\n"
    + "â”â”â”â”â”â”â”â”â”\n"
    + "ğŸ–¥ï¸ ì¥ë¹„: `" + device + "`\n"
    + "ğŸ”„ ë³€ê²½ìœ í˜•: *" + change_type + "*\n"
    + "ğŸ“‹ ëŒ€ìƒ: `" + object_name + "`\n"
    + "ğŸ”— ê²½ë¡œ: `" + value + "`\n"
    + "ğŸ‘¤ ê´€ë¦¬ì: " + user + "\n"
    + "ğŸŒ ì ‘ì†IP: " + access_ip + "\n"
    + "ğŸ”Œ ì ‘ì†ë°©ë²•: " + access_method + "\n"
    + "ğŸ•’ ì‹œê°„: " + timestamp + "\n"
    + "âš ï¸ ì‹¬ê°ë„: *" + severity + "*"
| eval webhook_payload="{\"text\": \"" + slack_message + "\"}"
| eval curl_command="curl -X POST YOUR_WEBHOOK_URL -H 'Content-Type: application/json' -d '" + webhook_payload + "'"
| table alert_type, device, user, change_type, category, object_name, severity, slack_message, webhook_payload, curl_command</query>
          <done>
            <unset token="trigger_config_alert"></unset>
            <unset token="slack_device"></unset>
            <unset token="slack_user"></unset>
            <unset token="slack_change_type"></unset>
            <unset token="slack_category"></unset>
            <unset token="slack_object"></unset>
            <unset token="slack_value"></unset>
            <unset token="slack_method"></unset>
            <unset token="slack_ip"></unset>
            <unset token="slack_time"></unset>
          </done>
        </search>
        <option name="drilldown">none</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
      </table>
    </panel>
  </row>

  <!-- Row 3: ğŸ“¢ ë°©í™”ë²½ ì •ì±… ë³€ê²½ (Slack ì•Œë¦¼) -->
  <row>
    <panel>
      <title>ğŸ›¡ï¸ ë°©í™”ë²½ ì •ì±… ë³€ê²½ (í´ë¦­ â†’ Slack ì•Œë¦¼)</title>
      <table id="policy_changes_table">
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100044547" OR logid="0100044546" OR logid="0100044545") earliest=$time_picker.earliest$ latest=$time_picker.latest$
| rex field=_raw "cfgpath=\"?(?&lt;cfg_path&gt;[^\"]+)\"?"
| search cfg_path="firewall.policy*"
| rex field=_raw "cfgobj=\"?(?&lt;policy_name&gt;[^\"]+)\"?"
| rex field=_raw "cfgattr=\"?(?&lt;cfg_attr&gt;[^\"]+)\"?"
| eval change_type = case(
    logid="0100044547", "ì‚­ì œ",
    logid="0100044546", "ìˆ˜ì •",
    logid="0100044545", "ì¶”ê°€",
    1=1, "ê¸°íƒ€"
  )
| eval change_detail = cfg_path + " [" + cfg_attr + "]"
| dedup _time devname policy_name change_detail
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| table timestamp, devname, user, change_type, policy_name, change_detail
| sort - timestamp
| head 20</query>
        </search>
        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">20</option>
        <option name="refresh.display">preview</option>
        <drilldown>
          <set token="policy_device">$row.devname$</set>
          <set token="policy_user">$row.user$</set>
          <set token="policy_change_type">$row.change_type$</set>
          <set token="policy_name">$row.policy_name$</set>
          <set token="policy_detail">$row.change_detail$</set>
          <set token="policy_time">$row.timestamp$</set>
          <set token="trigger_policy_alert">1</set>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Hidden Panel: Policy Change Alert -->
  <row depends="$trigger_policy_alert$">
    <panel>
      <title>Policy Change Alert Trigger</title>
      <table>
        <search>
          <query>| makeresults
| eval alert_type="ë°©í™”ë²½ì •ì±…ë³€ê²½"
| eval device="$policy_device$"
| eval user="$policy_user$"
| eval change_type="$policy_change_type$"
| eval policy_name="$policy_name$"
| eval detail="$policy_detail$"
| eval timestamp="$policy_time$"
| eval severity="high"
| eval message="*[ë°©í™”ë²½ì •ì±…ë³€ê²½]*\n"
    + "â”â”â”â”â”â”â”â”â”\n"
    + "ğŸ–¥ï¸ ì¥ë¹„: `" + device + "`\n"
    + "ğŸ“‹ ì •ì±…ëª…: `" + policy_name + "`\n"
    + "ğŸ”„ ë³€ê²½ìœ í˜•: *" + change_type + "*\n"
    + "ğŸ”— ê²½ë¡œ: `" + detail + "`\n"
    + "ğŸ‘¤ ê´€ë¦¬ì: " + user + "\n"
    + "ğŸ•’ ì‹œê°„: " + timestamp + "\n"
    + "âš ï¸ ì‹¬ê°ë„: *" + severity + "*"
| sendalert fortinet_slack param.message="$result.message$" param.severity="$result.severity$" param.device="$result.device$" param.user="$result.user$" param.change_type="$result.change_type$" param.policy_name="$result.policy_name$" param.detail="$result.detail$" param.timestamp="$result.timestamp$"</query>
          <done>
            <unset token="trigger_policy_alert"></unset>
            <unset token="policy_device"></unset>
            <unset token="policy_user"></unset>
            <unset token="policy_change_type"></unset>
            <unset token="policy_name"></unset>
            <unset token="policy_detail"></unset>
            <unset token="policy_time"></unset>
          </done>
        </search>
      </table>
    </panel>
  </row>

  <!-- Row 4: ì‹œìŠ¤í…œ ì¸í„°í˜ì´ìŠ¤ ë³€ê²½ -->
  <row>
    <panel>
      <title>ğŸ”Œ ì‹œìŠ¤í…œ ì¸í„°í˜ì´ìŠ¤ ë³€ê²½</title>
      <table>
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100044547" OR logid="0100044546" OR logid="0100044545") earliest=$time_picker.earliest$ latest=$time_picker.latest$
| rex field=_raw "cfgpath=\"?(?&lt;cfg_path&gt;[^\"]+)\"?"
| search cfg_path="system.interface*"
| rex field=_raw "cfgobj=\"?(?&lt;interface_name&gt;[^\"]+)\"?"
| rex field=_raw "cfgattr=\"?(?&lt;cfg_attr&gt;[^\"]+)\"?"
| eval change_type = case(
    logid="0100044547", "ì‚­ì œ",
    logid="0100044546", "ìˆ˜ì •",
    logid="0100044545", "ì¶”ê°€",
    1=1, "ê¸°íƒ€"
  )
| dedup _time devname interface_name cfg_attr
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| table timestamp, devname, user, change_type, interface_name, cfg_attr
| sort - timestamp
| head 15</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">15</option>
        <option name="refresh.display">preview</option>
      </table>
    </panel>
  </row>

  <!-- Row 5: ê´€ë¦¬ì í™œë™ -->
  <row>
    <panel>
      <title>ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ</title>
      <table>
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100032001" OR logid="0100032003") earliest=$time_picker.earliest$ latest=$time_picker.latest$
| eval login_status = case(
    logid="0100032001", "ë¡œê·¸ì¸",
    logid="0100032003", "ë¡œê·¸ì•„ì›ƒ",
    1=1, "ê¸°íƒ€"
  )
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval source_ip = coalesce(from_ip, remip, "N/A")
| table timestamp, devname, user, login_status, source_ip, ui
| sort - timestamp
| head 20</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">20</option>
        <option name="refresh.display">preview</option>
      </table>
    </panel>
    <panel>
      <title>ğŸ“Š ê´€ë¦¬ìë³„ ì„¤ì • ë³€ê²½ í†µê³„</title>
      <table>
        <search>
          <query>index=fw devname=$device_filter$ (logid="0100044547" OR logid="0100044546" OR logid="0100044545") earliest=$time_picker.earliest$ latest=$time_picker.latest$
| stats count by user, devname
| sort - count
| head 10</query>
        </search>
        <option name="drilldown">none</option>
        <option name="rowNumbers">false</option>
        <option name="wrap">true</option>
        <option name="dataOverlayMode">heatmap</option>
        <option name="count">10</option>
        <option name="refresh.display">preview</option>
      </table>
    </panel>
  </row>

  <!-- Row 6: ğŸ“¢ Critical ì´ë²¤íŠ¸ (Slack ì•Œë¦¼) -->
  <row>
    <panel>
      <title>ğŸš¨ Critical ì´ë²¤íŠ¸ (í´ë¦­ â†’ Slack ì•Œë¦¼)</title>
      <table id="critical_events_table">
        <search>
          <query>index=fw devname=$device_filter$ (level=critical OR level=alert OR level=emergency) earliest=$time_picker.earliest$ latest=$time_picker.latest$
| search NOT msg="*Update Fail*"
| eval event_category = case(
    match(msg, "(?i)(fail|error|down)"), "ì‹œìŠ¤í…œ ì˜¤ë¥˜",
    match(msg, "(?i)(attack|intrusion|malware)"), "ë³´ì•ˆ ìœ„í˜‘",
    match(msg, "(?i)(cpu|memory|disk)"), "ë¦¬ì†ŒìŠ¤",
    match(msg, "(?i)(ha|failover|backup)"), "HA ì´ë²¤íŠ¸",
    match(msg, "(?i)(hardware|sensor)"), "í•˜ë“œì›¨ì–´",
    1=1, "ê¸°íƒ€ Critical"
  )
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| dedup _time devname msg
| table timestamp, devname, level, event_category, type, msg
| sort - timestamp
| head 20</query>
        </search>
        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
        <option name="wrap">true</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">20</option>
        <option name="refresh.display">preview</option>
        <drilldown>
          <set token="critical_device">$row.devname$</set>
          <set token="critical_level">$row.level$</set>
          <set token="critical_category">$row.event_category$</set>
          <set token="critical_type">$row.type$</set>
          <set token="critical_msg">$row.msg$</set>
          <set token="critical_time">$row.timestamp$</set>
          <set token="trigger_critical_alert">1</set>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Hidden Panel: Critical Event Alert -->
  <row depends="$trigger_critical_alert$">
    <panel>
      <title>Critical Event Alert Trigger</title>
      <table>
        <search>
          <query>| makeresults
| eval alert_type="CRITICAL"
| eval device="$critical_device$"
| eval severity_level="$critical_level$"
| eval category="$critical_category$"
| eval event_type="$critical_type$"
| eval message_text="$critical_msg$"
| eval timestamp="$critical_time$"
| eval severity="critical"
| eval message="ğŸš¨ *[CRITICAL ì´ë²¤íŠ¸]*\n"
    + "â”â”â”â”â”â”â”â”â”\n"
    + "ğŸ–¥ï¸ ì¥ë¹„: `" + device + "`\n"
    + "ğŸ”´ ë ˆë²¨: *" + severity_level + "*\n"
    + "ğŸ“‹ ì¹´í…Œê³ ë¦¬: " + category + "\n"
    + "ğŸ”” ì´ë²¤íŠ¸íƒ€ì…: " + event_type + "\n"
    + "ğŸ’¬ ë©”ì‹œì§€: ```" + message_text + "```\n"
    + "ğŸ•’ ì‹œê°„: " + timestamp + "\n"
    + "âš ï¸ ì‹¬ê°ë„: *" + severity + "*"
| sendalert fortinet_slack param.message="$result.message$" param.severity="$result.severity$" param.device="$result.device$" param.severity_level="$result.severity_level$" param.category="$result.category$" param.event_type="$result.event_type$" param.message_text="$result.message_text$" param.timestamp="$result.timestamp$"</query>
          <done>
            <unset token="trigger_critical_alert"></unset>
            <unset token="critical_device"></unset>
            <unset token="critical_level"></unset>
            <unset token="critical_category"></unset>
            <unset token="critical_type"></unset>
            <unset token="critical_msg"></unset>
            <unset token="critical_time"></unset>
          </done>
        </search>
      </table>
    </panel>
  </row>

  <!-- Row 7: ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ -->
  <row>
    <panel>
      <title>ğŸ“¡ ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ (ìµœê·¼ 15ë¶„, 30ì´ˆ ìë™ ìƒˆë¡œê³ ì¹¨)</title>
      <event>
        <search>
          <query>index=fw devname=$device_filter$ earliest=-15m
| sort - _time
| head 100</query>
          <refresh>30s</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">15</option>
        <option name="list.drilldown">none</option>
        <option name="maxLines">3</option>
        <option name="raw.drilldown">none</option>
        <option name="rowNumbers">true</option>
        <option name="type">list</option>
        <option name="segmentation">full</option>
      </event>
    </panel>
  </row>
</form>
