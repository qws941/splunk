<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ›¡ï¸ Fortinet ë°©í™”ë²½ ì •ì±… í™•ì¸</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #ffffff;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .verification-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .form-section {
      background: rgba(255, 255, 255, 0.05);
      padding: 25px;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .form-section h3 {
      margin-bottom: 20px;
      color: #4fc3f7;
      font-size: 1.3rem;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #e3f2fd;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 0 2px #4fc3f7;
    }

    .form-group input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .verify-button {
      grid-column: span 2;
      text-align: center;
      margin-top: 20px;
    }

    .btn {
      padding: 15px 40px;
      background: linear-gradient(45deg, #4fc3f7, #29b6f6);
      border: none;
      border-radius: 50px;
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(79, 195, 247, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .results-section {
      margin-top: 40px;
      display: none;
    }

    .result-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 25px;
      border-left: 5px solid;
    }

    .result-card.allow {
      border-left-color: #4caf50;
    }

    .result-card.block {
      border-left-color: #f44336;
    }

    .result-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .result-icon {
      font-size: 2rem;
      margin-right: 15px;
    }

    .result-icon.allow {
      color: #4caf50;
    }

    .result-icon.block {
      color: #f44336;
    }

    .result-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .result-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .detail-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 10px;
    }

    .detail-label {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 5px;
    }

    .detail-value {
      font-size: 1.1rem;
      font-weight: 500;
    }

    .loading {
      display: none;
      text-align: center;
      margin: 20px 0;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left: 4px solid #4fc3f7;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      background: rgba(244, 67, 54, 0.1);
      border: 1px solid #f44336;
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      color: #ffcdd2;
      display: none;
    }

    .advanced-options {
      margin-top: 20px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      border: 1px dashed rgba(255, 255, 255, 0.1);
    }

    .advanced-toggle {
      background: none;
      border: none;
      color: #4fc3f7;
      cursor: pointer;
      font-size: 0.9rem;
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .verification-form {
        grid-template-columns: 1fr;
      }

      .verify-button {
        grid-column: span 1;
      }

      .result-details {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ›¡ï¸ Fortinet ë°©í™”ë²½ ì •ì±… í™•ì¸</h1>
      <p>ì¶œë°œì§€ â†’ ëª©ì ì§€ íŠ¸ë˜í”½ì— ëŒ€í•œ ì •ì±… ì ìš© ê²°ê³¼ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤</p>
    </div>

    <form class="verification-form" id="verificationForm">
      <div class="form-section">
        <h3>ğŸŒ ë„¤íŠ¸ì›Œí¬ ì •ë³´</h3>
        <div class="form-group">
          <label for="sourceIP">ì¶œë°œì§€ IP ì£¼ì†Œ</label>
          <input type="text" id="sourceIP" name="sourceIP" placeholder="ì˜ˆ: 192.168.1.100" required>
        </div>
        <div class="form-group">
          <label for="destIP">ëª©ì ì§€ IP ì£¼ì†Œ</label>
          <input type="text" id="destIP" name="destIP" placeholder="ì˜ˆ: 10.0.0.100" required>
        </div>
      </div>

      <div class="form-section">
        <h3>ğŸ”Œ ì„œë¹„ìŠ¤ ì •ë³´</h3>
        <div class="form-group">
          <label for="protocol">í”„ë¡œí† ì½œ</label>
          <select id="protocol" name="protocol">
            <option value="TCP">TCP</option>
            <option value="UDP">UDP</option>
            <option value="ICMP">ICMP</option>
            <option value="any">Any</option>
          </select>
        </div>
        <div class="form-group">
          <label for="port">í¬íŠ¸ ë²ˆí˜¸</label>
          <input type="number" id="port" name="port" placeholder="ì˜ˆ: 80, 443, 22" value="80" min="1" max="65535">
        </div>
      </div>

      <div class="form-section">
        <h3>ğŸ–¥ï¸ ì¥ë¹„ ì„ íƒ</h3>
        <div class="form-group">
          <label for="device">FortiGate ì¥ë¹„</label>
          <select id="device" name="device">
            <option value="">ì „ì²´ ì¥ë¹„</option>
          </select>
        </div>
        <div class="form-group">
          <label for="vdom">Virtual Domain</label>
          <select id="vdom" name="vdom">
            <option value="root">Root</option>
          </select>
        </div>
      </div>

      <div class="form-section">
        <h3>âš™ï¸ ê³ ê¸‰ ì˜µì…˜</h3>
        <button type="button" class="advanced-toggle" onclick="toggleAdvanced()">
          ê³ ê¸‰ ì˜µì…˜ í‘œì‹œ â–¼
        </button>
        <div class="advanced-options" id="advancedOptions" style="display: none;">
          <div class="form-group">
            <label for="service">ì„œë¹„ìŠ¤ ê°ì²´</label>
            <input type="text" id="service" name="service" placeholder="ì˜ˆ: HTTP, HTTPS, ALL">
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="showAllPolicies" name="showAllPolicies">
              ëª¨ë“  ë§¤ì¹­ ì •ì±… í‘œì‹œ (ì²« ë²ˆì§¸ ë§¤ì¹­ë§Œì´ ì•„ë‹Œ)
            </label>
          </div>
        </div>
      </div>

      <div class="verify-button">
        <button type="submit" class="btn" id="verifyBtn">
          ğŸ” ì •ì±… í™•ì¸
        </button>
      </div>
    </form>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>ì •ì±…ì„ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
    </div>

    <div class="error-message" id="errorMessage">
      <strong>ì˜¤ë¥˜ ë°œìƒ:</strong> <span id="errorText"></span>
    </div>

    <div class="results-section" id="resultsSection">
      <div class="result-card" id="resultCard">
        <div class="result-header">
          <span class="result-icon" id="resultIcon">ğŸ›¡ï¸</span>
          <div>
            <div class="result-title" id="resultTitle">ì •ì±… í™•ì¸ ê²°ê³¼</div>
            <div id="resultSummary">íŠ¸ë˜í”½ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤</div>
          </div>
        </div>

        <div class="result-details" id="resultDetails">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let devices = [];

    // Initialize page
    document.addEventListener('DOMContentLoaded', async () => {
      await loadDevices();
    });

    // Load managed devices
    async function loadDevices() {
      try {
        const response = await fetch('/api/fortimanager/devices');
        if (response.ok) {
          devices = await response.json();
          populateDeviceSelect();
        }
      } catch (error) {
        console.log('ì¥ë¹„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error);
      }
    }

    // Populate device select
    function populateDeviceSelect() {
      const deviceSelect = document.getElementById('device');
      const vdomSelect = document.getElementById('vdom');

      // Clear existing options (except "ì „ì²´ ì¥ë¹„")
      deviceSelect.innerHTML = '<option value="">ì „ì²´ ì¥ë¹„</option>';

      devices.forEach(device => {
        const option = document.createElement('option');
        option.value = device.name;
        option.textContent = `${device.name} (${device.ip})`;
        if (device.status !== 'up') {
          option.textContent += ' - ì—°ê²° ì•ˆë¨';
          option.disabled = true;
        }
        deviceSelect.appendChild(option);
      });

      // Update VDOM options when device changes
      deviceSelect.addEventListener('change', () => {
        const selectedDevice = devices.find(d => d.name === deviceSelect.value);
        vdomSelect.innerHTML = '<option value="root">Root</option>';

        if (selectedDevice && selectedDevice.vdoms) {
          selectedDevice.vdoms.forEach(vdom => {
            if (vdom !== 'root') {
              const option = document.createElement('option');
              option.value = vdom;
              option.textContent = vdom;
              vdomSelect.appendChild(option);
            }
          });
        }
      });
    }

    // Toggle advanced options
    function toggleAdvanced() {
      const options = document.getElementById('advancedOptions');
      const toggle = document.querySelector('.advanced-toggle');

      if (options.style.display === 'none') {
        options.style.display = 'block';
        toggle.innerHTML = 'ê³ ê¸‰ ì˜µì…˜ ìˆ¨ê¸°ê¸° â–²';
      } else {
        options.style.display = 'none';
        toggle.innerHTML = 'ê³ ê¸‰ ì˜µì…˜ í‘œì‹œ â–¼';
      }
    }

    // Form submission
    document.getElementById('verificationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await verifyPolicy();
    });

    // Verify policy
    async function verifyPolicy() {
      const form = document.getElementById('verificationForm');
      const formData = new FormData(form);
      const loading = document.getElementById('loading');
      const results = document.getElementById('resultsSection');
      const error = document.getElementById('errorMessage');
      const btn = document.getElementById('verifyBtn');

      // Reset UI
      loading.style.display = 'block';
      results.style.display = 'none';
      error.style.display = 'none';
      btn.disabled = true;

      try {
        const requestData = {
          sourceIP: formData.get('sourceIP'),
          destIP: formData.get('destIP'),
          protocol: formData.get('protocol'),
          port: parseInt(formData.get('port')) || 80,
          service: formData.get('service') || 'any',
          device: formData.get('device') || null,
          vdom: formData.get('vdom') || 'root',
          showAllPolicies: formData.get('showAllPolicies') === 'on'
        };

        console.log('Sending policy verification request:', requestData);

        const response = await fetch('/api/policy/verify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });

        if (!response.ok) {
          throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
        }

        const result = await response.json();
        displayResult(result, requestData);

      } catch (err) {
        console.error('Policy verification failed:', err);
        showError(err.message);
      } finally {
        loading.style.display = 'none';
        btn.disabled = false;
      }
    }

    // Display verification result
    function displayResult(result, request) {
      const results = document.getElementById('resultsSection');
      const resultCard = document.getElementById('resultCard');
      const resultIcon = document.getElementById('resultIcon');
      const resultTitle = document.getElementById('resultTitle');
      const resultSummary = document.getElementById('resultSummary');
      const resultDetails = document.getElementById('resultDetails');

      // Set result status
      const isAllowed = result.result === 'ALLOW';
      resultCard.className = `result-card ${isAllowed ? 'allow' : 'block'}`;
      resultIcon.className = `result-icon ${isAllowed ? 'allow' : 'block'}`;
      resultIcon.textContent = isAllowed ? 'âœ…' : 'âŒ';

      // Set title and summary
      resultTitle.textContent = `${result.result} - ${isAllowed ? 'í—ˆìš©ë¨' : 'ì°¨ë‹¨ë¨'}`;
      resultSummary.textContent = result.matches
        ? `ì •ì±… ID ${result.policy.id}ì— ì˜í•´ ${isAllowed ? 'í—ˆìš©' : 'ì°¨ë‹¨'}ë©ë‹ˆë‹¤`
        : 'ë§¤ì¹­ë˜ëŠ” ì •ì±…ì´ ì—†ì–´ ê¸°ë³¸ì ìœ¼ë¡œ ì°¨ë‹¨ë©ë‹ˆë‹¤';

      // Build details
      let detailsHTML = `
        <div class="detail-item">
          <div class="detail-label">íŠ¸ë˜í”½ íë¦„</div>
          <div class="detail-value">${request.sourceIP} â†’ ${request.destIP}:${request.port}/${request.protocol}</div>
        </div>
      `;

      if (result.matches && result.policy) {
        detailsHTML += `
          <div class="detail-item">
            <div class="detail-label">ì •ì±… ì´ë¦„</div>
            <div class="detail-value">${result.policy.name}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">ì •ì±… ID</div>
            <div class="detail-value">${result.policy.id}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">ë™ì‘</div>
            <div class="detail-value">${result.policy.action}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">ì¶œë°œì§€ ì£¼ì†Œ</div>
            <div class="detail-value">${Array.isArray(result.policy.srcaddr) ? result.policy.srcaddr.join(', ') : result.policy.srcaddr}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">ëª©ì ì§€ ì£¼ì†Œ</div>
            <div class="detail-value">${Array.isArray(result.policy.dstaddr) ? result.policy.dstaddr.join(', ') : result.policy.dstaddr}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">ì„œë¹„ìŠ¤</div>
            <div class="detail-value">${Array.isArray(result.policy.service) ? result.policy.service.join(', ') : result.policy.service}</div>
          </div>
        `;

        if (result.policy.device) {
          detailsHTML += `
            <div class="detail-item">
              <div class="detail-label">ì¥ë¹„</div>
              <div class="detail-value">${result.policy.device}</div>
            </div>
          `;
        }

        if (result.policy.vdom) {
          detailsHTML += `
            <div class="detail-item">
              <div class="detail-label">VDOM</div>
              <div class="detail-value">${result.policy.vdom}</div>
            </div>
          `;
        }

        if (result.policy.comments) {
          detailsHTML += `
            <div class="detail-item">
              <div class="detail-label">ì„¤ëª…</div>
              <div class="detail-value">${result.policy.comments}</div>
            </div>
          `;
        }

        if (result.policy.logtraffic) {
          detailsHTML += `
            <div class="detail-item">
              <div class="detail-label">ë¡œê·¸ ê¸°ë¡</div>
              <div class="detail-value">${result.policy.logtraffic}</div>
            </div>
          `;
        }
      } else {
        detailsHTML += `
          <div class="detail-item">
            <div class="detail-label">ì´ìœ </div>
            <div class="detail-value">${result.evaluation.reason || 'ë§¤ì¹­ë˜ëŠ” ì •ì±… ì—†ìŒ'}</div>
          </div>
        `;
      }

      resultDetails.innerHTML = detailsHTML;
      results.style.display = 'block';
    }

    // Show error message
    function showError(message) {
      const error = document.getElementById('errorMessage');
      const errorText = document.getElementById('errorText');
      errorText.textContent = message;
      error.style.display = 'block';
    }

    // Input validation
    function validateIP(ip) {
      const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
      return ipRegex.test(ip);
    }

    // Real-time validation
    document.getElementById('sourceIP').addEventListener('blur', function() {
      if (this.value && !validateIP(this.value)) {
        this.style.borderColor = '#f44336';
        showError('ì˜¬ë°”ë¥¸ IP ì£¼ì†Œ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤');
      } else {
        this.style.borderColor = '';
        document.getElementById('errorMessage').style.display = 'none';
      }
    });

    document.getElementById('destIP').addEventListener('blur', function() {
      if (this.value && !validateIP(this.value)) {
        this.style.borderColor = '#f44336';
        showError('ì˜¬ë°”ë¥¸ IP ì£¼ì†Œ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤');
      } else {
        this.style.borderColor = '';
        document.getElementById('errorMessage').style.display = 'none';
      }
    });
  </script>
</body>
</html>