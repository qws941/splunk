<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🛡️ Fortinet 방화벽 정책 확인</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #ffffff;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .verification-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .form-section {
      background: rgba(255, 255, 255, 0.05);
      padding: 25px;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .form-section h3 {
      margin-bottom: 20px;
      color: #4fc3f7;
      font-size: 1.3rem;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #e3f2fd;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 0 2px #4fc3f7;
    }

    .form-group input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .verify-button {
      grid-column: span 2;
      text-align: center;
      margin-top: 20px;
    }

    .btn {
      padding: 15px 40px;
      background: linear-gradient(45deg, #4fc3f7, #29b6f6);
      border: none;
      border-radius: 50px;
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(79, 195, 247, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .results-section {
      margin-top: 40px;
      display: none;
    }

    .result-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 25px;
      border-left: 5px solid;
    }

    .result-card.allow {
      border-left-color: #4caf50;
    }

    .result-card.block {
      border-left-color: #f44336;
    }

    .result-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .result-icon {
      font-size: 2rem;
      margin-right: 15px;
    }

    .result-icon.allow {
      color: #4caf50;
    }

    .result-icon.block {
      color: #f44336;
    }

    .result-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .result-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .detail-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 10px;
    }

    .detail-label {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 5px;
    }

    .detail-value {
      font-size: 1.1rem;
      font-weight: 500;
    }

    .loading {
      display: none;
      text-align: center;
      margin: 20px 0;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left: 4px solid #4fc3f7;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      background: rgba(244, 67, 54, 0.1);
      border: 1px solid #f44336;
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      color: #ffcdd2;
      display: none;
    }

    .advanced-options {
      margin-top: 20px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      border: 1px dashed rgba(255, 255, 255, 0.1);
    }

    .advanced-toggle {
      background: none;
      border: none;
      color: #4fc3f7;
      cursor: pointer;
      font-size: 0.9rem;
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .verification-form {
        grid-template-columns: 1fr;
      }

      .verify-button {
        grid-column: span 1;
      }

      .result-details {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🛡️ Fortinet 방화벽 정책 확인</h1>
      <p>출발지 → 목적지 트래픽에 대한 정책 적용 결과를 실시간으로 확인합니다</p>
    </div>

    <form class="verification-form" id="verificationForm">
      <div class="form-section">
        <h3>🌐 네트워크 정보</h3>
        <div class="form-group">
          <label for="sourceIP">출발지 IP 주소</label>
          <input type="text" id="sourceIP" name="sourceIP" placeholder="예: 192.168.1.100" required>
        </div>
        <div class="form-group">
          <label for="destIP">목적지 IP 주소</label>
          <input type="text" id="destIP" name="destIP" placeholder="예: 10.0.0.100" required>
        </div>
      </div>

      <div class="form-section">
        <h3>🔌 서비스 정보</h3>
        <div class="form-group">
          <label for="protocol">프로토콜</label>
          <select id="protocol" name="protocol">
            <option value="TCP">TCP</option>
            <option value="UDP">UDP</option>
            <option value="ICMP">ICMP</option>
            <option value="any">Any</option>
          </select>
        </div>
        <div class="form-group">
          <label for="port">포트 번호</label>
          <input type="number" id="port" name="port" placeholder="예: 80, 443, 22" value="80" min="1" max="65535">
        </div>
      </div>

      <div class="form-section">
        <h3>🖥️ 장비 선택</h3>
        <div class="form-group">
          <label for="device">FortiGate 장비</label>
          <select id="device" name="device">
            <option value="">전체 장비</option>
          </select>
        </div>
        <div class="form-group">
          <label for="vdom">Virtual Domain</label>
          <select id="vdom" name="vdom">
            <option value="root">Root</option>
          </select>
        </div>
      </div>

      <div class="form-section">
        <h3>⚙️ 고급 옵션</h3>
        <button type="button" class="advanced-toggle" onclick="toggleAdvanced()">
          고급 옵션 표시 ▼
        </button>
        <div class="advanced-options" id="advancedOptions" style="display: none;">
          <div class="form-group">
            <label for="service">서비스 객체</label>
            <input type="text" id="service" name="service" placeholder="예: HTTP, HTTPS, ALL">
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="showAllPolicies" name="showAllPolicies">
              모든 매칭 정책 표시 (첫 번째 매칭만이 아닌)
            </label>
          </div>
        </div>
      </div>

      <div class="verify-button">
        <button type="submit" class="btn" id="verifyBtn">
          🔍 정책 확인
        </button>
      </div>
    </form>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>정책을 확인하고 있습니다...</p>
    </div>

    <div class="error-message" id="errorMessage">
      <strong>오류 발생:</strong> <span id="errorText"></span>
    </div>

    <div class="results-section" id="resultsSection">
      <div class="result-card" id="resultCard">
        <div class="result-header">
          <span class="result-icon" id="resultIcon">🛡️</span>
          <div>
            <div class="result-title" id="resultTitle">정책 확인 결과</div>
            <div id="resultSummary">트래픽 분석 결과입니다</div>
          </div>
        </div>

        <div class="result-details" id="resultDetails">
          <!-- 동적으로 생성됨 -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let devices = [];

    // Initialize page
    document.addEventListener('DOMContentLoaded', async () => {
      await loadDevices();
    });

    // Load managed devices
    async function loadDevices() {
      try {
        const response = await fetch('/api/fortimanager/devices');
        if (response.ok) {
          devices = await response.json();
          populateDeviceSelect();
        }
      } catch (error) {
        console.log('장비 목록을 불러올 수 없습니다:', error);
      }
    }

    // Populate device select
    function populateDeviceSelect() {
      const deviceSelect = document.getElementById('device');
      const vdomSelect = document.getElementById('vdom');

      // Clear existing options (except "전체 장비")
      deviceSelect.innerHTML = '<option value="">전체 장비</option>';

      devices.forEach(device => {
        const option = document.createElement('option');
        option.value = device.name;
        option.textContent = `${device.name} (${device.ip})`;
        if (device.status !== 'up') {
          option.textContent += ' - 연결 안됨';
          option.disabled = true;
        }
        deviceSelect.appendChild(option);
      });

      // Update VDOM options when device changes
      deviceSelect.addEventListener('change', () => {
        const selectedDevice = devices.find(d => d.name === deviceSelect.value);
        vdomSelect.innerHTML = '<option value="root">Root</option>';

        if (selectedDevice && selectedDevice.vdoms) {
          selectedDevice.vdoms.forEach(vdom => {
            if (vdom !== 'root') {
              const option = document.createElement('option');
              option.value = vdom;
              option.textContent = vdom;
              vdomSelect.appendChild(option);
            }
          });
        }
      });
    }

    // Toggle advanced options
    function toggleAdvanced() {
      const options = document.getElementById('advancedOptions');
      const toggle = document.querySelector('.advanced-toggle');

      if (options.style.display === 'none') {
        options.style.display = 'block';
        toggle.innerHTML = '고급 옵션 숨기기 ▲';
      } else {
        options.style.display = 'none';
        toggle.innerHTML = '고급 옵션 표시 ▼';
      }
    }

    // Form submission
    document.getElementById('verificationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await verifyPolicy();
    });

    // Verify policy
    async function verifyPolicy() {
      const form = document.getElementById('verificationForm');
      const formData = new FormData(form);
      const loading = document.getElementById('loading');
      const results = document.getElementById('resultsSection');
      const error = document.getElementById('errorMessage');
      const btn = document.getElementById('verifyBtn');

      // Reset UI
      loading.style.display = 'block';
      results.style.display = 'none';
      error.style.display = 'none';
      btn.disabled = true;

      try {
        const requestData = {
          sourceIP: formData.get('sourceIP'),
          destIP: formData.get('destIP'),
          protocol: formData.get('protocol'),
          port: parseInt(formData.get('port')) || 80,
          service: formData.get('service') || 'any',
          device: formData.get('device') || null,
          vdom: formData.get('vdom') || 'root',
          showAllPolicies: formData.get('showAllPolicies') === 'on'
        };

        console.log('Sending policy verification request:', requestData);

        const response = await fetch('/api/policy/verify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });

        if (!response.ok) {
          throw new Error(`서버 오류: ${response.status}`);
        }

        const result = await response.json();
        displayResult(result, requestData);

      } catch (err) {
        console.error('Policy verification failed:', err);
        showError(err.message);
      } finally {
        loading.style.display = 'none';
        btn.disabled = false;
      }
    }

    // Display verification result
    function displayResult(result, request) {
      const results = document.getElementById('resultsSection');
      const resultCard = document.getElementById('resultCard');
      const resultIcon = document.getElementById('resultIcon');
      const resultTitle = document.getElementById('resultTitle');
      const resultSummary = document.getElementById('resultSummary');
      const resultDetails = document.getElementById('resultDetails');

      // Set result status
      const isAllowed = result.result === 'ALLOW';
      resultCard.className = `result-card ${isAllowed ? 'allow' : 'block'}`;
      resultIcon.className = `result-icon ${isAllowed ? 'allow' : 'block'}`;
      resultIcon.textContent = isAllowed ? '✅' : '❌';

      // Set title and summary
      resultTitle.textContent = `${result.result} - ${isAllowed ? '허용됨' : '차단됨'}`;
      resultSummary.textContent = result.matches
        ? `정책 ID ${result.policy.id}에 의해 ${isAllowed ? '허용' : '차단'}됩니다`
        : '매칭되는 정책이 없어 기본적으로 차단됩니다';

      // Build details
      let detailsHTML = `
        <div class="detail-item">
          <div class="detail-label">트래픽 흐름</div>
          <div class="detail-value">${request.sourceIP} → ${request.destIP}:${request.port}/${request.protocol}</div>
        </div>
      `;

      if (result.matches && result.policy) {
        detailsHTML += `
          <div class="detail-item">
            <div class="detail-label">정책 이름</div>
            <div class="detail-value">${result.policy.name}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">정책 ID</div>
            <div class="detail-value">${result.policy.id}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">동작</div>
            <div class="detail-value">${result.policy.action}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">출발지 주소</div>
            <div class="detail-value">${Array.isArray(result.policy.srcaddr) ? result.policy.srcaddr.join(', ') : result.policy.srcaddr}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">목적지 주소</div>
            <div class="detail-value">${Array.isArray(result.policy.dstaddr) ? result.policy.dstaddr.join(', ') : result.policy.dstaddr}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">서비스</div>
            <div class="detail-value">${Array.isArray(result.policy.service) ? result.policy.service.join(', ') : result.policy.service}</div>
          </div>
        `;

        if (result.policy.device) {
          detailsHTML += `
            <div class="detail-item">
              <div class="detail-label">장비</div>
              <div class="detail-value">${result.policy.device}</div>
            </div>
          `;
        }

        if (result.policy.vdom) {
          detailsHTML += `
            <div class="detail-item">
              <div class="detail-label">VDOM</div>
              <div class="detail-value">${result.policy.vdom}</div>
            </div>
          `;
        }

        if (result.policy.comments) {
          detailsHTML += `
            <div class="detail-item">
              <div class="detail-label">설명</div>
              <div class="detail-value">${result.policy.comments}</div>
            </div>
          `;
        }

        if (result.policy.logtraffic) {
          detailsHTML += `
            <div class="detail-item">
              <div class="detail-label">로그 기록</div>
              <div class="detail-value">${result.policy.logtraffic}</div>
            </div>
          `;
        }
      } else {
        detailsHTML += `
          <div class="detail-item">
            <div class="detail-label">이유</div>
            <div class="detail-value">${result.evaluation.reason || '매칭되는 정책 없음'}</div>
          </div>
        `;
      }

      resultDetails.innerHTML = detailsHTML;
      results.style.display = 'block';
    }

    // Show error message
    function showError(message) {
      const error = document.getElementById('errorMessage');
      const errorText = document.getElementById('errorText');
      errorText.textContent = message;
      error.style.display = 'block';
    }

    // Input validation
    function validateIP(ip) {
      const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
      return ipRegex.test(ip);
    }

    // Real-time validation
    document.getElementById('sourceIP').addEventListener('blur', function() {
      if (this.value && !validateIP(this.value)) {
        this.style.borderColor = '#f44336';
        showError('올바른 IP 주소 형식이 아닙니다');
      } else {
        this.style.borderColor = '';
        document.getElementById('errorMessage').style.display = 'none';
      }
    });

    document.getElementById('destIP').addEventListener('blur', function() {
      if (this.value && !validateIP(this.value)) {
        this.style.borderColor = '#f44336';
        showError('올바른 IP 주소 형식이 아닙니다');
      } else {
        this.style.borderColor = '';
        document.getElementById('errorMessage').style.display = 'none';
      }
    });
  </script>
</body>
</html>