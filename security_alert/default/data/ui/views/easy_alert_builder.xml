<form version="1.1" theme="dark">
  <label>ê°„í¸ ì•Œë¦¼ ìƒì„±ê¸° (ìë™ ê²€ì¦)</label>
  <description>ì²´í¬ë°•ìŠ¤ë¡œ ì‰½ê²Œ ì„¤ì • + ì‹¤ì‹œê°„ ë¬¸ë²• ê²€ì¦ + ìë™ ë£©ì—… ì ìš©</description>

  <!-- ========================================
       ì„¤ì • íŒ¨ë„ - ì²´í¬ë°•ìŠ¤ ë°©ì‹
       ======================================== -->
  <fieldset submitButton="false" autoRun="true">
    <html>
      <h2 style="color: #00d4ff; border-bottom: 2px solid #00d4ff; padding-bottom: 10px;">
        âš™ï¸ ì•Œë¦¼ ê¸°ë³¸ ì„¤ì •
      </h2>
    </html>

    <input type="text" token="alert_name">
      <label>ğŸ“ ì•Œë¦¼ëª…</label>
      <default>Custom_Alert</default>
    </input>
  </fieldset>

  <!-- ========================================
       ê°ì‹œ ëŒ€ìƒ ì„ íƒ (ì²´í¬ë°•ìŠ¤)
       ======================================== -->
  <fieldset submitButton="false">
    <html>
      <h3 style="color: #ff9500;">ğŸ“Š ê°ì‹œí•  ë°ì´í„° ì„ íƒ (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</h3>
    </html>

    <input type="checkbox" token="monitor_config_change">
      <label>ğŸ”§ ì„¤ì • ë³€ê²½ (Config Change)</label>
      <default>false</default>
      <change>
        <condition value="true">
          <set token="has_config_change">true</set>
        </condition>
        <condition>
          <unset token="has_config_change"></unset>
        </condition>
      </change>
    </input>

    <input type="checkbox" token="monitor_vpn">
      <label>ğŸ” VPN ìƒíƒœ (VPN Up/Down)</label>
      <default>false</default>
      <change>
        <condition value="true">
          <set token="has_vpn">true</set>
        </condition>
        <condition>
          <unset token="has_vpn"></unset>
        </condition>
      </change>
    </input>

    <input type="checkbox" token="monitor_hardware">
      <label>âš™ï¸ í•˜ë“œì›¨ì–´ ìƒíƒœ (Hardware Failure)</label>
      <default>false</default>
      <change>
        <condition value="true">
          <set token="has_hardware">true</set>
        </condition>
        <condition>
          <unset token="has_hardware"></unset>
        </condition>
      </change>
    </input>

    <input type="checkbox" token="monitor_ha">
      <label>ğŸ”„ HA ìƒíƒœ (High Availability)</label>
      <default>false</default>
      <change>
        <condition value="true">
          <set token="has_ha">true</set>
        </condition>
        <condition>
          <unset token="has_ha"></unset>
        </condition>
      </change>
    </input>

    <input type="checkbox" token="monitor_interface">
      <label>ğŸŒ ì¸í„°í˜ì´ìŠ¤ ìƒíƒœ (Link Up/Down)</label>
      <default>false</default>
      <change>
        <condition value="true">
          <set token="has_interface">true</set>
        </condition>
        <condition>
          <unset token="has_interface"></unset>
        </condition>
      </change>
    </input>

    <input type="checkbox" token="monitor_cpu_memory">
      <label>ğŸ“ˆ CPU/ë©”ëª¨ë¦¬ ì´ìƒ (Anomaly Detection)</label>
      <default>false</default>
      <change>
        <condition value="true">
          <set token="has_cpu_memory">true</set>
        </condition>
        <condition>
          <unset token="has_cpu_memory"></unset>
        </condition>
      </change>
    </input>

    <input type="checkbox" token="monitor_resource">
      <label>âš¡ ë¦¬ì†ŒìŠ¤ í•œê³„ (Resource Limit)</label>
      <default>false</default>
      <change>
        <condition value="true">
          <set token="has_resource">true</set>
        </condition>
        <condition>
          <unset token="has_resource"></unset>
        </condition>
      </change>
    </input>

    <input type="checkbox" token="monitor_traffic">
      <label>ğŸ“Š íŠ¸ë˜í”½ ê¸‰ì¦ (Traffic Spike)</label>
      <default>false</default>
      <change>
        <condition value="true">
          <set token="has_traffic">true</set>
        </condition>
        <condition>
          <unset token="has_traffic"></unset>
        </condition>
      </change>
    </input>
  </fieldset>

  <!-- ========================================
       ì•Œë¦¼ ì˜µì…˜ (ì²´í¬ë°•ìŠ¤)
       ======================================== -->
  <fieldset submitButton="false">
    <html>
      <h3 style="color: #1db954;">ğŸ”” ì•Œë¦¼ ì˜µì…˜</h3>
    </html>

    <input type="checkbox" token="enable_slack">
      <label>ğŸ’¬ Slack ì•Œë¦¼ í™œì„±í™”</label>
      <default>true</default>
    </input>

    <input type="checkbox" token="enable_email" depends="$show_email_option$">
      <label>ğŸ“§ ì´ë©”ì¼ ì•Œë¦¼ í™œì„±í™”</label>
      <default>false</default>
    </input>

    <input type="checkbox" token="enable_webhook">
      <label>ğŸ”— Webhook í˜¸ì¶œ</label>
      <default>false</default>
    </input>

    <input type="checkbox" token="enable_auto_response">
      <label>ğŸ¤– ìë™ ëŒ€ì‘ (Auto Response)</label>
      <default>false</default>
    </input>

    <input type="checkbox" token="enable_suppression">
      <label>ğŸ”• ì¤‘ë³µ ì•Œë¦¼ ì–µì œ</label>
      <default>true</default>
    </input>
  </fieldset>

  <!-- ========================================
       ìë™ ë£©ì—… ì ìš© (ì²´í¬ë°•ìŠ¤)
       ======================================== -->
  <fieldset submitButton="false">
    <html>
      <h3 style="color: #9c27b0;">ğŸ“š ìë™ ë°ì´í„° ê°•í™” (Automatic Lookup)</h3>
    </html>

    <input type="checkbox" token="apply_logid_lookup">
      <label>ğŸ” LogID ì •ë³´ ê°•í™” (category, severity, description)</label>
      <default>true</default>
    </input>

    <input type="checkbox" token="apply_severity_lookup">
      <label>âš ï¸ ì‹¬ê°ë„ ìš°ì„ ìˆœìœ„ ë§¤í•‘ (priority, color)</label>
      <default>true</default>
    </input>

    <input type="checkbox" token="apply_threat_intel">
      <label>ğŸ›¡ï¸ ìœ„í˜‘ ì¸í…”ë¦¬ì „ìŠ¤ (AbuseIPDB, VirusTotal)</label>
      <default>false</default>
    </input>

    <input type="checkbox" token="apply_mitre_mapping">
      <label>ğŸ¯ MITRE ATT&amp;CK ë§¤í•‘</label>
      <default>false</default>
    </input>

    <input type="checkbox" token="apply_ip_whitelist">
      <label>âœ… IP í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì²´í¬</label>
      <default>true</default>
    </input>
  </fieldset>

  <!-- ========================================
       ì‹¤ì‹œê°„ ê²€ì¦ ê²°ê³¼
       ======================================== -->
  <row>
    <panel>
      <html>
        <h2 style="color: #ff5722; border-bottom: 2px solid #ff5722; padding-bottom: 10px; margin-top: 30px;">
          âœ… ì‹¤ì‹œê°„ ê²€ì¦ ê²°ê³¼
        </h2>
      </html>
    </panel>
  </row>

  <row>
    <panel id="validation_panel">
      <title>ğŸ” ë¬¸ë²• ë° ì„¤ì • ê²€ì¦ (ìë™)</title>
      <html>
        <div id="validation_results" style="background: #1e1e1e; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace;">
          <div class="validation-item">
            <span class="status-icon" id="status_alert_name">â³</span>
            <span class="validation-label">ì•Œë¦¼ëª… ê²€ì¦:</span>
            <span class="validation-value" id="value_alert_name">ëŒ€ê¸° ì¤‘...</span>
          </div>
          <div class="validation-item">
            <span class="status-icon" id="status_monitors">â³</span>
            <span class="validation-label">ê°ì‹œ ëŒ€ìƒ ì„ íƒ:</span>
            <span class="validation-value" id="value_monitors">ëŒ€ê¸° ì¤‘...</span>
          </div>
          <div class="validation-item">
            <span class="status-icon" id="status_lookups">â³</span>
            <span class="validation-label">ìë™ ë£©ì—… ê²€ì¦:</span>
            <span class="validation-value" id="value_lookups">ëŒ€ê¸° ì¤‘...</span>
          </div>
          <div class="validation-item">
            <span class="status-icon" id="status_spl">â³</span>
            <span class="validation-label">SPL ë¬¸ë²• ê²€ì¦:</span>
            <span class="validation-value" id="value_spl">ëŒ€ê¸° ì¤‘...</span>
          </div>
          <div class="validation-item">
            <span class="status-icon" id="status_slack">â³</span>
            <span class="validation-label">Slack ì„¤ì • ê²€ì¦:</span>
            <span class="validation-value" id="value_slack">ëŒ€ê¸° ì¤‘...</span>
          </div>
          <div class="validation-item">
            <span class="status-icon" id="status_overall">â³</span>
            <span class="validation-label" style="font-weight: bold; color: #00d4ff;">ì¢…í•© ê²€ì¦:</span>
            <span class="validation-value" id="value_overall">ê²€ì¦ ì¤‘...</span>
          </div>
        </div>

        <style>
          .validation-item {
            padding: 10px 0;
            border-bottom: 1px solid #333;
            color: #e0e0e0;
          }
          .validation-item:last-child {
            border-bottom: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #00d4ff;
          }
          .status-icon {
            display: inline-block;
            width: 30px;
            font-size: 18px;
          }
          .validation-label {
            display: inline-block;
            width: 180px;
            font-weight: bold;
          }
          .validation-value {
            color: #00d4ff;
          }
        </style>

        <script><![CDATA[
          require([
            'jquery',
            'splunkjs/mvc',
            'splunkjs/mvc/simplexml/ready!'
          ], function($, mvc) {

            // í† í° ë³€ê²½ ì‹œ ìë™ ê²€ì¦
            var tokens = mvc.Components.get('default');
            var validationTimer;

            // ê²€ì¦ í•¨ìˆ˜
            function validateConfiguration() {
              clearTimeout(validationTimer);
              validationTimer = setTimeout(function() {
                runValidation();
              }, 1000); // 1ì´ˆ ë””ë°”ìš´ìŠ¤
            }

            function runValidation() {
              console.log('ğŸ” Starting validation...');

              // 1. ì•Œë¦¼ëª… ê²€ì¦
              var alertName = tokens.get('alert_name') || '';
              if (alertName.length >= 3 && /^[a-zA-Z0-9_]+$/.test(alertName)) {
                updateStatus('alert_name', 'success', 'âœ… ìœ íš¨í•œ ì•Œë¦¼ëª…');
              } else {
                updateStatus('alert_name', 'error', 'âŒ ì˜ë¬¸/ìˆ«ì/ì–¸ë”ìŠ¤ì½”ì–´ë§Œ ì‚¬ìš© (3ì ì´ìƒ)');
              }

              // 2. ê°ì‹œ ëŒ€ìƒ ê²€ì¦
              var monitorCount = 0;
              var monitors = [];
              if (tokens.get('monitor_config_change')) { monitorCount++; monitors.push('Config Change'); }
              if (tokens.get('monitor_vpn')) { monitorCount++; monitors.push('VPN'); }
              if (tokens.get('monitor_hardware')) { monitorCount++; monitors.push('Hardware'); }
              if (tokens.get('monitor_ha')) { monitorCount++; monitors.push('HA'); }
              if (tokens.get('monitor_interface')) { monitorCount++; monitors.push('Interface'); }
              if (tokens.get('monitor_cpu_memory')) { monitorCount++; monitors.push('CPU/Memory'); }
              if (tokens.get('monitor_resource')) { monitorCount++; monitors.push('Resource'); }
              if (tokens.get('monitor_traffic')) { monitorCount++; monitors.push('Traffic'); }

              if (monitorCount > 0) {
                updateStatus('monitors', 'success', 'âœ… ' + monitorCount + 'ê°œ ì„ íƒ: ' + monitors.join(', '));
              } else {
                updateStatus('monitors', 'warning', 'âš ï¸ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒ í•„ìš”');
              }

              // 3. ìë™ ë£©ì—… ê²€ì¦
              var lookupCount = 0;
              var lookups = [];
              if (tokens.get('apply_logid_lookup')) { lookupCount++; lookups.push('LogID'); }
              if (tokens.get('apply_severity_lookup')) { lookupCount++; lookups.push('Severity'); }
              if (tokens.get('apply_threat_intel')) { lookupCount++; lookups.push('Threat Intel'); }
              if (tokens.get('apply_mitre_mapping')) { lookupCount++; lookups.push('MITRE'); }
              if (tokens.get('apply_ip_whitelist')) { lookupCount++; lookups.push('IP Whitelist'); }

              if (lookupCount > 0) {
                updateStatus('lookups', 'success', 'âœ… ' + lookupCount + 'ê°œ ì ìš©: ' + lookups.join(', '));
              } else {
                updateStatus('lookups', 'info', 'â„¹ï¸ ìë™ ë£©ì—… ë¯¸ì‚¬ìš©');
              }

              // 4. SPL ë¬¸ë²• ê²€ì¦ (ë¹„ë™ê¸°)
              validateSPLSyntax();

              // 5. Slack ì„¤ì • ê²€ì¦
              if (tokens.get('enable_slack')) {
                // Slack í† í° í™•ì¸ (REST API)
                checkSlackConfiguration();
              } else {
                updateStatus('slack', 'info', 'â„¹ï¸ Slack ì•Œë¦¼ ë¹„í™œì„±í™”');
              }

              // 6. ì¢…í•© ê²€ì¦
              updateOverallStatus();
            }

            function validateSPLSyntax() {
              // SPL ì¿¼ë¦¬ ìƒì„±
              var spl = buildSPLQuery();

              // Splunk ê²€ìƒ‰ APIë¡œ ë¬¸ë²• ê²€ì¦
              var service = mvc.createService();
              var searchQuery = '| makeresults | eval test=1'; // ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸

              service.parse(spl, {}, function(err, result) {
                if (err) {
                  updateStatus('spl', 'error', 'âŒ SPL ë¬¸ë²• ì˜¤ë¥˜: ' + err.message);
                } else {
                  updateStatus('spl', 'success', 'âœ… SPL ë¬¸ë²• ê²€ì¦ ì™„ë£Œ');
                }
              });
            }

            function checkSlackConfiguration() {
              // REST APIë¡œ Slack ì„¤ì • í™•ì¸
              $.ajax({
                url: '/servicesNS/nobody/security_alert/admin/alert_actions/slack',
                type: 'GET',
                headers: {
                  'Authorization': 'Splunk ' + $C.SPLUNK_SESSION_KEY
                },
                success: function(response) {
                  var hasToken = false;
                  var hasChannel = false;

                  if (response && response.entry && response.entry.length > 0) {
                    var content = response.entry[0].content;
                    hasToken = !!(content.param_bot_token || content.param_webhook_url);
                    hasChannel = !!content.param_channel;
                  }

                  if (hasToken && hasChannel) {
                    updateStatus('slack', 'success', 'âœ… Slack ì„¤ì • ì™„ë£Œ');
                  } else if (!hasToken) {
                    updateStatus('slack', 'warning', 'âš ï¸ Slack í† í° ë¯¸ì„¤ì • (Setup í•„ìš”)');
                  } else if (!hasChannel) {
                    updateStatus('slack', 'warning', 'âš ï¸ Slack ì±„ë„ ë¯¸ì„¤ì •');
                  }
                },
                error: function() {
                  updateStatus('slack', 'error', 'âŒ Slack ì„¤ì • í™•ì¸ ì‹¤íŒ¨');
                }
              });
            }

            function buildSPLQuery() {
              var conditions = [];
              if (tokens.get('monitor_config_change')) conditions.push('(logid=0100044546 OR logid=0100044547)');
              if (tokens.get('monitor_vpn')) conditions.push('(logid=0101037124 OR logid=0101037131 OR logid=0101037134)');
              // ... ì¶”ê°€ ì¡°ê±´

              var whereClause = conditions.length > 0 ? '(' + conditions.join(' OR ') + ')' : '*';
              var spl = 'index=fw earliest=-15m ' + whereClause + ' | stats count by logid, devname';

              return spl;
            }

            function updateStatus(item, status, message) {
              var icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸',
                loading: 'â³'
              };

              $('#status_' + item).text(icons[status] || 'â³');
              $('#value_' + item).text(message);
            }

            function updateOverallStatus() {
              // ëª¨ë“  ê²€ì¦ ìƒíƒœ í™•ì¸
              var allValid = true;
              var hasError = false;

              $('[id^=status_]').each(function() {
                var status = $(this).text();
                if (status === 'âŒ') {
                  hasError = true;
                  allValid = false;
                } else if (status === 'âš ï¸') {
                  allValid = false;
                }
              });

              if (hasError) {
                updateStatus('overall', 'error', 'âŒ ì˜¤ë¥˜ ë°œê²¬ - ìˆ˜ì • í•„ìš”');
              } else if (!allValid) {
                updateStatus('overall', 'warning', 'âš ï¸ ê²½ê³  ìˆìŒ - í™•ì¸ í•„ìš”');
              } else {
                updateStatus('overall', 'success', 'âœ… ëª¨ë“  ê²€ì¦ í†µê³¼ - ì €ì¥ ê°€ëŠ¥');
              }
            }

            // í† í° ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
            tokens.on('change:alert_name', validateConfiguration);
            tokens.on('change:monitor_config_change', validateConfiguration);
            tokens.on('change:monitor_vpn', validateConfiguration);
            tokens.on('change:monitor_hardware', validateConfiguration);
            tokens.on('change:monitor_ha', validateConfiguration);
            tokens.on('change:monitor_interface', validateConfiguration);
            tokens.on('change:monitor_cpu_memory', validateConfiguration);
            tokens.on('change:monitor_resource', validateConfiguration);
            tokens.on('change:monitor_traffic', validateConfiguration);
            tokens.on('change:apply_logid_lookup', validateConfiguration);
            tokens.on('change:apply_severity_lookup', validateConfiguration);
            tokens.on('change:apply_threat_intel', validateConfiguration);
            tokens.on('change:apply_mitre_mapping', validateConfiguration);
            tokens.on('change:apply_ip_whitelist', validateConfiguration);
            tokens.on('change:enable_slack', validateConfiguration);

            // ì´ˆê¸° ê²€ì¦ ì‹¤í–‰
            setTimeout(validateConfiguration, 500);
          });
        ]]></script>
      </html>
    </panel>
  </row>

  <!-- ========================================
       ì €ì¥ ë²„íŠ¼
       ======================================== -->
  <row>
    <panel>
      <html>
        <div style="text-align: center; margin: 30px 0;">
          <button id="save_alert_btn" class="btn btn-primary" style="padding: 15px 40px; font-size: 16px; background: #1db954; border: none; border-radius: 5px; color: white; cursor: pointer;">
            ğŸ’¾ ì•Œë¦¼ ì €ì¥í•˜ê¸°
          </button>
          <button id="preview_alert_btn" class="btn btn-info" style="padding: 15px 40px; font-size: 16px; background: #00d4ff; border: none; border-radius: 5px; color: white; margin-left: 20px; cursor: pointer;">
            ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°
          </button>
        </div>

        <script><![CDATA[
          require([
            'jquery',
            'splunkjs/mvc',
            'splunkjs/mvc/simplexml/ready!'
          ], function($, mvc) {

            $('#save_alert_btn').click(function() {
              var tokens = mvc.Components.get('default');

              // ê²€ì¦ ìƒíƒœ í™•ì¸
              var overallStatus = $('#status_overall').text();
              if (overallStatus !== 'âœ…') {
                alert('âš ï¸ ê²€ì¦ì„ í†µê³¼í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
              }

              // ì„¤ì • ìˆ˜ì§‘
              var config = {
                alert_name: tokens.get('alert_name'),
                monitors: [],
                lookups: [],
                options: {}
              };

              // ê°ì‹œ ëŒ€ìƒ
              if (tokens.get('monitor_config_change')) config.monitors.push('config_change');
              if (tokens.get('monitor_vpn')) config.monitors.push('vpn');
              if (tokens.get('monitor_hardware')) config.monitors.push('hardware');
              if (tokens.get('monitor_ha')) config.monitors.push('ha');
              if (tokens.get('monitor_interface')) config.monitors.push('interface');
              if (tokens.get('monitor_cpu_memory')) config.monitors.push('cpu_memory');
              if (tokens.get('monitor_resource')) config.monitors.push('resource');
              if (tokens.get('monitor_traffic')) config.monitors.push('traffic');

              // ìë™ ë£©ì—…
              if (tokens.get('apply_logid_lookup')) config.lookups.push('logid');
              if (tokens.get('apply_severity_lookup')) config.lookups.push('severity');
              if (tokens.get('apply_threat_intel')) config.lookups.push('threat_intel');
              if (tokens.get('apply_mitre_mapping')) config.lookups.push('mitre');
              if (tokens.get('apply_ip_whitelist')) config.lookups.push('ip_whitelist');

              // ì˜µì…˜
              config.options.slack = tokens.get('enable_slack') || false;
              config.options.email = tokens.get('enable_email') || false;
              config.options.webhook = tokens.get('enable_webhook') || false;
              config.options.auto_response = tokens.get('enable_auto_response') || false;
              config.options.suppression = tokens.get('enable_suppression') || false;

              // REST API í˜¸ì¶œ
              $.ajax({
                url: '/servicesNS/nobody/security_alert/security_alert/alerts',
                type: 'POST',
                headers: {
                  'Authorization': 'Splunk ' + $C.SPLUNK_SESSION_KEY,
                  'Content-Type': 'application/json'
                },
                data: JSON.stringify(config),
                success: function(response) {
                  alert('âœ… ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì•Œë¦¼ëª…: ' + config.alert_name + '\nê°ì‹œ ëŒ€ìƒ: ' + config.monitors.length + 'ê°œ\nìë™ ë£©ì—…: ' + config.lookups.length + 'ê°œ');
                  window.location.href = '/app/security_alert/alert_management';
                },
                error: function(xhr, status, error) {
                  alert('âŒ ì•Œë¦¼ ì €ì¥ ì‹¤íŒ¨:\n' + error + '\n\nSTATUS: ' + xhr.status + '\n\nì‘ë‹µ: ' + xhr.responseText);
                }
              });
            });

            $('#preview_alert_btn').click(function() {
              // ë¯¸ë¦¬ë³´ê¸° ì°½ ì—´ê¸°
              window.open('/app/security_alert/alert_preview', '_blank', 'width=800,height=600');
            });
          });
        ]]></script>
      </html>
    </panel>
  </row>
</form>
