name: AppInspect

# Splunk App validation using AppInspect CLI
# Required for Splunkbase certification

on:
  push:
    branches: [master, main]
    paths:
      - 'security_alert/**'
      - '.github/workflows/appinspect.yml'
  pull_request:
    branches: [master, main]
    paths:
      - 'security_alert/**'
      - '.github/workflows/appinspect.yml'
  workflow_dispatch:
    inputs:
      mode:
        description: 'AppInspect mode'
        required: true
        default: 'precert'
        type: choice
        options:
          - precert
          - cloud

permissions:
  contents: read

env:
  APP_NAME: security_alert
  SPLUNK_VERSION: '9.3'

concurrency:
  group: appinspect-${{ github.ref }}
  cancel-in-progress: true

jobs:
  package:
    name: Package App
    runs-on: ubuntu-latest
    outputs:
      tarball: ${{ steps.package.outputs.tarball }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Extract version from app.conf
        id: version
        run: |
          VERSION=$(grep -E '^version\s*=' security_alert/default/app.conf | sed 's/.*=\s*//' | tr -d '[:space:]')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "App version: ${VERSION}"

      - name: Create tarball
        id: package
        run: |
          TARBALL="${APP_NAME}-${{ steps.version.outputs.version }}.tar.gz"
          tar -czf "${TARBALL}" \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.git' \
            --exclude='tests' \
            --exclude='*.egg-info' \
            --exclude='.DS_Store' \
            ${APP_NAME}/
          echo "tarball=${TARBALL}" >> $GITHUB_OUTPUT
          echo "Created: ${TARBALL}"
          ls -lh "${TARBALL}"
          tar -tzf "${TARBALL}" | head -20

      - name: Upload tarball
        uses: actions/upload-artifact@v4
        with:
          name: splunk-app-tarball
          path: ${{ steps.package.outputs.tarball }}
          retention-days: 7

  appinspect:
    name: AppInspect Validation
    runs-on: ubuntu-latest
    needs: package
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Download tarball
        uses: actions/download-artifact@v4
        with:
          name: splunk-app-tarball

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install AppInspect
        run: |
          pip install splunk-appinspect --quiet
          splunk-appinspect list checks | head -5 || echo "AppInspect installed"

      - name: Run AppInspect
        id: appinspect
        run: |
          MODE=${{ github.event.inputs.mode || 'precert' }}
          TARBALL="${{ needs.package.outputs.tarball }}"

          echo "Running AppInspect in ${MODE} mode..."
          echo "Tarball: ${TARBALL}"

          # Run AppInspect with appropriate checks
          set +e
          if [ "${MODE}" = "cloud" ]; then
            splunk-appinspect inspect "${TARBALL}" \
              --mode precert \
              --included-tags cloud \
              --output-file appinspect-results.json \
              --log-file appinspect.log \
              2>&1 | tee appinspect-output.txt
          else
            splunk-appinspect inspect "${TARBALL}" \
              --mode precert \
              --output-file appinspect-results.json \
              --log-file appinspect.log \
              2>&1 | tee appinspect-output.txt
          fi
          RESULT=$?
          set -e

          echo "exit_code=${RESULT}" >> $GITHUB_OUTPUT

          # Parse results
          if [ -f appinspect-results.json ]; then
            FAILURES=$(python3 -c "import json; d=json.load(open('appinspect-results.json')); print(d.get('summary',{}).get('failure',0))" 2>/dev/null || echo "0")
            ERRORS=$(python3 -c "import json; d=json.load(open('appinspect-results.json')); print(d.get('summary',{}).get('error',0))" 2>/dev/null || echo "0")
            WARNINGS=$(python3 -c "import json; d=json.load(open('appinspect-results.json')); print(d.get('summary',{}).get('warning',0))" 2>/dev/null || echo "0")
            SKIPPED=$(python3 -c "import json; d=json.load(open('appinspect-results.json')); print(d.get('summary',{}).get('skipped',0))" 2>/dev/null || echo "0")
            PASSED=$(python3 -c "import json; d=json.load(open('appinspect-results.json')); print(d.get('summary',{}).get('success',0))" 2>/dev/null || echo "0")

            echo "failures=${FAILURES}" >> $GITHUB_OUTPUT
            echo "errors=${ERRORS}" >> $GITHUB_OUTPUT
            echo "warnings=${WARNINGS}" >> $GITHUB_OUTPUT
            echo "skipped=${SKIPPED}" >> $GITHUB_OUTPUT
            echo "passed=${PASSED}" >> $GITHUB_OUTPUT
          fi

      - name: Generate Summary
        if: always()
        run: |
          echo "## AppInspect Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App**: ${{ env.APP_NAME }} v${{ needs.package.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Mode**: ${{ github.event.inputs.mode || 'precert' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f appinspect-results.json ]; then
            echo "### Summary" >> $GITHUB_STEP_SUMMARY
            echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| :white_check_mark: Passed | ${{ steps.appinspect.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| :warning: Warnings | ${{ steps.appinspect.outputs.warnings }} |" >> $GITHUB_STEP_SUMMARY
            echo "| :x: Failures | ${{ steps.appinspect.outputs.failures }} |" >> $GITHUB_STEP_SUMMARY
            echo "| :boom: Errors | ${{ steps.appinspect.outputs.errors }} |" >> $GITHUB_STEP_SUMMARY
            echo "| :fast_forward: Skipped | ${{ steps.appinspect.outputs.skipped }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show failures and errors if any
            if [ "${{ steps.appinspect.outputs.failures }}" != "0" ] || [ "${{ steps.appinspect.outputs.errors }}" != "0" ]; then
              echo "### Issues Found" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -E '"result":\s*"(failure|error)"' appinspect-results.json | head -20 >> $GITHUB_STEP_SUMMARY || echo "See artifact for details" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo ":x: AppInspect results not available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload AppInspect Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: appinspect-results
          path: |
            appinspect-results.json
            appinspect.log
            appinspect-output.txt
          retention-days: 30

      - name: Check for failures
        if: always()
        run: |
          FAILURES=${{ steps.appinspect.outputs.failures || '0' }}
          ERRORS=${{ steps.appinspect.outputs.errors || '0' }}

          if [ "${FAILURES}" != "0" ] || [ "${ERRORS}" != "0" ]; then
            echo "::error::AppInspect found ${FAILURES} failures and ${ERRORS} errors"
            exit 1
          fi

          echo "AppInspect validation passed!"

  appinspect-api:
    name: AppInspect API (Optional)
    runs-on: ubuntu-latest
    needs: package
    if: ${{ vars.SPLUNK_APPINSPECT_API_USER != '' }}
    continue-on-error: true
    steps:
      - name: Download tarball
        uses: actions/download-artifact@v4
        with:
          name: splunk-app-tarball

      - name: Submit to AppInspect API
        env:
          SPLUNK_USER: ${{ vars.SPLUNK_APPINSPECT_API_USER }}
          SPLUNK_PASS: ${{ secrets.SPLUNK_APPINSPECT_API_PASS }}
        run: |
          TARBALL="${{ needs.package.outputs.tarball }}"

          echo "Note: AppInspect API validation requires Splunk.com credentials"
          echo "Set SPLUNK_APPINSPECT_API_USER variable and SPLUNK_APPINSPECT_API_PASS secret"

          if [ -z "${SPLUNK_USER}" ] || [ -z "${SPLUNK_PASS}" ]; then
            echo "Skipping API validation - credentials not configured"
            exit 0
          fi

          # Get auth token
          TOKEN=$(curl -s -X GET \
            -u "${SPLUNK_USER}:${SPLUNK_PASS}" \
            --url "https://api.splunk.com/2.0/rest/login/splunk" \
            | jq -r '.data.token')

          if [ -z "${TOKEN}" ] || [ "${TOKEN}" = "null" ]; then
            echo "Failed to authenticate with Splunk API"
            exit 1
          fi

          # Submit app for validation
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: bearer ${TOKEN}" \
            -F "app_package=@${TARBALL}" \
            --url "https://appinspect.splunk.com/v1/app/validate")

          REQUEST_ID=$(echo "${RESPONSE}" | jq -r '.request_id')
          echo "Request ID: ${REQUEST_ID}"

          # Poll for results (max 5 minutes)
          for i in $(seq 1 30); do
            sleep 10
            STATUS=$(curl -s -X GET \
              -H "Authorization: bearer ${TOKEN}" \
              --url "https://appinspect.splunk.com/v1/app/validate/status/${REQUEST_ID}" \
              | jq -r '.status')

            echo "Status: ${STATUS}"

            if [ "${STATUS}" = "SUCCESS" ] || [ "${STATUS}" = "FAILURE" ]; then
              break
            fi
          done

          # Get final report
          curl -s -X GET \
            -H "Authorization: bearer ${TOKEN}" \
            --url "https://appinspect.splunk.com/v1/app/report/${REQUEST_ID}" \
            -o appinspect-api-report.json

          echo "API validation complete"
