name: Deploy Splunk App

on:
  push:
    branches: [master, main]
    paths:
      - 'security_alert/**'
  workflow_dispatch:
    inputs:
      target:
        description: 'Deployment target'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      force:
        description: 'Force restart Splunk'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

env:
  APP_NAME: security_alert

concurrency:
  group: deploy-splunk-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate:
    name: Validate Configs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Validate Splunk configs
        run: |
          python scripts/validate/check-stanza.py
          python3 -m py_compile security_alert/bin/*.py

      - name: Check XML syntax
        run: |
          for xml in security_alert/default/data/ui/views/*.xml; do
            if [ -f "$xml" ]; then
              echo "Checking: $xml"
              python3 -c "import xml.etree.ElementTree as ET; ET.parse('$xml')" || {
                echo "‚ùå Invalid XML: $xml"
                exit 1
              }
            fi
          done
          echo "‚úÖ All XML files valid"

  package:
    name: Package App
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      version: ${{ steps.version.outputs.version }}
      artifact_name: ${{ steps.package.outputs.artifact_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Get version
        id: version
        run: |
          VERSION=$(grep -oP 'version\s*=\s*\K[0-9.]+' security_alert/default/app.conf || echo "0.0.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "App version: $VERSION"

      - name: Create tarball
        id: package
        run: |
          ARTIFACT_NAME="security_alert-${{ steps.version.outputs.version }}-${{ github.sha }}.tar.gz"
          tar -czf "$ARTIFACT_NAME" \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.git' \
            --exclude='tests/' \
            security_alert/
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          ls -lh "$ARTIFACT_NAME"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: splunk-app-package
          path: ${{ steps.package.outputs.artifact_name }}
          retention-days: 7

  deploy-dev:
    name: Deploy to Dev (LXC 150)
    runs-on: [self-hosted, linux, internal-network]
    needs: package
    environment:
      name: splunk-dev
      url: https://splunk-dev.jclee.me
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'dev') ||
      (github.event_name == 'push')
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: splunk-app-package

      - name: Deploy via SSH + Splunk CLI
        env:
          SPLUNK_HOST: ${{ secrets.SPLUNK_HOST_DEV }}
          SPLUNK_USER: ${{ secrets.SPLUNK_USER }}
          SPLUNK_PASS: ${{ secrets.SPLUNK_PASS }}
        run: |
          if [ -z "$SPLUNK_HOST" ]; then
            echo "‚ö†Ô∏è SPLUNK_HOST_DEV secret not configured"
            echo "Set these secrets: SPLUNK_HOST_DEV, SPLUNK_USER, SPLUNK_PASS"
            exit 0
          fi

          TARBALL=$(ls security_alert-*.tar.gz 2>/dev/null | head -1)

          echo "üì¶ Deploying app package: $TARBALL"
          echo "üîó Connecting to Splunk at ${SPLUNK_HOST}..."

          # Test SSH connection
          if ! ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no root@${SPLUNK_HOST} "echo 'SSH OK'" 2>/dev/null; then
            echo "‚ö†Ô∏è Cannot SSH to Splunk server"
            echo "   Deploy requires self-hosted runner with SSH access"
            echo "   Artifact available for manual deploy"
            echo ""
            echo "üì¶ Manual deploy instructions:"
            echo "   1. scp ${TARBALL} root@splunk:/tmp/"
            echo "   2. ssh root@splunk '/opt/splunk/bin/splunk install app /tmp/${TARBALL} -update true -auth <user>:<pass>'"
            exit 0
          fi

          echo "‚úÖ SSH connection successful"

          # Step 1: Copy tarball to Splunk server
          echo "üì§ Copying tarball to server..."
          scp -o StrictHostKeyChecking=no "${TARBALL}" root@${SPLUNK_HOST}:/tmp/

          # Step 2: Install app via Splunk CLI
          echo "üì• Installing app via Splunk CLI..."
          INSTALL_OUTPUT=$(ssh -o StrictHostKeyChecking=no root@${SPLUNK_HOST} \
            "/opt/splunk/bin/splunk install app /tmp/${TARBALL} -update true -auth ${SPLUNK_USER}:${SPLUNK_PASS}" 2>&1)

          if echo "$INSTALL_OUTPUT" | grep -q "installed"; then
            echo "‚úÖ App installed successfully"
            echo "$INSTALL_OUTPUT"
          else
            echo "‚ùå Installation failed"
            echo "$INSTALL_OUTPUT"
            exit 1
          fi

          # Cleanup
          ssh -o StrictHostKeyChecking=no root@${SPLUNK_HOST} "rm -f /tmp/${TARBALL}"

      - name: Restart Splunk (if requested)
        if: github.event.inputs.force == 'true'
        env:
          SPLUNK_HOST: ${{ secrets.SPLUNK_HOST_DEV }}
        run: |
          if [ -z "$SPLUNK_HOST" ]; then
            echo "‚ö†Ô∏è SPLUNK_HOST_DEV not configured, skipping restart"
            exit 0
          fi

          echo "üîÑ Restarting Splunk via SSH..."
          ssh -o StrictHostKeyChecking=no root@${SPLUNK_HOST} "/opt/splunk/bin/splunk restart" || {
            echo "‚ö†Ô∏è Restart command sent (may have timed out, this is normal)"
          }

          echo "‚è≥ Waiting for Splunk to come back online..."
          sleep 45

          for i in {1..20}; do
            if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no root@${SPLUNK_HOST} \
              "/opt/splunk/bin/splunk status" 2>/dev/null | grep -q "running"; then
              echo "‚úÖ Splunk is back online"
              break
            fi
            echo "  Attempt $i/20..."
            sleep 10
          done

      - name: Verify deployment
        env:
          SPLUNK_HOST: ${{ secrets.SPLUNK_HOST_DEV }}
        run: |
          if [ -z "$SPLUNK_HOST" ]; then
            echo "‚ö†Ô∏è Skipping verification - no host configured"
            exit 0
          fi

          echo "üîç Verifying app installation..."

          # Check app version from app.conf
          VERSION=$(ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no root@${SPLUNK_HOST} \
            "grep '^version' /opt/splunk/etc/apps/security_alert/default/app.conf 2>/dev/null | cut -d= -f2 | tr -d ' '" 2>/dev/null) || VERSION="unknown"

          if [ -n "$VERSION" ] && [ "$VERSION" != "unknown" ]; then
            echo "‚úÖ App installed: security_alert v$VERSION"
          else
            echo "‚ö†Ô∏è Could not verify app version"
          fi

          echo ""
          echo "üìã Checking saved searches..."
          SEARCHES=$(ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no root@${SPLUNK_HOST} \
            "grep -c '^\[' /opt/splunk/etc/apps/security_alert/default/savedsearches.conf 2>/dev/null" 2>/dev/null) || SEARCHES="0"
          echo "   Found $SEARCHES saved search stanzas"

      - name: Post deployment summary
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| App | security_alert |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.package.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Dev (LXC 150) |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY

  deploy-prod:
    name: Deploy to Production
    runs-on: [self-hosted, linux, internal-network]
    needs: [package, deploy-dev]
    environment:
      name: splunk-prod
      url: https://splunk.jclee.me
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'prod'
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: splunk-app-package

      - name: Deploy via SSH + Splunk CLI
        env:
          SPLUNK_HOST: ${{ secrets.SPLUNK_HOST_PROD }}
          SPLUNK_USER: ${{ secrets.SPLUNK_USER }}
          SPLUNK_PASS: ${{ secrets.SPLUNK_PASS }}
        run: |
          if [ -z "$SPLUNK_HOST" ]; then
            echo "‚ö†Ô∏è SPLUNK_HOST_PROD secret not configured"
            exit 0
          fi

          TARBALL=$(ls security_alert-*.tar.gz 2>/dev/null | head -1)

          echo "üì¶ Deploying app package to production: $TARBALL"
          echo "üîó Connecting to Splunk at ${SPLUNK_HOST}..."

          # Test SSH connection
          if ! ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no root@${SPLUNK_HOST} "echo 'SSH OK'" 2>/dev/null; then
            echo "‚ö†Ô∏è Cannot SSH to production Splunk server"
            echo "   Deploy requires self-hosted runner with SSH access"
            echo "   Artifact available for manual deploy"
            exit 0
          fi

          echo "‚úÖ SSH connection successful"

          # Step 1: Copy tarball to Splunk server
          echo "üì§ Copying tarball to server..."
          scp -o StrictHostKeyChecking=no "${TARBALL}" root@${SPLUNK_HOST}:/tmp/

          # Step 2: Install app via Splunk CLI
          echo "üì• Installing app via Splunk CLI..."
          INSTALL_OUTPUT=$(ssh -o StrictHostKeyChecking=no root@${SPLUNK_HOST} \
            "/opt/splunk/bin/splunk install app /tmp/${TARBALL} -update true -auth ${SPLUNK_USER}:${SPLUNK_PASS}" 2>&1)

          if echo "$INSTALL_OUTPUT" | grep -q "installed"; then
            echo "‚úÖ App installed to production successfully"
            echo "$INSTALL_OUTPUT"
          else
            echo "‚ùå Production installation failed"
            echo "$INSTALL_OUTPUT"
            exit 1
          fi

          # Cleanup
          ssh -o StrictHostKeyChecking=no root@${SPLUNK_HOST} "rm -f /tmp/${TARBALL}"

      - name: Post deployment summary
        run: |
          echo "## üöÄ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| App | security_alert |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.package.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Production |" >> $GITHUB_STEP_SUMMARY
