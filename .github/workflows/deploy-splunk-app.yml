name: Deploy Splunk App

on:
  push:
    branches: [master, main]
    paths:
      - 'security_alert/**'
  workflow_dispatch:
    inputs:
      target:
        description: 'Deployment target'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      force:
        description: 'Force restart Splunk'
        required: false
        default: false
        type: boolean

env:
  APP_NAME: security_alert
  SPLUNK_API_PORT: 8089

concurrency:
  group: deploy-splunk-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate:
    name: Validate Configs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Validate Splunk configs
        run: |
          python scripts/check-stanza.py
          python3 -m py_compile security_alert/bin/*.py

      - name: Check XML syntax
        run: |
          for xml in security_alert/default/data/ui/views/*.xml; do
            if [ -f "$xml" ]; then
              echo "Checking: $xml"
              python3 -c "import xml.etree.ElementTree as ET; ET.parse('$xml')" || {
                echo "âŒ Invalid XML: $xml"
                exit 1
              }
            fi
          done
          echo "âœ… All XML files valid"

  package:
    name: Package App
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      version: ${{ steps.version.outputs.version }}
      artifact_name: ${{ steps.package.outputs.artifact_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION=$(grep -oP 'version\s*=\s*\K[0-9.]+' security_alert/default/app.conf || echo "0.0.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "App version: $VERSION"

      - name: Create tarball
        id: package
        run: |
          ARTIFACT_NAME="security_alert-${{ steps.version.outputs.version }}-${{ github.sha }}.tar.gz"
          tar -czf "$ARTIFACT_NAME" security_alert/
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          ls -lh "$ARTIFACT_NAME"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: splunk-app-package
          path: ${{ steps.package.outputs.artifact_name }}
          retention-days: 7

  deploy-dev:
    name: Deploy to Dev (LXC 150)
    runs-on: [self-hosted, linux, internal-network]
    needs: package
    environment:
      name: splunk-dev
      url: http://192.168.50.150:8000
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'dev') ||
      (github.event_name == 'push')
    steps:
      - uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: splunk-app-package

      - name: Deploy via Splunk REST API
        env:
          SPLUNK_HOST: ${{ secrets.SPLUNK_HOST_DEV }}
          SPLUNK_USER: ${{ secrets.SPLUNK_USER }}
          SPLUNK_PASS: ${{ secrets.SPLUNK_PASS }}
        run: |
          if [ -z "$SPLUNK_HOST" ]; then
            echo "âš ï¸ SPLUNK_HOST_DEV secret not configured"
            echo "Set these secrets: SPLUNK_DEV_HOST, SPLUNK_USER, SPLUNK_PASS"
            exit 0
          fi

          TARBALL=$(ls security_alert-*.tar.gz 2>/dev/null | head -1)
          
          echo "ðŸ“¦ Uploading app package: $TARBALL"
          
          echo "ðŸ”— Testing connection to Splunk at ${SPLUNK_HOST}..."
          
          # Test connection - exit gracefully if unreachable (internal network)
          CURL_EXIT=0
          curl -sk --connect-timeout 10 "https://${SPLUNK_HOST}:${{ env.SPLUNK_API_PORT }}/services/server/info" > /dev/null 2>&1 || CURL_EXIT=$?
          
          if [ $CURL_EXIT -ne 0 ]; then
            echo "âš ï¸ Cannot reach Splunk server (curl exit code: $CURL_EXIT)"
            echo "   This is expected - GitHub runners cannot access internal networks"
            echo "   Deploy requires self-hosted runner or VPN access"
            echo "   Skipping deployment - artifact available for manual deploy"
            echo ""
            echo "ðŸ“¦ Manual deploy instructions:"
            echo "   1. Download artifact from GitHub Actions"
            echo "   2. Upload to Splunk: curl -k -u admin:pass -X POST -F 'appfile=@security_alert.tar.gz' https://splunk:8089/services/apps/local"
            exit 0
          fi
          
          echo "âœ… Connection successful, uploading app..."
          
          RESPONSE=$(curl -s -k -u "${SPLUNK_USER}:${SPLUNK_PASS}" \
            --connect-timeout 30 \
            -X POST \
            -F "name=security_alert" \
            -F "filename=true" \
            -F "update=true" \
            -F "appfile=@${TARBALL}" \
            "https://${SPLUNK_HOST}:${{ env.SPLUNK_API_PORT }}/services/apps/local" \
            -w "\n%{http_code}" 2>&1) || {
            echo "âš ï¸ Upload failed (network error)"
            echo "   Artifact available for manual deploy"
            exit 0
          }
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          if [[ "$HTTP_CODE" =~ ^2 ]]; then
            echo "âœ… App uploaded successfully (HTTP $HTTP_CODE)"
          else
            echo "âŒ Upload failed (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi

      - name: Restart Splunk (if requested)
        if: github.event.inputs.force == 'true'
        env:
          SPLUNK_HOST: ${{ secrets.SPLUNK_HOST_DEV }}
          SPLUNK_USER: ${{ secrets.SPLUNK_USER }}
          SPLUNK_PASS: ${{ secrets.SPLUNK_PASS }}
        run: |
          echo "ðŸ”„ Restarting Splunk..."
          curl -s -k -u "${SPLUNK_USER}:${SPLUNK_PASS}" \
            -X POST \
            "https://${SPLUNK_HOST}:${{ env.SPLUNK_API_PORT }}/services/server/control/restart" \
            -d "" || echo "Restart initiated"
          
          echo "â³ Waiting for Splunk to come back online..."
          sleep 30
          
          for i in {1..20}; do
            if curl -s -k -o /dev/null -w "%{http_code}" \
              "https://${SPLUNK_HOST}:${{ env.SPLUNK_API_PORT }}/services/server/info" | grep -q "200"; then
              echo "âœ… Splunk is back online"
              break
            fi
            echo "  Attempt $i/20..."
            sleep 10
          done

      - name: Verify deployment
        env:
          SPLUNK_HOST: ${{ secrets.SPLUNK_HOST_DEV }}
          SPLUNK_USER: ${{ secrets.SPLUNK_USER }}
          SPLUNK_PASS: ${{ secrets.SPLUNK_PASS }}
        run: |
          if [ -z "$SPLUNK_HOST" ]; then
            echo "âš ï¸ Skipping verification - no host configured"
            exit 0
          fi
          
          echo "ðŸ” Verifying app installation..."
          
          RESPONSE=$(curl -s -k -u "${SPLUNK_USER}:${SPLUNK_PASS}" \
            --connect-timeout 10 \
            "https://${SPLUNK_HOST}:${{ env.SPLUNK_API_PORT }}/services/apps/local/security_alert?output_mode=json" 2>&1) || {
            echo "âš ï¸ Verification skipped - cannot reach server"
            exit 0
          }
          
          if echo "$RESPONSE" | grep -q '"name":"security_alert"'; then
            VERSION=$(echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['entry'][0]['content'].get('version','unknown'))" 2>/dev/null || echo "unknown")
            echo "âœ… App installed: security_alert v$VERSION"
          else
            echo "âš ï¸ App verification inconclusive (may not have deployed)"
            exit 0
          fi
          
          echo ""
          echo "ðŸ“‹ Checking saved searches..."
          SEARCHES=$(curl -s -k -u "${SPLUNK_USER}:${SPLUNK_PASS}" \
            --connect-timeout 10 \
            "https://${SPLUNK_HOST}:${{ env.SPLUNK_API_PORT }}/servicesNS/-/security_alert/saved/searches?output_mode=json&count=0" \
            | python3 -c "import sys,json; d=json.load(sys.stdin); print(len(d.get('entry',[])))" 2>/dev/null || echo "0")
          echo "   Found $SEARCHES saved searches"

      - name: Post deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| App | security_alert |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.package.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Dev (LXC 150) |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY

  deploy-prod:
    name: Deploy to Production
    runs-on: [self-hosted, linux, internal-network]
    needs: [package, deploy-dev]
    environment:
      name: splunk-prod
      url: https://splunk.jclee.me
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'prod'
    steps:
      - uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: splunk-app-package

      - name: Deploy via Splunk REST API
        env:
          SPLUNK_HOST: ${{ secrets.SPLUNK_HOST_PROD }}
          SPLUNK_USER: ${{ secrets.SPLUNK_USER }}
          SPLUNK_PASS: ${{ secrets.SPLUNK_PASS }}
        run: |
          if [ -z "$SPLUNK_HOST" ]; then
            echo "âš ï¸ SPLUNK_HOST_PROD secret not configured"
            exit 0
          fi

          TARBALL=$(ls security_alert-*.tar.gz 2>/dev/null | head -1)
          
          echo "ðŸ“¦ Uploading app package to production: $TARBALL"
          echo "ðŸ”— Testing connection to Splunk at ${SPLUNK_HOST}..."
          
          CURL_EXIT=0
          curl -sk --connect-timeout 10 "https://${SPLUNK_HOST}:${{ env.SPLUNK_API_PORT }}/services/server/info" > /dev/null 2>&1 || CURL_EXIT=$?
          
          if [ $CURL_EXIT -ne 0 ]; then
            echo "âš ï¸ Cannot reach production Splunk server (curl exit code: $CURL_EXIT)"
            echo "   Deploy requires self-hosted runner or VPN access"
            echo "   Artifact available for manual deploy"
            exit 0
          fi
          
          echo "âœ… Connection successful, uploading app..."
          
          RESPONSE=$(curl -s -k -u "${SPLUNK_USER}:${SPLUNK_PASS}" \
            --connect-timeout 30 \
            -X POST \
            -F "name=security_alert" \
            -F "filename=true" \
            -F "update=true" \
            -F "appfile=@${TARBALL}" \
            "https://${SPLUNK_HOST}:${{ env.SPLUNK_API_PORT }}/services/apps/local" \
            -w "\n%{http_code}" 2>&1) || {
            echo "âš ï¸ Upload failed (network error)"
            exit 0
          }
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          
          if [[ "$HTTP_CODE" =~ ^2 ]]; then
            echo "âœ… App uploaded to production (HTTP $HTTP_CODE)"
          else
            echo "âŒ Production upload failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Post deployment summary
        run: |
          echo "## ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| App | security_alert |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.package.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Production |" >> $GITHUB_STEP_SUMMARY
