name: CI

"on":
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]

env:
  SPLUNK_HOME: /opt/splunk
  PIP_CACHE_DIR: ${{ github.workspace }}/.cache/pip

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================
  # STAGE: validate
  # ============================================================

  validate-syntax:
    name: Validate Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Make scripts executable
        run: chmod -R +x scripts/*.sh tools/scripts/**/*.sh tests/integration/*.sh 2>/dev/null || true

      - name: Run CI validation
        run: ./scripts/ci-validate-security-alert.sh

      - name: Upload validation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-validate-results
          path: ci-validate-results.txt
          retention-days: 7

  validate-docs:
    name: Validate Docs
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Validate docs structure
        run: |
          echo "=== Docs Structure Validation ==="
          ERRORS=0

          # Check required documentation files
          for doc in README.md; do
            if [ ! -f "$doc" ]; then
              echo "Missing: $doc"
              ERRORS=$((ERRORS + 1))
            else
              echo "Found: $doc"
            fi
          done

          # Check security_alert app exists
          if [ ! -d "security_alert" ]; then
            echo "Missing: security_alert/ app directory"
            ERRORS=$((ERRORS + 1))
          else
            echo "Found: security_alert/ app directory"
          fi

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "$ERRORS critical errors found"
            exit 1
          fi

          echo ""
          echo "Docs validation passed"

  validate-pre-commit:
    name: Pre-commit Checks
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit
        run: pre-commit run --all-files --show-diff-on-failure || true

  validate-spl:
    name: Validate SPL
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Validate SPL queries
        run: |
          echo "=== SPL Query Validation ==="
          
          # Check savedsearches.conf exists
          if [ -f "security_alert/default/savedsearches.conf" ]; then
            echo "Found: savedsearches.conf"
            SEARCH_COUNT=$(grep -c "^\[" security_alert/default/savedsearches.conf || echo "0")
            echo "Saved searches count: $SEARCH_COUNT"
          else
            echo "Warning: savedsearches.conf not found"
          fi
          
          # Check macros.conf exists
          if [ -f "security_alert/default/macros.conf" ]; then
            echo "Found: macros.conf"
            MACRO_COUNT=$(grep -c "^\[" security_alert/default/macros.conf || echo "0")
            echo "Macros count: $MACRO_COUNT"
          fi
          
          echo "SPL validation completed"

  # ============================================================
  # STAGE: security
  # ============================================================

  security-sast:
    name: SAST Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Run Semgrep
        run: |
          pip install semgrep --quiet
          echo "=== SAST Scan (Semgrep) ==="
          semgrep scan --config auto --config p/python \
            --exclude third_party --exclude node_modules --exclude python/lib \
            --exclude extras --exclude .cache \
            --json --output semgrep-results.json \
            . || true

          # Parse results
          CRITICAL=$(grep -c '"severity": "ERROR"' semgrep-results.json 2>/dev/null || echo "0")
          HIGH=$(grep -c '"severity": "WARNING"' semgrep-results.json 2>/dev/null || echo "0")

          echo "Critical: $CRITICAL, High: $HIGH"

          if [ "$CRITICAL" -gt 0 ]; then
            echo "Critical vulnerabilities found"
            cat semgrep-results.json | python -m json.tool | head -100
            exit 1
          fi

          echo "SAST scan passed"

      - name: Upload SAST results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-results
          path: semgrep-results.json
          retention-days: 7

  security-secrets:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Detect secrets
        run: |
          pip install detect-secrets --quiet
          echo "=== Secret Detection ==="
          detect-secrets scan --exclude-files 'third_party/.*' \
            --exclude-files 'node_modules/.*' \
            --exclude-files 'python/lib/.*' \
            --exclude-files 'extras/.*' \
            --exclude-files '\.cache/.*' \
            --exclude-files '.*\.json$' \
            . > secrets-results.json 2>&1 || true

          SECRETS=$(grep -c '"is_secret": true' secrets-results.json 2>/dev/null || echo "0")

          if [ "$SECRETS" -gt 0 ]; then
            echo "Potential secrets detected: $SECRETS"
            cat secrets-results.json | python -m json.tool | head -50
          else
            echo "No secrets detected"
          fi

      - name: Upload secrets results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secrets-results
          path: secrets-results.json
          retention-days: 7

  security-dependency:
    name: Dependency Audit
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Audit dependencies
        run: |
          echo "=== Python Dependency Check ==="
          pip install pip-audit --quiet
          
          if [ -f requirements.txt ]; then
            pip-audit --requirement requirements.txt --format json --output pip-audit.json 2>/dev/null || true
            VULNS=$(grep -c '"id":' pip-audit.json 2>/dev/null || echo "0")
            echo "Python vulnerabilities: $VULNS"
          else
            echo "No requirements.txt found, skipping pip-audit"
          fi

          echo "Dependency scan completed"

      - name: Upload dependency results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-audit
          path: pip-audit.json
          retention-days: 7
          if-no-files-found: ignore

  security-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Generate SBOM
        run: |
          echo "=== Python SBOM (CycloneDX) ==="
          pip install cyclonedx-bom --quiet
          
          if [ -f requirements.txt ]; then
            cyclonedx-py requirements requirements.txt -o sbom-python.json --format json 2>/dev/null || echo "Python SBOM generated"
          else
            echo "No requirements.txt found, creating minimal SBOM"
            echo '{"bomFormat": "CycloneDX", "specVersion": "1.4", "components": []}' > sbom-python.json
          fi

          echo "SBOM generation completed"
          ls -la sbom-*.json 2>/dev/null || true

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom
          path: sbom-*.json
          retention-days: 30
          if-no-files-found: ignore

  # ============================================================
  # STAGE: test
  # ============================================================

  test-unit-python:
    name: Python Unit Tests
    runs-on: ubuntu-latest
    needs: validate-syntax
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install dependencies
        run: pip install pytest pytest-cov --quiet

      - name: Run pytest
        run: |
          if [ -d "tests/unit" ]; then
            pytest tests/unit/ -v --tb=short \
              --cov=python --cov-report=xml:coverage-python.xml \
              --cov-report=term --cov-fail-under=80 2>&1 | tee pytest-results.txt
          else
            echo "No tests/unit directory found, skipping tests"
            echo "SKIPPED - no tests/unit directory" > pytest-results.txt
          fi

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-coverage
          path: |
            pytest-results.txt
            coverage-python.xml
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: coverage-python.xml
          flags: python
          fail_ci_if_error: false

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test-unit-python
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Run integration tests
        env:
          SPLUNK_HOST: ${{ secrets.SPLUNK_HOST }}
        run: |
          echo "Integration tests require Splunk environment"
          if [ -n "${SPLUNK_HOST:-}" ]; then
            ./scripts/validate-deployment.sh
          else
            echo "Skipping - no Splunk environment configured"
          fi

  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [test-unit-python]
    if: always()
    steps:
      - name: Download Python coverage
        uses: actions/download-artifact@v4
        with:
          name: python-coverage
          path: .
        continue-on-error: true

      - name: Display coverage summary
        run: |
          echo "=== Coverage Report ==="
          echo ""
          if [ -f coverage-python.xml ]; then
            echo "Python: Available"
          else
            echo "Python: Not available"
          fi
