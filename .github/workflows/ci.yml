name: CI

"on":
  push:
    branches: [master, main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'splunk.wiki/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [master, main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'splunk.wiki/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'
      - 'LICENSE'
      - '.gitignore'

env:
  SPLUNK_HOME: /opt/splunk

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-syntax:
    name: Validate Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Make scripts executable
        run: chmod -R +x scripts/*.sh tools/scripts/**/*.sh tests/integration/*.sh 2>/dev/null || true

      - name: Run CI validation
        run: |
          ./scripts/ci-validate-security-alert.sh | tee ci-validate-results.txt
          exit ${PIPESTATUS[0]}

      - name: Upload validation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-validate-results
          path: ci-validate-results.txt
          retention-days: 7
          if-no-files-found: ignore

  validate-docs:
    name: Validate Docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate docs structure
        run: |
          ERRORS=0
          for doc in README.md; do
            if [ ! -f "$doc" ]; then
              echo "Missing: $doc"
              ERRORS=$((ERRORS + 1))
            else
              echo "Found: $doc"
            fi
          done
          if [ ! -d "security_alert" ]; then
            echo "Missing: security_alert/"
            ERRORS=$((ERRORS + 1))
          else
            echo "Found: security_alert/"
          fi
          [ $ERRORS -eq 0 ] || exit 1

  validate-pre-commit:
    name: Pre-commit Checks
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Run pre-commit
        run: |
          pip install pre-commit -q
          pre-commit run --all-files --show-diff-on-failure || true

  validate-spl:
    name: Validate SPL
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate SPL queries
        run: |
          if [ -f "security_alert/default/savedsearches.conf" ]; then
            echo "savedsearches.conf: $(grep -c '^\[' security_alert/default/savedsearches.conf) stanzas"
          fi
          if [ -f "security_alert/default/macros.conf" ]; then
            echo "macros.conf: $(grep -c '^\[' security_alert/default/macros.conf) stanzas"
          fi

  security-sast:
    name: SAST Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Run Semgrep
        run: |
          pip install semgrep -q
          semgrep scan --config auto --config p/python \
            --exclude third_party --exclude node_modules --exclude python/lib \
            --exclude extras --exclude .cache \
            --json --output semgrep-results.json . || true
          echo "Scan complete"

      - name: Upload SAST results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-results
          path: semgrep-results.json
          retention-days: 7
          if-no-files-found: ignore

  security-secrets:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Detect secrets
        run: |
          pip install detect-secrets -q
          detect-secrets scan --exclude-files 'third_party/.*' \
            --exclude-files 'node_modules/.*' \
            --exclude-files 'python/lib/.*' \
            --exclude-files 'extras/.*' \
            --exclude-files '\.cache/.*' \
            --exclude-files '.*\.json$' \
            . > secrets-results.json 2>&1 || true
          SECRETS=$(grep -c '"is_secret": true' secrets-results.json 2>/dev/null || echo "0")
          echo "Secrets found: $SECRETS"

      - name: Upload secrets results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secrets-results
          path: secrets-results.json
          retention-days: 7
          if-no-files-found: ignore

  security-dependency:
    name: Dependency Audit
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Audit dependencies
        run: |
          pip install pip-audit -q
          if [ -f requirements.txt ]; then
            pip-audit -r requirements.txt --format json -o pip-audit.json 2>/dev/null || true
            echo "Vulnerabilities: $(grep -c '"id":' pip-audit.json 2>/dev/null || echo "0")"
          else
            echo "No requirements.txt"
          fi

      - name: Upload dependency results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-audit
          path: pip-audit.json
          retention-days: 7
          if-no-files-found: ignore

  security-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Generate SBOM
        run: |
          pip install cyclonedx-bom -q
          if [ -f requirements.txt ]; then
            cyclonedx-py requirements requirements.txt -o sbom-python.json --format json 2>/dev/null || true
          else
            echo '{"bomFormat": "CycloneDX", "specVersion": "1.4", "components": []}' > sbom-python.json
          fi

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom
          path: sbom-*.json
          retention-days: 30
          if-no-files-found: ignore

  test-unit-python:
    name: Python Unit Tests
    runs-on: ubuntu-latest
    needs: validate-syntax
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Run pytest
        run: |
          pip install pytest pytest-cov -q
          if [ -d "tests/unit" ]; then
            pytest tests/unit/ -v --tb=short \
              --cov=python --cov-report=xml:coverage-python.xml \
              --cov-report=term 2>&1 | tee pytest-results.txt
          else
            echo "No tests/unit directory" | tee pytest-results.txt
          fi

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-coverage
          path: |
            pytest-results.txt
            coverage-python.xml
          retention-days: 7
          if-no-files-found: ignore

  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: validate-syntax
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install pytest pytest-cov requests -q

      - name: Run E2E tests (no live Splunk)
        run: |
          pytest tests/e2e/ -v --tb=short \
            -m "not splunk_live" \
            --cov=security_alert/bin --cov-report=xml:coverage-e2e.xml \
            --cov-report=term 2>&1 | tee e2e-results.txt
          exit ${PIPESTATUS[0]}

      - name: Upload E2E results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            e2e-results.txt
            coverage-e2e.xml
          retention-days: 7
          if-no-files-found: ignore

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test-unit-python
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Run integration tests
        env:
          SPLUNK_HOST: ${{ secrets.SPLUNK_HOST }}
        run: |
          if [ -n "${SPLUNK_HOST:-}" ]; then
            ./scripts/validate-deployment.sh
          else
            echo "Skipping - no SPLUNK_HOST configured"
          fi

  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [test-unit-python, test-e2e]
    if: always()
    steps:
      - name: Download unit test coverage
        uses: actions/download-artifact@v4
        with:
          name: python-coverage
          path: ./unit
        continue-on-error: true

      - name: Download E2E test coverage
        uses: actions/download-artifact@v4
        with:
          name: e2e-test-results
          path: ./e2e
        continue-on-error: true

      - name: Summary
        run: |
          echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f unit/coverage-python.xml ]; then
            echo "✅ Python unit coverage: Available" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Python unit coverage: Not available" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f e2e/coverage-e2e.xml ]; then
            echo "✅ E2E test coverage: Available" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ E2E test coverage: Not available" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f e2e/e2e-results.txt ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### E2E Test Results" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 e2e/e2e-results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
