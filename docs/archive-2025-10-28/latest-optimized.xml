<form version="1.1" theme="dark">
  <label>ğŸ” FMG/FAZ Security Dashboard (Optimized)</label>
  <description>FortiManager &amp; FortiAnalyzer Monitoring | Slack Alerts Enabled</description>

  <fieldset submitButton="false" autoRun="true">
    <input type="time" token="time_picker" searchWhenChanged="true">
      <label>â° ì‹œê°„ ë²”ìœ„</label>
      <default>
        <earliest>-1h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="device_type" searchWhenChanged="true">
      <label>ğŸ”§ ì¥ë¹„ ìœ í˜•</label>
      <choice value="*">ì „ì²´</choice>
      <choice value="FortiGate*">FortiGate</choice>
      <choice value="FortiManager*">FortiManager</choice>
      <choice value="FortiAnalyzer*">FortiAnalyzer</choice>
      <default>*</default>
    </input>
    <input type="dropdown" token="action_filter" searchWhenChanged="true">
      <label>ğŸš¦ ë°©í™”ë²½ ë™ì‘</label>
      <choice value="*">ì „ì²´</choice>
      <choice value="accept">í—ˆìš© (Accept)</choice>
      <choice value="deny">ì°¨ë‹¨ (Deny)</choice>
      <choice value="drop">ë“œë¡­ (Drop)</choice>
      <default>*</default>
    </input>
  </fieldset>

  <!-- Row 1: í•µì‹¬ ì§€í‘œ (KPI) -->
  <row>
    <panel>
      <single>
        <title>ğŸ“Š ì „ì²´ ì´ë²¤íŠ¸</title>
        <search>
          <query>
index=fw devname=$device_type$
| stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="useThousandSeparators">1</option>
        <option name="underLabel">Total Events</option>
      </single>
    </panel>

    <panel>
      <single>
        <title>âœ… í—ˆìš© íŠ¸ë˜í”½</title>
        <search>
          <query>
index=fw devname=$device_type$ (action=accept OR action=allowed OR action=permit)
| stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="colorBy">value</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x53A051"]</option>
        <option name="useColors">1</option>
        <option name="underLabel">Allowed</option>
      </single>
    </panel>

    <panel>
      <single>
        <title>ğŸš« ì°¨ë‹¨ íŠ¸ë˜í”½</title>
        <search>
          <query>
index=fw devname=$device_type$ (action=deny OR action=drop OR action=blocked OR action=close)
| stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="colorBy">value</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0xDC4E41"]</option>
        <option name="useColors">1</option>
        <option name="underLabel">Blocked</option>
      </single>
    </panel>

    <panel>
      <single>
        <title>ğŸ›¡ï¸ í™œì„± ì •ì±… ìˆ˜</title>
        <search>
          <query>
index=fw type=traffic policyid=* devname=$device_type$
| stats dc(policyid) as policies
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">Active Policies</option>
      </single>
    </panel>

    <panel>
      <single>
        <title>ğŸ“ˆ ì°¨ë‹¨ìœ¨</title>
        <search>
          <query>
index=fw type=traffic devname=$device_type$
| stats count(eval(action="deny" OR action="drop")) as blocked, count as total
| eval percentage = round((blocked/total)*100, 2)
| fields percentage
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">2</option>
        <option name="unit">%</option>
        <option name="underLabel">Block Rate</option>
        <option name="colorBy">value</option>
        <option name="colorMode">block</option>
        <option name="rangeValues">[0,5,10,20]</option>
        <option name="rangeColors">["0x53A051","0xF1813F","0xDC4E41","0x9E2520"]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>

  <!-- Row 2: ì‹œê°„ëŒ€ë³„ íŠ¸ë˜í”½ ì¶”ì´ -->
  <row>
    <panel>
      <title>ğŸ“Š ì‹œê°„ëŒ€ë³„ íŠ¸ë˜í”½ ì¶”ì´</title>
      <chart>
        <search>
          <query>
index=fw devname=$device_type$
| timechart span=5m count by action limit=10
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.axisTitleX.text">ì‹œê°„</option>
        <option name="charting.axisTitleY.text">ì´ë²¤íŠ¸ ìˆ˜</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>
  </row>

  <!-- Row 4: ì •ì±… ê´€ë¦¬ (í†µí•©) - íŠ¸ë˜í”½ + ë³€ê²½ ì´ë ¥ -->
  <row>
    <panel>
      <title>ğŸ” ì •ì±…ë³„ íŠ¸ë˜í”½ (Top 10)</title>
      <table>
        <search>
          <query>
index=fw type=traffic policyid=* action=$action_filter$ devname=$device_type$
| stats count as hits,
        sum(sentbyte) as sent,
        sum(rcvdbyte) as rcvd,
        dc(srcip) as unique_src,
        dc(dstip) as unique_dst
        by policyid, policyname
| eval total_gb = round((sent+rcvd)/1073741824, 2)
| sort -hits limit=10
| table policyid, policyname, hits, total_gb, unique_src, unique_dst
| rename policyid as "ì •ì±… ID", policyname as "ì •ì±… ì´ë¦„", hits as "íˆíŠ¸ ìˆ˜",
         total_gb as "íŠ¸ë˜í”½(GB)", unique_src as "ì¶œë°œì§€ ìˆ˜", unique_dst as "ëª©ì ì§€ ìˆ˜"
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">cell</option>
        <option name="count">10</option>
      </table>
    </panel>

    <panel>
      <title>âš™ï¸ FMG/FAZ ì„¤ì • ë³€ê²½ ì´ë ¥ (ì£¼ì†Œ/ì„œë¹„ìŠ¤/ì •ì±…)</title>
      <table>
        <search>
          <query>
index=fw (cfgpath=firewall.policy OR cfgpath=firewall.rule OR cfgpath=firewall.address OR cfgpath=firewall.addrgrp OR cfgpath=firewall.service OR cfgpath=firewall.servicegrp OR logid=0100044547 OR logid=0100044546 OR logid=0100032001 OR logid=0100032002)
| eval config_hash = md5(cfgpath . policy_obj . policy_attr . user . _time)
| stats first(_time) as _time,
        first(devname) as devname,
        first(user) as user,
        first(action) as action,
        first(cfgpath) as cfgpath,
        first(policy_obj) as policy_obj,
        first(policy_attr) as policy_attr,
        first(ip) as ip
        by config_hash
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| eval mgmt_source = case(
    match(devname, "FortiManager"), "ğŸ”§ FortiManager",
    match(devname, "FortiAnalyzer"), "ğŸ“Š FortiAnalyzer",
    1=1, "ğŸ›¡ï¸ FortiGate"
)
| eval change_type = case(
    match(cfgpath, "firewall.policy") OR match(cfgpath, "firewall.rule"), "ğŸ›¡ï¸ ì •ì±…",
    match(cfgpath, "firewall.address") OR match(cfgpath, "firewall.addrgrp"), "ğŸŒ ì£¼ì†Œ",
    match(cfgpath, "firewall.service") OR match(cfgpath, "firewall.servicegrp"), "ğŸ”Œ ì„œë¹„ìŠ¤",
    1=1, "âš™ï¸ ê¸°íƒ€"
)
| eval change_detail = case(
    isnotnull(policy_obj) AND isnotnull(policy_attr), policy_obj . " â†’ " . policy_attr,
    isnotnull(policy_obj), policy_obj,
    1=1, "ì„¤ì • ë³€ê²½"
)
| sort -_time limit=20
| table timestamp, mgmt_source, change_type, user, action, change_detail, ip
| rename timestamp as "ë³€ê²½ ì‹œê°", mgmt_source as "ê´€ë¦¬ ì¶œì²˜", change_type as "ë³€ê²½ ìœ í˜•", user as "ì‚¬ìš©ì",
         action as "ì‘ì—…", change_detail as "ë³€ê²½ ë‚´ìš©", ip as "ê´€ë¦¬ IP"
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="count">20</option>
      </table>
    </panel>
  </row>

  <!-- Row 6: Top ì¶œë°œì§€/ëª©ì ì§€ IP -->
  <row>
    <panel>
      <title>ğŸŒ Top ì¶œë°œì§€ IP (Source)</title>
      <table>
        <search>
          <query>
index=fw type=traffic srcip=* devname=$device_type$
| stats count as connections,
        sum(sentbyte) as sent_bytes,
        dc(dstip) as unique_dst,
        values(action) as actions
        by srcip
| eval sent_mb = round(sent_bytes/1048576, 2)
| sort -connections limit=10
| table srcip, connections, sent_mb, unique_dst, actions
| rename srcip as "ì¶œë°œì§€ IP", connections as "ì—°ê²° ìˆ˜", sent_mb as "ì „ì†¡ëŸ‰(MB)",
         unique_dst as "ëª©ì ì§€ ìˆ˜", actions as "ë™ì‘"
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">cell</option>
        <option name="count">10</option>
      </table>
    </panel>

    <panel>
      <title>ğŸ¯ Top ëª©ì ì§€ IP (Destination)</title>
      <table>
        <search>
          <query>
index=fw type=traffic dstip=* devname=$device_type$
| stats count as connections,
        sum(rcvdbyte) as rcvd_bytes,
        dc(srcip) as unique_src,
        dc(dstport) as unique_ports
        by dstip
| eval rcvd_mb = round(rcvd_bytes/1048576, 2)
| sort -connections limit=10
| table dstip, connections, rcvd_mb, unique_src, unique_ports
| rename dstip as "ëª©ì ì§€ IP", connections as "ì—°ê²° ìˆ˜", rcvd_mb as "ìˆ˜ì‹ ëŸ‰(MB)",
         unique_src as "ì¶œë°œì§€ ìˆ˜", unique_ports as "í¬íŠ¸ ìˆ˜"
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">cell</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>

  <!-- Row 7: ë³´ì•ˆ ìœ„í˜‘ ë¶„ì„ -->
  <row>
    <panel>
      <title>âš ï¸ ë³´ì•ˆ ìœ„í˜‘ ë¡œê·¸ (IPS/UTM)</title>
      <table>
        <search>
          <query>
index=fw (type=utm OR type=ips OR attack=* OR threat=*) devname=$device_type$
| eval severity_level = case(
    level="critical" OR level="emergency", "ğŸ”´ Critical",
    level="alert" OR level="warning", "ğŸŸ¡ High",
    level="notice", "ğŸŸ¢ Medium",
    1=1, "âšª Low"
)
| stats count as event_count,
        dc(srcip) as unique_sources,
        values(attack) as attacks,
        values(threat) as threats
        by severity_level
| sort -event_count
| table severity_level, event_count, unique_sources, attacks, threats
| rename severity_level as "ìœ„í˜‘ ìˆ˜ì¤€", event_count as "ì´ë²¤íŠ¸ ìˆ˜",
         unique_sources as "ì¶œë°œì§€ ìˆ˜", attacks as "ê³µê²© ìœ í˜•", threats as "ìœ„í˜‘ ìœ í˜•"
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>

  <!-- Row 8: ìƒì„¸ ë¡œê·¸ (ìµœê·¼ 100ê±´) -->
  <row>
    <panel>
      <title>ğŸ“‹ ìµœê·¼ ë¡œê·¸ (Latest 100 Events)</title>
      <table>
        <search>
          <query>
index=fw devname=$device_type$ action=$action_filter$
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| table timestamp, devname, srcip, srcport, dstip, dstport, action, policyid, service, app
| rename timestamp as "ì‹œê°", devname as "ì¥ë¹„", srcip as "ì¶œë°œì§€", srcport as "ì¶œë°œì§€í¬íŠ¸",
         dstip as "ëª©ì ì§€", dstport as "ëª©ì ì§€í¬íŠ¸", action as "ë™ì‘",
         policyid as "ì •ì±…ID", service as "ì„œë¹„ìŠ¤", app as "ì• í”Œë¦¬ì¼€ì´ì…˜"
| head 100
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <option name="count">20</option>
        <option name="showPager">true</option>
      </table>
    </panel>
  </row>

</form>
