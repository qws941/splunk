<dashboard version="1.1" theme="dark">
  <label>ğŸ¢ Fortinet í†µí•© ë³´ì•ˆ ê´€ë¦¬ì„¼í„°</label>
  <description>FortiGate(80+) + FortiManager + FortiAnalyzer í†µí•© ì‹œê°í™”</description>

  <!-- Enhanced Global Controls -->
  <fieldset submitButton="false" autoRun="true">
    <input type="time" token="time_picker" searchWhenChanged="true">
      <label>ğŸ“… ì‹œê°„ ë²”ìœ„</label>
      <default>
        <earliest>-4h@h</earliest>
        <latest>now</latest>
      </default>
    </input>

    <input type="dropdown" token="severity_filter" searchWhenChanged="true">
      <label>ğŸš¨ ì‹¬ê°ë„ í•„í„°</label>
      <choice value="*">ì „ì²´</choice>
      <choice value="critical">Critical</choice>
      <choice value="high">High</choice>
      <choice value="medium">Medium</choice>
      <default>*</default>
    </input>

    <input type="dropdown" token="device_filter" searchWhenChanged="true">
      <label>ğŸ–¥ï¸ ì¥ë¹„ í•„í„°</label>
      <choice value="*">ì „ì²´ ì¥ë¹„</choice>
      <choice value="FortiManager">FortiManager</choice>
      <choice value="FortiAnalyzer">FortiAnalyzer</choice>
      <choice value="FortiGate*">FortiGate</choice>
      <default>*</default>
    </input>
  </fieldset>

  <!-- Executive Summary Row with Enhanced KPIs -->
  <row>
    <panel>
      <title>ğŸ¢ ì´ ê´€ë¦¬ ì¥ë¹„</title>
      <single>
        <search>
          <query>
            index=fw devname=$device_filter$
            | stats dc(devname) as total_devices
            | eval display_value = total_devices + " ëŒ€"
            | fields display_value
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="useThousandSeparators">1</option>
        <option name="colorBy">value</option>
        <option name="rangeColors">["0x53A051","0xF8BE34","0xDC4E41"]</option>
        <option name="rangeValues">[50,70,80]</option>
        <option name="useColors">1</option>
      </single>
    </panel>

    <panel>
      <title>âš¡ ì‹¤ì‹œê°„ ì •ì±… ë³€ê²½</title>
      <single>
        <search>
          <query>
            index=fw (source_system="FortiManager" OR logid="0100044547" OR cfgpath="firewall.policy")
            priority=$severity_filter$ devname=$device_filter$
            | stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">detail</option>
        <option name="colorBy">trend</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendInterval">auto</option>
      </single>
    </panel>

    <panel>
      <title>ğŸ›¡ï¸ ìœ„í˜‘ íƒì§€ (FAZ)</title>
      <single>
        <search>
          <query>
            index=fw (source_system="FortiAnalyzer" OR sourcetype="fortianalyzer:*")
            severity=$severity_filter$ devname=$device_filter$
            | stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">detail</option>
        <option name="colorBy">value</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[0,10,50,100]</option>
      </single>
    </panel>

    <panel>
      <title>ğŸ“Š ì‹œìŠ¤í…œ ê±´ì „ì„±</title>
      <single>
        <search>
          <query>
            index=fw level!="critical" level!="emergency" devname=$device_filter$
            | stats count as healthy_events,
                    sum(eval(if(level="critical" OR level="emergency",1,0))) as critical_events
            | eval health_score = round((healthy_events/(healthy_events+critical_events))*100,1)
            | eval display_value = health_score + "%"
            | fields display_value
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="rangeColors">["0xDC4E41","0xF8BE34","0x53A051"]</option>
        <option name="rangeValues">[80,95,100]</option>
      </single>
    </panel>
  </row>

  <!-- Enhanced Visual Hierarchy: System Architecture -->
  <row>
    <panel span="12">
      <title>ğŸ—ï¸ Fortinet ìƒíƒœê³„ ì•„í‚¤í…ì²˜ ìƒíƒœ</title>
      <viz type="status_indicator_app.status_indicator">
        <search>
          <query>
            | makeresults count=3
            | eval system=case(
                _serial=0, "FortiManager",
                _serial=1, "FortiAnalyzer",
                _serial=2, "FortiGate Cluster"
              ),
              status=case(
                _serial=0, "operational",
                _serial=1, "operational",
                _serial=2, "operational"
              ),
              devices=case(
                _serial=0, 1,
                _serial=1, 1,
                _serial=2, 80
              ),
              color=case(
                status="operational", "#53A051",
                status="warning", "#F8BE34",
                1=1, "#DC4E41"
              )
          </query>
        </search>
        <option name="status_indicator_app.status_indicator.colorBy">field_value</option>
        <option name="status_indicator_app.status_indicator.fillColor">color</option>
      </viz>
    </panel>
  </row>

  <!-- Interactive Timeline with Drill-Down -->
  <row>
    <panel span="12">
      <title>ğŸ“ˆ ì‹¤ì‹œê°„ ë³´ì•ˆ ì´ë²¤íŠ¸ íƒ€ì„ë¼ì¸ (Interactive)</title>
      <chart>
        <search>
          <query>
            index=fw devname=$device_filter$
            | eval event_category = case(
                match(_raw, "cfgpath") OR source_system="FortiManager", "ì •ì±…ê´€ë¦¬",
                match(_raw, "critical") OR level="critical", "ìœ„í—˜ì´ë²¤íŠ¸",
                source_system="FortiAnalyzer", "ìœ„í˜‘ë¶„ì„",
                match(_raw, "schedule"), "ìŠ¤ì¼€ì¤„ì‘ì—…",
                1=1, "ì‹œìŠ¤í…œì´ë²¤íŠ¸"
              )
            | timechart span=5m count by event_category
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
          <refresh>30s</refresh>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.axisTitleY.text">ì´ë²¤íŠ¸ ìˆ˜</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.fieldColors">{"ì •ì±…ê´€ë¦¬":"#FF6B6B","ìœ„í—˜ì´ë²¤íŠ¸":"#DC4E41","ìœ„í˜‘ë¶„ì„":"#4ECDC4","ìŠ¤ì¼€ì¤„ì‘ì—…":"#87CEEB","ì‹œìŠ¤í…œì´ë²¤íŠ¸":"#DDA0DD"}</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.drilldown">all</option>
        <drilldown>
          <set token="drill_time_earliest">$click.timespan.earliest$</set>
          <set token="drill_time_latest">$click.timespan.latest$</set>
          <set token="drill_category">$click.name2$</set>
        </drilldown>
      </chart>
    </panel>
  </row>

  <!-- Enhanced Configuration Management with No RegEx -->
  <row>
    <panel span="8">
      <title>ğŸ”§ ì„¤ì • ë³€ê²½ ì¶”ì  (êµ¬ì¡°í™”ëœ ë°ì´í„° - RegEx ë¶ˆí•„ìš”)</title>
      <table>
        <search>
          <query>
            index=fw (
              (source_system="FortiManager" cfg_path_parsed=*) OR
              (logid="0100044547" OR logid="0100044546" OR logid="0100044548")
            ) devname=$device_filter$

            | eval
              timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S"),
              config_path = coalesce(cfg_path_parsed, 'firewall.policy'),
              config_object = coalesce(cfg_object_parsed, cfgobj, 'unknown'),
              parsed_attribute = coalesce(cfg_attribute_parsed.action, cfgattr, 'unknown'),
              change_category = coalesce(task_category, 'ì¼ë°˜ë³€ê²½')

            | eval path_category = case(
                match(config_path, "firewall\.policy"), "ğŸ”¥ ë°©í™”ë²½ ì •ì±…",
                match(config_path, "system\.admin"), "ğŸ‘¤ ê´€ë¦¬ì ê³„ì •",
                match(config_path, "system\.interface"), "ğŸŒ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤",
                match(config_path, "vpn\."), "ğŸ”’ VPN ì„¤ì •",
                1=1, "âš™ï¸ " + config_path
              )

            | table timestamp, devname, user, change_category, path_category, config_object, parsed_attribute, access_method, msg
            | rename timestamp AS "ì‹œê°„",
                     devname AS "ì¥ë¹„",
                     user AS "ê´€ë¦¬ì",
                     change_category AS "ë³€ê²½ë¶„ë¥˜",
                     path_category AS "ì„¤ì •ì˜ì—­",
                     config_object AS "ê°ì²´ëª…",
                     parsed_attribute AS "ë³€ê²½ê°’",
                     access_method AS "ì ‘ì†ë°©ë²•",
                     msg AS "ìƒì„¸ë‚´ìš©"
            | sort -ì‹œê°„
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">20</option>
        <option name="drilldown">cell</option>
        <option name="wrap">true</option>
        <option name="dataOverlayMode">none</option>
        <format type="color" field="ë³€ê²½ë¶„ë¥˜">
          <colorPalette type="map">{"ì •ì±…ê´€ë¦¬":#FF6B6B,"ê´€ë¦¬ìí™œë™":#4ECDC4,"ì¥ë¹„ìƒíƒœ":#45B7D1,"ì„¤ì •ë°°í¬":#96CEB4}</colorPalette>
        </format>
      </table>
    </panel>

    <panel span="4">
      <title>ğŸ“Š ì„¤ì • ë³€ê²½ íˆíŠ¸ë§µ</title>
      <viz type="calendar_heatmap_app.calendar_heatmap">
        <search>
          <query>
            index=fw (source_system="FortiManager" OR logid="0100044547") devname=$device_filter$
            | eval date = strftime(_time, "%Y-%m-%d")
            | stats count by date
            | sort date
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
      </viz>
    </panel>
  </row>

  <!-- Policy Analysis with Advanced Visualization -->
  <row>
    <panel span="6">
      <title>ğŸ¯ ì •ì±… ë³€ê²½ íŒ¨í„´ ë¶„ì„</title>
      <viz type="sankey_diagram_app.sankey_diagram">
        <search>
          <query>
            index=fw source_system="FortiManager" cfg_path_parsed="firewall.policy" devname=$device_filter$
            | eval
              source_category = case(
                match(cfg_attribute_parsed.srcaddr, "any"), "Any Source",
                match(cfg_attribute_parsed.srcaddr, "Internal"), "Internal Network",
                1=1, "External Source"
              ),
              dest_category = case(
                match(cfg_attribute_parsed.dstaddr, "any"), "Any Destination",
                match(cfg_attribute_parsed.dstaddr, "Internal"), "Internal Systems",
                1=1, "External Destination"
              ),
              action_result = cfg_attribute_parsed.action
            | stats count by source_category, dest_category, action_result
            | eval link = source_category + " -> " + dest_category + " -> " + action_result
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
      </viz>
    </panel>

    <panel span="6">
      <title>âš¡ ì‹¤ì‹œê°„ ìœ„í—˜ ìˆ˜ì¤€ ê²Œì´ì§€</title>
      <single>
        <search>
          <query>
            index=fw (level="critical" OR level="emergency" OR priority="critical") devname=$device_filter$
            | stats count as critical_events
            | eval risk_level = case(
                critical_events=0, 0,
                critical_events&lt;5, 25,
                critical_events&lt;15, 50,
                critical_events&lt;30, 75,
                1=1, 100
              )
            | fields risk_level
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
          <refresh>15s</refresh>
        </search>
        <option name="drilldown">none</option>
        <option name="colorBy">value</option>
        <option name="rangeColors">["0x53A051","0xF8BE34","0xF58F39","0xDC4E41"]</option>
        <option name="rangeValues">[25,50,75,100]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>

  <!-- Mobile-Optimized Critical Alerts -->
  <row>
    <panel span="12">
      <title>ğŸš¨ Critical ì´ë²¤íŠ¸ ì•Œë¦¼ì„¼í„° (ëª¨ë°”ì¼ ìµœì í™”)</title>
      <table>
        <search>
          <query>
            index=fw (level="critical" OR level="emergency" OR priority="critical") devname=$device_filter$
            NOT ("update fail" OR "update failed")
            | eval
              timestamp = strftime(_time, "%m/%d %H:%M"),
              severity_icon = case(
                level="emergency", "ğŸ”´",
                level="critical", "ğŸŸ ",
                priority="critical", "âš ï¸",
                1=1, "â„¹ï¸"
              ),
              device_type = case(
                source_system="FortiManager", "FMG",
                source_system="FortiAnalyzer", "FAZ",
                1=1, "FG"
              ),
              short_message = substr(coalesce(generateDetailedMessage, msg, logdesc), 1, 80) + "..."
            | table timestamp, severity_icon, device_type, devname, user, short_message
            | rename timestamp AS "ì‹œê°",
                     severity_icon AS "ë“±ê¸‰",
                     device_type AS "ìœ í˜•",
                     devname AS "ì¥ë¹„",
                     user AS "ì‚¬ìš©ì",
                     short_message AS "ì•Œë¦¼ë‚´ìš©"
            | sort -ì‹œê°
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
          <refresh>10s</refresh>
        </search>
        <option name="count">10</option>
        <option name="wrap">false</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <format type="color" field="ë“±ê¸‰">
          <colorPalette type="map">{"ğŸ”´":#FF0000,"ğŸŸ ":#FF6600,"âš ï¸":#FFCC00,"â„¹ï¸":#0099FF}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

</dashboard>