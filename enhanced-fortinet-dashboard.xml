<dashboard version="1.1" theme="dark">
  <label>🏢 Fortinet 통합 보안 관리센터</label>
  <description>FortiGate(80+) + FortiManager + FortiAnalyzer 통합 시각화</description>

  <!-- Enhanced Global Controls -->
  <fieldset submitButton="false" autoRun="true">
    <input type="time" token="time_picker" searchWhenChanged="true">
      <label>📅 시간 범위</label>
      <default>
        <earliest>-4h@h</earliest>
        <latest>now</latest>
      </default>
    </input>

    <input type="dropdown" token="severity_filter" searchWhenChanged="true">
      <label>🚨 심각도 필터</label>
      <choice value="*">전체</choice>
      <choice value="critical">Critical</choice>
      <choice value="high">High</choice>
      <choice value="medium">Medium</choice>
      <default>*</default>
    </input>

    <input type="dropdown" token="device_filter" searchWhenChanged="true">
      <label>🖥️ 장비 필터</label>
      <choice value="*">전체 장비</choice>
      <choice value="FortiManager">FortiManager</choice>
      <choice value="FortiAnalyzer">FortiAnalyzer</choice>
      <choice value="FortiGate*">FortiGate</choice>
      <default>*</default>
    </input>
  </fieldset>

  <!-- Executive Summary Row with Enhanced KPIs -->
  <row>
    <panel>
      <title>🏢 총 관리 장비</title>
      <single>
        <search>
          <query>
            index=fw devname=$device_filter$
            | stats dc(devname) as total_devices
            | eval display_value = total_devices + " 대"
            | fields display_value
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="useThousandSeparators">1</option>
        <option name="colorBy">value</option>
        <option name="rangeColors">["0x53A051","0xF8BE34","0xDC4E41"]</option>
        <option name="rangeValues">[50,70,80]</option>
        <option name="useColors">1</option>
      </single>
    </panel>

    <panel>
      <title>⚡ 실시간 정책 변경</title>
      <single>
        <search>
          <query>
            index=fw (source_system="FortiManager" OR logid="0100044547" OR cfgpath="firewall.policy")
            priority=$severity_filter$ devname=$device_filter$
            | stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">detail</option>
        <option name="colorBy">trend</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="showTrendIndicator">1</option>
        <option name="trendInterval">auto</option>
      </single>
    </panel>

    <panel>
      <title>🛡️ 위협 탐지 (FAZ)</title>
      <single>
        <search>
          <query>
            index=fw (source_system="FortiAnalyzer" OR sourcetype="fortianalyzer:*")
            severity=$severity_filter$ devname=$device_filter$
            | stats count
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="drilldown">detail</option>
        <option name="colorBy">value</option>
        <option name="rangeColors">["0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[0,10,50,100]</option>
      </single>
    </panel>

    <panel>
      <title>📊 시스템 건전성</title>
      <single>
        <search>
          <query>
            index=fw level!="critical" level!="emergency" devname=$device_filter$
            | stats count as healthy_events,
                    sum(eval(if(level="critical" OR level="emergency",1,0))) as critical_events
            | eval health_score = round((healthy_events/(healthy_events+critical_events))*100,1)
            | eval display_value = health_score + "%"
            | fields display_value
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="colorBy">value</option>
        <option name="rangeColors">["0xDC4E41","0xF8BE34","0x53A051"]</option>
        <option name="rangeValues">[80,95,100]</option>
      </single>
    </panel>
  </row>

  <!-- Enhanced Visual Hierarchy: System Architecture -->
  <row>
    <panel span="12">
      <title>🏗️ Fortinet 생태계 아키텍처 상태</title>
      <viz type="status_indicator_app.status_indicator">
        <search>
          <query>
            | makeresults count=3
            | eval system=case(
                _serial=0, "FortiManager",
                _serial=1, "FortiAnalyzer",
                _serial=2, "FortiGate Cluster"
              ),
              status=case(
                _serial=0, "operational",
                _serial=1, "operational",
                _serial=2, "operational"
              ),
              devices=case(
                _serial=0, 1,
                _serial=1, 1,
                _serial=2, 80
              ),
              color=case(
                status="operational", "#53A051",
                status="warning", "#F8BE34",
                1=1, "#DC4E41"
              )
          </query>
        </search>
        <option name="status_indicator_app.status_indicator.colorBy">field_value</option>
        <option name="status_indicator_app.status_indicator.fillColor">color</option>
      </viz>
    </panel>
  </row>

  <!-- Interactive Timeline with Drill-Down -->
  <row>
    <panel span="12">
      <title>📈 실시간 보안 이벤트 타임라인 (Interactive)</title>
      <chart>
        <search>
          <query>
            index=fw devname=$device_filter$
            | eval event_category = case(
                match(_raw, "cfgpath") OR source_system="FortiManager", "정책관리",
                match(_raw, "critical") OR level="critical", "위험이벤트",
                source_system="FortiAnalyzer", "위협분석",
                match(_raw, "schedule"), "스케줄작업",
                1=1, "시스템이벤트"
              )
            | timechart span=5m count by event_category
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
          <refresh>30s</refresh>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.axisTitleY.text">이벤트 수</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.fieldColors">{"정책관리":"#FF6B6B","위험이벤트":"#DC4E41","위협분석":"#4ECDC4","스케줄작업":"#87CEEB","시스템이벤트":"#DDA0DD"}</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.drilldown">all</option>
        <drilldown>
          <set token="drill_time_earliest">$click.timespan.earliest$</set>
          <set token="drill_time_latest">$click.timespan.latest$</set>
          <set token="drill_category">$click.name2$</set>
        </drilldown>
      </chart>
    </panel>
  </row>

  <!-- Enhanced Configuration Management with No RegEx -->
  <row>
    <panel span="8">
      <title>🔧 설정 변경 추적 (구조화된 데이터 - RegEx 불필요)</title>
      <table>
        <search>
          <query>
            index=fw (
              (source_system="FortiManager" cfg_path_parsed=*) OR
              (logid="0100044547" OR logid="0100044546" OR logid="0100044548")
            ) devname=$device_filter$

            | eval
              timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S"),
              config_path = coalesce(cfg_path_parsed, 'firewall.policy'),
              config_object = coalesce(cfg_object_parsed, cfgobj, 'unknown'),
              parsed_attribute = coalesce(cfg_attribute_parsed.action, cfgattr, 'unknown'),
              change_category = coalesce(task_category, '일반변경')

            | eval path_category = case(
                match(config_path, "firewall\.policy"), "🔥 방화벽 정책",
                match(config_path, "system\.admin"), "👤 관리자 계정",
                match(config_path, "system\.interface"), "🌐 네트워크 인터페이스",
                match(config_path, "vpn\."), "🔒 VPN 설정",
                1=1, "⚙️ " + config_path
              )

            | table timestamp, devname, user, change_category, path_category, config_object, parsed_attribute, access_method, msg
            | rename timestamp AS "시간",
                     devname AS "장비",
                     user AS "관리자",
                     change_category AS "변경분류",
                     path_category AS "설정영역",
                     config_object AS "객체명",
                     parsed_attribute AS "변경값",
                     access_method AS "접속방법",
                     msg AS "상세내용"
            | sort -시간
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
        <option name="count">20</option>
        <option name="drilldown">cell</option>
        <option name="wrap">true</option>
        <option name="dataOverlayMode">none</option>
        <format type="color" field="변경분류">
          <colorPalette type="map">{"정책관리":#FF6B6B,"관리자활동":#4ECDC4,"장비상태":#45B7D1,"설정배포":#96CEB4}</colorPalette>
        </format>
      </table>
    </panel>

    <panel span="4">
      <title>📊 설정 변경 히트맵</title>
      <viz type="calendar_heatmap_app.calendar_heatmap">
        <search>
          <query>
            index=fw (source_system="FortiManager" OR logid="0100044547") devname=$device_filter$
            | eval date = strftime(_time, "%Y-%m-%d")
            | stats count by date
            | sort date
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
      </viz>
    </panel>
  </row>

  <!-- Policy Analysis with Advanced Visualization -->
  <row>
    <panel span="6">
      <title>🎯 정책 변경 패턴 분석</title>
      <viz type="sankey_diagram_app.sankey_diagram">
        <search>
          <query>
            index=fw source_system="FortiManager" cfg_path_parsed="firewall.policy" devname=$device_filter$
            | eval
              source_category = case(
                match(cfg_attribute_parsed.srcaddr, "any"), "Any Source",
                match(cfg_attribute_parsed.srcaddr, "Internal"), "Internal Network",
                1=1, "External Source"
              ),
              dest_category = case(
                match(cfg_attribute_parsed.dstaddr, "any"), "Any Destination",
                match(cfg_attribute_parsed.dstaddr, "Internal"), "Internal Systems",
                1=1, "External Destination"
              ),
              action_result = cfg_attribute_parsed.action
            | stats count by source_category, dest_category, action_result
            | eval link = source_category + " -> " + dest_category + " -> " + action_result
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
        </search>
      </viz>
    </panel>

    <panel span="6">
      <title>⚡ 실시간 위험 수준 게이지</title>
      <single>
        <search>
          <query>
            index=fw (level="critical" OR level="emergency" OR priority="critical") devname=$device_filter$
            | stats count as critical_events
            | eval risk_level = case(
                critical_events=0, 0,
                critical_events&lt;5, 25,
                critical_events&lt;15, 50,
                critical_events&lt;30, 75,
                1=1, 100
              )
            | fields risk_level
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
          <refresh>15s</refresh>
        </search>
        <option name="drilldown">none</option>
        <option name="colorBy">value</option>
        <option name="rangeColors">["0x53A051","0xF8BE34","0xF58F39","0xDC4E41"]</option>
        <option name="rangeValues">[25,50,75,100]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>

  <!-- Mobile-Optimized Critical Alerts -->
  <row>
    <panel span="12">
      <title>🚨 Critical 이벤트 알림센터 (모바일 최적화)</title>
      <table>
        <search>
          <query>
            index=fw (level="critical" OR level="emergency" OR priority="critical") devname=$device_filter$
            NOT ("update fail" OR "update failed")
            | eval
              timestamp = strftime(_time, "%m/%d %H:%M"),
              severity_icon = case(
                level="emergency", "🔴",
                level="critical", "🟠",
                priority="critical", "⚠️",
                1=1, "ℹ️"
              ),
              device_type = case(
                source_system="FortiManager", "FMG",
                source_system="FortiAnalyzer", "FAZ",
                1=1, "FG"
              ),
              short_message = substr(coalesce(generateDetailedMessage, msg, logdesc), 1, 80) + "..."
            | table timestamp, severity_icon, device_type, devname, user, short_message
            | rename timestamp AS "시각",
                     severity_icon AS "등급",
                     device_type AS "유형",
                     devname AS "장비",
                     user AS "사용자",
                     short_message AS "알림내용"
            | sort -시각
          </query>
          <earliest>$time_picker.earliest$</earliest>
          <latest>$time_picker.latest$</latest>
          <refresh>10s</refresh>
        </search>
        <option name="count">10</option>
        <option name="wrap">false</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <format type="color" field="등급">
          <colorPalette type="map">{"🔴":#FF0000,"🟠":#FF6600,"⚠️":#FFCC00,"ℹ️":#0099FF}</colorPalette>
        </format>
      </table>
    </panel>
  </row>

</dashboard>