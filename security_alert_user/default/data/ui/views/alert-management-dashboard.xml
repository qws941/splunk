<form version="1.1" theme="dark">
  <label>Alert Management Dashboard</label>
  <description>Manage dynamically created alerts</description>

  <fieldset submitButton="false" autoRun="true">
    <input type="text" token="search_filter" searchWhenChanged="true">
      <label>Search Alerts</label>
      <default>*</default>
    </input>
  </fieldset>

  <!-- Summary Statistics -->
  <row>
    <panel>
      <title>Total Dynamic Alerts</title>
      <single>
        <search>
          <query>| rest /services/saved/searches splunk_server=local
| search title=Custom_* OR title=Alert_*
| stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
      </single>
    </panel>

    <panel>
      <title>Enabled Alerts</title>
      <single>
        <query>| rest /services/saved/searches splunk_server=local
| search title=Custom_* OR title=Alert_*
| search disabled=0
| stats count</query>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">Active</option>
      </single>
    </panel>

    <panel>
      <title>Alerts Triggered (Last 24h)</title>
      <single>
        <query>index=_audit action=alert_fired earliest=-24h
| search savedsearch_name=Custom_* OR savedsearch_name=Alert_*
| stats count</query>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">Triggered</option>
      </single>
    </panel>
  </row>

  <!-- Alert List -->
  <row>
    <panel>
      <title>Dynamic Alerts (Click row to edit, Click "ğŸ—‘ï¸ Delete" to remove)</title>
      <table>
        <search>
          <query>| rest /services/saved/searches splunk_server=local
| search title=Custom_* OR title=Alert_*
| search title="*$search_filter$*"
| eval enabled = if(disabled=0, "âœ… Enabled", "âŒ Disabled")
| eval slack_channel = 'action.slack_blockkit.param.channel'
| eval severity = 'action.slack_blockkit.param.severity'
| eval last_run = strftime(strptime('next_scheduled_time', "%Y-%m-%dT%H:%M:%S%z"), "%Y-%m-%d %H:%M:%S")
| eval delete_button = "ğŸ—‘ï¸ Delete"
| table title, description, enabled, slack_channel, severity, cron_schedule, last_run, delete_button
| rename title as "Alert Name", description as "Description", enabled as "Status", slack_channel as "Slack Channel", severity as "Severity", cron_schedule as "Schedule", last_run as "Next Run"</query>
        </search>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <condition field="delete_button">
            <eval token="alert_to_delete">$row.Alert Name$</eval>
            <set token="show_delete_confirm">true</set>
          </condition>
          <condition field="*">
            <link target="_blank">/app/security_alert/alert_editor?alert_name=$row.Alert Name$</link>
          </condition>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Alert Activity History -->
  <row>
    <panel>
      <title>Alert Trigger History (Last 7 days)</title>
      <chart>
        <query>index=_audit action=alert_fired earliest=-7d
| search savedsearch_name=Custom_* OR savedsearch_name=Alert_*
| timechart count by savedsearch_name
| rename savedsearch_name as "Alert Name"</query>
        <option name="charting.chart">column</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.drilldown">all</option>
      </chart>
    </panel>

    <panel>
      <title>Top Triggered Alerts</title>
      <chart>
        <query>index=_audit action=alert_fired earliest=-7d
| search savedsearch_name=Custom_* OR savedsearch_name=Alert_*
| stats count by savedsearch_name
| sort -count
| head 10
| rename savedsearch_name as "Alert Name"</query>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">all</option>
      </chart>
    </panel>
  </row>

  <!-- Recent Alert Results -->
  <row>
    <panel>
      <title>Recent Alert Triggers (Last 24 hours)</title>
      <table>
        <query>index=_audit action=alert_fired earliest=-24h
| search savedsearch_name=Custom_* OR savedsearch_name=Alert_*
| eval timestamp = strftime(_time, "%Y-%m-%d %H:%M:%S")
| table timestamp, savedsearch_name, user, result_count
| rename timestamp as "Time", savedsearch_name as "Alert Name", user as "Triggered By", result_count as "Event Count"
| sort -Time</query>
        <option name="drilldown">none</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

  <!-- Delete Confirmation Modal (simulated) -->
  <row depends="$show_delete_confirm$">
    <panel>
      <title>âš ï¸ Confirm Delete</title>
      <html>
        <div style="background-color: #fff3cd; padding: 20px; border-radius: 5px; border: 2px solid #ffc107;">
          <h3>Are you sure you want to delete this alert?</h3>
          <p><strong>Alert Name:</strong> $alert_to_delete$</p>
          <p>This action cannot be undone.</p>

          <button onclick="deleteAlert()" style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; cursor: pointer; border-radius: 5px; margin-right: 10px;">
            ğŸ—‘ï¸ Yes, Delete
          </button>

          <button onclick="cancelDelete()" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; cursor: pointer; border-radius: 5px;">
            âŒ Cancel
          </button>

          <div id="delete_status" style="margin-top: 15px; font-weight: bold;"></div>
        </div>

        <script>
          function deleteAlert() {
            const alertName = "$alert_to_delete$";

            fetch(`/servicesNS/nobody/security_alert/saved/searches/${encodeURIComponent(alertName)}`, {
              method: 'DELETE',
              headers: {
                'X-Splunk-Form-Key': window.SPLUNK_FORM_KEY || '',
                'Content-Type': 'application/json'
              }
            }).then(response => {
              if (response.ok) {
                document.getElementById('delete_status').innerHTML = 'âœ… Alert deleted successfully! Refreshing...';
                document.getElementById('delete_status').style.color = 'green';
                setTimeout(() => window.location.reload(), 2000);
              } else {
                document.getElementById('delete_status').innerHTML = 'âŒ Delete failed: ' + response.statusText;
                document.getElementById('delete_status').style.color = 'red';
              }
            }).catch(error => {
              document.getElementById('delete_status').innerHTML = 'âŒ Error: ' + error.message;
              document.getElementById('delete_status').style.color = 'red';
            });
          }

          function cancelDelete() {
            window.location.reload();
          }
        </script>
      </html>
    </panel>
  </row>

  <!-- Quick Actions -->
  <row>
    <panel>
      <title>Quick Actions</title>
      <html>
        <div style="padding: 20px; background-color: #e3f2fd; border-radius: 5px;">
          <h3>ğŸš€ Quick Actions</h3>

          <button onclick="window.location.href='/app/security_alert/alert_builder'" style="padding: 10px 20px; background-color: #2196F3; color: white; border: none; cursor: pointer; border-radius: 5px; margin: 5px;">
            â• Create New Alert
          </button>

          <button onclick="window.location.href='/app/security_alert/data_explorer'" style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px; margin: 5px;">
            ğŸ“Š Explore Data (index=fw)
          </button>

          <button onclick="enableAllAlerts()" style="padding: 10px 20px; background-color: #ff9800; color: white; border: none; cursor: pointer; border-radius: 5px; margin: 5px;">
            âœ… Enable All Dynamic Alerts
          </button>

          <button onclick="disableAllAlerts()" style="padding: 10px 20px; background-color: #f44336; color: white; border: none; cursor: pointer; border-radius: 5px; margin: 5px;">
            â¸ï¸ Disable All Dynamic Alerts
          </button>

          <div id="bulk_action_status" style="margin-top: 10px; font-weight: bold;"></div>
        </div>

        <script>
          function enableAllAlerts() {
            updateAllAlerts('enable');
          }

          function disableAllAlerts() {
            updateAllAlerts('disable');
          }

          function updateAllAlerts(action) {
            const statusDiv = document.getElementById('bulk_action_status');
            statusDiv.innerHTML = `â³ ${action === 'enable' ? 'Enabling' : 'Disabling'} all dynamic alerts...`;
            statusDiv.style.color = '#ff9800';

            // This would need actual implementation via REST API
            // For now, showing placeholder
            setTimeout(() => {
              statusDiv.innerHTML = `âš ï¸ Bulk ${action} not yet implemented. Please enable/disable alerts individually.`;
              statusDiv.style.color = '#f44336';
            }, 1000);
          }
        </script>
      </html>
    </panel>
  </row>

  <!-- Instructions -->
  <row>
    <panel>
      <title>ğŸ“– How to Manage Alerts</title>
      <html>
        <div style="padding: 15px; background-color: #f5f5f5; border-radius: 5px;">
          <h3>Managing Your Dynamic Alerts</h3>
          <ul>
            <li><strong>Create:</strong> Click "â• Create New Alert" or explore data in Data Explorer and click on rows</li>
            <li><strong>Edit:</strong> Click on any alert row to edit its configuration</li>
            <li><strong>Delete:</strong> Click "ğŸ—‘ï¸ Delete" button in the alert row</li>
            <li><strong>Enable/Disable:</strong> Edit the alert and toggle the enabled status</li>
            <li><strong>Monitor:</strong> View trigger history and statistics in the charts above</li>
          </ul>

          <h3>ğŸ’¡ Tips</h3>
          <ul>
            <li>Use meaningful alert names (e.g., "High_CPU_Alert", "Failed_Login_Monitor")</li>
            <li>Set appropriate thresholds to avoid false positives</li>
            <li>Configure Slack channels based on alert severity</li>
            <li>Review alert history regularly to tune thresholds</li>
            <li>Delete alerts that are no longer needed</li>
          </ul>
        </div>
      </html>
    </panel>
  </row>
</form>
