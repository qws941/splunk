<form version="1.1" theme="dark">
  <label>FortiGate Data Explorer (index=fw)</label>
  <description>Explore your FortiGate data and create dynamic alerts</description>

  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="time_range">
      <label>Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>

  <!-- Top Statistics -->
  <row>
    <panel>
      <title>Total Events</title>
      <single>
        <search>
          <query>index=fw earliest=$time_range.earliest$ latest=$time_range.latest$ | stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">Total Events in index=fw</option>
      </single>
    </panel>

    <panel>
      <title>Unique Devices</title>
      <single>
        <query>index=fw earliest=$time_range.earliest$ latest=$time_range.latest$ | stats dc(devname) as unique_devices</query>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="underLabel">FortiGate Devices</option>
      </single>
    </panel>

    <panel>
      <title>Top LogID</title>
      <single>
        <query>index=fw earliest=$time_range.earliest$ latest=$time_range.latest$ | top limit=1 logid | fields logid</query>
        <option name="drilldown">none</option>
        <option name="underLabel">Most Frequent Log Type</option>
      </single>
    </panel>
  </row>

  <!-- LogID Distribution -->
  <row>
    <panel>
      <title>Top 20 LogIDs (Click to create alert)</title>
      <table>
        <search>
          <query>index=fw earliest=$time_range.earliest$ latest=$time_range.latest$
| stats count as event_count,
        dc(devname) as devices,
        dc(srcip) as unique_src_ips,
        values(logdesc) as description
    by logid
| sort -event_count
| head 20
| eval alert_ready = "âœ… Create Alert"</query>
        </search>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <link target="_blank">/app/security_alert/alert_builder?logid=$row.logid$&amp;count=$row.event_count$&amp;desc=$row.description$</link>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Severity Distribution -->
  <row>
    <panel>
      <title>Event Severity Distribution</title>
      <chart>
        <query>index=fw earliest=$time_range.earliest$ latest=$time_range.latest$
| eval severity = coalesce(level, "unknown")
| stats count by severity
| sort -count</query>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">all</option>
        <drilldown>
          <link target="_blank">/app/security_alert/alert_builder?severity=$click.value$</link>
        </drilldown>
      </chart>
    </panel>

    <panel>
      <title>Top Source IPs (Potential threats)</title>
      <table>
        <query>index=fw earliest=$time_range.earliest$ latest=$time_range.latest$
| stats count as events,
        dc(dstip) as targets,
        values(logdesc) as activities
    by srcip
| sort -events
| head 10
| eval alert_button = "ðŸš¨ Monitor This IP"</query>
        <option name="drilldown">row</option>
        <drilldown>
          <link target="_blank">/app/security_alert/alert_builder?srcip=$row.srcip$&amp;events=$row.events$</link>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Field Analysis -->
  <row>
    <panel>
      <title>Available Fields in index=fw</title>
      <table>
        <query>| rest /services/data/indexes/fw/fields
| search disabled=0
| stats count by title
| rename title as field_name
| sort field_name
| head 50</query>
        <option name="drilldown">cell</option>
      </table>
    </panel>

    <panel>
      <title>Top Actions (Click to create alert)</title>
      <table>
        <query>index=fw earliest=$time_range.earliest$ latest=$time_range.latest$ action=*
| stats count by action
| sort -count
| head 10
| eval alert_option = "âž• Alert on this"</query>
        <option name="drilldown">row</option>
        <drilldown>
          <link target="_blank">/app/security_alert/alert_builder?action=$row.action$</link>
        </drilldown>
      </table>
    </panel>
  </row>

  <!-- Sample Events -->
  <row>
    <panel>
      <title>Sample Events (Raw Data)</title>
      <table>
        <query>index=fw earliest=$time_range.earliest$ latest=$time_range.latest$
| head 20
| table _time, devname, logid, logdesc, srcip, dstip, action, level</query>
        <option name="drilldown">row</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
</form>
